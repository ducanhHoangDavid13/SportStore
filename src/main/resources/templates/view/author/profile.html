<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:fragment="head-links">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"/>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
    </div>
    <title>Th√¥ng Tin C√° Nh√¢n</title>
    <style>
        .account-page-wrapper { background-color: #f8f9fa; padding: 40px 0; }
        .main-content-panel { background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        .form-control:focus { border-color: #e5101d; box-shadow: 0 0 0 0.25rem rgba(229, 16, 29, 0.25); }
        .btn-submit { background-color: #e5101d; color: white; font-weight: 600; padding: 10px 25px; border: none; }
        .btn-submit:hover { background-color: #c40e18; }
        /* ƒê·∫£m b·∫£o c√°c tr∆∞·ªùng ch·ªâ ƒë·ªçc c√≥ m√†u n·ªÅn kh√°c ƒë·ªÉ d·ªÖ ph√¢n bi·ªát */
        .form-control-plaintext, .form-control:disabled, .form-control[readonly] {
            background-color: #e9ecef; /* M√†u n·ªÅn x√°m nh·∫°t */
            color: #495057;
        }
    </style>
</head>
<body>

<header th:replace="~{library/header :: header}"></header>

<div class="account-page-wrapper">
    <div class="container" style="max-width: 1200px;">
        <div class="row">
            <div class="col-lg-3">
                <div th:replace="~{/library/hosoUser :: account-sidebar(activePage='profile')}"></div>
            </div>

            <div class="col-lg-9">
                <div class="main-content-panel">
                    <h3 class="fw-bold mb-1">H·ªì S∆° C·ªßa T√¥i</h3>
                    <p class="text-muted mb-4">Qu·∫£n l√Ω th√¥ng tin h·ªì s∆° ƒë·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n</p>
                    <hr>
                    <div class="row">
                        <div class="col-md-12"> <form id="profileForm">
                            <input type="hidden" id="khachHangId" name="id" value="">
                            <input type="hidden" id="maKhachHang" name="maKhachHang" value="">

                            <div class="mb-3 row">
                                <label for="username" class="col-sm-3 col-form-label">T√™n ƒëƒÉng nh·∫≠p</label>
                                <div class="col-sm-9">
                                    <input type="text" readonly class="form-control" id="username" value="">
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="fullName" class="col-sm-3 col-form-label">H·ªç T√™n</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="fullName" name="tenKhachHang" value="">
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="email" class="col-sm-3 col-form-label">Email</label>
                                <div class="col-sm-9">
                                    <input type="email" readonly class="form-control" id="email" name="email" value="">
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="phone" class="col-sm-3 col-form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="phone" name="soDienThoai" value="">
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="namSinh" class="col-sm-3 col-form-label">NƒÉm sinh</label>
                                <div class="col-sm-9">
                                    <input type="number" class="form-control" id="namSinh" name="namSinh" value="">
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="age" class="col-sm-3 col-form-label">Tu·ªïi</label>
                                <div class="col-sm-9">
                                    <input type="text" readonly class="form-control" id="age" value="">
                                </div>
                            </div>

                            <div class="mb-4 row">
                                <label class="col-sm-3 col-form-label">Gi·ªõi t√≠nh</label>
                                <div class="col-sm-9 d-flex align-items-center">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="gioiTinh" id="male" value="true">
                                        <label class="form-check-label" for="male">Nam</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="gioiTinh" id="female" value="false">
                                        <label class="form-check-label" for="female">N·ªØ</label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-9 offset-sm-3">
                                    <button type="submit" class="btn btn-submit">L∆∞u Thay ƒê·ªïi</button>
                                </div>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{/library/footer :: footer}"></footer>
<div th:replace="~{/library/footer :: scripts}"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    toastr.options = { "closeButton": true, "progressBar": true, "positionClass": "toast-bottom-right", "timeOut": "3000" };

    // --- 1. VALIDATION FORM ---
    function validateForm(data) {
        let isValid = true;
        const currentYear = new Date().getFullYear();

        // X√≥a c√°c tr·∫°ng th√°i l·ªói c≈©
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').remove();

        const appendError = (id, msg) => {
            // ƒê·∫£m b·∫£o id t·ªìn t·∫°i tr∆∞·ªõc khi th√™m class/feedback
            const $element = $(`#${id}`);
            if($element.length) {
                $element.addClass('is-invalid').after(`<div class="invalid-feedback">${msg}</div>`);
                isValid = false;
            }
        };

        // 1. H·ªç T√™n
        if (!data.tenKhachHang || data.tenKhachHang.trim() === '') {
            appendError('fullName', 'H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
        }

        // 2. S·ªë ƒêi·ªán Tho·∫°i (SƒêT)
        const sdt = data.soDienThoai;
        if (sdt && sdt.trim() !== '') {
            // Cho ph√©p 10 ho·∫∑c 11 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0
            if (!/^0\d{9,10}$/.test(sdt)) {
                appendError('phone', 'SƒêT ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 0 v√† c√≥ 10 ho·∫∑c 11 ch·ªØ s·ªë.');
            }
        }

        // 3. NƒÉm Sinh
        const namSinh = data.namSinh;
        if (namSinh && namSinh.trim() !== '') {
            const year = parseInt(namSinh);
            if (isNaN(year) || year < 1900 || year > currentYear) {
                appendError('namSinh', `NƒÉm sinh ph·∫£i l√† s·ªë h·ª£p l·ªá (1900-${currentYear}).`);
            }
        }

        return isValid;
    }

    // üü¢ H√ÄM JQUERY ƒê·ªÇ L·∫§Y V√Ä ƒêI·ªÄN D·ªÆ LI·ªÜU T·ª™ API & C·∫¨P NH·∫¨T üü¢
    $(document).ready(function() {
        const LOAD_API = "/api/khach-hang/me";
        let khachHangId = null;

        // --- 2. H√ÄM T·∫¢I D·ªÆ LI·ªÜU ---
        function loadProfileData() {
            $.ajax({
                url: LOAD_API,
                type: "GET",
                dataType: "json",
                contentType: "application/json",
                success: function(data) {
                    // X√≥a l·ªói validation khi t·∫£i th√†nh c√¥ng
                    $('.form-control').removeClass('is-invalid');
                    $('.invalid-feedback').remove();

                    if (data) {
                        khachHangId = data.id;
                        const currentYear = new Date().getFullYear();

                        // ƒêi·ªÅn d·ªØ li·ªáu
                        $('#khachHangId').val(data.id);
                        $('#maKhachHang').val(data.maKhachHang || '');
                        $('#fullName').val(data.tenKhachHang || '');
                        $('#phone').val(data.soDienThoai || '');
                        $('#namSinh').val(data.namSinh || '');

                        // Tr∆∞·ªùng ch·ªâ ƒë·ªçc
                        $('#username').val(data.email || 'N/A');
                        $('#email').val(data.email || '');

                        // T√≠nh v√† ƒëi·ªÅn Tu·ªïi
                        if (data.namSinh && data.namSinh > 1900 && data.namSinh <= currentYear) {
                            $('#age').val(currentYear - data.namSinh);
                        } else {
                            $('#age').val('Ch∆∞a c·∫≠p nh·∫≠t');
                        }

                        // X·ª≠ l√Ω Gi·ªõi t√≠nh (Boolean: true/false)
                        if (data.gioiTinh === true) {
                            $('#male').prop('checked', true);
                        } else if (data.gioiTinh === false) {
                            $('#female').prop('checked', true);
                        } else {
                            // N·∫øu null, kh√¥ng check radio n√†o
                            $('input[name="gioiTinh"]').prop('checked', false);
                        }
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401 || xhr.status === 403) {
                        toastr.error("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ xem h·ªì s∆°.");
                    } else {
                        toastr.error("ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu h·ªì s∆°.");
                    }
                }
            });
        }

        // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
        loadProfileData();

        // --- 3. C·∫¨P NH·∫¨T TU·ªîI KHI THAY ƒê·ªîI NƒÇM SINH ---
        $('#namSinh').on('input', function() {
            const namSinhValue = $(this).val();
            const currentYear = new Date().getFullYear();
            const namSinh = parseInt(namSinhValue);

            if (!isNaN(namSinh) && namSinh > 1900 && namSinh <= currentYear) {
                $('#age').val(currentYear - namSinh);
            } else {
                $('#age').val('Ch∆∞a c·∫≠p nh·∫≠t');
            }
            // Logic validation ƒë·∫ßy ƒë·ªß s·∫Ω ƒë∆∞·ª£c ch·∫°y trong h√†m submit
        });


        // --- 4. H√ÄM X·ª¨ L√ù C·∫¨P NH·∫¨T (PUT) ---
        $('#profileForm').submit(function(e) {
            e.preventDefault();

            if (!khachHangId) {
                toastr.warning("Kh√¥ng t√¨m th·∫•y ID kh√°ch h√†ng. Vui l√≤ng t·∫£i l·∫°i trang.");
                return;
            }

            // 1. Thu th·∫≠p d·ªØ li·ªáu t·ª´ Form
            const updateData = {
                id: khachHangId,
                // Gi·ªØ nguy√™n MaKhachHang, Email
                maKhachHang: $('#maKhachHang').val(),
                tenKhachHang: $('#fullName').val().trim(),
                soDienThoai: $('#phone').val().trim(),
                email: $('#email').val(),
                namSinh: $('#namSinh').val().trim(),
                // L·∫•y gi√° tr·ªã boolean t·ª´ radio
                gioiTinh: $('input[name="gioiTinh"]:checked').val() === 'true'
            };

            // 2. Validation
            if (!validateForm(updateData)) {
                toastr.error("Vui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng b·ªã l·ªói.");
                return;
            }

            // 3. G·ªçi API PUT
            $.ajax({
                url: `/api/khach-hang/${khachHangId}`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(updateData),
                success: function(response) {
                    toastr.success("C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!");
                    // T·∫£i l·∫°i d·ªØ li·ªáu ƒë·ªÉ ƒë·∫£m b·∫£o Tu·ªïi ƒë∆∞·ª£c c·∫≠p nh·∫≠t ch√≠nh x√°c v√† x√≥a tr·∫°ng th√°i l·ªói
                    loadProfileData();
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || "L·ªói c·∫≠p nh·∫≠t. Vui l√≤ng ki·ªÉm tra d·ªØ li·ªáu.";
                    toastr.error(errorMsg);
                }
            });
        });
    });
</script>

</body>
</html>