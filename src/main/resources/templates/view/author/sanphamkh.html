<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:fragment="head-links">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sản Phẩm - SPORTX</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
    </div>

    <style>
        /* [Giữ nguyên CSS] */
        /* ======================= 1. VARIABLES & RESET (MATCH HOMEPAGE) ======================= */
        :root {
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Oswald', sans-serif;
            --primary: #0b72ff;       /* Màu xanh chủ đạo */
            --primary-dark: #0056c7;
            --dark: #111111;
            --light: #f4f7f6;
            --text-gray: #6c757d;
            --border-color: #e5e7eb;
            --shadow-card: 0 10px 30px rgba(0,0,0,0.08);
            --shadow-hover: 0 15px 40px rgba(11, 114, 255, 0.15);
            --radius: 12px;
        }

        body { font-family: var(--font-main); background-color: #f8fafc; color: var(--dark); }
        h1, h2, h3, h4, h5 { font-family: var(--font-heading); text-transform: uppercase; letter-spacing: 0.5px; }
        a { text-decoration: none; transition: 0.3s; }

        /* Layout */
        .main-container { max-width: 1350px; margin: 40px auto; padding: 0 20px; }

        /* ======================= 2. PAGE HEADER & SORT ======================= */
        .page-header-wrapper {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
        }
        .page-title { font-size: 2rem; margin: 0; font-weight: 700; color: var(--dark); }

        .sort-box { position: relative; min-width: 200px; }
        .sort-select {
            width: 100%; padding: 10px 15px; border-radius: 50px; border: 1px solid var(--border-color);
            appearance: none; background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236c757d'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E") no-repeat right 15px center; background-size: 16px;
            font-family: var(--font-main); font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sort-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(11, 114, 255, 0.1); }

        /* ======================= 3. SIDEBAR FILTER (MODERN STYLE) ======================= */
        .filter-sidebar {
            background: #fff; padding: 25px; border-radius: 16px;
            box-shadow: var(--shadow-card); position: sticky; top: 100px; /* Trượt theo khi cuộn */
        }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filter-header h5 { font-size: 1.2rem; margin: 0; display: flex; align-items: center; gap: 8px; }
        .reset-btn { font-size: 0.85rem; color: var(--text-gray); cursor: pointer; border: none; background: none; text-decoration: underline; }
        .reset-btn:hover { color: var(--primary); }

        .filter-group { margin-bottom: 30px; }
        .filter-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 15px; display: block; font-family: var(--font-heading); }

        .filter-list { max-height: 200px; overflow-y: auto; padding-right: 5px; }
        /* Scrollbar đẹp */
        .filter-list::-webkit-scrollbar { width: 4px; }
        .filter-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Custom Checkbox Design */
        .custom-check { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; font-size: 0.95rem; color: #4b5563; transition: 0.2s; }
        .custom-check:hover { color: var(--primary); }
        .custom-check input { display: none; }
        .check-indicator {
            width: 20px; height: 20px; border: 2px solid #d1d5db; border-radius: 6px; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0;
        }

        /* Trạng thái Checked */
        .custom-check input:checked ~ .check-indicator { background-color: var(--primary); border-color: var(--primary); }
        .custom-check input:checked ~ .check-indicator::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #fff; font-size: 12px; }

        /* ======================= 4. PRODUCT CARD (COPY FROM HOMEPAGE) ======================= */
        .product-card {
            background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid #f1f5f9;
            transition: 0.3s; position: relative; height: 100%;
        }
        .product-card:hover { box-shadow: var(--shadow-hover); border-color: transparent; transform: translateY(-5px); }

        .product-img-wrap { position: relative; overflow: hidden; padding-top: 100%; background: #f8fafc; }
        .product-img-wrap img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .product-card:hover .product-img-wrap img { transform: scale(1.08); }

        /* Action Buttons */
        .product-actions {
            position: absolute; bottom: 15px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px;
            opacity: 0; transform: translateY(20px); transition: 0.3s; z-index: 3;
        }
        .product-card:hover .product-actions { opacity: 1; transform: translateY(0); }

        .action-btn {
            width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; cursor: pointer; border: none;
        }
        .action-btn:hover { background: var(--primary); color: #fff; }

        .product-info { padding: 20px; text-align: center; }
        .product-tag { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--primary); letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .product-name { font-size: 1rem; font-weight: 600; margin-bottom: 8px; color: var(--dark); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 48px; }
        .product-price { font-size: 1.1rem; font-weight: 700; color: var(--dark); }

        /* ======================= 5. PAGINATION ======================= */
        .pagination { gap: 5px; }
        .page-link {
            border: none; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50% !important; color: var(--dark); font-weight: 600; font-family: var(--font-main);
        }
        .page-item.active .page-link { background-color: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(11, 114, 255, 0.3); }
        .page-link:hover:not(.active) { background-color: #e2e8f0; color: var(--primary); }

        /* Loading Spinner */
        #loading-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.8); z-index: 10;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }

        /* Cần thiết cho slider */
        .form-range { margin-bottom: 15px; }


        /* Responsive */
        @media (max-width: 991px) {
            .filter-sidebar { margin-bottom: 30px; position: static; }
            .page-header-wrapper { flex-direction: column; align-items: flex-start; gap: 15px; }
            .sort-box { width: 100%; }
        }
    </style>
</head>
<body>

<header th:replace="~{/library/header :: header}"></header>

<main class="main-container">

    <div class="page-header-wrapper">
        <h2 class="page-title">CỬA HÀNG</h2>
        <div class="sort-box">
            <select id="sort-select" class="sort-select">
                <option value="id,desc" selected>Mới nhất</option>
                <option value="giaTien,asc">Giá: Thấp đến Cao</option>
                <option value="giaTien,desc">Giá: Cao đến Thấp</option>
                <option value="tenSanPham,asc">Tên: A-Z</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-3">
            <div class="filter-sidebar">
                <div class="filter-header">
                    <h5><i class="fa-solid fa-sliders"></i> BỘ LỌC</h5>
                    <button id="reset-filter-btn" class="reset-btn">Xóa tất cả</button>
                </div>

                <div class="filter-group">
                    <span class="filter-title">TÌM KIẾM TÊN SP</span>
                    <input type="text" id="keyword-search" class="form-control" placeholder="Nhập tên sản phẩm..." style="border-radius: 50px;">
                </div>

                <div class="filter-group">
                    <span class="filter-title">KHOẢNG GIÁ</span>
                    <div style="margin-top: 10px;">
                        <p class="mb-2 fw-semibold">
                            Tối đa: <span id="max-price-display">10.000.000 VND</span>
                        </p>

                        <input type="range" class="form-range" id="max-price-slider" min="0" max="10000000" step="500000" value="10000000">
                    </div>
                </div>

                <div class="filter-group">
                    <span class="filter-title">THỂ LOẠI</span>
                    <div class="filter-list" id="theLoaiOptions" data-filter-key="theLoaiIds"></div>
                </div>

                <div class="filter-group">
                    <span class="filter-title">THƯƠNG HIỆU</span>
                    <div class="filter-list" id="xuatXuOptions" data-filter-key="xuatXuIds"></div>
                </div>

                <div class="filter-group">
                    <span class="filter-title">ĐỐI TƯỢNG</span>
                    <div class="filter-list" id="phanLoaiOptions" data-filter-key="phanLoaiIds"></div>
                </div>

                <div class="filter-group">
                    <span class="filter-title">CHẤT LIỆU</span>
                    <div class="filter-list" id="chatLieuOptions" data-filter-key="chatLieuIds"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-9 position-relative">
            <div id="loading-overlay" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            </div>

            <div class="row row-cols-2 row-cols-md-3 row-cols-xl-3 g-4" id="product-grid">
            </div>

            <div id="pagination-container" class="mt-5 d-flex justify-content-center"></div>
        </div>
    </div>
</main>

<footer th:replace="~{/library/footer :: footer}"></footer>

<a href="#" class="floating-chat-btn position-fixed bottom-0 end-0 m-4 p-3 rounded-circle shadow-lg text-white" style="background: #0084FF; width: 60px; height: 60px; display:flex; align-items:center; justify-content:center; z-index:9999;">
    <i class="fa-brands fa-facebook-messenger fs-2"></i>
</a>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = "/api/san-pham/filter";
    const MAX_PRICE_VALUE = 100000000;

    const FILTER_CONFIG = {
        'theLoaiOptions': { url: '/api/the-loai', nameKey: 'tenTheLoai', type: 'checkbox' },
        'xuatXuOptions': { url: '/api/xuat-xu', nameKey: 'tenXuatXu', type: 'checkbox' },
        'phanLoaiOptions': { url: '/api/phan-loai', nameKey: 'phanLoai', type: 'checkbox' },
        'chatLieuOptions': { url: '/api/chat-lieu', nameKey: 'loaiChatLieu', type: 'checkbox' }
    };

    let currentPage = 0;
    let currentSize = 9;
    let productImagesMap = {};
    let isFetching = false; // Biến kiểm soát việc gọi API

    let filterParams = {
        xuatXuIds: null, theLoaiIds: null, phanLoaiIds: null, chatLieuIds: null,
        minPrice: 0,
        maxPrice: MAX_PRICE_VALUE,
        sort: "id,desc",
        keyword: null
    };

    // Hàm Debounce
    function debounce(func, delay) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Hàm định dạng tiền tệ
    function formatCurrency(number) {
        if (number === undefined || number === null) return '0 VND';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 }).format(number);
    }

    // --- 1. TẢI ẢNH ---
    function loadAllImagesAndMap() {
        return new Promise((resolve) => {
            $.ajax({
                url: "/api/hinh-anh/all",
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const images = response.content || response;
                    productImagesMap = {};
                    if (Array.isArray(images)) {
                        images.forEach(image => {
                            // SỬA: Đảm bảo lấy tên trường ảnh chính xác và là ảnh đầu tiên cho mỗi sản phẩm
                            const productId = image.sanPham?.id;
                            const tenHinhAnh = image.tenHinhAnh; // Giả sử đây là tên file
                            if (productId && tenHinhAnh) {
                                if (!productImagesMap[productId]) {
                                    productImagesMap[productId] = tenHinhAnh;
                                }
                            }
                        });
                    }
                    resolve();
                },
                error: (xhr) => { console.error("Lỗi ảnh:", xhr); resolve(); }
            });
        });
    }

    // --- 2. RENDER CARD ---
    // --- 2. RENDER CARD (ĐÃ CẬP NHẬT) ---
    function createProductCard(product) {
        const formattedPrice = formatCurrency(product.giaTien);

        // Lấy ảnh từ Map
        let imageUrl = 'https://placehold.co/400x400?text=No+Image';
        if (productImagesMap[product.id]) {
            imageUrl = '/image/' + productImagesMap[product.id];
        }

        // --- 1. LOGIC TÍNH TỒN KHO (ĐÃ SỬA) ---
        let totalStock = 0;

        // QUAN TRỌNG: Phải kiểm tra danh sách biến thể (SPCT) TRƯỚC
        // Vì số lượng ở bảng cha (product.soLuong) đang bị sai (chưa cập nhật kịp).
        if (Array.isArray(product.sanPhamChiTiets) && product.sanPhamChiTiets.length > 0) {
            totalStock = product.sanPhamChiTiets.reduce((sum, spct) => sum + (spct.soLuong || 0), 0);
        }
        // Chỉ khi nào không có danh sách biến thể thì mới dùng số lượng của bảng cha
        else {
            totalStock = product.soLuong || 0;
        }

        // Kiểm tra trạng thái: 0 là ngừng kinh doanh HOẶC tổng tồn kho <= 0
        const isOutOfStock = (product.trangThai === 0) || (totalStock <= 0);

        // --- 2. LOGIC GIAO DIỆN (ĐÃ SỬA) ---

        // CSS cho trạng thái hết hàng:
        // BỎ 'pointer-events: none' đi để khách vẫn click vào ảnh xem chi tiết được.
        // Chỉ làm mờ và xám ảnh thôi.
        const stockStatusStyle = isOutOfStock ? 'opacity: 0.6; filter: grayscale(100%);' : '';

        // Nút bấm hành động
        // Nếu hết hàng -> Nút bị vô hiệu hóa (disabled)
        const actionButton = isOutOfStock
            ? `<button class="action-btn" disabled style="background: #6c757d; cursor: not-allowed;" title="Hết hàng"><i class="fa-solid fa-ban"></i></button>`
            : `<button class="action-btn btn-add-to-cart" title="Thêm vào giỏ" data-product-id="${product.id}">
                <i class="fa-solid fa-cart-plus"></i>
           </button>`;

        // Nhãn báo hết hàng (Overlay)
        const stockLabel = isOutOfStock
            ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; font-weight: bold; border-radius: 4px; z-index: 10; pointer-events: none;">HẾT HÀNG</div>`
            : '';

        return `
    <div class="col">
        <div class="product-card" data-product-id="${product.id}">
            <div class="product-img-wrap" style="position: relative; ${stockStatusStyle}">
                <img src="${imageUrl}" alt="${product.tenSanPham}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=No+Image';">

                ${stockLabel}

                <div class="product-actions">
                    ${actionButton}
                    <button class="action-btn btn-detail" title="Xem chi tiết">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="product-info">
                <span class="product-tag">${product.xuatXu?.tenXuatXu || 'SPORTX'}</span>
                <h3 class="product-name">
                    <a href="/san-pham/chi-tiet/${product.id}" class="text-dark">${product.tenSanPham}</a>
                </h3>
                <div class="product-price">${formattedPrice}</div>

                ${isOutOfStock
            ? '<small class="text-danger fw-bold">Tạm hết hàng</small>'
            : `<small class="text-muted">Sẵn hàng: ${totalStock}</small>`
        }
            </div>
        </div>
    </div>`;
    }

    // --- 3. TẠO FILTER UI & SLIDER ---
    function populateFilterOptions(containerId, apiUrl, nameKey, type) {
        const $container = $('#' + containerId);
        return new Promise((resolve) => {
            $.ajax({
                url: apiUrl, method: 'GET', dataType: 'json',
                success: function(response) {
                    const data = response.content || response;
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const id = item.id;
                            const name = item[nameKey] || item.ten;
                            const optionHtml = `
                                <label class="custom-check">
                                    <input type="${type}" name="${containerId}" value="${id}" class="filter-checkbox-trigger">
                                    <span class="check-indicator"></span>
                                    ${name}
                                </label>`;
                            $container.append(optionHtml);
                        });
                    }
                    resolve();
                },
                error: () => resolve()
            });
        });
    }

    // Logic cho Range Slider (Chỉ dùng Max Price)
    function setupPriceSlider() {
        const $maxSlider = $('#max-price-slider');
        const $maxDisplay = $('#max-price-display');

        // Set giá trị ban đầu
        $maxDisplay.text(formatCurrency(parseInt($maxSlider.val())));

        // 1. Sự kiện 'input': Chỉ cập nhật số tiền hiển thị (để UI mượt)
        $maxSlider.on('input', function() {
            const val = parseInt($(this).val());
            $maxDisplay.text(formatCurrency(val));
        });

        // 2. Sự kiện 'change': Chỉ gọi API khi người dùng THẢ tay khỏi chuột
        // (Thay thế cho debounce ở đây để tránh gọi API liên tục khi đang kéo)
        $maxSlider.on('change', function() {
            const val = parseInt($(this).val());
            filterParams.maxPrice = val;
            console.log("Lọc giá dưới: " + val); // Debug
            loadProducts(0);
        });
    }


    // --- 4. LOAD & RENDER PRODUCTS ---
    function loadProducts(page = 0) {
        if (isFetching) return;
        isFetching = true;

        currentPage = page;
        $('#loading-overlay').show();

        const params = { ...filterParams, page: currentPage, size: currentSize };
        const finalParams = {};
        for (const key in params) {
            // Đảm bảo không gửi giá trị null/undefined lên API
            if (params[key] !== null && params[key] !== undefined && params[key] !== '') {
                finalParams[key] = params[key];
            }
        }

        $.ajax({
            url: API_URL, data: $.param(finalParams, true), method: 'GET', dataType: 'json',
            success: function(response) {
                setTimeout(() => {
                    $('#loading-overlay').hide();
                    isFetching = false;
                }, 300);

                const products = response.content;
                if (!products || products.length === 0) {
                    $('#product-grid').html(`
                        <div class="col-12 py-5 text-center">
                            <i class="fa-solid fa-box-open fs-1 text-muted mb-3"></i>
                            <p class="text-muted">Không tìm thấy sản phẩm nào phù hợp với bộ lọc.</p>
                        </div>`);
                    $('#pagination-container').empty();
                    return;
                }
                $('#product-grid').html(products.map(createProductCard).join(''));

                // Cập nhật Pagination
                if (response.totalPages > 1) createPagination(response);
                else $('#pagination-container').empty();
            },
            error: function() {
                $('#loading-overlay').hide();
                isFetching = false;
                $('#product-grid').html('<div class="col-12 text-center text-danger">Lỗi kết nối máy chủ khi tải sản phẩm.</div>');
            }
        });
    }

    // --- 5. PAGINATION LOGIC ---
    let pageObject = {};
    function createPagination(response) {
        pageObject = response;
        const totalPages = pageObject.totalPages;
        const current = pageObject.number;
        const $nav = $('<nav><ul class="pagination"></ul></nav>');
        const $ul = $nav.find('ul');

        const createItem = (text, page, disabled, active) => {
            return `<li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                        <button class="page-link page-nav-link" data-page="${page}">${text}</button>
                    </li>`;
        };

        if (totalPages <= 1) return;

        $ul.append(createItem('<i class="fa-solid fa-chevron-left"></i>', current - 1, current === 0, false));

        let start = Math.max(0, current - 2);
        let end = Math.min(totalPages - 1, current + 2);

        if (start > 0) $ul.append(createItem('1', 0, false, false));
        if (start > 1) $ul.append('<li class="page-item disabled"><span class="page-link">...</span></li>');

        for (let i = start; i <= end; i++) {
            $ul.append(createItem(i + 1, i, false, i === current));
        }

        if (end < totalPages - 2) $ul.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
        if (end < totalPages - 1) $ul.append(createItem(totalPages, totalPages - 1, false, false));

        $ul.append(createItem('<i class="fa-solid fa-chevron-right"></i>', current + 1, current === totalPages - 1, false));
        $('#pagination-container').empty().append($nav);
    }

    // --- 6. EVENTS ---
    $(document).ready(function() {
        // Init Load
        const initPromises = [loadAllImagesAndMap()];

        // KHỞI TẠO SLIDER
        setupPriceSlider();

        // KHỞI TẠO CÁC BỘ LỌC CHECKBOX
        for (const key in FILTER_CONFIG) {
            initPromises.push(populateFilterOptions(key, FILTER_CONFIG[key].url, FILTER_CONFIG[key].nameKey, FILTER_CONFIG[key].type));
        }

        // Tải sản phẩm sau khi tải ảnh và bộ lọc
        Promise.all(initPromises).then(() => loadProducts(0));

        // Sort Change
        $('#sort-select').on('change', function() {
            filterParams.sort = $(this).val();
            loadProducts(0);
        });

        // Event tìm kiếm theo keyword (sử dụng debounce)
        $('#keyword-search').on('input', debounce(function() {
            const keyword = $(this).val().trim();
            filterParams.keyword = keyword.length > 0 ? keyword : null;
            loadProducts(0);
        }, 300));

        // Filter Checkbox Change (Chỉ xử lý Checkbox, không xử lý Slider hay Keyword)
        $('.filter-sidebar').on('change', '.filter-checkbox-trigger', function() {
            // Lấy giá trị Checkboxes
            $('.filter-list[data-filter-key]').each(function() {
                const key = $(this).attr('data-filter-key');
                // Lấy ID (Integer) của các checkbox đã chọn
                const checked = $(this).find('input:checked').map((_, el) => parseInt($(el).val())).get();
                filterParams[key] = checked.length ? checked : null;
            });
            loadProducts(0);
        });


        // Reset Filter
        $('#reset-filter-btn').on('click', function() {
            // Reset Checkboxes
            $('input[type="checkbox"]').prop('checked', false);

            // Reset Keyword
            $('#keyword-search').val('');

            // Reset Slider (Max Price)
            $('#max-price-slider').val(MAX_PRICE_VALUE).trigger('input'); // Trigger input để cập nhật display và filterParams

            // Reset Sort
            $('#sort-select').val('id,desc');

            // Reset filterParams (đảm bảo đồng bộ với UI)
            filterParams = {
                xuatXuIds: null, theLoaiIds: null, phanLoaiIds: null, chatLieuIds: null,
                minPrice: 0,
                maxPrice: MAX_PRICE_VALUE,
                sort: "id,desc",
                keyword: null
            };
            loadProducts(0);
        });

        // Pagination Click
        $(document).on('click', '.page-nav-link', function() {
            if (!pageObject.totalPages) return;

            const page = $(this).data('page');
            if (page !== undefined && page >= 0 && page < pageObject.totalPages) {
                loadProducts(page);
                $('html, body').animate({ scrollTop: 0 }, 400);
            }
        });

        // Add Cart Click (Giả định sản phẩm có tồn kho > 0)
        $(document).on('click', '.btn-add-to-cart', function(e) {
            e.stopPropagation();
            const btn = $(this);
            const productId = btn.closest('.product-card').data('product-id');

            console.log("Thêm vào giỏ hàng sản phẩm: " + productId);

            // Hiệu ứng thành công tạm thời
            btn.html('<i class="fa-solid fa-check"></i>').css({'background': '#10b981', 'color': '#fff'});

            // Note: Cần chuyển sang trang chi tiết để chọn biến thể, hoặc sử dụng modal
            // Hiện tại chỉ là hiệu ứng

            setTimeout(() => {
                btn.html('<i class="fa-solid fa-cart-plus"></i>').css({'background': '', 'color': ''});
            }, 1500);
        });

        // View Detail Click
        $(document).on('click', '.btn-detail', function(e) {
            e.stopPropagation();
            const id = $(this).closest('.product-card').data('product-id');
            window.location.href = `/san-pham/chi-tiet/${id}`;
        });
    });
</script>
</body>
</html>