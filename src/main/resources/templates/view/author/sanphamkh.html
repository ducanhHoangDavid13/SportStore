<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Sản Phẩm - Thể Thao</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts: Poppins & Lato -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* ======================= 1. GLOBAL, HEADER, FOOTER STYLES ======================= */
        /* === BIẾN MÀU SẮC CHUNG === */
        :root {
            --primary-font: 'Poppins', sans-serif;
            --secondary-font: 'Lato', sans-serif;
            --bg-color: #ffffff; /* Nền trắng cho trang sản phẩm */
            --text-color: #212529;
            --accent-color: #0d6efd; /* Bootstrap Primary Blue for consistency */
            --accent-hover-color: #0b5ed7;
            --gray-color: #6c757d;
            --white-color: #ffffff;
            --footer-bg: #343a40;
            --border-color: #dee2e6;
            --sale-color: #dc3545;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        /* === CẤU TRÚC CHUNG === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--secondary-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        h1, h2, h3, h4, h5, h6 { font-family: var(--primary-font); font-weight: 600; }
        a { text-decoration: none; color: inherit; transition: color 0.3s ease; }
        ul { list-style: none; }
        .container, .container-fluid { max-width: 1400px; }

        /* === HEADER === */
        .header {
            background-color: var(--white-color);
            box-shadow: var(--shadow);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-container { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 15px;}
        .header-logo { font-family: var(--primary-font); font-size: 1.8rem; font-weight: 700; color: var(--accent-color); }
        .main-nav ul { display: flex; gap: 30px; }
        .main-nav a { font-family: var(--primary-font); font-weight: 500; font-size: 1rem; padding: 5px 0; position: relative; }
        .main-nav a::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 2px; background-color: var(--accent-color); transition: width 0.3s ease; }
        .main-nav a:hover::after, .main-nav a.active::after { width: 100%; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .action-icon { font-size: 1.2rem; position: relative; color: var(--text-color); }
        .action-icon:hover { color: var(--accent-color); }
        .cart-count { position: absolute; top: -8px; right: -10px; background-color: var(--sale-color); color: var(--white-color); width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: bold; }
        .logout-form { display: inline; }
        .logout-btn { background: none; border: none; cursor: pointer; padding: 0; }

        /* === FOOTER === */
        .footer { background-color: var(--footer-bg); color: #adb5bd; padding: 60px 0 20px; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-col h4 { color: var(--white-color); font-size: 1.2rem; margin-bottom: 20px; }
        .footer-logo { font-family: var(--primary-font); font-size: 1.8rem; font-weight: 700; color: var(--white-color); }
        .footer-col p { font-size: 0.9rem; line-height: 1.8; }
        .footer-col ul li { margin-bottom: 12px; }
        .footer-col ul a:hover { color: var(--white-color); padding-left: 5px; }
        .social-icons { margin-top: 20px; display: flex; gap: 15px; }
        .social-icons a { color: #adb5bd; font-size: 1.2rem; }
        .social-icons a:hover { color: var(--accent-color); }
        .newsletter-form { margin-top: 20px; display: flex; }
        .newsletter-form input { flex-grow: 1; padding: 10px; border: 1px solid var(--gray-color); border-radius: 5px 0 0 5px; background-color: #495057; color: var(--white-color); border-right: none; }
        .newsletter-form button { padding: 10px 15px; border: none; background-color: var(--accent-color); color: var(--white-color); border-radius: 0 5px 5px 0; cursor: pointer; font-weight: 500; }
        .footer-bottom { border-top: 1px solid var(--gray-color); padding-top: 20px; text-align: center; font-size: 0.9rem; }

        /* ==================================== */
        /* === 2. CSS CHO TRANG SẢN PHẨM (PLP) === */
        /* ==================================== */
        .container-section { padding: 40px 20px; max-width: 1400px; margin: 0 auto; }
        .plp-page-title { font-size: 1.8rem; font-weight: 800; color: var(--text-color); margin-bottom: 20px; padding-top: 20px; }
        .plp-sort-bar { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .plp-sort-bar select { width: 150px; height: 35px; font-size: 0.85rem; }
        .sort-text { color: #666; font-weight: 500; }

        /* --- BỘ LỌC SIDEBAR (THAY ĐỔI NHIỀU NHẤT) --- */
        .filter-sidebar { background-color: #f8f8f8; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        @media (min-width: 992px) { .filter-sidebar { position: sticky; top: 100px; } }
        .filter-sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 5px; border-bottom: 1px dashed #ddd; }
        .filter-sidebar-header h5 { margin-bottom: 0; font-weight: 700; }
        .reset-filter-btn { border: none; background: transparent; color: var(--text-color); font-size: 1.1rem; cursor: pointer; transition: transform 0.2s, color 0.2s; padding: 5px; }
        .reset-filter-btn:hover { color: var(--accent-color); transform: rotate(15deg); }
        .filter-group-item { margin-bottom: 20px; }
        .filter-group-item label.form-label { font-weight: 600; margin-bottom: 10px; display: block; font-size: 0.95rem; color: #555; }

        /* --- CUSTOM CHECKBOX & RADIO --- */
        .filter-options-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .filter-option {
            display: block;
            position: relative;
            padding-left: 30px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .filter-option input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #eee;
            border: 1px solid #ccc;
            transition: all 0.2s;
        }
        .filter-option:hover input ~ .checkmark { background-color: #ccc; }
        .filter-option input:checked ~ .checkmark { background-color: var(--accent-color); border-color: var(--accent-color); }
        .checkmark:after { content: ""; position: absolute; display: none; }
        .filter-option input:checked ~ .checkmark:after { display: block; }

        /* Checkbox checkmark */
        .filter-option .checkmark.checkbox:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }
        .filter-option .checkmark.checkbox { border-radius: 4px; }

        /* Radio checkmark */
        .filter-option .checkmark.radio { border-radius: 50%; }
        .filter-option .checkmark.radio:after {
            top: 5px;
            left: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }

        /* --- CARD SẢN PHẨM --- */
        .product-list-card {
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .product-list-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); }
        .product-list-img-container { position: relative; height: 300px; overflow: hidden; }
        .product-list-img-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .product-list-text { padding: 15px; text-align: center; min-height: 80px; }
        .product-list-name { font-size: 0.95rem; font-weight: 600; color: var(--text-color); margin-bottom: 5px; height: 40px; overflow: hidden; }
        .product-list-price { font-size: 1.1rem; font-weight: 700; color: var(--accent-color); }
        .product-list-footer {
            position: absolute; bottom: 0; left: 0; right: 0; width: 100%;
            background-color: rgba(13, 110, 253, 0.95); /* Tông màu xanh của Bootstrap */
            transform: translateY(100%); opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            height: 50px; display: flex; justify-content: stretch;
        }
        .product-list-card:hover .product-list-footer { opacity: 1; transform: translateY(0); }
        .footer-btn {
            flex: 1; height: 100%; border: none; color: #fff; background: transparent;
            font-size: 0.9rem; font-weight: 600; display: flex; align-items: center;
            justify-content: center; gap: 8px; cursor: pointer; transition: background-color 0.2s;
        }
        .btn-add-to-cart { border-right: 1px solid rgba(255,255,255,0.3); }
        .btn-detail:hover, .btn-add-to-cart:hover { background-color: rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body>

<!-- ======================= HEADER ======================= -->
<header class="header">
    <div class="header-container">
        <a href="/home" class="header-logo">SportGear</a>

        <nav class="main-nav">
            <ul>
                <li><a href="#">Nam</a></li>
                <li><a href="#">Nữ</a></li>
                <li><a href="#">Trẻ Em</a></li>
                <li><a href="/san-pham" class="active">Sản Phẩm</a></li>
                <li><a href="#">Sale</a></li>
            </ul>
        </nav>

        <div class="header-actions">
            <a href="#" class="action-icon"><i class="fa-solid fa-magnifying-glass"></i></a>
            <a href="/" class="action-icon"><i class="fa-solid fa-user"></i></a>
            <a href="#" class="action-icon"><i class="fa-solid fa-heart"></i></a>
            <a href="#" class="action-icon">
                <i class="fa-solid fa-bag-shopping"></i>
                <span class="cart-count">3</span>
            </a>
            <form th:action="@{/logout}" method="post" class="logout-form">
                <button type="submit" class="action-icon logout-btn" title="Đăng xuất">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </form>
        </div>
    </div>
</header>

<!-- ======================= MAIN CONTENT ======================= -->
<div class="container-section">
    <h2 class="plp-page-title">DANH SÁCH SẢN PHẨM</h2>

    <div class="plp-sort-bar">
        <span class="sort-text">Sắp xếp:</span>
        <select id="sort-select" class="form-select form-select-sm">
            <option value="id,desc" selected>Mới nhất</option>
            <option value="giaTien,asc">Giá: Thấp đến Cao</option>
            <option value="giaTien,desc">Giá: Cao đến Thấp</option>
            <option value="tenSanPham,asc">Tên: A-Z</option>
        </select>
    </div>

    <div class="row">
        <!-- BỘ LỌC SIDEBAR -->
        <div class="col-lg-3">
            <div class="filter-sidebar">
                <div class="filter-sidebar-header">
                    <h5>Bộ Lọc</h5>
                    <button id="reset-filter-btn" class="reset-filter-btn" title="Đặt lại bộ lọc">&#x21BB;</button>
                </div>

                <div class="filter-group-item">
                    <label class="form-label">Khoảng Giá</label>
                    <div class="filter-options-list" id="priceRangeOptions">
                        <!-- Dữ liệu giá sẽ được JS chèn vào đây -->
                    </div>
                </div>

                <div class="filter-group-item">
                    <label class="form-label">Thể Loại</label>
                    <div class="filter-options-list" id="theLoaiOptions" data-filter-key="theLoaiIds"></div>
                </div>

                <div class="filter-group-item">
                    <label class="form-label">Xuất Xứ</label>
                    <div class="filter-options-list" id="xuatXuOptions" data-filter-key="xuatXuIds"></div>
                </div>

                <div class="filter-group-item">
                    <label class="form-label">Phân Loại</label>
                    <div class="filter-options-list" id="phanLoaiOptions" data-filter-key="phanLoaiIds"></div>
                </div>

                <div class="filter-group-item">
                    <label class="form-label">Chất Liệu</label>
                    <div class="filter-options-list" id="chatLieuOptions" data-filter-key="chatLieuIds"></div>
                </div>
            </div>
        </div>

        <!-- DANH SÁCH SẢN PHẨM -->
        <div class="col-lg-9">
            <div id="product-list-container">
                <div class="alert alert-info text-center" id="loading-message" style="display: none;">Đang tải sản phẩm...</div>
                <div class="row row-cols-2 row-cols-md-3 g-4" id="product-grid"></div>
            </div>

            <div id="pagination-container" class="d-flex flex-column align-items-center mt-5"></div>
        </div>
    </div>
</div>

<!-- ======================= FOOTER ======================= -->
<footer class="footer">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col">
                <h4 class="footer-logo">SportGear</h4>
                <p>Nâng tầm trải nghiệm thể thao của bạn với những sản phẩm chất lượng hàng đầu.</p>
                <div class="social-icons">
                    <a href="#"><i class="fa-brands fa-facebook-f"></i></a>
                    <a href="#"><i class="fa-brands fa-instagram"></i></a>
                    <a href="#"><i class="fa-brands fa-tiktok"></i></a>
                </div>
            </div>
            <div class="footer-col">
                <h4>Sản phẩm</h4>
                <ul>
                    <li><a href="#">Quần áo</a></li>
                    <li><a href="#">Giày</a></li>
                    <li><a href="#">Phụ kiện</a></li>
                    <li><a href="#">Dụng cụ</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Hỗ trợ</h4>
                <ul>
                    <li><a href="#">Chính sách đổi trả</a></li>
                    <li><a href="#">Hướng dẫn mua hàng</a></li>
                    <li><a href="#">Câu hỏi thường gặp</a></li>
                    <li><a href="#">Chính sách bảo mật</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Đăng ký nhận tin</h4>
                <p>Nhận thông tin về sản phẩm mới và khuyến mãi đặc biệt.</p>
                <form class="newsletter-form">
                    <input type="email" placeholder="Nhập email của bạn">
                    <button type="submit">Đăng Ký</button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 SportGear. Đã đăng ký bản quyền.</p>
        </div>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = "/api/san-pham/filter";
    // Cấu hình mới cho việc tạo bộ lọc
    const FILTER_CONFIG = {
        'theLoaiOptions': { url: '/api/the-loai', nameKey: 'tenTheLoai', type: 'checkbox' },
        'xuatXuOptions': { url: '/api/xuat-xu', nameKey: 'tenXuatXu', type: 'checkbox' },
        'phanLoaiOptions': { url: '/api/phan-loai', nameKey: 'phanLoai', type: 'checkbox' },
        'chatLieuOptions': { url: '/api/chat-lieu', nameKey: 'loaiChatLieu', type: 'checkbox' }
    };
    const PRICE_RANGES = [
        { label: 'Tất cả', value: '0,999999999' },
        { label: 'Dưới 1 triệu', value: '0,1000000' },
        { label: '1 - 5 triệu', value: '1000000,5000000' },
        { label: 'Trên 5 triệu', value: '5000000,999999999' }
    ];

    let currentPage = 0;
    let currentSize = 12;
    let totalPagesCount = 1;
    let productImagesMap = {};

    let filterParams = {
        xuatXuIds: null, theLoaiIds: null, phanLoaiIds: null, chatLieuIds: null,
        minPrice: 0, maxPrice: 999999999, sort: "id,desc"
    };

    // --- HÀM TẢI VÀ ÁNH XẠ ẢNH ---
    function loadAllImagesAndMap() {
        return new Promise((resolve) => {
            $.ajax({
                url: "/api/hinh-anh/all",
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const images = response.content || response;
                    productImagesMap = {};
                    if (Array.isArray(images)) {
                        images.forEach(image => {
                            const productId = image.sanPham?.id;
                            if (productId) {
                                if (!productImagesMap[productId]) productImagesMap[productId] = [];
                                productImagesMap[productId].push(image);
                            }
                        });
                    }
                    resolve();
                },
                error: (xhr, status, error) => { console.error("Lỗi khi tải hình ảnh:", error); resolve(); }
            });
        });
    }

    // --- HÀM TẠO CARD SẢN PHẨM ---
    function createProductCard(product) {
        const formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.giaTien);
        let imageUrl = '/image/default_no_image.png';
        if (productImagesMap[product.id]?.length > 0) {
            imageUrl = '/image/' + productImagesMap[product.id][0].tenHinhAnh;
        }

        return `
        <div class="col">
            <div class="product-list-card" data-product-id="${product.id}">
                <div class="product-list-img-container">
                    <img src="${imageUrl}" alt="${product.tenSanPham}" loading="lazy">
                    <div class="product-list-footer">
                        <button class="footer-btn btn-add-to-cart"><i class="fa-solid fa-cart-plus"></i> Mua nhanh</button>
                        <button class="footer-btn btn-detail"><i class="fa-solid fa-eye"></i> Xem chi tiết</button>
                    </div>
                </div>
                <div class="product-list-text">
                    <p class="product-list-name">${product.tenSanPham}</p>
                    <p class="product-list-price">${formattedPrice}</p>
                </div>
            </div>
        </div>`;
    }

    // --- HÀM TẠO PHÂN TRANG ---
    function createPagination(pageObject) {
        const totalPages = pageObject.totalPages;
        const currentPageNumber = pageObject.number;
        totalPagesCount = totalPages;
        const paginationContainer = $('#pagination-container');
        paginationContainer.empty();
        if (totalPages <= 1) return;

        const info = `<div class="text-center text-muted mb-3">Trang ${currentPageNumber + 1} / ${totalPages}</div>`;
        const nav = $('<nav aria-label="Phân trang sản phẩm"><ul class="pagination justify-content-center"></ul></nav>');
        const ul = nav.find('ul');

        const createPageItem = (text, page, isDisabled = false, isActive = false) => {
            const disabledClass = isDisabled ? 'disabled' : '';
            const activeClass = isActive ? 'active' : '';
            return `<li class="page-item ${disabledClass} ${activeClass}"><a class="page-link page-nav-link" href="#" data-page="${page}">${text}</a></li>`;
        };

        ul.append(createPageItem('Trước', currentPageNumber - 1, pageObject.first));

        let startPage = Math.max(0, currentPageNumber - 2);
        let endPage = Math.min(totalPages - 1, currentPageNumber + 2);
        if (currentPageNumber < 2) endPage = Math.min(totalPages - 1, 4);
        if (currentPageNumber > totalPages - 3) startPage = Math.max(0, totalPages - 5);
        if (startPage > 0) ul.append('<li class="page-item disabled"><span class="page-link">...</span></li>');

        for (let i = startPage; i <= endPage; i++) {
            ul.append(createPageItem(i + 1, i, false, i === currentPageNumber));
        }

        if (endPage < totalPages - 1) ul.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
        ul.append(createPageItem('Sau', currentPageNumber + 1, pageObject.last));

        paginationContainer.html(info).append(nav);
    }

    // --- HÀM TẠO CÁC LỰA CHỌN BỘ LỌC (CHECKBOX/RADIO) ---
    function populateFilterOptions(containerId, apiUrl, nameKey, type) {
        const $container = $('#' + containerId);
        return new Promise((resolve) => {
            $.ajax({
                url: apiUrl, method: 'GET', dataType: 'json',
                success: function(response) {
                    const data = response.content || response;
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const id = item.id;
                            const name = item[nameKey] || item.ten;
                            const optionHtml = `
                                <label class="filter-option">${name}
                                    <input type="${type}" name="${containerId}" value="${id}" class="filter-trigger">
                                    <span class="checkmark ${type}"></span>
                                </label>`;
                            $container.append(optionHtml);
                        });
                    }
                    resolve();
                },
                error: (xhr, status, error) => { console.error(`Lỗi tải ${containerId}:`, error); resolve(); }
            });
        });
    }

    function populatePriceRanges() {
        const $container = $('#priceRangeOptions');
        PRICE_RANGES.forEach((range, index) => {
            const isChecked = index === 0 ? 'checked' : '';
            const optionHtml = `
                <label class="filter-option">${range.label}
                    <input type="radio" name="priceRange" value="${range.value}" class="filter-trigger" ${isChecked}>
                    <span class="checkmark radio"></span>
                </label>`;
            $container.append(optionHtml);
        });
    }

    // --- HÀM GỌI AJAX TẢI SẢN PHẨM ---
    function loadProducts(page = 0) {
        currentPage = page;
        $('#product-grid').empty();
        $('#pagination-container').empty();
        $('#loading-message').show();

        const params = { ...filterParams, page: currentPage, size: currentSize };
        const finalParams = {};
        for (const key in params) {
            const value = params[key];
            if (value !== null && value !== undefined && !(Array.isArray(value) && value.length === 0)) {
                finalParams[key] = value;
            }
        }

        $.ajax({
            url: API_URL, data: $.param(finalParams, true), method: 'GET', dataType: 'json',
            success: function(response) {
                $('#loading-message').hide();
                const products = response.content;
                if (products.length === 0) {
                    $('#product-grid').html('<div class="col-12"><div class="alert alert-warning text-center">Không tìm thấy sản phẩm nào phù hợp.</div></div>');
                    return;
                }
                $('#product-grid').html(products.map(createProductCard).join(''));
                if (response.totalPages > 1) createPagination(response);
            },
            error: function(xhr) {
                $('#loading-message').hide();
                console.error("Lỗi khi tải sản phẩm:", xhr.responseText);
                $('#product-grid').html(`<div class="col-12"><div class="alert alert-danger text-center">Có lỗi xảy ra khi tải dữ liệu (${xhr.status}).</div></div>`);
            }
        });
    }

    // --- THIẾT LẬP CÁC SỰ KIỆN LẮNG NGHE ---
    $(document).ready(function() {
        // --- BƯỚC 1: LOAD DỮ LIỆU KHỞI TẠO ---
        const initialPromises = [loadAllImagesAndMap()];
        populatePriceRanges(); // Tạo radio button cho giá (dữ liệu tĩnh)
        for (const containerId in FILTER_CONFIG) {
            const config = FILTER_CONFIG[containerId];
            initialPromises.push(populateFilterOptions(containerId, config.url, config.nameKey, config.type));
        }

        Promise.all(initialPromises).then(() => {
            loadProducts(currentPage);
        }).catch(error => {
            console.error("Lỗi khởi tạo:", error);
            $('#product-grid').html('<div class="alert alert-danger text-center">Không thể tải dữ liệu khởi tạo.</div>');
        });

        // --- BƯỚC 2: XỬ LÝ SỰ KIỆN LỌC VÀ SẮP XẾP ---
        $('#sort-select').on('change', function() {
            filterParams.sort = $(this).val();
            loadProducts(0);
        });

        // Lắng nghe sự kiện thay đổi trên tất cả checkbox và radio trong sidebar
        $('.filter-sidebar').on('change', '.filter-trigger', function() {
            // Xử lý radio (khoảng giá)
            const priceRange = $('input[name="priceRange"]:checked').val().split(',');
            filterParams.minPrice = parseFloat(priceRange[0]);
            filterParams.maxPrice = parseFloat(priceRange[1]);

            // Xử lý checkboxes
            $('.filter-options-list[data-filter-key]').each(function() {
                const key = $(this).data('filter-key');
                const selectedIds = $(this).find('input[type="checkbox"]:checked').map(function() {
                    return parseInt($(this).val());
                }).get();
                filterParams[key] = selectedIds.length > 0 ? selectedIds : null;
            });

            loadProducts(0);
        });

        // --- BƯỚC 3: XỬ LÝ NÚT RESET BỘ LỌC ---
        $('#reset-filter-btn').on('click', function() {
            // 1. Reset UI
            $('input[type="checkbox"]').prop('checked', false);
            $('input[name="priceRange"][value="0,999999999"]').prop('checked', true); // Chọn lại "Tất cả"
            $('#sort-select').val('id,desc');

            // 2. Reset filterParams object
            filterParams = {
                xuatXuIds: null, theLoaiIds: null, phanLoaiIds: null, chatLieuIds: null,
                minPrice: 0, maxPrice: 999999999, sort: "id,desc"
            };

            // 3. Tải lại sản phẩm
            loadProducts(0);
        });

        // --- BƯỚC 4: XỬ LÝ SỰ KIỆN PHÂN TRANG VÀ CARD ACTION ---
        $(document).on('click', '.page-nav-link', function(e) {
            e.preventDefault();
            const newPage = $(this).data('page');
            if (!$(this).parent().hasClass('disabled')) {
                loadProducts(newPage);
                $('html, body').animate({ scrollTop: $('.plp-page-title').offset().top - 100 }, 500);
            }
        });

        $(document).on('click', '.btn-detail', function(e) {
            e.stopPropagation();
            const productId = $(this).closest('.product-list-card').data('product-id');
            // Chuyển hướng đến trang chi tiết sản phẩm
            window.location.href = '/san-pham/' + productId;
        });

        $(document).on('click', '.btn-add-to-cart', function(e) {
            e.stopPropagation();
            const productId = $(this).closest('.product-list-card').data('product-id');
            // TODO: Logic thêm sản phẩm vào giỏ hàng (ví dụ: gọi API)
            console.log('Thêm SP ID: ' + productId + ' vào giỏ.');
            // Hiển thị thông báo tạm thời
            $(this).html('<i class="fa-solid fa-check"></i> Đã thêm');
            setTimeout(() => {
                $(this).html('<i class="fa-solid fa-cart-plus"></i> Mua nhanh');
            }, 1500);
        });

        $(document).on('click', '.product-list-card', function() {
            const productId = $(this).data('product-id');
            window.location.href = '/san-pham/' + productId;
        });
    });
</script>
</body>
</html>