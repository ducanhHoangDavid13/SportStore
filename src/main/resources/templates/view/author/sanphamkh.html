<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:fragment="head-links">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sản Phẩm - SPORTX</title>

        <!-- Bootstrap 5 -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- FontAwesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

        <!-- CSS Project -->
        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
    </div>

    <style>
        /* ======================= 1. VARIABLES & RESET (MATCH HOMEPAGE) ======================= */
        :root {
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Oswald', sans-serif;
            --primary: #0b72ff;       /* Màu xanh chủ đạo */
            --primary-dark: #0056c7;
            --dark: #111111;
            --light: #f4f7f6;
            --text-gray: #6c757d;
            --border-color: #e5e7eb;
            --shadow-card: 0 10px 30px rgba(0,0,0,0.08);
            --shadow-hover: 0 15px 40px rgba(11, 114, 255, 0.15);
            --radius: 12px;
        }

        body { font-family: var(--font-main); background-color: #f8fafc; color: var(--dark); }
        h1, h2, h3, h4, h5 { font-family: var(--font-heading); text-transform: uppercase; letter-spacing: 0.5px; }
        a { text-decoration: none; transition: 0.3s; }

        /* Layout */
        .main-container { max-width: 1350px; margin: 40px auto; padding: 0 20px; }

        /* ======================= 2. PAGE HEADER & SORT ======================= */
        .page-header-wrapper {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
        }
        .page-title { font-size: 2rem; margin: 0; font-weight: 700; color: var(--dark); }

        .sort-box { position: relative; min-width: 200px; }
        .sort-select {
            width: 100%; padding: 10px 15px; border-radius: 50px; border: 1px solid var(--border-color);
            appearance: none; background: #fff url("data:image/svg+xml,...") no-repeat right 15px center; /* Icon mũi tên */
            font-family: var(--font-main); font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sort-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(11, 114, 255, 0.1); }

        /* ======================= 3. SIDEBAR FILTER (MODERN STYLE) ======================= */
        .filter-sidebar {
            background: #fff; padding: 25px; border-radius: 16px;
            box-shadow: var(--shadow-card); position: sticky; top: 100px; /* Trượt theo khi cuộn */
        }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filter-header h5 { font-size: 1.2rem; margin: 0; display: flex; align-items: center; gap: 8px; }
        .reset-btn { font-size: 0.85rem; color: var(--text-gray); cursor: pointer; border: none; background: none; text-decoration: underline; }
        .reset-btn:hover { color: var(--primary); }

        .filter-group { margin-bottom: 30px; }
        .filter-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 15px; display: block; font-family: var(--font-heading); }

        .filter-list { max-height: 200px; overflow-y: auto; padding-right: 5px; }
        /* Scrollbar đẹp */
        .filter-list::-webkit-scrollbar { width: 4px; }
        .filter-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Custom Checkbox Design */
        .custom-check { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; font-size: 0.95rem; color: #4b5563; transition: 0.2s; }
        .custom-check:hover { color: var(--primary); }
        .custom-check input { display: none; }
        .check-indicator {
            width: 20px; height: 20px; border: 2px solid #d1d5db; border-radius: 6px; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0;
        }

        /* Trạng thái Checked */
        .custom-check input:checked ~ .check-indicator { background-color: var(--primary); border-color: var(--primary); }
        .custom-check input:checked ~ .check-indicator::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #fff; font-size: 12px; }

        /* Radio button style (cho Giá) */
        .custom-check input[type="radio"] ~ .check-indicator { border-radius: 50%; }
        .custom-check input[type="radio"]:checked ~ .check-indicator::after { content: ''; width: 10px; height: 10px; background: #fff; border-radius: 50%; }

        /* ======================= 4. PRODUCT CARD (COPY FROM HOMEPAGE) ======================= */
        .product-card {
            background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid #f1f5f9;
            transition: 0.3s; position: relative; height: 100%;
        }
        .product-card:hover { box-shadow: var(--shadow-hover); border-color: transparent; transform: translateY(-5px); }

        .product-img-wrap { position: relative; overflow: hidden; padding-top: 100%; background: #f8fafc; }
        .product-img-wrap img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .product-card:hover .product-img-wrap img { transform: scale(1.08); }

        /* Action Buttons */
        .product-actions {
            position: absolute; bottom: 15px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px;
            opacity: 0; transform: translateY(20px); transition: 0.3s; z-index: 3;
        }
        .product-card:hover .product-actions { opacity: 1; transform: translateY(0); }

        .action-btn {
            width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; cursor: pointer; border: none;
        }
        .action-btn:hover { background: var(--primary); color: #fff; }

        .product-info { padding: 20px; text-align: center; }
        .product-tag { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--primary); letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .product-name { font-size: 1rem; font-weight: 600; margin-bottom: 8px; color: var(--dark); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 48px; }
        .product-price { font-size: 1.1rem; font-weight: 700; color: var(--dark); }

        /* ======================= 5. PAGINATION ======================= */
        .pagination { gap: 5px; }
        .page-link {
            border: none; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50% !important; color: var(--dark); font-weight: 600; font-family: var(--font-main);
        }
        .page-item.active .page-link { background-color: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(11, 114, 255, 0.3); }
        .page-link:hover:not(.active) { background-color: #e2e8f0; color: var(--primary); }

        /* Loading Spinner */
        #loading-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.8); z-index: 10;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }

        /* Responsive */
        @media (max-width: 991px) {
            .filter-sidebar { margin-bottom: 30px; position: static; }
            .page-header-wrapper { flex-direction: column; align-items: flex-start; gap: 15px; }
            .sort-box { width: 100%; }
        }
    </style>
</head>
<body>

<!-- Header -->
<header th:replace="~{/library/header :: header}"></header>

<main class="main-container">

    <!-- Title & Sort -->
    <div class="page-header-wrapper">
        <h2 class="page-title">CỬA HÀNG</h2>
        <div class="sort-box">
            <select id="sort-select" class="sort-select">
                <option value="id,desc" selected>Mới nhất</option>
                <option value="giaTien,asc">Giá: Thấp đến Cao</option>
                <option value="giaTien,desc">Giá: Cao đến Thấp</option>
                <option value="tenSanPham,asc">Tên: A-Z</option>
            </select>
        </div>
    </div>

    <div class="row">
        <!-- 1. SIDEBAR FILTER -->
        <div class="col-lg-3">
            <div class="filter-sidebar">
                <div class="filter-header">
                    <h5><i class="fa-solid fa-sliders"></i> BỘ LỌC</h5>
                    <button id="reset-filter-btn" class="reset-btn">Xóa tất cả</button>
                </div>

                <!-- Khoảng giá -->
                <div class="filter-group">
                    <span class="filter-title">KHOẢNG GIÁ</span>
                    <div class="filter-list" id="priceRangeOptions">
                        <!-- JS render -->
                    </div>
                </div>

                <!-- Thể loại -->
                <div class="filter-group">
                    <span class="filter-title">THỂ LOẠI</span>
                    <div class="filter-list" id="theLoaiOptions" data-filter-key="theLoaiIds"></div>
                </div>

                <!-- Thương hiệu (Xuất xứ) -->
                <div class="filter-group">
                    <span class="filter-title">THƯƠNG HIỆU</span>
                    <div class="filter-list" id="xuatXuOptions" data-filter-key="xuatXuIds"></div>
                </div>

                <!-- Đối tượng -->
                <div class="filter-group">
                    <span class="filter-title">ĐỐI TƯỢNG</span>
                    <div class="filter-list" id="phanLoaiOptions" data-filter-key="phanLoaiIds"></div>
                </div>

                <!-- Chất liệu -->
                <div class="filter-group">
                    <span class="filter-title">CHẤT LIỆU</span>
                    <div class="filter-list" id="chatLieuOptions" data-filter-key="chatLieuIds"></div>
                </div>
            </div>
        </div>

        <!-- 2. PRODUCT GRID -->
        <div class="col-lg-9 position-relative">
            <!-- Loading Spinner -->
            <div id="loading-overlay" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            </div>

            <!-- Grid Sản Phẩm -->
            <div class="row row-cols-2 row-cols-md-3 row-cols-xl-3 g-4" id="product-grid">
                <!-- JS Render Products Here -->
            </div>

            <!-- Phân trang -->
            <div id="pagination-container" class="mt-5 d-flex justify-content-center"></div>
        </div>
    </div>
</main>

<!-- Footer -->
<footer th:replace="~{/library/footer :: footer}"></footer>

<!-- Nút Messenger -->
<a href="#" class="floating-chat-btn position-fixed bottom-0 end-0 m-4 p-3 rounded-circle shadow-lg text-white" style="background: #0084FF; width: 60px; height: 60px; display:flex; align-items:center; justify-content:center; z-index:9999;">
    <i class="fa-brands fa-facebook-messenger fs-2"></i>
</a>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = "/api/san-pham/filter";

    // Config: API endpoint & key name
    const FILTER_CONFIG = {
        'theLoaiOptions': { url: '/api/the-loai', nameKey: 'tenTheLoai', type: 'checkbox' },
        'xuatXuOptions': { url: '/api/xuat-xu', nameKey: 'tenXuatXu', type: 'checkbox' },
        'phanLoaiOptions': { url: '/api/phan-loai', nameKey: 'phanLoai', type: 'checkbox' },
        'chatLieuOptions': { url: '/api/chat-lieu', nameKey: 'loaiChatLieu', type: 'checkbox' }
    };

    const PRICE_RANGES = [
        { label: 'Tất cả mức giá', value: '0,999999999' },
        { label: 'Dưới 1 triệu', value: '0,1000000' },
        { label: '1 - 5 triệu', value: '1000000,5000000' },
        { label: 'Trên 5 triệu', value: '5000000,999999999' }
    ];

    let currentPage = 0;
    let currentSize = 9; // Grid 3x3 đẹp hơn
    let productImagesMap = {};

    let filterParams = {
        xuatXuIds: null, theLoaiIds: null, phanLoaiIds: null, chatLieuIds: null,
        minPrice: 0, maxPrice: 999999999, sort: "id,desc"
    };

    // --- 1. TẢI ẢNH (Dùng Map để map ID sản phẩm -> Ảnh) ---
    function loadAllImagesAndMap() {
        return new Promise((resolve) => {
            $.ajax({
                url: "/api/hinh-anh/all",
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const images = response.content || response;
                    productImagesMap = {};
                    if (Array.isArray(images)) {
                        images.forEach(image => {
                            const productId = image.sanPham?.id;
                            if (productId) {
                                if (!productImagesMap[productId]) productImagesMap[productId] = [];
                                productImagesMap[productId].push(image);
                            }
                        });
                    }
                    resolve();
                },
                error: (xhr) => { console.error("Lỗi ảnh:", xhr); resolve(); }
            });
        });
    }

    // --- 2. RENDER CARD (HTML CHUẨN MỚI) ---
    function createProductCard(product) {
        const formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.giaTien);

        // Lấy ảnh
        let imageUrl = 'https://placehold.co/400x400?text=No+Image'; // Ảnh placeholder nếu lỗi
        if (productImagesMap[product.id] && productImagesMap[product.id].length > 0) {
            imageUrl = '/image/' + productImagesMap[product.id][0].tenHinhAnh;
        }

        return `
        <div class="col">
            <div class="product-card" data-product-id="${product.id}">
                <div class="product-img-wrap">
                    <img src="${imageUrl}" alt="${product.tenSanPham}" loading="lazy">
                    <!-- Action Buttons Floating -->
                    <div class="product-actions">
                        <button class="action-btn btn-add-to-cart" title="Thêm vào giỏ">
                            <i class="fa-solid fa-cart-plus"></i>
                        </button>
                        <button class="action-btn btn-detail" title="Xem chi tiết">
                            <i class="fa-regular fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="product-info">
                    <span class="product-tag">${product.xuatXu?.tenXuatXu || 'SPORTX'}</span>
                    <h3 class="product-name" title="${product.tenSanPham}">
                        <a href="/san-pham/chi-tiet/${product.id}" class="text-dark">${product.tenSanPham}</a>
                    </h3>
                    <div class="product-price">${formattedPrice}</div>
                </div>
            </div>
        </div>`;
    }

    // --- 3. TẠO FILTER UI (Custom Checkbox) ---
    function populateFilterOptions(containerId, apiUrl, nameKey, type) {
        const $container = $('#' + containerId);
        return new Promise((resolve) => {
            $.ajax({
                url: apiUrl, method: 'GET', dataType: 'json',
                success: function(response) {
                    const data = response.content || response;
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const id = item.id;
                            const name = item[nameKey] || item.ten;
                            // Custom Checkbox HTML Structure
                            const optionHtml = `
                                <label class="custom-check">
                                    <input type="${type}" name="${containerId}" value="${id}" class="filter-trigger">
                                    <span class="check-indicator"></span>
                                    ${name}
                                </label>`;
                            $container.append(optionHtml);
                        });
                    }
                    resolve();
                },
                error: () => resolve()
            });
        });
    }

    function populatePriceRanges() {
        const $container = $('#priceRangeOptions');
        PRICE_RANGES.forEach((range, index) => {
            const isChecked = index === 0 ? 'checked' : '';
            const optionHtml = `
                <label class="custom-check">
                    <input type="radio" name="priceRange" value="${range.value}" class="filter-trigger" ${isChecked}>
                    <span class="check-indicator"></span>
                    ${range.label}
                </label>`;
            $container.append(optionHtml);
        });
    }

    // --- 4. LOAD & RENDER PRODUCTS ---
    function loadProducts(page = 0) {
        currentPage = page;
        $('#loading-overlay').show(); // Show loading

        const params = { ...filterParams, page: currentPage, size: currentSize };
        // Cleanup null/undefined
        const finalParams = {};
        for (const key in params) {
            if (params[key] !== null && params[key] !== undefined) finalParams[key] = params[key];
        }

        $.ajax({
            url: API_URL, data: $.param(finalParams, true), method: 'GET', dataType: 'json',
            success: function(response) {
                setTimeout(() => { $('#loading-overlay').hide(); }, 300); // Fake delay nhẹ cho mượt

                const products = response.content;
                if (!products || products.length === 0) {
                    $('#product-grid').html(`
                        <div class="col-12 py-5 text-center">
                            <i class="fa-solid fa-box-open fs-1 text-muted mb-3"></i>
                            <p class="text-muted">Không tìm thấy sản phẩm nào phù hợp.</p>
                        </div>`);
                    $('#pagination-container').empty();
                    return;
                }
                $('#product-grid').html(products.map(createProductCard).join(''));
                if (response.totalPages > 1) createPagination(response);
                else $('#pagination-container').empty();
            },
            error: function() {
                $('#loading-overlay').hide();
                $('#product-grid').html('<div class="col-12 text-center text-danger">Lỗi kết nối máy chủ.</div>');
            }
        });
    }

    // --- 5. PAGINATION LOGIC ---
    function createPagination(pageObject) {
        const totalPages = pageObject.totalPages;
        const current = pageObject.number;
        const $nav = $('<nav><ul class="pagination"></ul></nav>');
        const $ul = $nav.find('ul');

        const createItem = (text, page, disabled, active) => {
            return `<li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                        <button class="page-link page-nav-link" data-page="${page}">${text}</button>
                    </li>`;
        };

        if (totalPages <= 1) return;

        $ul.append(createItem('<i class="fa-solid fa-chevron-left"></i>', current - 1, current === 0, false));

        let start = Math.max(0, current - 2);
        let end = Math.min(totalPages - 1, current + 2);

        if (start > 0) $ul.append(createItem('1', 0, false, false));
        if (start > 1) $ul.append('<li class="page-item disabled"><span class="page-link">...</span></li>');

        for (let i = start; i <= end; i++) {
            $ul.append(createItem(i + 1, i, false, i === current));
        }

        if (end < totalPages - 2) $ul.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
        if (end < totalPages - 1) $ul.append(createItem(totalPages, totalPages - 1, false, false));

        $ul.append(createItem('<i class="fa-solid fa-chevron-right"></i>', current + 1, current === totalPages - 1, false));
        $('#pagination-container').empty().append($nav);
    }

    // --- 6. EVENTS ---
    $(document).ready(function() {
        // Init Load
        const initPromises = [loadAllImagesAndMap()];
        populatePriceRanges();
        for (const key in FILTER_CONFIG) {
            initPromises.push(populateFilterOptions(key, FILTER_CONFIG[key].url, FILTER_CONFIG[key].nameKey, FILTER_CONFIG[key].type));
        }

        Promise.all(initPromises).then(() => loadProducts(0));

        // Sort
        $('#sort-select').on('change', function() {
            filterParams.sort = $(this).val();
            loadProducts(0);
        });

        // Filter Change
        $('.filter-sidebar').on('change', '.filter-trigger', function() {
            // Price
            const priceVal = $('input[name="priceRange"]:checked').val();
            if (priceVal) {
                const parts = priceVal.split(',');
                filterParams.minPrice = parseFloat(parts[0]);
                filterParams.maxPrice = parseFloat(parts[1]);
            }
            // Checkboxes
            $('.filter-list[data-filter-key]').each(function() {
                const key = $(this).attr('data-filter-key');
                const checked = $(this).find('input:checked').map((_, el) => parseInt($(el).val())).get();
                filterParams[key] = checked.length ? checked : null;
            });
            loadProducts(0);
        });

        // Reset
        $('#reset-filter-btn').on('click', function() {
            $('input[type="checkbox"]').prop('checked', false);
            $('input[name="priceRange"][value="0,999999999"]').prop('checked', true);
            $('#sort-select').val('id,desc');
            filterParams = {
                xuatXuIds: null, theLoaiIds: null, phanLoaiIds: null, chatLieuIds: null,
                minPrice: 0, maxPrice: 999999999, sort: "id,desc"
            };
            loadProducts(0);
        });

        // Pagination Click
        $(document).on('click', '.page-nav-link', function() {
            const page = $(this).data('page');
            loadProducts(page);
            $('html, body').animate({ scrollTop: 0 }, 400);
        });

        // Add Cart Click
        $(document).on('click', '.btn-add-to-cart', function(e) {
            e.stopPropagation();
            const btn = $(this);
            // Hiệu ứng simple
            btn.html('<i class="fa-solid fa-check"></i>').css('background', '#10b981').css('color', '#fff');

            // TODO: Gọi API thêm vào giỏ hàng ở đây
            console.log("Add cart: " + btn.closest('.product-card').data('product-id'));

            setTimeout(() => {
                btn.html('<i class="fa-solid fa-cart-plus"></i>').css('background', '').css('color', '');
            }, 1500);
        });

        // View Detail Click
        $(document).on('click', '.btn-detail', function(e) {
            e.stopPropagation();
            const id = $(this).closest('.product-card').data('product-id');
            window.location.href = `/san-pham/chi-tiet/${id}`;
        });
    });
    // Đoạn mã JavaScript mẫu để gọi API
    $.ajax({
        url: '/api/cart/add',
        type: 'POST',
        data: {
            productDetailId: YOUR_PRODUCT_ID, // Lấy ID sản phẩm bạn muốn thêm
            quantity: 1 // Lấy số lượng bạn muốn thêm
        },
        success: function(response) {
            if (response.success) {
                // Cập nhật số lượng mới lên header
                $('#cart-count').text(response.newCount);
                // Cập nhật giá trị hiển thị cũ (th:text="2")
            }
        }
        // ... xử lý lỗi (error handling)
    });
</script>
</body>
</html>