<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:fragment="head-links">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
    </div>
    <title>ƒê∆°n h√†ng c·ªßa t√¥i</title>
    <style>
        /* CSS C∆† B·∫¢N */
        .account-page-wrapper { background-color: #f8f9fa; padding: 30px 0; }
        .main-content-panel { background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 3px 15px rgba(0,0,0,0.05); }

        /* C·∫¨P NH·∫¨T CSS CHO TABLIST */
        .order-status-tabs {
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            white-space: nowrap;
            display: flex;
            flex-wrap: nowrap;
        }
        .order-status-tabs .nav-link { border: none; color: #495057; padding: 10px 0; margin: 0 15px; font-weight: 500; position: relative; background-color: transparent !important; cursor: pointer; }
        .order-status-tabs .nav-link.active { color: #e5101d; font-weight: 700; }
        .order-status-tabs .nav-link::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 3px; background-color: #e5101d; transition: width 0.3s ease; }
        .order-status-tabs .nav-link.active::after, .order-status-tabs .nav-link:hover::after { width: 100%; }

        /* C·∫¨P NH·∫¨T CSS CHO CARD ƒê∆†N H√ÄNG */
        .order-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .order-card-header {
            padding: 10px 15px;
            background-color: #f1f3f5;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .order-info-group {
            display: flex;
            align-items: center;
        }

        .sale-type-badge {
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 4px;
            font-weight: 600;
            margin-right: 10px;
        }
        .sale-type-online { color: #007bff; background-color: rgba(0, 123, 255, 0.1); border: 1px solid #007bff; }
        .sale-type-store { color: #28a745; background-color: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; }


        .order-status { font-weight: 700; padding: 3px 8px; border-radius: 50px; font-size: 0.75rem; }

        /* THU G·ªåN CHI TI·∫æT S·∫¢N PH·∫®M */
        .product-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            margin-bottom: 5px;
            border-bottom: 1px dashed #eee;
            font-size: 0.85rem;
        }
        .product-item:last-of-type { border-bottom: none !important; }

        .product-image {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            margin-right: 10px;
        }
        .product-info { flex-grow: 1; }
        .product-info .product-name { font-weight: 600; color: #333; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .product-info .product-details { font-size: 0.75rem; color: #6c757d; }
        .product-item .product-qty-price { width: 150px; text-align: right; }
        .product-item .product-qty-price strong { color: #e5101d; font-size: 0.95rem; }

        /* FOOTER */
        .order-card-footer {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .total-amount { font-size: 1rem; font-weight: 700; }
        .total-amount span { color: #e5101d; }
        .btn-toggle-items {
            padding: 5px 10px;
            font-size: 0.8rem;
            color: #007bff;
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
        .btn-toggle-items:hover {
            text-decoration: underline;
        }

        /* D√ÄNH CHO HI·ªÇN TH·ªä R√öT G·ªåN */
        .collapsed-item {
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n c√°c item sau item ƒë·∫ßu ti√™n */
        }
        .expanded .collapsed-item {
            display: flex; /* Hi·ªÉn th·ªã t·∫•t c·∫£ khi c√≥ class 'expanded' */
        }
        .product-list-container {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

    </style>
</head>
<body>
<header th:replace="~{library/header :: header}"></header>

<div class="account-page-wrapper">
    <div class="container" style="max-width: 1200px;">
        <div class="row">
            <div class="col-lg-3">
                <div th:replace="~{/library/hosoUser :: account-sidebar(activePage='orders')}"></div>
            </div>

            <div class="col-lg-9">
                <div class="main-content-panel">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold mb-2 mb-md-0">ƒê∆°n H√†ng C·ªßa T√¥i</h3>
                    </div>

                    <ul class="nav order-status-tabs mb-3" id="orderTabs" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" data-status="">T·∫•t c·∫£</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-status="0">Ch·ªù x√°c nh·∫≠n</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-status="1">ƒê√£ x√°c nh·∫≠n</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-status="2">ƒêang chu·∫©n b·ªã</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-status="3">ƒêang giao</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-status="4">Ho√†n th√†nh</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-status="5">ƒê√£ h·ªßy</button></li>
                    </ul>

                    <div class="tab-content" id="orderTabsContent">
                        <div class="tab-pane fade show active" id="orders-list-container">
                        </div>
                    </div>

                    <nav aria-label="Order pagination" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination-links">
                        </ul>
                    </nav>

                    <div class="empty-orders-placeholder d-none" id="empty-orders-placeholder">
                        <img th:src="@{/image/empty-box.png}" alt="Empty Box">
                        <h5 class="mt-4 mb-3 fw-bold">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h5>
                        <p class="text-muted">H√£y b·∫Øt ƒë·∫ßu mua s·∫Øm ƒë·ªÉ l·∫•p ƒë·∫ßy gi·ªè h√†ng c·ªßa b·∫°n nh√©!</p>
                        <a th:href="@{/san-pham}" class="btn btn-danger btn-discover-now mt-3">
                            <i class="fas fa-shopping-bag me-2"></i> Mua s·∫Øm ngay
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{/library/footer :: footer}"></footer>
<div th:replace="~{/library/footer :: scripts}"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // C·∫•u h√¨nh API v√† bi·∫øn tr·∫°ng th√°i
    const API_URL = "/api/don-hang-cua-toi";
    const PAGE_SIZE = 10;

    // Map tr·∫°ng th√°i (gi√° tr·ªã Integer) v·ªõi text hi·ªÉn th·ªã v√† class CSS
    const STATUS_MAP = {
        0: { text: "Ch·ªù x√°c nh·∫≠n", class: "status-processing" },
        1: { text: "ƒê√£ x√°c nh·∫≠n", class: "status-processing" },
        2: { text: "ƒêang chu·∫©n b·ªã", class: "status-processing" },
        3: { text: "ƒêang giao", class: "status-shipping" },
        4: { text: "Ho√†n th√†nh", class: "status-completed" },
        5: { text: "ƒê√£ h·ªßy", class: "status-cancelled" }
    };

    // Map H√¨nh th·ª©c b√°n h√†ng
    const SALES_TYPE_MAP = {
        0: { text: "Online", class: "sale-type-online" },
        1: { text: "T·∫°i qu·∫ßy", class: "sale-type-store" },
        default: { text: "Kh√¥ng r√µ", class: "sale-type-cancelled" }
    };

    let currentStatus = null; // null = T·∫•t c·∫£
    let currentPage = 0;

    /**
     * H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá (VND).
     */
    const formatCurrency = (amount) => {
        const value = amount !== null && amount !== undefined ? amount : 0;
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    };

    /**
     * H√†m g·ªçi API ƒë·ªÉ l·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n.
     */
    function fetchOrders(status, page) {
        currentStatus = status;
        currentPage = page;

        const params = {
            page: page,
            size: PAGE_SIZE
        };

        if (status !== null) {
            params.trangThai = status;
        }

        $("#orders-list-container").html('<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-danger"></i><p class="mt-2">ƒêang t·∫£i ƒë∆°n h√†ng...</p></div>');
        $("#empty-orders-placeholder").addClass("d-none");
        $("#pagination-links").empty();

        $.ajax({
            url: API_URL,
            method: "GET",
            data: params,
            success: function(response) {
                const orders = response.content;
                const totalPages = response.totalPages;

                $("#orders-list-container").empty();

                if (orders && orders.length > 0) {
                    orders.forEach(function(order) {
                        const orderHtml = createOrderCard(order);
                        $("#orders-list-container").append(orderHtml);
                    });
                    renderPagination(totalPages, page);
                } else {
                    $("#empty-orders-placeholder").removeClass("d-none");
                }
            },
            error: function(xhr) {
                let errorMessage = "L·ªói kh√¥ng x√°c ƒë·ªãnh khi t·∫£i ƒë∆°n h√†ng.";
                if (xhr.status === 401 || xhr.status === 403) {
                    errorMessage = "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ƒë∆°n h√†ng.";
                } else if (xhr.status === 500) {
                    errorMessage = "L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.";
                }

                $("#orders-list-container").html(`
                    <div class="text-center p-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">${errorMessage}</p>
                    </div>
                `);
                console.error("L·ªói API:", xhr.responseText);
            }
        });
    }

    /**
     * üî• H√ÄM T·∫†O GIAO DI·ªÜN CARD ƒê∆†N H√ÄNG M·ªöI (C√ì CH·ª®C NƒÇNG XEM TH√äM/THU G·ªåN)
     */
    function createOrderCard(order) {
        const statusInfo = STATUS_MAP[order.trangThai] || { text: "Kh√¥ng r√µ", class: "status-cancelled" };
        const salesTypeInfo = SALES_TYPE_MAP[order.hinhThucBanHang] || SALES_TYPE_MAP.default;

        // ƒê·ªãnh d·∫°ng ng√†y gi·ªù
        const ngayTao = new Date(order.ngayTao).toLocaleString('vi-VN', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });

        const totalItems = order.hoaDonChiTiets ? order.hoaDonChiTiets.length : 0;
        let itemsHtml = '';

        if (order.hoaDonChiTiets && totalItems > 0) {
            order.hoaDonChiTiets.forEach((item, index) => {
                const spct = item.sanPhamChiTiet;
                const sanPham = spct && spct.sanPham;

                const tenSanPham = sanPham ? sanPham.tenSanPham : "S·∫£n ph·∫©m kh√¥ng r√µ";
                const tenKichThuoc = spct && spct.kichThuoc ? spct.kichThuoc.tenKichThuoc : "N/A";
                const tenMauSac = spct && spct.mauSac ? spct.mauSac.tenMauSac : "N/A";
                const soLuong = item.soLuong;
                const imageUrl = spct && spct.anhSanPham ? spct.anhSanPham : "https://via.placeholder.com/40";

                // Th√™m class 'collapsed-item' cho c√°c s·∫£n ph·∫©m t·ª´ v·ªã tr√≠ 1 tr·ªü ƒëi (index > 0)
                const itemClass = index > 0 ? ' collapsed-item' : '';

                itemsHtml += `
                    <div class="product-item${itemClass}">
                        <img src="${imageUrl}" alt="${tenSanPham}" class="product-image">
                        <div class="product-info">
                            <div class="product-name">${tenSanPham}</div>
                            <div class="product-details">
                                ${tenMauSac} / ${tenKichThuoc} &bull; SL: ${soLuong}
                            </div>
                        </div>
                        <div class="product-qty-price">
                            <strong>${formatCurrency(item.thanhTien)}</strong>
                        </div>
                    </div>
                `;
            });
        } else {
            itemsHtml = '<p class="text-muted p-3" style="font-size: 0.9rem;">ƒê∆°n h√†ng kh√¥ng c√≥ s·∫£n ph·∫©m chi ti·∫øt.</p>';
        }

        // T·∫°o n√∫t Xem th√™m/Thu g·ªçn n·∫øu c√≥ nhi·ªÅu h∆°n 1 s·∫£n ph·∫©m
        let toggleButtonHtml = '';
        if (totalItems > 1) {
            toggleButtonHtml = `
                <button class="btn-toggle-items" data-toggle="collapsed">
                    <i class="fas fa-chevron-down me-1"></i> Xem th√™m ${totalItems - 1} s·∫£n ph·∫©m
                </button>
            `;
        }

        const tongTienSauGiam = order.tongTienSauGiam || order.tongTien;
        const tienGiamGia = order.tienGiamGia || 0;
        const tongTien = order.tongTien || 0;

        return `
            <div class="order-card" data-order-id="${order.id}">
                <div class="order-card-header">
                    <div class="order-info-group">
                        <span class="sale-type-badge ${salesTypeInfo.class}">${salesTypeInfo.text}</span>
                        <span class="order-id">M√£ ƒë∆°n: ${order.maHoaDon}</span>
                    </div>
                    <span class="order-status ${statusInfo.class}">${statusInfo.text}</span>
                </div>

                <div class="order-card-body p-3">

                    <div class="d-flex justify-content-between text-muted pb-2 mb-2" style="border-bottom: 1px dotted #dee2e6; font-size: 0.85rem;">
                        <span>Ng√†y t·∫°o: ${ngayTao}</span>
                        <span>Gi·∫£m gi√°: <strong class="text-success">${formatCurrency(tienGiamGia)}</strong></span>
                    </div>

                    <div class="product-list-container" id="items-${order.id}">
                        ${itemsHtml}
                    </div>

                    ${toggleButtonHtml}

                </div>

                <div class="order-card-footer d-flex justify-content-end align-items-center">
                    <div class="text-end">
                        <div class="total-amount">
                            Th√†nh ti·ªÅn: <span>${formatCurrency(tongTienSauGiam)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * H√†m x·ª≠ l√Ω logic Xem th√™m/Thu g·ªçn
     */
    $(document).on('click', '.btn-toggle-items', function() {
        const $button = $(this);
        const $card = $button.closest('.order-card');
        const $container = $card.find('.product-list-container');
        const totalItems = $container.find('.product-item').length;
        const isCollapsed = $button.attr('data-toggle') === 'collapsed';

        if (isCollapsed) {
            // Xem th√™m (Expand)
            $container.addClass('expanded');
            $button.attr('data-toggle', 'expanded');
            $button.html('<i class="fas fa-chevron-up me-1"></i> Thu g·ªçn');
        } else {
            // Thu g·ªçn (Collapse)
            $container.removeClass('expanded');
            $button.attr('data-toggle', 'collapsed');
            $button.html(`<i class="fas fa-chevron-down me-1"></i> Xem th√™m ${totalItems - 1} s·∫£n ph·∫©m`);
        }
    });


    /**
     * H√†m t·∫°o giao di·ªán Ph√¢n trang (Gi·ªØ nguy√™n)
     */
    function renderPagination(totalPages, currentPage) {
        const ul = $("#pagination-links");
        ul.empty();

        if (totalPages <= 1) return;

        const createPaginationItem = (text, pageIndex, isActive) => {
            let classes = 'page-item';
            if (isActive) classes += ' active';
            if (pageIndex < 0 || pageIndex >= totalPages) classes += ' disabled';

            return `
                <li class="${classes}">
                    <a class="page-link" href="#" data-page="${pageIndex}">${text}</a>
                </li>
            `;
        };

        ul.append(createPaginationItem('<i class="fas fa-chevron-left"></i>', currentPage - 1, currentPage === 0));

        let startPage = Math.max(0, currentPage - 2);
        let endPage = Math.min(totalPages - 1, currentPage + 2);

        if (currentPage < 2) endPage = Math.min(totalPages - 1, 4);
        if (currentPage > totalPages - 3) startPage = Math.max(0, totalPages - 5);

        for (let i = startPage; i <= endPage; i++) {
            ul.append(createPaginationItem(i + 1, i, i === currentPage));
        }

        ul.append(createPaginationItem('<i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages - 1));

        ul.find('li:not(.disabled) a').on('click', function(e) {
            e.preventDefault();
            const newPage = $(this).data('page');
            if (newPage !== undefined) {
                fetchOrders(currentStatus, newPage);
                $('html, body').animate({ scrollTop: $(".main-content-panel").offset().top - 20 }, 'slow');
            }
        });
    }

    // =======================================================
    // X·ª≠ l√Ω s·ª± ki·ªán khi t√†i li·ªáu ƒë√£ t·∫£i xong
    // =======================================================
    $(document).ready(function() {

        // X·ª≠ l√Ω s·ª± ki·ªán TAB click
        $("#orderTabs button").on('click', function() {
            $("#orderTabs button").removeClass('active');
            $(this).addClass('active');

            const statusString = $(this).data('status');
            const statusValue = statusString === "" ? null : parseInt(statusString);

            fetchOrders(statusValue, 0);
        });

        // T·∫£i ƒë∆°n h√†ng ban ƒë·∫ßu khi trang v·ª´a load (T·∫•t c·∫£, trang 0)
        fetchOrders(null, 0);
    });
    /*]]>*/
</script>
</body>
</html>