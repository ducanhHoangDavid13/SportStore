<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:fragment="head-links">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"/>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
    </div>
    <title>Đơn hàng của tôi</title>
</head>
<style>
    /* CSS CƠ BẢN */
    .account-page-wrapper { background-color: #f8f9fa; padding: 30px 0; }
    .main-content-panel { background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 3px 15px rgba(0,0,0,0.05); }

    /* TABLIST */
    .order-status-tabs {
        border-bottom: 2px solid #dee2e6;
        overflow-x: auto;
        white-space: nowrap;
        display: flex;
        flex-wrap: nowrap;
    }
    .order-status-tabs .nav-link { border: none; color: #495057; padding: 10px 0; margin: 0 15px; font-weight: 500; position: relative; background-color: transparent !important; cursor: pointer; }
    .order-status-tabs .nav-link.active { color: #e5101d; font-weight: 700; }
    .order-status-tabs .nav-link::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 3px; background-color: #e5101d; transition: width 0.3s ease; }
    .order-status-tabs .nav-link.active::after, .order-status-tabs .nav-link:hover::after { width: 100%; }

    /* CARD ĐƠN HÀNG */
    .order-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    .order-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); }

    .order-card-header {
        padding: 10px 15px;
        background-color: #f1f3f5;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
    }

    .order-info-group { display: flex; align-items: center; }

    .sale-type-badge { font-size: 0.7rem; padding: 1px 6px; border-radius: 4px; font-weight: 600; margin-right: 10px; }
    .sale-type-online { color: #007bff; background-color: rgba(0, 123, 255, 0.1); border: 1px solid #007bff; }
    .sale-type-store { color: #28a745; background-color: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; }

    .order-status { font-weight: 700; padding: 3px 8px; border-radius: 50px; font-size: 0.75rem; }
    /* Màu sắc trạng thái */
    .status-processing { color: #ffc107; background-color: #fff3cd; }
    .status-shipping { color: #17a2b8; background-color: #d1ecf1; }
    .status-completed { color: #28a745; background-color: #d4edda; }
    .status-cancelled { color: #dc3545; background-color: #f8d7da; }

    /* SẢN PHẨM */
    .product-item {
        display: flex; align-items: center; padding: 8px 0; margin-bottom: 5px;
        border-bottom: 1px dashed #eee; font-size: 0.85rem;
    }
    .product-item:last-of-type { border-bottom: none !important; }

    .product-image { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; margin-right: 10px; }
    .product-info { flex-grow: 1; }
    .product-info .product-name { font-weight: 600; color: #333; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
    .product-info .product-details { font-size: 0.75rem; color: #6c757d; }
    .product-item .product-qty-price { width: 150px; text-align: right; }
    .product-item .product-qty-price strong { color: #e5101d; font-size: 0.95rem; }

    /* FOOTER */
    .order-card-footer {
        padding: 10px 15px; background-color: #f8f9fa; border-top: 1px solid #dee2e6;
        display: flex; justify-content: space-between; align-items: center;
    }
    .total-amount { font-size: 1rem; font-weight: 700; }
    .total-amount span { color: #e5101d; }
    .btn-toggle-items { padding: 5px 10px; font-size: 0.8rem; color: #007bff; background-color: transparent; border: none; cursor: pointer; }
    .btn-toggle-items:hover { text-decoration: underline; }

    /* RÚT GỌN */
    .collapsed-item { display: none; }
    .expanded .collapsed-item { display: flex; }
    .product-list-container { padding-bottom: 5px; margin-bottom: 5px; }
</style>

<body>
<header th:replace="~{library/header :: header}"></header>

<div class="account-page-wrapper">
    <div class="container" style="max-width: 1200px;">
        <div class="row">
            <div class="col-lg-3">
                <div th:replace="~{/library/hosoUser :: account-sidebar(activePage='orders')}"></div>
            </div>

            <div class="col-lg-9">
                <div class="main-content-panel">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold mb-2 mb-md-0">Đơn Hàng Của Tôi</h3>
                    </div>

                    <ul class="nav order-status-tabs mb-3" id="orderTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-status="">Tất cả</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="0">Chờ xác nhận</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="1">Đã xác nhận</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="2">Đang chuẩn bị</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="3">Đang giao</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="4">Hoàn thành</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="5,7">Đã hủy</button></li>
                    </ul>

                    <div class="tab-content" id="orderTabsContent">
                        <div class="tab-pane fade show active" id="orders-list-container"></div>
                    </div>

                    <nav aria-label="Order pagination" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination-links"></ul>
                    </nav>

                    <div class="empty-orders-placeholder d-none" id="empty-orders-placeholder" style="text-align: center; padding: 40px 0;">
                        <img th:src="@{/image/empty-box.png}" alt="Empty Box" style="width: 100px; opacity: 0.6;">
                        <h5 class="mt-4 mb-3 fw-bold">Bạn chưa có đơn hàng nào</h5>
                        <a th:href="@{/san-pham}" class="btn btn-danger btn-discover-now mt-3">
                            <i class="fas fa-shopping-bag me-2"></i> Mua sắm ngay
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{/library/footer :: footer}"></footer>
<div th:replace="~{/library/footer :: scripts}"></div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const API_URL = "/api/don-hang-cua-toi";
    const API_UPDATE_STATUS_URL = "/api/don-hang-cua-toi/cap-nhat-trang-thai";
    const API_IMAGE_URL = "/api/hinh-anh/all";
    const PAGE_SIZE = 10;

    const STATUS_MAP = {
        0: { text: "Chờ xác nhận", class: "status-processing" },
        1: { text: "Đã xác nhận", class: "status-processing" },
        2: { text: "Đang chuẩn bị", class: "status-processing" },
        3: { text: "Đang giao", class: "status-shipping" },
        4: { text: "Hoàn thành", class: "status-completed" },
        5: { text: "Đã hủy", class: "status-cancelled" },
        7: { text: "Đã hủy/Hoàn", class: "status-cancelled" } // Thêm trạng thái 7
    };

    const SALES_TYPE_MAP = {
        0: { text: "Online", class: "sale-type-online" },
        1: { text: "Tại quầy", class: "sale-type-store" },
        default: { text: "Không rõ", class: "sale-type-cancelled" }
    };

    let currentStatus = null;
    let currentPage = 0;
    let productImagesMap = {};

    const formatCurrency = (amount) => {
        const value = amount !== null && amount !== undefined ? amount : 0;
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    };

    function loadAllImagesAndMap() {
        return new Promise((resolve) => {
            $.ajax({
                url: API_IMAGE_URL,
                method: 'GET',
                success: function(response) {
                    const images = response.content || response;
                    productImagesMap = {};
                    if (Array.isArray(images)) {
                        images.forEach(image => {
                            const productId = image.sanPham?.id;
                            const tenHinhAnh = image.tenHinhAnh;
                            if (productId && tenHinhAnh && !productImagesMap[productId]) {
                                productImagesMap[productId] = tenHinhAnh;
                            }
                        });
                    }
                    resolve();
                },
                error: (xhr) => { console.error("Lỗi tải API ảnh:", xhr); resolve(); }
            });
        });
    }

    function fetchOrders(status, page) {
        currentStatus = status;
        currentPage = page;

        const params = { page: page, size: PAGE_SIZE };
        // status lúc này có thể là null, số (0,1,2,3,4) hoặc chuỗi ("5,7")
        if (status !== null && status !== "") params.trangThai = status;

        $("#orders-list-container").html('<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-danger"></i><p class="mt-2">Đang tải đơn hàng...</p></div>');
        $("#empty-orders-placeholder").addClass("d-none");
        $("#pagination-links").empty();

        $.ajax({
            url: API_URL,
            method: "GET",
            data: params,
            success: function(response) {
                const orders = response.content;
                const totalPages = response.totalPages;
                $("#orders-list-container").empty();

                if (orders && orders.length > 0) {
                    orders.forEach(order => {
                        $("#orders-list-container").append(createOrderCard(order));
                    });
                    renderPagination(totalPages, page);
                } else {
                    $("#empty-orders-placeholder").removeClass("d-none");
                }
            },
            error: function(xhr) {
                $("#orders-list-container").html('<div class="text-center text-danger p-5">Lỗi tải dữ liệu.</div>');
            }
        });
    }

    function createOrderCard(order) {
        const statusInfo = STATUS_MAP[order.trangThai] || { text: "Không rõ", class: "status-cancelled" };
        const salesTypeInfo = SALES_TYPE_MAP[order.hinhThucBanHang] || SALES_TYPE_MAP.default;

        const totalItems = order.hoaDonChiTiets ? order.hoaDonChiTiets.length : 0;
        let itemsHtml = '';

        if (order.hoaDonChiTiets && totalItems > 0) {
            order.hoaDonChiTiets.forEach((item, index) => {
                const spct = item.sanPhamChiTiet || {};
                const sanPham = spct.sanPham || {};
                let imageUrl = 'https://via.placeholder.com/40';
                if (sanPham.id && productImagesMap[sanPham.id]) {
                    imageUrl = '/image/' + productImagesMap[sanPham.id];
                }
                const itemClass = index > 0 ? ' collapsed-item' : '';
                itemsHtml += `
                    <div class="product-item${itemClass}">
                        <img src="${imageUrl}" alt="Product" class="product-image" onerror="this.onerror=null;this.src='https://via.placeholder.com/40';">
                        <div class="product-info">
                            <div class="product-name">${sanPham.tenSanPham || 'Sản phẩm'}</div>
                            <div class="product-details">${spct.mauSac?.tenMauSac || '-'} / ${spct.kichThuoc?.tenKichThuoc || '-'} &bull; SL: ${item.soLuong}</div>
                        </div>
                        <div class="product-qty-price"><strong>${formatCurrency(item.thanhTien)}</strong></div>
                    </div>`;
            });
        }

        let toggleButtonHtml = totalItems > 1 ?
            `<button class="btn-toggle-items" data-toggle="collapsed"><i class="fas fa-chevron-down me-1"></i> Xem thêm ${totalItems - 1} sản phẩm</button>` : '';

        let actionButtonHtml = '';
        if (order.trangThai === 0) {
            actionButtonHtml = `<button class="btn btn-outline-secondary btn-sm btn-action-trigger" data-order-id="${order.id}" data-new-status="5" data-action-text="Hủy"><i class="fas fa-times me-1"></i> Hủy đơn hàng</button>`;
        } else if (order.trangThai === 3) {
            actionButtonHtml = `<button class="btn btn-danger btn-sm btn-action-trigger" data-order-id="${order.id}" data-new-status="4" data-action-text="Xác nhận đã nhận"><i class="fas fa-check me-1"></i> Đã nhận được hàng</button>`;
        }

        return `
            <div class="order-card">
                <div class="order-card-header">
                    <div class="order-info-group">
                        <span class="sale-type-badge ${salesTypeInfo.class}">${salesTypeInfo.text}</span>
                        <span class="fw-bold">#${order.maHoaDon}</span>
                    </div>
                    <span class="order-status ${statusInfo.class}">${statusInfo.text}</span>
                </div>
                <div class="order-card-body p-3">
                    <div class="d-flex justify-content-between text-muted pb-2 mb-2 border-bottom small">
                        <span>Ngày đặt: ${new Date(order.ngayTao).toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="product-list-container">${itemsHtml}</div>
                    ${toggleButtonHtml}
                </div>
                <div class="order-card-footer">
                    <div>${actionButtonHtml}</div>
                    <div class="text-end total-amount">Thành tiền: <span>${formatCurrency(order.tongTienSauGiam || order.tongTien)}</span></div>
                </div>
            </div>`;
    }

    // --- Hành động Hủy/Nhận hàng (SweetAlert2) ---
    $(document).on('click', '.btn-action-trigger', function() {
        const orderId = $(this).data('order-id');
        const newStatus = $(this).data('new-status');
        const actionText = $(this).data('action-text');
        let title, text, icon, confirmColor, confirmButtonText;

        if (newStatus === 5) {
            title = 'Xác nhận hủy đơn?';
            text = 'Hành động này không thể hoàn tác.';
            icon = 'warning'; confirmColor = '#d33'; confirmButtonText = 'Vâng, Hủy đơn!';
        } else {
            title = 'Bạn đã nhận được hàng?';
            text = 'Hãy xác nhận khi bạn đã nhận sản phẩm.';
            icon = 'question'; confirmColor = '#28a745'; confirmButtonText = 'Đúng, Tôi đã nhận';
        }

        Swal.fire({
            title: title, text: text, icon: icon,
            showCancelButton: true, confirmButtonColor: confirmColor,
            cancelButtonColor: '#6c757d', confirmButtonText: confirmButtonText,
            cancelButtonText: 'Đóng', reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `${API_UPDATE_STATUS_URL}/${orderId}`,
                    method: "PUT", contentType: "application/json",
                    data: JSON.stringify(newStatus),
                    success: function() {
                        Swal.fire({ title: 'Thành công!', icon: 'success', timer: 1500, showConfirmButton: false });
                        fetchOrders(currentStatus, currentPage);
                    },
                    error: function(xhr) { Swal.fire('Thất bại', xhr.responseJSON?.message || 'Lỗi', 'error'); }
                });
            }
        });
    });

    $(document).on('click', '.btn-toggle-items', function() {
        const $btn = $(this);
        const $container = $btn.closest('.order-card').find('.product-list-container');
        if ($btn.attr('data-toggle') === 'collapsed') {
            $container.addClass('expanded');
            $btn.attr('data-toggle', 'expanded').html('<i class="fas fa-chevron-up me-1"></i> Thu gọn');
        } else {
            $container.removeClass('expanded');
            $btn.attr('data-toggle', 'collapsed').html(`<i class="fas fa-chevron-down me-1"></i> Xem thêm ${$container.find('.product-item').length - 1} sản phẩm`);
        }
    });

    function renderPagination(totalPages, currentPage) {
        const ul = $("#pagination-links"); ul.empty();
        if (totalPages <= 1) return;
        const createItem = (text, page, isActive) => `<li class="page-item ${isActive ? 'active' : ''}"><a class="page-link" href="#" data-page="${page}">${text}</a></li>`;
        ul.append(createItem('«', Math.max(0, currentPage - 1), false));
        for (let i = 0; i < totalPages; i++) {
            if (i >= currentPage - 2 && i <= currentPage + 2) ul.append(createItem(i + 1, i, i === currentPage));
        }
        ul.append(createItem('»', Math.min(totalPages - 1, currentPage + 1), false));
        ul.find('a').click(function(e) {
            e.preventDefault();
            fetchOrders(currentStatus, $(this).data('page'));
        });
    }

    $(document).ready(function() {
        loadAllImagesAndMap().then(() => {
            $("#orderTabs button").click(function() {
                $("#orderTabs button").removeClass('active');
                $(this).addClass('active');

                // Lấy giá trị status (ví dụ: "", "0", "5,7")
                const st = $(this).data('status');

                // Cập nhật: Truyền thẳng giá trị chuỗi, không dùng parseInt
                fetchOrders(st === "" ? null : st, 0);
            });
            fetchOrders(null, 0);
        });
    });
    /*]]>*/
</script>
</body>
</html>