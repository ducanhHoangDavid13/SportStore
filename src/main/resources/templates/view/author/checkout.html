<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán - SPORTX</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <style>
        :root {
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Oswald', sans-serif;
            --primary: #0b72ff;
            --primary-dark: #0056c7;
            --dark: #111111;
            --light-bg: #f4f7f6;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow-card: 0 10px 30px rgba(0,0,0,0.06);
        }
        body { font-family: var(--font-main); background-color: var(--light-bg); color: var(--dark); }
        .checkout-wrapper { max-width: 1300px; margin: 40px auto 80px; padding: 0 20px; }
        .checkout-grid { display: grid; grid-template-columns: 7fr 5fr; gap: 30px; }
        .checkout-card { background: #fff; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow-card); border: 1px solid #fff; }
        .section-header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .section-title { font-family: var(--font-heading); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; }
        .form-label { font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; display: block; color: #333; }
        .form-control, .form-select { padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.95rem; background: #fbfbfc; transition: 0.2s; }
        .form-control:focus, .form-select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(11, 114, 255, 0.1); outline: none; }
        .summary-card { position: sticky; top: 100px; background: #fff; }
        .order-list { max-height: 350px; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
        .order-list::-webkit-scrollbar { width: 4px; }
        .order-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .order-item { display: flex; gap: 15px; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed var(--border); }
        .item-img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 0.95rem; line-height: 1.3; margin-bottom: 4px; display: block; color: var(--dark); }
        .item-meta { font-size: 0.85rem; color: #64748b; }
        .item-price { font-weight: 700; color: var(--primary); font-size: 0.95rem; text-align: right; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #555; }
        .total-final { font-size: 1.1rem; font-weight: 700; color: var(--dark); border-top: 2px dashed var(--border); padding-top: 20px; margin-top: 15px; align-items: center; display: flex; justify-content: space-between; }
        .total-final span:last-child { color: var(--primary); font-size: 1.5rem; font-family: var(--font-heading); }
        .payment-methods { margin-top: 25px; }
        .payment-option { border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; display: block; position: relative; background: #fff; }
        .payment-option:hover { border-color: var(--primary); background: #f0f7ff; }
        .payment-header { display: flex; align-items: center; gap: 12px; }
        .btn-checkout { width: 100%; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 700; text-transform: uppercase; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(11, 114, 255, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-checkout:hover { background: var(--primary-dark); transform: translateY(-3px); color: #fff; }
        .btn-checkout:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-remove-item { border: none; background: #fff; color: #ef4444; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-remove-item:hover { background-color: #fee2e2; transform: scale(1.1); }
        @media (max-width: 991px) { .checkout-grid { grid-template-columns: 1fr; } .summary-card { position: static; } }
    </style>
</head>
<body>

<header th:replace="~{library/header :: header}"></header>

<main class="checkout-wrapper">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb" style="background: transparent; padding: 0;">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
            <li class="breadcrumb-item active text-dark fw-bold" aria-current="page">THANH TOÁN</li>
        </ol>
    </nav>

    <form id="checkoutForm">
        <div class="checkout-grid">
            <div class="checkout-card">
                <div class="section-header">
                    <i class="fa-regular fa-address-card section-icon"></i>
                    <h2 class="section-title">THÔNG TIN GIAO HÀNG</h2>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fullName" placeholder="Nhập họ tên người nhận" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="phone" placeholder="Ví dụ: 0912345678" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Email (Nhận thông báo đơn hàng)</label>
                        <input type="email" class="form-control" id="email" placeholder="email@example.com">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tỉnh / Thành phố <span class="text-danger">*</span></label>
                        <select class="form-select" id="city" required><option value="" selected>Chọn Tỉnh/Thành</option></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Quận / Huyện <span class="text-danger">*</span></label>
                        <select class="form-select" id="district" required disabled><option value="" selected>Chọn Quận/Huyện</option></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Phường / Xã <span class="text-danger">*</span></label>
                        <select class="form-select" id="ward" required disabled><option value="" selected>Chọn Phường/Xã</option></select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Địa chỉ cụ thể <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addressDetail" placeholder="Số nhà, ngõ, tên đường..." required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Ghi chú đơn hàng (Tùy chọn)</label>
                        <textarea class="form-control" rows="3" id="note" placeholder="Ví dụ: Giao hàng giờ hành chính..."></textarea>
                    </div>
                </div>
            </div>

            <div class="checkout-card summary-card">
                <div class="section-header">
                    <i class="fa-solid fa-bag-shopping section-icon"></i>
                    <h2 class="section-title">ĐƠN HÀNG</h2>
                </div>

                <div class="order-list" id="cartItemsList">
                    <p class="text-center text-muted py-3 small">Đang tải giỏ hàng...</p>
                    <div id="checkoutCart"></div>
                    <h4 class="mt-3">Tổng: <span id="checkoutTotal">0</span>₫</h4>

                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">MÃ GIẢM GIÁ</label>
                    <select class="form-select" id="voucherSelect" >
                        <option value="" selected>-- Chọn mã giảm giá --</option>
                    </select>
                </div>

                <div class="total-row"><span>Tạm tính</span><span id="subTotal" class="fw-bold">0₫</span></div>
                <div class="total-row"><span>Phí vận chuyển</span><span id="shippingFee" class="fw-bold">30.000₫</span></div>
                <div class="total-row text-success"><span>Giảm giá</span><span id="discountAmount" class="fw-bold">-0₫</span></div>
                <div class="total-final"><span>TỔNG CỘNG</span><span id="finalTotal">0₫</span></div>

                <div class="payment-methods">
                    <h6 class="mb-3 text-uppercase fw-bold text-secondary" style="font-size: 0.85rem;">Phương thức thanh toán</h6>
                    <label class="payment-option">
                        <div class="payment-header">
                            <input type="radio" name="paymentMethod" value="COD" class="payment-radio" checked>
                            <span class="payment-label ms-2">Thanh toán khi nhận hàng (COD)</span>
                            <i class="fa-solid fa-money-bill-wave ms-auto text-secondary"></i>
                        </div>
                    </label>
                    <label class="payment-option">
                        <div class="payment-header">
                            <input type="radio" name="paymentMethod" value="VNPAY" class="payment-radio">
                            <span class="payment-label ms-2">Ví VNPAY / Thẻ ATM</span>
                            <i class="fa-solid fa-qrcode ms-auto text-primary"></i>
                        </div>
                    </label>
                </div>

                <button type="button" class="btn-checkout" id="btnPlaceOrder">
                    ĐẶT HÀNG NGAY <i class="fa-solid fa-arrow-right"></i>
                </button>
                <p class="text-center mt-3 small text-muted"><i class="fa-solid fa-shield-halved"></i> Thông tin được bảo mật an toàn</p>
            </div>
        </div>
    </form>
</main>

<footer th:replace="~{library/footer :: footer}"></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    ///dia chi
    // =========================================================================
    // 2. XỬ LÝ ĐỊA CHỈ (SỬ DỤNG API CŨ VÀ THÊM BẮT LỖI ASYNC/AWAIT)
    //    - Đảm bảo các thẻ <select> trong HTML của bạn có id là 'city', 'district', 'ward'.
    //    - Cần có thư viện Toastr để hiển thị thông báo lỗi.
    // =========================================================================

    // Khai báo lại API đã chạy được (esgoo.net)
    const API_TINH = "https://esgoo.net/api-tinhthanh/1/0.htm";
    const API_HUYEN = "https://esgoo.net/api-tinhthanh/2/"; // Cần thêm {id_tinh}.htm
    const API_XA = "https://esgoo.net/api-tinhthanh/3/"; // Cần thêm {id_huyen}.htm

    /**
     * Hàm fetch chung để tải dữ liệu từ API esgoo.net
     * Có xử lý lỗi mạng/CORS và lỗi logic từ API (error !== 0).
     * @param {string} endpoint - URL đầy đủ hoặc phần còn lại của URL.
     * @returns {Promise<Array|null>} Mảng dữ liệu địa chỉ hoặc null nếu có lỗi.
     */
    async function fetchEsgooData(endpoint) {
        const fullUrl = endpoint;
        try {
            const response = await fetch(fullUrl);

            // 1. Kiểm tra lỗi HTTP (404, 500, v.v.)
            if (!response.ok) {
                console.error(`Lỗi HTTP ${response.status} khi tải địa chỉ.`);
                // Thông báo lỗi chung, có thể là lỗi mạng hoặc lỗi server
                throw new Error("Lỗi Server: " + response.status);
            }

            const data = await response.json();

            // 2. Kiểm tra lỗi logic của API Esgoo (data.error === 0 là thành công)
            if (data.error !== 0) {
                console.error(`API Esgoo trả về lỗi: ${data.error} - ${data.message}`);
                throw new Error(data.message || "Lỗi dữ liệu từ API.");
            }

            return data.data; // Trả về mảng dữ liệu (là trường 'data' trong response)
        } catch (e) {
            console.error("LỖI KẾT NỐI/CORS khi tải địa chỉ:", e);
            // Hiển thị thông báo lỗi cho người dùng
            if (typeof toastr !== 'undefined') {
                toastr.error("Không thể tải dữ liệu địa chỉ. Vui lòng kiểm tra console log.");
            }
            return null; // Trả về null nếu có lỗi
        }
    }

    /**
     * Khởi tạo và xử lý logic Tỉnh/Thành, Quận/Huyện, Phường/Xã
     */
    function loadAddressData() {
        const citySelect = document.getElementById('city');
        const distSelect = document.getElementById('district');
        const wardSelect = document.getElementById('ward');

        if (!citySelect || !distSelect || !wardSelect) {
            console.error("Không tìm thấy đủ các thẻ select (city, district, ward) trong DOM.");
            return;
        }

        // Tải Tỉnh/Thành phố khi trang load
        fetchEsgooData(API_TINH)
            .then(data => {
                if (!data) return; // Dừng nếu có lỗi và đã hiển thị toastr

                let html = '<option value="" selected>Chọn Tỉnh/Thành</option>';
                // API này trả về mảng các đối tượng {id, full_name}
                data.forEach(tinh => html += `<option value="${tinh.id}" data-name="${tinh.full_name}">${tinh.full_name}</option>`);
                citySelect.innerHTML = html;
            });

        // Lắng nghe sự kiện thay đổi Tỉnh/Thành
        citySelect.addEventListener('change', function () {
            const idTinh = this.value;

            // 1. Reset các ô dưới và thiết lập trạng thái loading
            distSelect.innerHTML = '<option value="" selected>Đang tải...</option>';
            wardSelect.innerHTML = '<option value="" selected>Chọn Phường/Xã</option>';
            distSelect.disabled = true;
            wardSelect.disabled = true;

            if (idTinh) {
                // 2. Tải Quận/Huyện: /api-tinhthanh/2/{id}.htm
                fetchEsgooData(API_HUYEN + idTinh + ".htm")
                    .then(data => {
                        if (!data) return;

                        let html = '<option value="" selected>Chọn Quận/Huyện</option>';
                        // API này trả về mảng các đối tượng {id, full_name}
                        data.forEach(h => html += `<option value="${h.id}" data-name="${h.full_name}">${h.full_name}</option>`);
                        distSelect.innerHTML = html;
                        distSelect.disabled = false; // Mở khóa Quận/Huyện
                    });
            } else {
                // Nếu không chọn tỉnh nào (chọn lại 'Chọn Tỉnh/Thành')
                distSelect.innerHTML = '<option value="" selected>Chọn Quận/Huyện</option>';
            }
        });

        // Lắng nghe sự kiện thay đổi Quận/Huyện
        distSelect.addEventListener('change', function () {
            const idHuyen = this.value;

            // 1. Reset ô Phường/Xã và thiết lập trạng thái loading
            wardSelect.innerHTML = '<option value="" selected>Đang tải...</option>';
            wardSelect.disabled = true;

            if (idHuyen) {
                // 2. Tải Phường/Xã: /api-tinhthanh/3/{id}.htm
                fetchEsgooData(API_XA + idHuyen + ".htm")
                    .then(data => {
                        if (!data) return;

                        let html = '<option value="" selected>Chọn Phường/Xã</option>';
                        // API này trả về mảng các đối tượng {id, full_name}
                        data.forEach(x => html += `<option value="${x.id}" data-name="${x.full_name}">${x.full_name}</option>`);
                        wardSelect.innerHTML = html;
                        wardSelect.disabled = false; // Mở khóa Phường/Xã
                    });
            } else {
                // Nếu không chọn huyện nào
                wardSelect.innerHTML = '<option value="" selected>Chọn Phường/Xã</option>';
            }
        });
    }

    // Gọi hàm khởi tạo khi DOM đã sẵn sàng
    document.addEventListener('DOMContentLoaded', loadAddressData);
    // Đường dẫn hình ảnh tĩnh của bạn (ví dụ: resources/static/images)
    const IMAGE_BASE_URL = "/image/";
    const SHIPPING_FEE = 30000; // Phí vận chuyển cố định

    // Hàm gọi API và load giỏ hàng
    async function loadCart() {
        let res;
        try {
            // Thử API JSON đã xác nhận hoạt động (đặt cái này lên đầu)
            res = await fetch("/api/cart");
        } catch (e) {
            // Fallback nếu API /api/cart lỗi
            try {
                res = await fetch("/cart/api/view");
            } catch (e2) {
                console.error("Lỗi: Không thể kết nối đến bất kỳ API giỏ hàng nào.");
                renderCart([]); // Hiển thị giỏ hàng trống
                return;
            }
        }

        if (!res.ok) {
            console.error(`Lỗi API giỏ hàng: Status ${res.status}`);
            renderCart([]);
            return;
        }

        const cart = await res.json();
        renderCart(cart);
    }

    // Hàm hiển thị giỏ hàng
    function renderCart(cart) {
        const div = document.getElementById("cartItemsList");
        const subTotalElement = document.getElementById("subTotal");
        const finalTotalElement = document.getElementById("finalTotal");

        if (!cart || cart.length === 0) {
            div.innerHTML = "<p class='text-center text-muted'>Giỏ hàng đang trống.</p>";
            subTotalElement.innerText = "0₫";
            finalTotalElement.innerText = SHIPPING_FEE.toLocaleString('vi-VN') + "₫"; // Vẫn hiển thị phí vận chuyển nếu có
            document.getElementById("btnPlaceOrder").disabled = true;
            return;
        }

        let subTotal = 0; // Tạm tính (trước phí ship)
        let html = "";
        let totalItems = 0;
        let finalAmount;

        cart.forEach(item => {
            // ⭐ SỬ DỤNG TÊN TRƯỜNG ĐÚNG TỪ GioHangDTO ⭐
            const quantity = Number(item.soLuong) || 0;
            const price = Number(item.donGia) || 0;
            const sum = price * quantity;

            subTotal += sum;
            totalItems += quantity;

            // Lấy tên hình ảnh (đảm bảo không bị null)
            const imageName = item.tenHinhAnh || "placeholder.png";

            // Lấy tên/màu/size để hiển thị chi tiết
            const itemMeta = `Màu: ${item.tenMau || 'N/A'}, Size: ${item.tenKichCo || 'N/A'}`;

            html += `
                <div class="order-item">
                    <img src="${IMAGE_BASE_URL}${imageName}" alt="${item.tenSanPham}" class="item-img">
                    <div class="item-info">
                        <span class="item-name">${item.tenSanPham || 'Sản phẩm không tên'}</span>
                        <span class="item-meta">SL: ${quantity} - ${itemMeta}</span>
                    </div>
                    <div class="item-price">${sum.toLocaleString('vi-VN')}₫</div>
                </div>
            `;
        });

        // Cập nhật DOM
        div.innerHTML = html;

        // Tính tổng cuối cùng (chưa tính mã giảm giá)
        // Giả sử: Giảm giá mặc định là 0
        const discount = Number(document.getElementById("discountAmount").innerText.replace(/[^0-9]/g, '')) || 0;
        finalAmount = subTotal + SHIPPING_FEE - discount;

        // Cập nhật các trường tổng
        subTotalElement.innerText = subTotal.toLocaleString('vi-VN') + "₫";
        document.getElementById("shippingFee").innerText = SHIPPING_FEE.toLocaleString('vi-VN') + "₫";
        finalTotalElement.innerText = finalAmount.toLocaleString('vi-VN') + "₫";

        // Cập nhật header "ĐƠN HÀNG (tổng số lượng sản phẩm)"
        const orderHeader = document.querySelector('.section-header h2.section-title');
        if (orderHeader) {
            orderHeader.innerText = `ĐƠN HÀNG (${totalItems} SẢN PHẨM)`;
        }

        document.getElementById("btnPlaceOrder").disabled = false;
    }

    loadCart();
//
    // =========================================================================
    // 4. CÁC HÀM TIỆN ÍCH & XỬ LÝ ĐẶT HÀNG (HANDLE CHECKOUT)
    // =========================================================================

    /**
     * HÀM TIỆN ÍCH: Lấy dữ liệu giỏ hàng hiện tại (để gửi lên Server)
     */
    async function getCartData() {
        try {
            // Sử dụng API /api/cart đã được định nghĩa trong loadCart
            const res = await fetch("/api/cart");
            if (res.ok) {
                return await res.json();
            }
            return [];
        } catch (e) {
            console.error("Không thể lấy dữ liệu giỏ hàng để đặt hàng:", e);
            return [];
        }
    }

    /**
     * Hàm tính toán lại tổng tiền cuối cùng (Đơn giản hóa, không dùng Voucher)
     */
    function calculateFinalTotal() {
        // Lấy tạm tính (subTotal) từ DOM
        const subTotalText = document.getElementById("subTotal").innerText.replace(/[^0-9]/g, '');
        const subTotal = Number(subTotalText) || 0;

        // Discount mặc định là 0
        const newDiscount = 0;

        // Tính tổng cuối = Tạm tính + Phí ship
        let finalAmount = subTotal + SHIPPING_FEE - newDiscount;
        if (finalAmount < 0) finalAmount = 0;

        // Cập nhật DOM
        document.getElementById("discountAmount").innerText = `-0₫`;
        document.getElementById("finalTotal").innerText = finalAmount.toLocaleString('vi-VN') + "₫";

        // Bật/tắt nút Đặt hàng: chỉ bật khi SubTotal > 0
        const btn = document.getElementById("btnPlaceOrder");
        btn.disabled = (subTotal <= 0);
    }

    // Gọi hàm tính toán lại tổng tiền sau khi giỏ hàng được load
    calculateFinalTotal();

    /**
     * Xử lý sự kiện khi nhấn nút Đặt hàng.
     */
    async function handleCheckout() {
        // 1. Lấy & trim dữ liệu
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const addressDetail = document.getElementById('addressDetail').value.trim();
        const citySelect = document.getElementById('city');
        const distSelect = document.getElementById('district');
        const wardSelect = document.getElementById('ward');
        const note = document.getElementById('note').value.trim();
        const paymentMethod = (document.querySelector('input[name="paymentMethod"]:checked') || {}).value || 'COD';

        const cityName = citySelect && citySelect.options[citySelect.selectedIndex]?.getAttribute('data-name') || '';
        const districtName = distSelect && distSelect.options[distSelect.selectedIndex]?.getAttribute('data-name') || '';
        const wardName = wardSelect && wardSelect.options[wardSelect.selectedIndex]?.getAttribute('data-name') || '';

        // 2. Front-end validation (bảo đảm các field bắt buộc phù hợp entity DiaChi)
        let missing = [];
        if (!fullName) missing.push('Họ tên');
        if (!phone) missing.push('Số điện thoại');
        if (!addressDetail) missing.push('Địa chỉ cụ thể');
        if (!wardSelect || !wardSelect.value) missing.push('Phường/Xã');
        if (!citySelect || !citySelect.value) missing.push('Tỉnh/Thành');

        if (missing.length) {
            toastr.error('Thiếu thông tin: ' + missing.join(', '));
            console.warn('Validation failed on client. Missing:', missing);
            return;
        }

        // 3. Lấy giỏ hàng hiện tại (từ /api/cart)
        let currentCart = [];
        try {
            const resCart = await fetch('/api/cart');
            if (resCart.ok) currentCart = await resCart.json();
            else {
                toastr.error('Không thể lấy giỏ hàng từ server.');
                console.error('GET /api/cart failed status=', resCart.status);
                return;
            }
        } catch (e) {
            toastr.error('Lỗi mạng khi lấy giỏ hàng.');
            console.error('GET /api/cart error', e);
            return;
        }

        if (!currentCart || currentCart.length === 0) {
            toastr.error('Giỏ hàng trống!');
            return;
        }

        // 4. Tính finalTotal chắc chắn
        const subText = document.getElementById('subTotal')?.innerText || '0';
        const numOnly = subText.replace(/[^0-9]/g, '');
        const subTotal = Number(numOnly) || 0;
        const finalText = document.getElementById('finalTotal')?.innerText || '0';
        const finalNum = Number(finalText.replace(/[^0-9]/g, '')) || subTotal;
        const finalTotal = finalNum;

        if (finalTotal <= 0) {
            toastr.error('Tổng tiền không hợp lệ.');
            return;
        }

        // 5. Build orderData theo đúng Entity/DTO Server
        const orderData = {
            // ⭐ SỬ DỤNG TÊN TRƯỜNG CHỮ HOA ĐỂ KHẮC PHỤC LỖI VALIDATION ROOT ⭐
            HoTen: fullName, // Khắc phục lỗi HoTen
            soDienThoai: phone, // Giữ nguyên
            email: document.getElementById('email')?.value.trim() || null,
            ghiChu: note,
            phuongThucThanhToan: paymentMethod,
            maPhieuGiamGia: null,
            tongTien: finalTotal,

            // ⭐ SỬ DỤNG TÊN OBJECT LỒNG NHAU CHỮ HOA: DiaChi ⭐
            DiaChi: {
                // Thường là các trường tên là: tenTinh, tenHuyen, tenXa, diaChiChiTiet
                // Tôi dùng tên trường phổ biến: tenTinh, tenHuyen, tenXa và diaChiCuThe/diaChiChiTiet

                tenTinh: cityName,
                tenHuyen: districtName,
                tenXa: wardName,
                diaChiChiTiet: addressDetail, // Sử dụng tên field phổ biến là diaChiChiTiet/diaChiCuThe

                // Thêm ID để đảm bảo DTO DiaChi đầy đủ (Nếu server yêu cầu ID)
                idTinh: citySelect.value,
                idHuyen: distSelect.value,
                idXa: wardSelect.value,

                // Thêm các trường DTO DiaChi của bạn nếu có (vd: hoTen người nhận, SĐT)
                // Nếu DTO DiaChi của bạn cần hoTen và soDienThoai bên trong:
                // hoTen: fullName,
                // soDienThoai: phone,
                // loaiDiaChi: "Nhà riêng"
            },

            chiTietDonHangs: currentCart.map(item => ({
                idChiTietSP: item.idChiTietSP,
                soLuong: item.soLuong,
                donGia: item.donGia
            }))
        };
        // 6. Debug: show payload trước khi gửi (console + toast ngắn)
        console.group('%c[DEBUG] Order payload', 'color: #0b72ff; font-weight:bold');
        console.log(orderData);
        console.groupEnd();
        toastr.info('Đang gửi đơn — kiểm tra console (F12) để xem payload');

        // 7. Gửi request, và in nguyên response nếu có lỗi (để biết exact violation)
        const btn = document.getElementById('btnPlaceOrder');
        const originalHtml = btn.innerHTML;
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ĐANG XỬ LÝ...';

            const resp = await fetch('/api/checkout/place-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const text = await resp.text();
            let json;
            try { json = JSON.parse(text); } catch(e) { json = null; }

            // Nếu server trả lỗi (400/500), show nguyên text để debug
            if (!resp.ok) {
                console.error('Server returned error status', resp.status, 'body:', text);
                // Nếu JSON có danh sách violation, show cụ thể
                if (json && json.constraintViolations) {
                    console.error('Constraint violations:', json);
                    toastr.error('Lỗi validate server: xem console (F12).');
                } else {
                    // Hiện popup chứa message server (truncate 300 ký tự)
                    const msg = (json && (json.message || JSON.stringify(json))) || text;
                    toastr.error('Server trả lỗi: ' + msg.substring(0, 200));
                }
                return;
            }

            // Success
            console.log('Server success response:', json || text);
            toastr.success('Đặt hàng thành công!');
            // nếu server trả id hoặc paymentUrl
            if (json && json.paymentUrl) {
                window.location.href = json.paymentUrl;
            } else if (json && json.id) {
                window.location.href = '/checkout/success?id=' + json.id;
            } else {
                // fallback
                window.location.href = '/checkout/success';
            }

        } catch (err) {
            console.error('Network / unexpected error when placing order:', err);
            toastr.error('Lỗi kết nối khi gửi đơn. Mở console để xem chi tiết.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }


    // GẮN SỰ KIỆN CHO NÚT
    document.getElementById('btnPlaceOrder').addEventListener('click', handleCheckout);
    document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById("btnPlaceOrder");
        if (btn) {
            btn.addEventListener("click", handleCheckout);
        } else {
            console.error("btnPlaceOrder NOT FOUND");
        }
    });

</script>




</body>
</html>