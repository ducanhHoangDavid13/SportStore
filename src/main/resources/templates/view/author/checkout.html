<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:fragment="head-links">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Thanh toán - SPORTX</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
    </div>
    <style>
        :root {
            --primary: #0b72ff;
            --primary-light: #eef5ff;
            --secondary: #64748b;
            --dark: #0f172a;
            --success: #10b981;
            --border: #e2e8f0;
            --radius-lg: 16px;
            --radius-md: 10px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        body { background-color: #f8fafc; color: var(--dark); font-family: 'Inter', sans-serif; }

        .checkout-wrapper { max-width: 1200px; margin: 40px auto 80px; padding: 0 20px; }

        .checkout-card {
            background: #fff;
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            letter-spacing: 0.5px;
            color: var(--dark);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-title i { color: var(--primary); font-size: 1.1rem; }

        /* Address Box */
        .address-option {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 18px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            position: relative;
        }
        .address-option.selected {
            border: 2px solid var(--primary);
            background-color: var(--primary-light);
        }

        /* Order List & Items */
        .order-list { max-height: 450px; overflow-y: auto; margin-bottom: 25px; padding-right: 5px; }
        .order-item {
            display: flex; gap: 16px; padding: 20px 0; border-bottom: 1px solid var(--border);
            position: relative;
        }
        .item-img { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; background: #f1f5f9; }

        /* Quantity Controls */
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2px 5px;
            width: fit-content;
            margin-top: 8px;
        }
        .qty-btn {
            width: 24px; height: 24px; border: none; background: none;
            display: flex; align-items: center; justify-content: center;
            color: var(--secondary); cursor: pointer; border-radius: 4px;
        }
        .qty-btn:hover { background: #f1f5f9; color: var(--primary); }

        /* CSS Input số lượng (Đã cập nhật) */
        .qty-input {
            width: 40px; border: none; text-align: center;
            font-weight: 600; font-size: 0.9rem; outline: none;
            -moz-appearance: textfield; /* Firefox */
        }
        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .btn-remove-item {
            position: absolute; right: 0; top: 20px;
            color: #ef4444; cursor: pointer; font-size: 0.9rem; opacity: 0.6;
        }
        .btn-remove-item:hover { opacity: 1; }

        /* Summary & Checkout */
        .summary-total {
            border-top: 2px dashed var(--border);
            margin-top: 20px; padding-top: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .total-amount { font-family: 'Oswald'; color: var(--primary); font-size: 1.75rem; font-weight: 700; }

        .btn-checkout {
            width: 100%; padding: 18px; background: var(--primary); color: #fff;
            border: none; border-radius: 50px; font-weight: 700; text-transform: uppercase;
            box-shadow: 0 4px 14px 0 rgba(11, 114, 255, 0.39);
            transition: all 0.3s;
        }
        .btn-checkout:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-checkout:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
    </style>
</head>
<body>

<header th:replace="~{library/header :: header}"></header>

<main class="checkout-wrapper">
    <form id="checkoutForm">
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="checkout-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title m-0"><i class="fa-solid fa-location-dot"></i>ĐỊA CHỈ GIAO HÀNG</h2>
                        <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#newAddressModal">
                            + Thêm mới
                        </button>
                    </div>
                    <div id="addressSelectionContainer">
                        <div class="text-center py-4 text-muted">Đang tải địa chỉ...</div>
                    </div>
                    <div class="mt-4">
                        <label class="fw-bold small mb-2 text-secondary">GHI CHÚ ĐƠN HÀNG</label>
                        <textarea class="form-control" id="note" rows="3" placeholder="Nhập lời nhắn cho shipper..."></textarea>
                    </div>
                </div>

                <div class="checkout-card">
                    <h2 class="section-title"><i class="fa-solid fa-credit-card"></i>PHƯƠNG THỨC THANH TOÁN</h2>
                    <div class="payment-methods">
                        <label class="address-option selected d-flex align-items-center">
                            <input type="radio" name="paymentMethod" value="COD" checked>
                            <div class="ms-3">
                                <div class="fw-bold">Thanh toán khi nhận hàng (COD)</div>
                                <div class="small text-muted">Nhận hàng rồi mới trả tiền</div>
                            </div>
                            <i class="fa-solid fa-money-bill-1-wave ms-auto text-success fs-4"></i>
                        </label>
                        <label class="address-option d-flex align-items-center">
                            <input type="radio" name="paymentMethod" value="VNPAY">
                            <div class="ms-3">
                                <div class="fw-bold">Ví VNPAY / Thẻ ATM</div>
                                <div class="small text-muted">Thanh toán online an toàn qua cổng VNPAY</div>
                            </div>
                            <i class="fa-solid fa-qrcode ms-auto text-primary fs-4"></i>
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="checkout-card sticky-top" style="top: 20px;">
                    <h2 class="section-title"><i class="fa-solid fa-basket-shopping"></i>ĐƠN HÀNG</h2>
                    <div id="cartItemsList" class="order-list">
                    </div>

                    <div class="mb-4">
                        <label class="small fw-bold text-secondary mb-2">MÃ GIẢM GIÁ</label>
                        <select class="form-select" id="voucherSelect">
                            <option value="">-- Chọn ưu đãi --</option>
                        </select>
                    </div>

                    <div class="summary-box">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Tạm tính:</span> <span id="subTotal" class="fw-bold">0₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Phí vận chuyển:</span> <span class="fw-bold">30.000₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Giảm giá:</span> <span id="discountAmount" class="fw-bold">0₫</span>
                        </div>
                        <div class="summary-total">
                            <span class="fw-bold">TỔNG CỘNG:</span>
                            <span id="finalTotal" class="total-amount">0₫</span>
                        </div>
                    </div>

                    <button type="button" class="btn-checkout mt-4" id="btnPlaceOrder" disabled onclick="handlePlaceOrderClick()">
                        XÁC NHẬN ĐẶT HÀNG <i class="fa-solid fa-chevron-right ms-2 small"></i>
                    </button>
                    <p class="text-center mt-3 small text-muted">Thông tin thanh toán được bảo mật an toàn</p>
                </div>
            </div>
        </div>
    </form>
</main>

<div class="modal fade" id="newAddressModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold">Thêm địa chỉ giao hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3"><input type="text" id="newHoTen" class="form-control" placeholder="Họ và tên người nhận"></div>
                <div class="mb-3"><input type="text" id="newSoDienThoai" class="form-control" placeholder="Số điện thoại liên lạc"></div>
                <div class="row g-2 mb-3">
                    <div class="col-4"><select id="newCity" class="form-select"><option value="">Tỉnh/TP</option></select></div>
                    <div class="col-4"><select id="newDistrict" class="form-select" disabled><option value="">Quận/Huyện</option></select></div>
                    <div class="col-4"><select id="newWard" class="form-select" disabled><option value="">Phường/Xã</option></select></div>
                </div>
                <div class="mb-3"><input type="text" id="newDiaChiCuThe" class="form-control" placeholder="Số nhà, tên đường..."></div>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="loaiDC" id="dcNha" value="Nhà riêng" checked>
                        <label class="form-check-label" for="dcNha">Nhà riêng</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="loaiDC" id="dcVP" value="Văn phòng">
                        <label class="form-check-label" for="dcVP">Văn phòng</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="saveNewAddress()">Lưu địa chỉ</button>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{library/footer :: footer}"></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    let currentCart = [];
    let selectedAddressId = null;
    const urlParams = new URLSearchParams(window.location.search);

    // Cấu hình Toastr
    toastr.options = {"positionClass": "toast-bottom-right", "timeOut": "3000"};

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
    }

    $(document).ready(function() {
        initData();
        loadAddresses();
        loadVouchers();
        setupAddressApi();

        $(document).on('click', '.payment-methods .address-option', function() {
            $('.payment-methods .address-option').removeClass('selected border-primary');
            $(this).addClass('selected border-primary');
            $(this).find('input').prop('checked', true);
        });
    });

    // 1. LẤY DỮ LIỆU SẢN PHẨM & TỒN KHO
    async function initData() {
        const productId = urlParams.get('productId');
        const cartIds = urlParams.getAll('cartIds');

        try {
            let url = "";
            if (productId) {
                url = `/api/checkout/product-detail/${productId}?quantity=${urlParams.get('quantity') || 1}`;
            } else if (cartIds.length > 0) {
                const query = cartIds.map(id => `cartIds=${id}`).join('&');
                url = `/checkout/api/items?${query}`;
            } else {
                window.location.href = "/cart";
                return;
            }

            const res = await fetch(url);
            const data = await res.json();

            if (productId) {
                currentCart = [{
                    id: data.id, name: data.tenSanPham, price: data.giaTien,
                    quantity: parseInt(urlParams.get('quantity')),
                    image: data.tenHinhAnh, size: data.tenKichCo, color: data.tenMau,
                    stock: data.soLuongTon // Tồn kho từ API
                }];
            } else {
                currentCart = data.cartItems.map(item => ({
                    id: item.idSanPhamChiTiet, name: item.tenSanPham,
                    price: item.donGia, quantity: item.soLuong,
                    image: item.tenHinhAnh, size: item.tenKichCo, color: item.tenMau,
                    stock: item.soLuongTon // Tồn kho từ API
                }));
            }

            renderCart();
            calculateTotal();
        } catch (e) {
            toastr.error("Không thể tải thông tin đơn hàng");
        }
    }

    // 2. HIỂN THỊ GIỎ HÀNG (CÓ INPUT NHẬP TAY)
    function renderCart() {
        let html = currentCart.map((item, index) => `
            <div class="order-item">
                <img src="/image/${item.image}" class="item-img" onerror="this.src='https://placehold.co/80'">
                <div class="flex-grow-1">
                    <div class="fw-bold small pe-4">${item.name}</div>
                    <div class="text-muted" style="font-size: 0.75rem;">${item.size} / ${item.color}</div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty(${index}, -1)"><i class="fa fa-minus"></i></button>
                            <input type="number" class="qty-input"
                                   id="qtyInput_${index}"
                                   value="${item.quantity}"
                                   onchange="checkManualQty(${index})"
                                   onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                            <button class="qty-btn" onclick="updateQty(${index}, 1)"><i class="fa fa-plus"></i></button>
                        </div>
                        <span class="fw-bold text-primary">${formatCurrency(item.price * item.quantity)}</span>
                    </div>
                </div>
                <i class="fa-solid fa-xmark btn-remove-item" onclick="removeItem(${index})"></i>
            </div>
        `).join('');
        $('#cartItemsList').html(html || '<p class="text-center py-4 text-muted">Đơn hàng trống</p>');
        $('#btnPlaceOrder').prop('disabled', currentCart.length === 0);
    }

    // 3. LOGIC TĂNG GIẢM / XÓA (CÓ CHECK STOCK)
    function updateQty(index, delta) {
        let item = currentCart[index];
        let newQty = item.quantity + delta;
        let maxStock = item.stock || 9999;

        if (delta > 0 && newQty > maxStock) {
            toastr.warning(`Chỉ còn ${maxStock} sản phẩm trong kho!`);
            return;
        }

        if (newQty > 0) {
            currentCart[index].quantity = newQty;
            renderCart();
            calculateTotal();
        }
    }

    function checkManualQty(index) {
        const input = document.getElementById(`qtyInput_${index}`);
        let val = parseInt(input.value);
        let item = currentCart[index];
        let maxStock = item.stock || 9999;

        if (isNaN(val) || val < 1) {
            val = 1;
            toastr.warning("Số lượng tối thiểu là 1");
        }

        if (val > maxStock) {
            val = maxStock;
            toastr.warning(`Kho chỉ còn ${maxStock} sản phẩm!`);
        }

        input.value = val;
        currentCart[index].quantity = val;
        calculateTotal();
    }

    function removeItem(index) {
        currentCart.splice(index, 1);
        renderCart();
        calculateTotal();
    }

    // 4. TÍNH TOÁN TIỀN & CHECK VOUCHER (ĐÃ SỬA: THÊM CẢNH BÁO)
    function calculateTotal() {
        const voucherCode = $('#voucherSelect').val();

        fetch('/api/checkout/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                voucherCode: voucherCode,
                items: currentCart.map(i => ({ sanPhamChiTietId: i.id, soLuong: i.quantity }))
            })
        })
            .then(r => r.json())
            .then(data => {
                $('#subTotal').text(formatCurrency(data.subTotal));
                $('#discountAmount').text("-" + formatCurrency(data.discountAmount));
                $('#finalTotal').text(formatCurrency(data.finalTotal));

                // --- [ĐOẠN CODE MỚI THÊM] ---
                // Kiểm tra: Có chọn mã NHƯNG số tiền giảm = 0 -> Không đủ điều kiện
                if (voucherCode && data.discountAmount === 0) {
                    // Ưu tiên hiển thị message từ API nếu có (data.message), nếu không thì hiện câu chung chung
                    const msg = data.message || "Đơn hàng chưa đủ điều kiện (giá trị tối thiểu, hạn dùng...) để áp dụng mã này!";

                    toastr.warning(msg, "Không thể áp dụng!");

                    // Reset ô chọn voucher về mặc định
                    $('#voucherSelect').val("");

                    // Reset lại hiển thị giảm giá về 0
                    $('#discountAmount').text("-" + formatCurrency(0));
                }
                // -----------------------------
            });
    }

    // 5. QUẢN LÝ ĐỊA CHỈ
    function loadAddresses(selectedId = null) {
        fetch('/api/dia-chi').then(r => r.json()).then(data => {
            if (data.length === 0) {
                $('#addressSelectionContainer').html('<p class="text-danger small">Vui lòng thêm địa chỉ giao hàng để tiếp tục!</p>');
                return;
            }
            let selId = selectedId || data.find(a => a.diaChiMacDinh)?.id || data[0].id;
            selectedAddressId = selId;

            let html = data.map(addr => `
                <div class="address-option ${addr.id === selId ? 'selected' : ''}" onclick="selectAddress(${addr.id})">
                    <div class="fw-bold">${addr.hoTen} <span class="text-muted fw-normal mx-2">|</span> ${addr.soDienThoai}</div>
                    <div class="small text-muted mt-1">${addr.diaChiCuThe}, ${addr.xa}, ${addr.thanhPho}</div>
                    <span class="badge bg-light text-dark border mt-2" style="font-size: 0.65rem;">${addr.loaiDiaChi}</span>
                </div>
            `).join('');
            $('#addressSelectionContainer').html(html);
        });
    }

    function selectAddress(id) {
        selectedAddressId = id;
        loadAddresses(id);
    }

    // 6. ĐẶT HÀNG
    async function handlePlaceOrderClick() {
        if (!selectedAddressId) { toastr.warning("Vui lòng chọn địa chỉ nhận hàng"); return; }
        if (currentCart.length === 0) { toastr.warning("Giỏ hàng trống!"); return; }

        Swal.fire({ title: 'Đang xử lý...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const payload = {
            addressId: selectedAddressId,
            note: $('#note').val(),
            paymentMethod: $('input[name="paymentMethod"]:checked').val(),
            items: currentCart.map(i => ({ sanPhamChiTietId: i.id, soLuong: i.quantity })),
            // Gửi thêm voucher code khi đặt hàng (nếu có)
            voucherCode: $('#voucherSelect').val()
        };

        try {
            const res = await fetch('/api/checkout/place-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await res.json();

            if (result.success) {
                const cartIdsToDelete = new URLSearchParams(window.location.search).getAll('cartIds');
                if (cartIdsToDelete.length > 0) {
                    await fetch('/checkout/api/clear-cart', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(cartIdsToDelete)
                    });
                }
                Swal.fire("Thành công", "Đơn hàng đang chuyến hướng tới VNPAY!", "success").then(() => {
                    window.location.href = result.redirectUrl;
                });
            } else {
                Swal.fire("Lỗi", result.message, "error");
            }
        } catch (e) {
            Swal.fire("Lỗi", "Có lỗi xảy ra, vui lòng thử lại sau.", "error");
        }
    }

    // 7. API TỈNH THÀNH & VOUCHER
    function setupAddressApi() {
        $.getJSON("https://esgoo.net/api-tinhthanh/1/0.htm", r => r.data.forEach(t => $('#newCity').append(`<option value="${t.id}" data-name="${t.full_name}">${t.full_name}</option>`)));
        $('#newCity').change(function() {
            $('#newDistrict').html('<option>Quận/Huyện</option>').prop('disabled', false);
            $.getJSON(`https://esgoo.net/api-tinhthanh/2/${$(this).val()}.htm`, r => r.data.forEach(d => $('#newDistrict').append(`<option value="${d.id}" data-name="${d.full_name}">${d.full_name}</option>`)));
        });
        $('#newDistrict').change(function() {
            $('#newWard').html('<option>Phường/Xã</option>').prop('disabled', false);
            $.getJSON(`https://esgoo.net/api-tinhthanh/3/${$(this).val()}.htm`, r => r.data.forEach(w => $('#newWard').append(`<option value="${w.id}" data-name="${w.full_name}">${w.full_name}</option>`)));
        });
    }

    async function saveNewAddress() {
        const payload = {
            hoTen: $('#newHoTen').val(), soDienThoai: $('#newSoDienThoai').val(), diaChiCuThe: $('#newDiaChiCuThe').val(),
            xa: $('#newWard option:selected').data('name') + ", " + $('#newDistrict option:selected').data('name'),
            thanhPho: $('#newCity option:selected').data('name'),
            loaiDiaChi: $('input[name="loaiDC"]:checked').val()
        };
        const res = await fetch('/api/dia-chi', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        if (res.ok) {
            const d = await res.json();
            bootstrap.Modal.getInstance($('#newAddressModal')).hide();
            loadAddresses(d.id);
            toastr.success("Đã thêm địa chỉ mới");
        }
    }

    function loadVouchers() {
        fetch('/api/phieu-giam-gia/active').then(r => r.json()).then(data => {
            data.forEach(v => $('#voucherSelect').append(`<option value="${v.maPhieuGiamGia}">${v.maPhieuGiamGia} - Giảm ${formatCurrency(v.giaTriGiam)}</option>`));
        });
        $('#voucherSelect').change(calculateTotal);
    }
</script>
</body>
</html>