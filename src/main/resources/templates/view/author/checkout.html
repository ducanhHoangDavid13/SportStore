<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:fragment="head-links">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Thanh toán - SPORTX</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
    </div>
    <style>
        :root {
            --primary: #0b72ff;
            --primary-light: #eef5ff;
            --secondary: #64748b;
            --dark: #0f172a;
            --success: #10b981;
            --border: #e2e8f0;
            --radius-lg: 16px;
            --radius-md: 10px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        body { background-color: #f8fafc; color: var(--dark); font-family: 'Inter', sans-serif; }

        /* Checkout Container */
        .checkout-wrapper { max-width: 1200px; margin: 40px auto 80px; padding: 0 20px; }

        /* Card Style */
        .checkout-card {
            background: #fff;
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            letter-spacing: 0.5px;
            color: var(--dark);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-title i { color: var(--primary); font-size: 1.1rem; }

        /* Address Selection */
        .address-option {
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 18px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: #fff;
        }
        .address-option:hover { border-color: var(--primary); transform: translateY(-2px); }
        .address-option.selected {
            border-color: var(--primary);
            background-color: var(--primary-light);
            box-shadow: 0 4px 12px rgba(11, 114, 255, 0.1);
        }

        /* Order Items */
        .order-list { max-height: 400px; overflow-y: auto; margin-bottom: 25px; padding-right: 8px; }
        .order-item {
            display: flex;
            gap: 16px;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            transition: opacity 0.3s;
        }
        .item-img { width: 72px; height: 72px; border-radius: var(--radius-md); object-fit: cover; border: 1px solid var(--border); }
        .item-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--dark); }

        /* Quantity Box */
        .qty-box {
            display: flex;
            align-items: center;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            width: fit-content;
            background: #fff;
        }
        .qty-box input {
            width: 45px; border: none; text-align: center; font-weight: 700;
            font-size: 0.9rem; pointer-events: none; background: transparent;
        }
        .qty-box button {
            border: none; background: transparent; padding: 4px 10px; color: var(--secondary);
            transition: 0.2s;
        }
        .qty-box button:hover { color: var(--primary); background: #f1f5f9; }

        /* Payment Options */
        .payment-option {
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .payment-option.selected { border-color: var(--primary); background: var(--primary-light); }
        .payment-option input { width: 18px; height: 18px; cursor: pointer; }

        /* Price Summary */
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; color: var(--secondary); }
        .summary-total {
            border-top: 2px dashed var(--border);
            margin-top: 20px;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-label { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .total-amount { font-family: 'Oswald'; color: var(--primary); font-size: 1.75rem; font-weight: 700; }

        .btn-checkout {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 25px;
            box-shadow: 0 10px 20px -5px rgba(11, 114, 255, 0.4);
            transition: 0.3s;
        }
        .btn-checkout:hover { background: #005ae2; transform: translateY(-2px); box-shadow: 0 12px 24px -5px rgba(11, 114, 255, 0.5); }
        .btn-checkout:disabled { background: #cbd5e1; box-shadow: none; transform: none; cursor: not-allowed; }

        .btn-remove-item {
            color: #ef4444; border: none; background: transparent; padding: 8px;
            border-radius: 50%; transition: 0.2s;
        }
        .btn-remove-item:hover { background: #fee2e2; }

        /* Breadcrumb */
        .breadcrumb-item a { color: var(--secondary); text-decoration: none; font-size: 0.85rem; }
        .breadcrumb-item.active { color: var(--dark); font-weight: 600; font-size: 0.85rem; }
    </style>
</head>
<body>

<header th:replace="~{library/header :: header}"></header>

<main class="checkout-wrapper">
    <nav aria-label="breadcrumb" class="mb-5">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/"><i class="fa-solid fa-house me-2"></i>Trang chủ</a></li>
            <li class="breadcrumb-item active">THANH TOÁN</li>
        </ol>
    </nav>

    <form id="checkoutForm">
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="checkout-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title m-0"><i class="fa-solid fa-location-dot"></i>ĐỊA CHỈ GIAO HÀNG</h2>
                        <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#newAddressModal">
                            <i class="fa-solid fa-plus me-1"></i> Thêm mới
                        </button>
                    </div>

                    <div id="addressSelectionContainer">
                        <div class="text-center py-4 text-muted"><i class="fa-solid fa-spinner fa-spin me-2"></i>Đang tải...</div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label fw-bold small text-secondary">GHI CHÚ ĐƠN HÀNG</label>
                        <textarea class="form-control shadow-none" rows="3" id="note" placeholder="Nhập lời nhắn cho shipper..."></textarea>
                    </div>
                </div>

                <div class="checkout-card">
                    <h2 class="section-title"><i class="fa-solid fa-credit-card"></i>PHƯƠNG THỨC THANH TOÁN</h2>
                    <div class="payment-methods">
                        <label class="payment-option selected" data-method="COD">
                            <input type="radio" name="paymentMethod" value="COD" checked>
                            <div class="ms-2 flex-grow-1">
                                <div class="fw-bold">Thanh toán khi nhận hàng (COD)</div>
                                <div class="small text-muted">Nhận hàng rồi mới trả tiền</div>
                            </div>
                            <i class="fa-solid fa-money-bill-wave text-success fs-4"></i>
                        </label>
                        <label class="payment-option" data-method="VNPAY">
                            <input type="radio" name="paymentMethod" value="VNPAY">
                            <div class="ms-2 flex-grow-1">
                                <div class="fw-bold">Ví VNPAY / Thẻ ATM</div>
                                <div class="small text-muted">Thanh toán online an toàn qua cổng VNPAY</div>
                            </div>
                            <i class="fa-solid fa-qrcode text-primary fs-4"></i>
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="checkout-card sticky-top" style="top: 100px;">
                    <h2 class="section-title"><i class="fa-solid fa-basket-shopping"></i>ĐƠN HÀNG CỦA BẠN</h2>

                    <div class="order-list" id="cartItemsList">
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold small text-secondary">MÃ GIẢM GIÁ</label>
                        <div class="input-group">
                            <select class="form-select shadow-none" id="voucherSelect">
                                <option value="" selected>-- Chọn ưu đãi --</option>
                            </select>
                        </div>
                    </div>

                    <div class="summary-box p-3 bg-light rounded-3">
                        <div class="summary-row"><span>Tạm tính</span><span id="subTotal" class="fw-bold text-dark">0₫</span></div>
                        <div class="summary-row"><span>Phí vận chuyển</span><span id="shippingFee" class="fw-bold text-dark">30.000₫</span></div>
                        <div class="summary-row text-success"><span>Giảm giá</span><span id="discountAmount" class="fw-bold">-0₫</span></div>

                        <div class="summary-total">
                            <span class="total-label text-uppercase">Tổng cộng</span>
                            <span id="finalTotal" class="total-amount">0₫</span>
                        </div>
                    </div>

                    <button type="button" class="btn-checkout" id="btnPlaceOrder" disabled>
                        XÁC NHẬN ĐẶT HÀNG <i class="fa-solid fa-chevron-right ms-2"></i>
                    </button>

                    <div class="text-center mt-4 opacity-50 small">
                        <i class="fa-solid fa-shield-check me-1"></i> Thông tin thanh toán được mã hóa an toàn
                    </div>
                </div>
            </div>
        </div>
    </form>
</main>

<div class="modal fade" id="newAddressModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 overflow-hidden" style="border-radius: 20px;">
            <div class="modal-header border-0 bg-light p-4">
                <h5 class="modal-title fw-bold m-0"><i class="fa-solid fa-map-location-dot me-2 text-primary"></i>Thêm Địa Chỉ Giao Hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="newAddressForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Họ và tên người nhận</label>
                            <input type="text" class="form-control rounded-3" id="newHoTen" placeholder="VD: Nguyễn Văn A" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Số điện thoại</label>
                            <input type="text" class="form-control rounded-3" id="newSoDienThoai" placeholder="VD: 0987xxxxxx" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Tỉnh/Thành</label>
                            <select class="form-select rounded-3" id="newCity" required><option value="">Chọn Tỉnh</option></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Quận/Huyện</label>
                            <select class="form-select rounded-3" id="newDistrict" required disabled><option value="">Chọn Huyện</option></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Phường/Xã</label>
                            <select class="form-select rounded-3" id="newWard" required disabled><option value="">Chọn Xã</option></select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold">Số nhà, tên đường</label>
                            <input type="text" class="form-control rounded-3" id="newDiaChiCuThe" placeholder="VD: 123 Đường ABC..." required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Loại địa chỉ</label>
                            <select id="newLoaiDiaChi" class="form-select rounded-3">
                                <option value="Nhà riêng">Nhà riêng</option>
                                <option value="Văn phòng">Văn phòng</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" form="newAddressForm" class="btn btn-primary rounded-pill px-4" id="btnSaveNewAddress">Lưu địa chỉ</button>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{library/footer :: footer}"></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    // =========================================================================
    // CONFIG & STATE
    // =========================================================================
    const SHIPPING_FEE = 30000;
    const API_DIACHI_BASE_URL = '/api/dia-chi';
    const API_TINH = "https://esgoo.net/api-tinhthanh/1/0.htm";
    const API_HUYEN = "https://esgoo.net/api-tinhthanh/2/";
    const API_XA = "https://esgoo.net/api-tinhthanh/3/";

    let currentCart = [];
    let productStock = {};
    let selectedAddress = null;
    let isBuyNowMode = false;
    let newAddressModal;

    toastr.options = { "positionClass": "toast-top-right", "timeOut": "3000", "progressBar": true };

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
    }

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    document.addEventListener("DOMContentLoaded", function () {
        newAddressModal = new bootstrap.Modal(document.getElementById('newAddressModal'));

        loadUserAddresses();
        initCheckoutData(); // LUỒNG CHÍNH: TỰ ĐỘNG XÓA DỮ LIỆU CŨ NẾU MUA NGAY
        loadActiveVouchers();

        document.getElementById('voucherSelect').addEventListener('change', applyVoucher);
        document.getElementById('btnPlaceOrder').addEventListener('click', handlePlaceOrderClick);

        // UI Select Payment Method
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });

        // Cascading Address Selectors
        setupAddressSelectors('#newCity', '#newDistrict', '#newWard');
        document.getElementById('newAddressForm').addEventListener('submit', handleNewAddressSubmission);
    });

    // =========================================================================
    // CORE LOGIC: MUA NGAY VS GIỎ HÀNG
    // =========================================================================
    async function initCheckoutData() {
        const params = new URLSearchParams(window.location.search);
        const buyNowId = params.get('productId');
        const buyNowQty = params.get('quantity') || 1;

        // Luôn làm trống dữ liệu cũ để tránh xung đột
        currentCart = [];
        productStock = {};

        if (buyNowId) {
            isBuyNowMode = true;
            try {
                // Gọi API lấy thông tin riêng cho sản phẩm mua ngay
                const res = await fetch(`/api/checkout/product-detail/${buyNowId}`);
                if (!res.ok) throw new Error("Sản phẩm không tồn tại");

                const p = await res.json();
                currentCart = [{
                    id: p.id,
                    name: p.tenSanPham,
                    price: p.giaTien,
                    quantity: Math.min(parseInt(buyNowQty), p.soLuong),
                    size: p.tenKichCo || "N/A",
                    color: p.tenMau || "N/A",
                    image: p.tenHinhAnh ? `/image/${p.tenHinhAnh}` : 'https://placehold.co/100',
                    stock: p.soLuong,
                    isBuyNow: true
                }];
                productStock[p.id] = p.soLuong;

                renderCartHTML();
                applyVoucher(); // Tính toán lại tiền dựa trên sản phẩm duy nhất này
            } catch (e) {
                toastr.error("Không thể tải sản phẩm mua ngay. Đang chuyển về giỏ hàng...");
                window.location.href = "/checkout"; // Reset nếu lỗi
            }
        } else {
            // Chỉ tải giỏ hàng khi KHÔNG có tham số mua ngay
            isBuyNowMode = false;
            await loadCartFromServer();
        }
    }

    async function loadCartFromServer() {
        try {
            const res = await fetch('/api/cart');
            const data = await res.json();
            currentCart = data.map(item => ({
                id: item.idSanPhamChiTiet,
                name: item.tenSanPham,
                price: item.donGia,
                quantity: item.soLuong,
                size: item.tenKichCo,
                color: item.tenMau,
                image: item.tenHinhAnh ? `/image/${item.tenHinhAnh}` : 'https://placehold.co/100',
                stock: item.soLuongTon,
                isBuyNow: false
            }));
            await syncPricesAndStock();
        } catch (e) { console.error(e); }
    }

    async function syncPricesAndStock() {
        if (isBuyNowMode || currentCart.length === 0) return;
        const promises = currentCart.map(item => fetch(`/api/san-pham-chi-tiet/${item.id}`).then(r => r.ok ? r.json() : null));
        const products = await Promise.all(promises);
        products.forEach((p, idx) => {
            if (p) {
                productStock[currentCart[idx].id] = p.soLuong;
                currentCart[idx].price = p.giaTien;
                if (currentCart[idx].quantity > p.soLuong) currentCart[idx].quantity = p.soLuong;
            }
        });
        renderCartHTML();
        applyVoucher();
    }

    // =========================================================================
    // UI RENDERING & INTERACTION
    // =========================================================================
    function renderCartHTML() {
        const container = document.getElementById('cartItemsList');
        if (currentCart.length === 0) {
            container.innerHTML = `<div class="text-center py-5"><i class="fa-solid fa-box-open fs-1 text-light mb-3"></i><p class="text-muted">Đơn hàng hiện đang trống</p></div>`;
            updateOrderButtonState();
            return;
        }

        container.innerHTML = currentCart.map((item, index) => {
            const stock = productStock[item.id] || 0;
            return `
                <div class="order-item">
                    <img src="${item.image}" class="item-img" onerror="this.src='https://placehold.co/100'">
                    <div class="flex-grow-1">
                        <div class="item-name">${item.name}</div>
                        <div class="small text-muted mb-2">${item.size} / ${item.color} <span class="ms-2 badge bg-light text-dark fw-normal">Kho: ${stock}</span></div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="qty-box">
                                <button type="button" onclick="changeQty(${index}, -1)"><i class="fa-solid fa-minus small"></i></button>
                                <input type="number" value="${item.quantity}">
                                <button type="button" onclick="changeQty(${index}, 1)"><i class="fa-solid fa-plus small"></i></button>
                            </div>
                            <div class="fw-bold text-primary">${formatCurrency(item.price * item.quantity)}</div>
                        </div>
                    </div>
                    <button type="button" class="btn-remove-item ms-2 align-self-start" onclick="removeCartItem(${index})">
                        <i class="fa-solid fa-xmark fs-5"></i>
                    </button>
                </div>`;
        }).join('');
        updateOrderButtonState();
    }

    function changeQty(index, delta) {
        const item = currentCart[index];
        const stock = productStock[item.id] || 0;
        let newQty = item.quantity + delta;

        if (newQty < 1) return;
        if (newQty > stock) { toastr.warning(`Sản phẩm chỉ còn ${stock} món.`); newQty = stock; }

        item.quantity = newQty;
        renderCartHTML();
        applyVoucher();
    }

    function removeCartItem(index) {
        Swal.fire({
            title: 'Loại bỏ sản phẩm?', text: "Hành động này sẽ xóa sản phẩm khỏi danh sách thanh toán.",
            icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Đồng ý xóa'
        }).then((result) => {
            if (result.isConfirmed) {
                currentCart.splice(index, 1);
                renderCartHTML();
                applyVoucher();
            }
        });
    }

    // =========================================================================
    // PAYMENTS & CALCULATIONS
    // =========================================================================
    function applyVoucher() {
        if (currentCart.length === 0) { updateTotalsUI(0, 0, 0); return; }
        const code = document.getElementById('voucherSelect').value;

        fetch('/api/checkout/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ voucherCode: code, items: currentCart.map(i => ({ sanPhamChiTietId: i.id, soLuong: i.quantity })) })
        })
            .then(res => res.json())
            .then(data => updateTotalsUI(data.subTotal, data.discountAmount, data.finalTotal))
            .catch(() => toastr.error("Lỗi tính toán tiền hàng"));
    }

    function updateTotalsUI(sub, dis, total) {
        document.getElementById('subTotal').innerText = formatCurrency(sub);
        document.getElementById('discountAmount').innerText = "-" + formatCurrency(dis);
        document.getElementById('finalTotal').innerText = formatCurrency(total);
    }

    async function handlePlaceOrderClick() {
        if (!selectedAddress) return toastr.warning("Vui lòng chọn địa chỉ giao hàng!");

        const btn = document.getElementById('btnPlaceOrder');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>ĐANG XỬ LÝ...';
        btn.disabled = true;

        const payload = {
            addressId: selectedAddress,
            note: document.getElementById('note').value,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
            voucherCode: document.getElementById('voucherSelect').value,
            items: currentCart.map(i => ({ sanPhamChiTietId: i.id, soLuong: i.quantity })),
            isBuyNow: isBuyNowMode
        };

        try {
            const res = await fetch('/api/checkout/place-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Đặt hàng thành công!', showConfirmButton: false, timer: 1500 })
                    .then(() => window.location.href = data.redirectUrl || `/order-success?id=${data.hoaDonId}`);
            } else {
                Swal.fire('Lỗi đặt hàng', data.message, 'error');
                btn.innerHTML = originalHtml; btn.disabled = false;
            }
        } catch (e) {
            toastr.error("Lỗi kết nối máy chủ");
            btn.innerHTML = originalHtml; btn.disabled = false;
        }
    }

    // =========================================================================
    // ADDRESS & MODAL UTILS
    // =========================================================================
    async function loadUserAddresses(forceId = null) {
        const res = await fetch(API_DIACHI_BASE_URL);
        const addresses = await res.json();
        const container = document.getElementById('addressSelectionContainer');

        if (addresses.length === 0) {
            container.innerHTML = `<div class="text-center py-5 border rounded-3 bg-light"><p class="text-muted m-0">Bạn chưa có địa chỉ nào lưu sẵn.</p></div>`;
            return;
        }

        let selId = forceId || addresses.find(a => a.diaChiMacDinh)?.id || addresses[0].id;
        container.innerHTML = addresses.map(addr => `
            <div class="col-12">
                <label class="address-option ${addr.id === selId ? 'selected' : ''}" data-id="${addr.id}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold fs-6 mb-1">${addr.hoTen} <span class="ms-2 fw-normal text-muted small">| ${addr.soDienThoai}</span></div>
                            <div class="text-secondary small mb-1">${addr.diaChiCuThe}, ${addr.xa}, ${addr.thanhPho}</div>
                            <span class="badge bg-white text-dark border small fw-normal">${addr.loaiDiaChi}</span>
                            ${addr.diaChiMacDinh ? '<span class="badge bg-primary ms-2 fw-normal">Mặc định</span>' : ''}
                        </div>
                        <input type="radio" name="addr" value="${addr.id}" ${addr.id === selId ? 'checked' : ''} style="display:none">
                    </div>
                </label>
            </div>`).join('');

        container.querySelectorAll('.address-option').forEach(el => el.addEventListener('click', function() {
            selectedAddress = parseInt(this.dataset.id);
            container.querySelectorAll('.address-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            updateOrderButtonState();
        }));
        selectedAddress = selId;
        updateOrderButtonState();
    }

    function setupAddressSelectors(cId, dId, wId) {
        const cityS = $(cId), distS = $(dId), wardS = $(wId);
        $.getJSON(API_TINH, r => cityS.append(r.data.map(t => `<option value="${t.id}" data-name="${t.full_name}">${t.full_name}</option>`)));
        cityS.on('change', function() {
            const id = $(this).val();
            distS.html('<option value="">Chọn Quận/Huyện</option>').prop('disabled', !id);
            wardS.html('<option value="">Chọn Phường/Xã</option>').prop('disabled', true);
            if (id) $.getJSON(API_HUYEN + id + ".htm", r => distS.append(r.data.map(d => `<option value="${d.id}" data-name="${d.full_name}">${d.full_name}</option>`)));
        });
        distS.on('change', function() {
            const id = $(this).val();
            wardS.html('<option value="">Chọn Phường/Xã</option>').prop('disabled', !id);
            if (id) $.getJSON(API_XA + id + ".htm", r => wardS.append(r.data.map(w => `<option value="${w.id}" data-name="${w.full_name}">${w.full_name}</option>`)));
        });
    }

    async function handleNewAddressSubmission(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSaveNewAddress');
        const payload = {
            hoTen: $('#newHoTen').val(), soDienThoai: $('#newSoDienThoai').val(), diaChiCuThe: $('#newDiaChiCuThe').val(),
            xa: $('#newWard option:selected').data('name') + ", " + $('#newDistrict option:selected').data('name'),
            thanhPho: $('#newCity option:selected').data('name'), loaiDiaChi: $('#newLoaiDiaChi').val()
        };
        const res = await fetch(API_DIACHI_BASE_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        if (res.ok) { const data = await res.json(); newAddressModal.hide(); loadUserAddresses(data.id); }
    }

    function updateOrderButtonState() {
        document.getElementById('btnPlaceOrder').disabled = (currentCart.length === 0 || selectedAddress === null);
    }

    function loadActiveVouchers() {
        fetch('/api/phieu-giam-gia/active').then(r => r.json()).then(data => {
            document.getElementById('voucherSelect').innerHTML += data.map(v => `<option value="${v.maPhieuGiamGia}">${v.maPhieuGiamGia} - ${v.tenPhieuGiamGia}</option>`).join('');
        });
    }
</script>
</body>
</html>