<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán - SPORTX</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <style>
        :root {
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Oswald', sans-serif;
            --primary: #0b72ff;
            --primary-dark: #0056c7;
            --dark: #111111;
            --light-bg: #f4f7f6;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow-card: 0 10px 30px rgba(0,0,0,0.06);
        }
        body { font-family: var(--font-main); background-color: var(--light-bg); color: var(--dark); }
        .checkout-wrapper { max-width: 1300px; margin: 40px auto 80px; padding: 0 20px; }
        .checkout-grid { display: grid; grid-template-columns: 7fr 5fr; gap: 30px; }
        .checkout-card { background: #fff; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow-card); border: 1px solid #fff; }
        .section-header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .section-title { font-family: var(--font-heading); font-size: 1.4rem; font-weight: 700; margin: 0; text-transform: uppercase; }
        .form-label { font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; display: block; color: #333; }
        .form-control, .form-select { padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.95rem; background: #fbfbfc; transition: 0.2s; }
        .form-control:focus, .form-select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(11, 114, 255, 0.1); outline: none; }
        .summary-card { position: sticky; top: 100px; background: #fff; }
        .order-list { max-height: 350px; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
        .order-list::-webkit-scrollbar { width: 4px; }
        .order-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .order-item { display: flex; gap: 15px; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed var(--border); }
        .item-img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 0.95rem; line-height: 1.3; margin-bottom: 4px; display: block; color: var(--dark); }
        .item-meta { font-size: 0.85rem; color: #64748b; }
        .item-price { font-weight: 700; color: var(--primary); font-size: 0.95rem; text-align: right; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #555; }
        .total-final { font-size: 1.1rem; font-weight: 700; color: var(--dark); border-top: 2px dashed var(--border); padding-top: 20px; margin-top: 15px; align-items: center; display: flex; justify-content: space-between; }
        .total-final span:last-child { color: var(--primary); font-size: 1.5rem; font-family: var(--font-heading); }
        .payment-methods { margin-top: 25px; }
        .payment-option { border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; display: block; position: relative; background: #fff; }
        .payment-option:hover { border-color: var(--primary); background: #f0f7ff; }
        .payment-header { display: flex; align-items: center; gap: 12px; }
        .btn-checkout { width: 100%; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 700; text-transform: uppercase; margin-top: 25px; transition: 0.3s; box-shadow: 0 5px 15px rgba(11, 114, 255, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-checkout:hover { background: var(--primary-dark); transform: translateY(-3px); color: #fff; }
        .btn-checkout:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-remove-item { border: none; background: #fff; color: #ef4444; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-remove-item:hover { background-color: #fee2e2; transform: scale(1.1); }
        @media (max-width: 991px) { .checkout-grid { grid-template-columns: 1fr; } .summary-card { position: static; } }
    </style>
</head>
<body>

<header th:replace="~{library/header :: header}"></header>

<main class="checkout-wrapper">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb" style="background: transparent; padding: 0;">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
            <li class="breadcrumb-item active text-dark fw-bold" aria-current="page">THANH TOÁN</li>
        </ol>
    </nav>

    <form id="checkoutForm">
        <div class="checkout-grid">
            <div class="checkout-card">
                <div class="section-header">
                    <i class="fa-regular fa-address-card section-icon"></i>
                    <h2 class="section-title">THÔNG TIN GIAO HÀNG</h2>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fullName" placeholder="Nhập họ tên người nhận" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="phone" placeholder="Ví dụ: 0912345678" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Email (Nhận thông báo đơn hàng)</label>
                        <input type="email" class="form-control" id="email" placeholder="email@example.com">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tỉnh / Thành phố <span class="text-danger">*</span></label>
                        <select class="form-select" id="city" required><option value="" selected>Chọn Tỉnh/Thành</option></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Quận / Huyện <span class="text-danger">*</span></label>
                        <select class="form-select" id="district" required disabled><option value="" selected>Chọn Quận/Huyện</option></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Phường / Xã <span class="text-danger">*</span></label>
                        <select class="form-select" id="ward" required disabled><option value="" selected>Chọn Phường/Xã</option></select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Địa chỉ cụ thể <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addressDetail" placeholder="Số nhà, ngõ, tên đường..." required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Ghi chú đơn hàng (Tùy chọn)</label>
                        <textarea class="form-control" rows="3" id="note" placeholder="Ví dụ: Giao hàng giờ hành chính..."></textarea>
                    </div>
                </div>
            </div>

            <div class="checkout-card summary-card">
                <div class="section-header">
                    <i class="fa-solid fa-bag-shopping section-icon"></i>
                    <h2 class="section-title">ĐƠN HÀNG</h2>
                </div>

                <div class="order-list" id="cartItemsList">
                    <p class="text-center text-muted py-3 small">Đang tải giỏ hàng...</p>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">MÃ GIẢM GIÁ</label>
                    <select class="form-select" id="voucherSelect" >
                        <option value="" selected>-- Chọn mã giảm giá --</option>
                    </select>
                </div>

                <div class="total-row"><span>Tạm tính</span><span id="subTotal" class="fw-bold">0₫</span></div>
                <div class="total-row"><span>Phí vận chuyển</span><span id="shippingFee" class="fw-bold">30.000₫</span></div>
                <div class="total-row text-success"><span>Giảm giá</span><span id="discountAmount" class="fw-bold">-0₫</span></div>
                <div class="total-final"><span>TỔNG CỘNG</span><span id="finalTotal">0₫</span></div>

                <div class="payment-methods">
                    <h6 class="mb-3 text-uppercase fw-bold text-secondary" style="font-size: 0.85rem;">Phương thức thanh toán</h6>
                    <label class="payment-option">
                        <div class="payment-header">
                            <input type="radio" name="paymentMethod" value="COD" class="payment-radio" checked>
                            <span class="payment-label ms-2">Thanh toán khi nhận hàng (COD)</span>
                            <i class="fa-solid fa-money-bill-wave ms-auto text-secondary"></i>
                        </div>
                    </label>
                    <label class="payment-option">
                        <div class="payment-header">
                            <input type="radio" name="paymentMethod" value="VNPAY" class="payment-radio">
                            <span class="payment-label ms-2">Ví VNPAY / Thẻ ATM</span>
                            <i class="fa-solid fa-qrcode ms-auto text-primary"></i>
                        </div>
                    </label>
                </div>

                <button type="button" class="btn-checkout" id="btnPlaceOrder">
                    ĐẶT HÀNG NGAY <i class="fa-solid fa-arrow-right"></i>
                </button>
                <p class="text-center mt-3 small text-muted"><i class="fa-solid fa-shield-halved"></i> Thông tin được bảo mật an toàn</p>
            </div>
        </div>
    </form>
</main>

<footer th:replace="~{library/footer :: footer}"></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    // =========================================================================
    // 1. CẤU HÌNH & KHỞI TẠO
    // =========================================================================
    const SHIPPING_FEE = 30000;

    // API Hành chính Việt Nam
    const API_TINH = "https://esgoo.net/api-tinhthanh/1/0.htm";
    const API_HUYEN = "https://esgoo.net/api-tinhthanh/2/";
    const API_XA = "https://esgoo.net/api-tinhthanh/3/";

    let currentCart = [];
    // Lưu trữ tồn kho thực tế từ Server sau khi sync
    let productStock = {};

    // Cấu hình thông báo
    toastr.options = { "closeButton": true, "progressBar": true, "positionClass": "toast-top-right", "timeOut": "3000" };

    // Định dạng tiền tệ
    function formatCurrency(amount) {
        if (amount === undefined || amount === null || isNaN(amount)) return "0 ₫";
        // Chuyển đổi sang số nếu là chuỗi (để formatCurrency() hoạt động đúng)
        if (typeof amount === 'string') {
            amount = parseFloat(amount);
        }
        if (isNaN(amount)) return "0 ₫";
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadAddressData();      // Tải Tỉnh/Thành
        // loadCartFromStorage();  // Tải giỏ hàng từ LocalStorage
        fetch('/api/cart', {
            credentials: 'same-origin'
        })
            .then(res => res.json())
            .then(data => {
                console.log('CART FROM SERVER:', data);
                currentCart = data.map(item => ({
                    id: item.idSanPhamChiTiet,          // dùng cho checkout + tồn kho
                    cartId: item.id,                    // id dòng giỏ
                    name: item.tenSanPham,
                    color: item.tenMau,
                    size: item.tenKichCo,
                    price: item.donGia,
                    quantity: item.soLuong,
                    image: item.tenHinhAnh
                        ? `/images/${item.tenHinhAnh}`
                        : 'https://placehold.co/64?text=Img',
                    stock: item.soLuongTon
                }));

                renderCartHTML();
                applyVoucher();

            });


        loadActiveVouchers();   // Tải mã giảm giá

        // Lắng nghe sự kiện thay đổi voucher để tính lại tiền ngay
        document.getElementById('voucherSelect').addEventListener('change', applyVoucher);
    });

    // =========================================================================
    // 2. XỬ LÝ ĐỊA CHỈ (GIỮ NGUYÊN)
    // =========================================================================
    function loadAddressData() {
        fetch(API_TINH).then(r => r.json()).then(data => {
            if (data.error === 0) {
                let html = '<option value="">Chọn Tỉnh/Thành</option>';
                data.data.forEach(tinh => html += `<option value="${tinh.id}" data-name="${tinh.full_name}">${tinh.full_name}</option>`);
                document.getElementById('city').innerHTML = html;
            }
        });

        document.getElementById('city').addEventListener('change', function () {
            const idTinh = this.value;
            const distSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');
            distSelect.innerHTML = '<option value="">Đang tải...</option>';
            wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>'; distSelect.disabled = true; wardSelect.disabled = true;

            if (idTinh) {
                fetch(API_HUYEN + idTinh + ".htm").then(r => r.json()).then(data => {
                    if (data.error === 0) {
                        let html = '<option value="">Chọn Quận/Huyện</option>';
                        data.data.forEach(h => html += `<option value="${h.id}" data-name="${h.full_name}">${h.full_name}</option>`);
                        distSelect.innerHTML = html; distSelect.disabled = false;
                    }
                });
            } else { distSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>'; }
        });

        document.getElementById('district').addEventListener('change', function () {
            const idHuyen = this.value;
            const wardSelect = document.getElementById('ward');
            wardSelect.innerHTML = '<option value="">Đang tải...</option>'; wardSelect.disabled = true;
            if (idHuyen) {
                fetch(API_XA + idHuyen + ".htm").then(r => r.json()).then(data => {
                    if (data.error === 0) {
                        let html = '<option value="">Chọn Phường/Xã</option>';
                        data.data.forEach(x => html += `<option value="${x.id}" data-name="${x.full_name}">${x.full_name}</option>`);
                        wardSelect.innerHTML = html; wardSelect.disabled = false;
                    }
                });
            } else { wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>'; }
        });
    }

    // =========================================================================
    // 3. QUẢN LÝ GIỎ HÀNG & ĐỒNG BỘ GIÁ/TỒN KHO
    // =========================================================================

    async function loadCartFromStorage() {
        const json = localStorage.getItem('cartItems');
        currentCart = json ? JSON.parse(json) : [];

        // 1. Render trước dữ liệu cũ để khách không phải chờ
        renderCartHTML();

        // 2. Nếu giỏ hàng có đồ, tiến hành ĐỒNG BỘ và TÍNH TOÁN
        if (currentCart.length > 0) {
            await syncPricesAndStockWithServer(); // Đồng bộ giá/tồn kho
            applyVoucher(); // Tính toán tổng tiền sau khi sync
        } else {
            updateTotals(0, 0, 0);
        }
        document.getElementById('btnPlaceOrder').disabled = (currentCart.length === 0);
    }

    // [MỚI] Hàm này gọi API lấy chi tiết từng sản phẩm để cập nhật giá và tồn kho
    async function syncPricesAndStockWithServer() {
        productStock = {}; // Reset tồn kho
        const btn = document.getElementById('btnPlaceOrder');
        btn.disabled = true;

        // Tạo danh sách các Promise để gọi API song song
        const promises = currentCart.map(item =>
            fetch(`/api/san-pham-chi-tiet/${item.id}`).then(res => {
                if(res.ok) return res.json();
                return null;
            }).catch(() => null)
        );

        try {
            const products = await Promise.all(promises);
            let hasChange = false;
            let indicesToRemove = []; // Dùng để lưu index các sản phẩm cần xóa

            products.forEach((product, index) => {
                const item = currentCart[index];
                if (product) {
                    // Logic giá: Lấy giá SPCT
                    const realPrice = product.giaTien;
                    const stock = product.soLuong; // Lấy tồn kho (Chú ý: Dùng 'soLuong' thay vì 'soLuongTon' nếu entity dùng 'soLuong')

                    // Lưu tồn kho thực tế
                    productStock[item.id] = stock;

                    // 1. Cập nhật giá nếu khác
                    if (realPrice && item.price !== realPrice) {
                        item.price = realPrice;
                        hasChange = true;
                    }

                    // 2. Kiểm tra số lượng tồn
                    if (item.quantity > stock) {
                        if (stock === 0) {
                            toastr.error(`Sản phẩm "${item.name}" (${item.size}/${item.color}) đã hết hàng và bị xóa khỏi giỏ.`);
                            indicesToRemove.push(index); // Đánh dấu xóa
                        } else {
                            item.quantity = stock; // Giảm về tồn kho tối đa
                            toastr.warning(`Sản phẩm "${item.name}" (${item.size}/${item.color}) chỉ còn ${stock} sản phẩm. Số lượng đã được điều chỉnh.`);
                        }
                        hasChange = true;
                    } else if (stock === 0 && item.quantity > 0) {
                        // Trường hợp ban đầu vẫn còn, nhưng sau sync thì hết
                        toastr.error(`Sản phẩm "${item.name}" (${item.size}/${item.color}) đã hết hàng và bị xóa khỏi giỏ.`);
                        indicesToRemove.push(index);
                        hasChange = true;
                    }

                } else {
                    // Sản phẩm bị xóa khỏi hệ thống
                    toastr.error(`Sản phẩm "${item.name}" đã bị xóa khỏi hệ thống và được loại bỏ khỏi giỏ.`);
                    indicesToRemove.push(index);
                    hasChange = true;
                }
            });

            // Thực hiện xóa các sản phẩm đã đánh dấu (phải xóa ngược để không ảnh hưởng index)
            for(let i = indicesToRemove.length - 1; i >= 0; i--) {
                currentCart.splice(indicesToRemove[i], 1);
            }

            // Nếu có thay đổi (giá, số lượng, xóa) thì lưu lại và render
            if (hasChange) {
                localStorage.setItem('cartItems', JSON.stringify(currentCart));
            }

            // Luôn gọi renderCartHTML sau khi kết thúc đồng bộ
            renderCartHTML();

            // Kích hoạt nút đặt hàng nếu giỏ hàng không trống
            if (currentCart.length > 0) {
                btn.disabled = false;
            } else {
                updateTotals(0, 0, 0); // Reset totals nếu giỏ hàng trống
            }

            // LƯU Ý: applyVoucher() sẽ được gọi ở cuối loadCartFromStorage()

        } catch (err) {
            console.error("Lỗi đồng bộ giá và tồn kho:", err);
            toastr.error("Lỗi kết nối server khi đồng bộ giỏ hàng.");
        }
    }

    function renderCartHTML() {
        const container = document.getElementById('cartItemsList');
        if (currentCart.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted"><i class="fa-solid fa-basket-shopping fs-1 mb-2"></i><p>Giỏ hàng đang trống</p><a href="/san-pham" class="btn btn-sm btn-outline-primary rounded-pill">Mua sắm ngay</a></div>`;
            document.getElementById('btnPlaceOrder').disabled = true;
            return;
        }

        let html = '';
        currentCart.forEach((item, index) => {
           // const stock = productStock[item.id] !== undefined ? productStock[item.id] : '...'; // Lấy tồn kho đã sync
            const stock = item.stock ?? '...';
            const isOutOfStock = stock === 0;
            const isMaxStock = item.quantity >= stock && stock > 0;

            html += `
                <div class="order-item align-items-center">
                    <img src="${item.image || 'https://placehold.co/64?text=Img'}" class="item-img" onerror="this.src='https://placehold.co/64?text=Img'">
                    <div class="item-info flex-grow-1 ps-3">
                        <span class="item-name text-truncate" style="max-width: 180px;">${item.name}</span>
                        <div class="item-meta mb-1 small text-dark">
                            Size: <b>${item.size}</b> | Màu: <b>${item.color}</b>
                            <span class="text-${isOutOfStock ? 'danger' : 'success'} ms-2">(Tồn: ${stock})</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <button class="btn btn-outline-secondary px-2" type="button" onclick="changeQuantity(${index}, -1)" ${item.quantity <= 1 || isOutOfStock ? 'disabled' : ''}>-</button>
                                <input type="text" class="form-control text-center px-1" value="${item.quantity}" readonly style="background: #fff;">
                                <button class="btn btn-outline-secondary px-2" type="button" onclick="changeQuantity(${index}, 1)" ${isMaxStock || isOutOfStock ? 'disabled' : ''}>+</button>
                            </div>
                            <span class="item-price fw-bold text-primary">${formatCurrency(item.price * item.quantity)}</span>
                        </div>
                    </div>
                    <div class="ms-2">
                        <button type="button" class="btn-remove-item text-danger" onclick="removeCartItem(${index})"><i class="fa-regular fa-trash-can"></i></button>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
        document.getElementById('btnPlaceOrder').disabled = (currentCart.length === 0);
    }

    function changeQuantity(index, delta) {
        let item = currentCart[index];
        let newQty = item.quantity + delta;
        const stock = productStock[item.id];

        if (newQty < 1) {
            removeCartItem(index);
            return;
        }

        if (stock === 0) {
            toastr.error(`Sản phẩm đã hết hàng.`);
            return;
        }

        if (newQty > stock) {
            toastr.warning(`Tồn kho tối đa chỉ còn ${stock} sản phẩm.`);
            newQty = stock; // Điều chỉnh về mức tồn kho tối đa
        }

        // Chỉ cập nhật nếu số lượng thay đổi
        if (item.quantity !== newQty) {
            item.quantity = newQty;
            localStorage.setItem('cartItems', JSON.stringify(currentCart));
            renderCartHTML();
            applyVoucher(); // Tính lại tiền ngay
        }
    }

    function removeCartItem(index) {
        Swal.fire({
            title: 'Xóa sản phẩm?', text: "Bỏ sản phẩm này khỏi đơn hàng?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Xóa', cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                currentCart.splice(index, 1);
                localStorage.setItem('cartItems', JSON.stringify(currentCart));
                // Không cần gọi loadCartFromStorage(), chỉ cần render và applyVoucher
                renderCartHTML();
                applyVoucher();
                toastr.success('Đã cập nhật giỏ hàng');
            }
        });
    }

    // HÀM QUAN TRỌNG: Cập nhật UI dựa trên số liệu Server trả về
    function updateTotals(subTotal, discount, finalTotal) {
        document.getElementById('subTotal').innerText = formatCurrency(subTotal);
        document.getElementById('shippingFee').innerText = formatCurrency(SHIPPING_FEE);
        document.getElementById('discountAmount').innerText = discount > 0 ? "-" + formatCurrency(discount) : "0₫";
        document.getElementById('finalTotal').innerText = formatCurrency(finalTotal);
    }

    // =========================================================================
    // 4. XỬ LÝ VOUCHER & TÍNH TIỀN (GỌI SERVER)
    // =========================================================================
    function loadActiveVouchers() {
        fetch('/api/phieu-giam-gia/active')
            .then(res => res.json())
            .then(data => {
                let html = '<option value="">-- Chọn mã giảm giá --</option>';
                data.forEach(v => {
                    let discountText = v.hinhThucGiam === 2 ? `Giảm ${v.giaTriGiam}%` : `Giảm ${formatCurrency(v.giaTriGiam)}`;
                    // Lấy điều kiện tối thiểu
                    const minOrder = v.dieuKienGiamGia || 0;

                    // LƯU Ý: Vẫn giữ value là mã và thêm data-min-order
                    html += `<option value="${v.maPhieuGiamGia}" data-min-order="${minOrder}">
                            ${v.maPhieuGiamGia} - ${v.tenPhieuGiamGia} [${discountText}] (Đơn từ ${formatCurrency(minOrder)})
                         </option>`;
                });
                document.getElementById('voucherSelect').innerHTML = html;
            })
            .catch(() => console.log("Không tải được voucher"));
    }

    /**
     * Hàm chính tính toán tổng tiền và áp dụng voucher (gọi API Server)
     */
    function applyVoucher() {
        if (currentCart.length === 0) {
            updateTotals(0, 0, 0);
            return;
        }

        const btnPlaceOrder = document.getElementById('btnPlaceOrder');
        btnPlaceOrder.disabled = true;

        const selectElement = document.getElementById('voucherSelect');
        let code = selectElement.value; // Mã voucher hiện tại

        // --- KIỂM TRA ĐIỀU KIỆN TỐI THIỂU (FRONTEND CHECK) ---
        if (code) {
            const subTotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            // Chắc chắn là số
            const minOrder = parseFloat(selectedOption.getAttribute('data-min-order')) || 0;

            if (subTotal < minOrder) {
                toastr.warning(`Đơn hàng chưa đạt tối thiểu ${formatCurrency(minOrder)} để áp dụng mã này!`);
                selectElement.value = ""; // Reset voucher trên UI
                code = ""; // Gửi request với mã rỗng
                // KHÔNG cần return hay gọi lại applyVoucher() nữa, cứ tiếp tục fetch
            }
        }

        const itemsPayload = currentCart.map(i => ({
            sanPhamChiTietId: i.id,
            soLuong: i.quantity
        }));

        // Bắt đầu Fetch
        fetch('/api/checkout/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                voucherCode: code,
                shippingFee: SHIPPING_FEE,
                items: itemsPayload
            })
        })
            .then(res => {
                if (!res.ok) {
                    // Cố gắng đọc thông báo lỗi từ Server (nếu có)
                    return res.json().catch(() => {
                        throw new Error("Lỗi Server: " + res.status);
                    }).then(errData => {
                        throw new Error(errData.message || "Lỗi Server: " + res.status);
                    });
                }
                return res.json();
            })
            .then(data => {
                let needsRecalculateDueToStock = false;

                // 1. KIỂM TRA TỒN KHO/GIÁ (Nếu Server trả về lỗi)
                if(data.outOfStock) {
                    toastr.error(data.error);
                    const productId = data.productId;

                    const indexToRemove = currentCart.findIndex(item => item.id === productId);
                    if (indexToRemove !== -1) {
                        currentCart.splice(indexToRemove, 1);
                        localStorage.setItem('cartItems', JSON.stringify(currentCart));
                        needsRecalculateDueToStock = true;
                    }
                }

                if (needsRecalculateDueToStock) {
                    renderCartHTML();
                    // Gọi lại applyVoucher() để tính toán lại với giỏ hàng đã được sửa
                    return applyVoucher();
                }

                // 2. XỬ LÝ VOUCHER (Backend trả về lỗi)
                // Chỉ kiểm tra nếu trước đó đã có mã (code khác rỗng)
                if (code && !data.voucherValid) {
                    toastr.warning(data.voucherMessage || "Mã không hợp lệ hoặc không đủ điều kiện.");
                    selectElement.value = ""; // Xóa mã voucher không hợp lệ trên UI
                    code = ""; // Reset mã để gửi request tính toán lại

                    // Gọi lại applyVoucher() ngay lập tức để Server tính lại tiền với voucher rỗng
                    return applyVoucher();

                } else if(code && data.voucherValid) {
                    toastr.success(data.voucherMessage || "Áp dụng mã thành công!");
                }

                // 3. CẬP NHẬT UI TỔNG TIỀN
                updateTotals(data.subTotal, data.discountAmount, data.finalTotal);

                // 4. BẬT NÚT ĐẶT HÀNG
                if (currentCart.length > 0) {
                    btnPlaceOrder.disabled = false;
                }
            })
            .catch(err => {
                console.error("Lỗi tính tiền:", err);
                // Hiển thị thông báo lỗi từ Server (nếu có)
                toastr.error(err.message || "Không thể tính lại tổng tiền. Vui lòng thử lại.");
                btnPlaceOrder.disabled = false;
            });
    }

    // =========================================================================
    // 5. XỬ LÝ ĐẶT HÀNG
    // =========================================================================
    document.getElementById('btnPlaceOrder').addEventListener('click', function() {
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('addressDetail').value.trim();
        const citySel = document.getElementById('city');
        const distSel = document.getElementById('district');
        const wardSel = document.getElementById('ward');

        if(!fullName || !phone || !address || !citySel.value || !distSel.value || !wardSel.value) {
            toastr.error('Vui lòng điền đầy đủ thông tin giao hàng!'); return;
        }
        if (currentCart.length === 0) { toastr.error('Giỏ hàng trống!'); return; }

        // Kiểm tra finalTotal để chắc chắn không phải là NaN
        const finalTotalText = document.getElementById('finalTotal').innerText;
        if(finalTotalText === '0 ₫' && currentCart.length > 0) {
            // Có thể có lỗi tính toán, yêu cầu chạy lại applyVoucher
            toastr.warning('Đang kiểm tra lại tổng tiền. Vui lòng chờ 1 chút.');
            applyVoucher();
            return;
        }

        Swal.fire({
            title: 'Xác nhận đặt hàng?', text: "Đơn hàng sẽ được gửi đi.", icon: 'question',
            showCancelButton: true, confirmButtonColor: '#0b72ff', confirmButtonText: 'Đồng ý, Đặt hàng!', cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) submitOrderToServer();
        });
    });

    function submitOrderToServer() {
        const citySel = document.getElementById('city');
        const distSel = document.getElementById('district');
        const wardSel = document.getElementById('ward');

        // LẤY TÊN NGẮN GỌN (ĐÃ SỬA ĐỂ LOẠI BỎ 'Tỉnh', 'Huyện', 'Xã')
        const selectedCityName = citySel.value
            ? citySel.options[citySel.selectedIndex].getAttribute('data-name').replace(/Tỉnh |Thành phố /g, '').trim()
            : '';
        const selectedDistrictName = distSel.value
            ? distSel.options[distSel.selectedIndex].getAttribute('data-name').replace(/Quận |Huyện /g, '').trim()
            : '';
        const selectedWardName = wardSel.value
            ? wardSel.options[wardSel.selectedIndex].getAttribute('data-name').replace(/Phường |Xã /g, '').trim()
            : '';

        const payload = {
            fullName: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,

            // GỬI TÊN ĐÃ LỌC
            city: selectedCityName,
            district: selectedDistrictName,
            ward: selectedWardName,

            addressDetail: document.getElementById('addressDetail').value,
            note: document.getElementById('note').value,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
            voucherCode: document.getElementById('voucherSelect').value,
            shippingFee: SHIPPING_FEE,
            items: currentCart.map(i => ({
                sanPhamChiTietId: i.id,
                soLuong: i.quantity
            }))
        };

        const btn = document.getElementById('btnPlaceOrder');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ĐANG XỬ LÝ...'; btn.disabled = true;

        fetch('/api/checkout/place-order', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if(data.success) {
                // Xóa giỏ hàng chỉ khi thanh toán COD thành công hoặc khi VNPAY chuyển hướng
                if(data.paymentMethod === 'COD' || data.redirectUrl) {
                    localStorage.removeItem('cartItems');
                }

                if(data.redirectUrl) {
                    Swal.fire({ icon: 'success', title: 'Chuyển hướng thanh toán...', timer: 1500, showConfirmButton: false })
                        .then(() => window.location.href = data.redirectUrl);
                } else {
                    Swal.fire({ icon: 'success', title: 'Đặt hàng thành công!', text: 'Đơn hàng của bạn đang được xử lý.', showConfirmButton: false, timer: 2000 })
                        .then(() => window.location.href = '/order-success');
                }
            } else {
                Swal.fire({ icon: 'error', title: 'Thất bại', text: data.message });
                btn.innerHTML = originalText; btn.disabled = false;
            }
        }).catch(err => {
            console.error(err);
            Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Không thể kết nối Server.' });
            btn.innerHTML = originalText; btn.disabled = false;
        });
    }
</script>

</body>
</html>