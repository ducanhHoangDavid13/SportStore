<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org ">
<head >
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" th:href="@{/css/navbar.css}"></head>
<link rel="stylesheet" href="css/styles.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.2/css/dataTables.bootstrap5.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" /> </head>
<body>
<nav th:replace="library/navbar :: admin-navbar"></nav>

<div class="page-wrapper ">
    <div th:replace="library/navbar :: admin-sidebar"></div>
    <main class="main-content  " >

        <div class="container ">
            <div class="row mb-3 p-3 border rounded bg-light">
                <h5 class="mb-3 text-info"><i class="fas fa-filter"></i> Bộ lọc tìm kiếm</h5>

                <form id="filterForm">
                    <div class="d-flex flex-wrap align-items-end gap-3">
                        <div class="form-group" style="min-width: 200px;">
                            <label for="searchCodeName" class="form-label visually-hidden">Theo mã, tên</label>
                            <input type="text" id="keyword" class="form-control form-control-sm" placeholder="Tìm theo mã, tên">
                        </div>

                        <div class="form-group" style="min-width: 200px;">
                            <label for="searchPhone" class="form-label visually-hidden">Số điện thoại</label>
                            <input type="text" id="sdt" class="form-control form-control-sm" placeholder="Số điện thoại">
                        </div>

                        <div class="form-group" style="min-width: 150px;">
                            <label for="genderSelect" class="form-label visually-hidden">Giới tính</label>
                            <select id="gioiTinh" class="form-select form-select-sm">
                                <option value="">Chọn giới tính</option> <option value="true">Nam</option>       <option value="false">Nữ</option>      </select>
                        </div>

                        <div class="form-group d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-search"></i> Lọc
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnReset">
                                <i class="fas fa-redo-alt"></i> Reset
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="row">
                <div class="col-12 data-panel">
                    <h3 class="mb-3" >Khách hàng</h3>

                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal"
                                data-bs-target="#addKhachHangModal" ><i class="fas fa-user-plus"></i> Thêm Khách hàng</button>
                        <button class="btn btn-secondary btn-sm"><i class="fas fa-file-export"></i> Xuất file</button>
                    </div>

                    <div class="table-responsive" style="height: 250px" >
                        <table class="table table-bordered table-hover table-sm" >
                            <thead class="thead-light">
                            <tr>
                                <th>Mã khách hàng</th>
                                <th>Tên khách hàng</th>
                                <th>Điện thoại</th>
                                <th>Email</th>
                                <th>Tuổi</th>
                                <th>Giới tính</th>
                                <th>Thao tác</th>
                            </tr>
                            </thead>
                            <tbody id="khachHangTableBody">
                            <tr><td colspan="7" class="text-center">Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>


                    <div class="d-flex justify-content-between align-items-center mt-3 ">
                        <nav id="paginationNav">
                        </nav>
                    </div>

                    <ul class="nav nav-tabs mt-4">
                        <li class="nav-item"><a  class="nav-link active " data-bs-toggle="tab" href="#tabdiachi"><p style="color: black;">Địa chỉ</p></a></li>
                    </ul>
                    <div class="tab-content border p-3 bg-white">
                        <div class="tab-pane fade show active" id="tabdiachi" role="tabpanel">
                            <table class="table table-sm table-striped" id="diaChiTable"> <thead class="bg-light">
                            <tr>
                                <th>Họ tên</th>
                                <th>Số điện thoại</th>
                                <th>Địa chỉ cụ thể</th>
                                <th>Xã</th>
                                <th>Thành phố</th>
                                <th>Loại địa chỉ</th>
                                <th>Ghi chú</th>
                            </tr>
                            </thead>
                                <tbody id="diaChiTableBody"> <tr><td colspan="7" class="text-center">Vui lòng chọn một khách hàng để xem địa chỉ.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="modal fade" id="addKhachHangModal" tabindex="-1" aria-labelledby="addKhachHangModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <form id="khachHangForm" method="post">
                        <div class="modal-header bg-primary text-white"> <h5 class="modal-title" id="addKhachHangModalLabel"><i class="fas fa-user-plus me-2"></i> THÊM THÔNG TIN KHÁCH HÀNG</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">

                                <div class="col-md-6 mb-3">
                                    <label for="newMaKhachHang" class="form-label">Mã Khách hàng (*)</label>
                                    <input type="text" class="form-control" id="newMaKhachHang" placeholder="Ví dụ: KH001" required>
                                    <div class="invalid-feedback" id="error-newMaKhachHang"></div> <div class="form-text">Mã khách hàng phải là duy nhất.</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="newTenKhachHang" class="form-label">Tên Khách hàng (*)</label>
                                    <input type="text" class="form-control" id="newTenKhachHang" placeholder="Nhập họ và tên đầy đủ" required>
                                    <div class="invalid-feedback" id="error-newTenKhachHang"></div> </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newSoDienThoai" class="form-label">Số Điện thoại</label>
                                    <input type="text" class="form-control" id="newSoDienThoai" placeholder="0XXXXXXXXX">
                                    <div class="invalid-feedback" id="error-newSoDienThoai"></div> </div>

                                <div class="col-md-6 mb-3">
                                    <label for="newEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="newEmail" placeholder="vd: tenkhachhang@gmail.com">
                                    <div class="invalid-feedback" id="error-newEmail"></div> </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newNamSinh" class="form-label">Năm Sinh</label>
                                    <input type="number" class="form-control" id="newNamSinh" min="1900" max="2025" placeholder="YYYY">
                                    <div class="invalid-feedback" id="error-newNamSinh"></div> </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Giới Tính</label><br>
                                    <div class="d-flex gap-4 pt-1"> <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="newGioiTinh" id="newGioiTinhNam" value="true">
                                        <label class="form-check-label" for="newGioiTinhNam">
                                            <i class="fas fa-mars text-info"></i> Nam
                                        </label>
                                    </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="newGioiTinh" id="newGioiTinhNu" value="false">
                                            <label class="form-check-label" for="newGioiTinhNu">
                                                <i class="fas fa-venus text-danger"></i> Nữ
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info py-2 mt-3" role="alert">
                                Các trường có dấu (*) là bắt buộc.
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Đóng</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Lưu Khách hàng</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editKhachHangModal" tabindex="-1" aria-labelledby="editKhachHangModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <form id="editKhachHangForm" method="post">

                        <input type="hidden" id="editKhachHangId" name="id">

                        <div class="modal-header bg-warning text-dark"> <h5 class="modal-title" id="editKhachHangModalLabel"><i class="fas fa-edit me-2"></i> CẬP NHẬT THÔNG TIN KHÁCH HÀNG</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">

                                <div class="col-md-6 mb-3">
                                    <label for="editMaKhachHang" class="form-label">Mã Khách hàng (*)</label>
                                    <input type="text" class="form-control" id="editMaKhachHang" placeholder="Ví dụ: KH001" required>
                                    <div class="invalid-feedback" id="error-editMaKhachHang"></div> <div class="form-text">Mã khách hàng phải là duy nhất.</div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="editTenKhachHang" class="form-label">Tên Khách hàng (*)</label>
                                    <input type="text" class="form-control" id="editTenKhachHang" placeholder="Nhập họ và tên đầy đủ" required>
                                    <div class="invalid-feedback" id="error-editTenKhachHang"></div> </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editSoDienThoai" class="form-label">Số Điện thoại</label>
                                    <input type="text" class="form-control" id="editSoDienThoai" placeholder="0XXXXXXXXX">
                                    <div class="invalid-feedback" id="error-editSoDienThoai"></div> </div>

                                <div class="col-md-6 mb-3">
                                    <label for="editEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editEmail" placeholder="vd: tenkhachhang@gmail.com">
                                    <div class="invalid-feedback" id="error-editEmail"></div> </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editNamSinh" class="form-label">Năm Sinh</label>
                                    <input type="number" class="form-control" id="editNamSinh" min="1900" max="2025" placeholder="YYYY">
                                    <div class="invalid-feedback" id="error-editNamSinh"></div> </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Giới Tính</label><br>
                                    <div class="d-flex gap-4 pt-1">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="editGioiTinh" id="editGioiTinhNam" value="true">
                                            <label class="form-check-label" for="editGioiTinhNam">
                                                <i class="fas fa-mars text-info"></i> Nam
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="editGioiTinh" id="editGioiTinhNu" value="false">
                                            <label class="form-check-label" for="editGioiTinhNu">
                                                <i class="fas fa-venus text-danger"></i> Nữ
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning py-2 mt-3" role="alert">
                                Lưu ý: Bạn đang thay đổi thông tin của khách hàng hiện tại.
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Hủy</button>
                            <button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt me-1"></i> Cập nhật</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="deleteKhachHangModal" tabindex="-1" aria-labelledby="deleteKhachHangModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteKhachHangModalLabel"><i class="fas fa-exclamation-triangle me-2"></i> XÁC NHẬN XÓA</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="deleteKhachHangId">
                        <p>Bạn có chắc chắn muốn xóa khách hàng có mã **<span id="deleteKhachHangMa"></span>** không? Thao tác này không thể hoàn tác.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Hủy</button>
                        <button type="button" class="btn btn-danger btn-sm" id="btnConfirmDelete"><i class="fas fa-trash-alt me-1"></i> Xóa</button>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script> <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/my-custom-scripts.js}"></script>


<script>
    // Cấu hình Toastr mặc định
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "3000"
    };

    $(document).ready(function() {
        // Biến toàn cục để lưu trạng thái lọc và phân trang hiện tại
        let currentFilter = {
            pageNo: 1,
            keyword: '',
            sdt: '',
            gioiTinh: ''
        };

        // ==========================================================
        // KHỐI HÀM VALIDATION
        // ==========================================================

        function clearValidationErrors(prefix) {
            // Xóa tất cả các trạng thái lỗi và thông báo lỗi hiển thị trên form
            $(`#${prefix}KhachHangForm .form-control`).removeClass('is-invalid');
            $(`#${prefix}KhachHangModal .invalid-feedback`).empty();
        }

        function validateKhachHangForm(prefix) {
            clearValidationErrors(prefix); // Luôn dọn dẹp lỗi cũ trước khi kiểm tra

            let isValid = true;

            // Lấy giá trị
            const maKhachHang = $('#' + prefix + 'MaKhachHang').val().trim();
            const tenKhachHang = $('#' + prefix + 'TenKhachHang').val().trim();
            const soDienThoai = $('#' + prefix + 'SoDienThoai').val().trim();
            const email = $('#' + prefix + 'Email').val().trim();
            const namSinhStr = $('#' + prefix + 'NamSinh').val().trim();

            // Hàm hiển thị lỗi
            const setError = (fieldId, message) => {
                $(`#${prefix}${fieldId}`).addClass('is-invalid');
                $(`#error-${prefix}${fieldId}`).text(message);
                isValid = false;
            };

            // 1. Kiểm tra trường BẮT BUỘC (Mã KH, Tên KH)
            if (!maKhachHang) {
                setError('MaKhachHang', "Mã Khách hàng không được để trống.");
            }
            if (!tenKhachHang) {
                setError('TenKhachHang', "Tên Khách hàng không được để trống.");
            }

            // 2. Kiểm tra Số Điện Thoại
            if (soDienThoai) {
                // Regex: 10 chữ số, bắt đầu bằng 0
                const phoneRegex = /^0\d{9}$/;
                if (!phoneRegex.test(soDienThoai)) {
                    setError('SoDienThoai', "Số Điện thoại phải là 10 chữ số và bắt đầu bằng số 0.");
                }
            }

            // 3. Kiểm tra Email
            if (email) {
                // Regex kiểm tra định dạng email cơ bản
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    setError('Email', "Email không đúng định dạng (ví dụ: user@domain.com).");
                }
            }

            // 4. Kiểm tra Năm Sinh
            if (namSinhStr) {
                const namSinh = parseInt(namSinhStr);

                if (isNaN(namSinh)) {
                    setError('NamSinh', "Năm Sinh phải là một số.");
                } else if (namSinh < 1900 || namSinh > 2025) {
                    setError('NamSinh', "Năm Sinh phải nằm trong khoảng từ 1900 đến 2025.");
                }
            }

            return isValid;
        }


        // ==========================================================
        // KHỐI HÀM CHÍNH: KHÁCH HÀNG (LOAD, RENDER)
        // ==========================================================

        function loadKhachHang() {
            let params = {
                pageNo: currentFilter.pageNo,
                keyword: currentFilter.keyword,
                sdt: currentFilter.sdt,
                gioiTinh: currentFilter.gioiTinh === 'true' ? true : (currentFilter.gioiTinh === 'false' ? false : null)
            };

            $('#khachHangTableBody').html('<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...</td></tr>');
            renderDiaChiTable([]);

            $.ajax({
                url: "/api/khach-hang",
                type: "GET",
                data: params,
                dataType: "json",
                success: function(response) {
                    renderTable(response.content);
                    renderPagination(response.number + 1, response.totalPages);
                },
                error: function(error) {
                    console.error("Lỗi khi tải dữ liệu:", error);
                    toastr.error("Không tải được dữ liệu khách hàng. Vui lòng kiểm tra API.", "Lỗi tải dữ liệu");
                    $('#khachHangTableBody').html('<tr><td colspan="7" class="text-danger text-center">Lỗi: Không tải được dữ liệu khách hàng. Vui lòng kiểm tra API.</td></tr>');
                }
            });
        }

        function renderTable(khachHangList) {
            let html = '';
            if (khachHangList.length === 0) {
                html = '<tr><td colspan="7" class="text-center">Không tìm thấy khách hàng nào.</td></tr>';
            } else {
                khachHangList.forEach(function(kh) {
                    let gioiTinhText = kh.gioiTinh === true ? 'Nam' : (kh.gioiTinh === false ? 'Nữ' : 'N/A');
                    let tuoi = kh.tuoi !== null ? kh.tuoi : 'N/A';

                    html += '<tr data-id="' + kh.id + '" data-ma="' + kh.maKhachHang + '" class="clickable-row">';
                    html += '<td>' + kh.maKhachHang + '</td>';
                    html += '<td>' + kh.tenKhachHang + '</td>';
                    html += '<td>' + (kh.soDienThoai || '') + '</td>';
                    html += '<td>' + (kh.email || '') + '</td>';
                    html += '<td>' + tuoi + '</td>';
                    html += '<td>' + gioiTinhText + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-warning btn-sm me-2 btn-edit" data-id="' + kh.id + '">Sửa</button>';
                    html += '<button class="btn btn-danger btn-sm btn-delete" data-id="' + kh.id + '" data-ma="' + kh.maKhachHang + '">Xóa</button>';
                    html += '</td>';
                    html += '</tr>';
                });
            }
            $('#khachHangTableBody').html(html);
        }

        function renderPagination(currentPage, totalPages) {
            if (totalPages <= 1) {
                $('#paginationNav').empty();
                return;
            }

            let paginationHtml = '<ul class="pagination pagination-sm mb-0">';
            let prevDisabled = currentPage === 1 ? 'disabled' : '';
            paginationHtml += '<li class="page-item ' + prevDisabled + '"><a class="page-link" href="#" data-page="' + (currentPage - 1) + '">&laquo;</a></li>';

            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                let active = currentPage === i ? 'active' : '';
                paginationHtml += '<li class="page-item ' + active + '"><a class="page-link" href="#" data-page="' + i + '">' + i + '</a></li>';
            }

            let nextDisabled = currentPage === totalPages ? 'disabled' : '';
            paginationHtml += '<li class="page-item ' + nextDisabled + '"><a class="page-link" href="#" data-page="' + (currentPage + 1) + '">&raquo;</a></li>';

            paginationHtml += '</ul>';

            $('#paginationNav').html(paginationHtml);

            $('#paginationNav').off('click', 'a.page-link').on('click', 'a.page-link', function(e) {
                e.preventDefault();
                if ($(this).parent().hasClass('disabled')) return;
                currentFilter.pageNo = $(this).data('page');
                loadKhachHang();
            });
        }


        // ==========================================================
        // KHỐI HÀM ĐỊA CHỈ (LOAD & RENDER)
        // ==========================================================

        function renderDiaChiTable(diaChiList) {
            let html = '';
            if (diaChiList.length === 0) {
                html = '<tr><td colspan="7" class="text-center">Khách hàng này chưa có địa chỉ hoạt động nào được lưu.</td></tr>';
            } else {
                diaChiList.forEach(function(dc) {
                    html += '<tr>';
                    html += '<td>' + (dc.hoTen || '') + '</td>';
                    html += '<td>' + (dc.soDienThoai || '') + '</td>';
                    html += '<td>' + (dc.diaChiCuThe || '') + '</td>';
                    html += '<td>' + (dc.xa || '') + '</td>';
                    html += '<td>' + (dc.thanhPho || '') + '</td>';
                    html += '<td>' + (dc.loaiDiaChi || '') + '</td>';
                    html += '<td>' + (dc.ghiChu || '') + '</td>';
                    html += '</tr>';
                });
            }
            $('#diaChiTableBody').html(html);
        }

        function loadDiaChiByKhachHangId(khachHangId) {
            if (!khachHangId) {
                $('#diaChiTableBody').html('<tr><td colspan="7" class="text-center">Vui lòng chọn một khách hàng để xem địa chỉ.</td></tr>');
                return;
            }

            $('#diaChiTableBody').html('<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải địa chỉ...</td></tr>');

            $.ajax({
                url: "/api/dia-chi/khach-hang/" + khachHangId,
                type: "GET",
                dataType: "json",
                success: function(response) {
                    renderDiaChiTable(response);
                },
                error: function(error) {
                    console.error("Lỗi khi tải địa chỉ:", error);
                    toastr.error("Không tải được danh sách địa chỉ.", "Lỗi");
                    $('#diaChiTableBody').html('<tr><td colspan="7" class="text-danger text-center">Lỗi: Không tải được danh sách địa chỉ.</td></tr>');
                }
            });
        }


        // ==========================================================
        // KHỐI SỰ KIỆN: TƯƠNG TÁC NGƯỜI DÙNG
        // ==========================================================

        // BẮT SỰ KIỆN: LỌC & RESET
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            currentFilter.keyword = $('#keyword').val();
            currentFilter.sdt = $('#sdt').val();
            currentFilter.gioiTinh = $('#gioiTinh').val();
            currentFilter.pageNo = 1;
            loadKhachHang();
        });

        $('#btnReset').on('click', function() {
            $('#keyword').val('');
            $('#sdt').val('');
            $('#gioiTinh').val('');
            currentFilter = {
                pageNo: 1, keyword: '', sdt: '', gioiTinh: ''
            };
            loadKhachHang();
        });

        // BẮT SỰ KIỆN: CLICK VÀO HÀNG KHÁCH HÀNG (ĐỂ XEM ĐỊA CHỈ)
        $(document).on('click', '#khachHangTableBody tr', function() {
            let khachHangId = $(this).data('id');

            if (khachHangId) {
                // 1. Cập nhật trạng thái chọn (Highlight hàng)
                $('#khachHangTableBody tr').removeClass('table-active');
                $(this).addClass('table-active');

                // 2. Tải và hiển thị địa chỉ tương ứng
                loadDiaChiByKhachHangId(khachHangId);
            }
        });


        // 1. CHỨC NĂNG THÊM MỚI (POST /api/khach-hang)
        $('#khachHangForm').on('submit', function(e) {
            e.preventDefault();

            if (!validateKhachHangForm('new')) {
                toastr.warning("Vui lòng kiểm tra lại các trường bị lỗi.", "Validation");
                return;
            }

            let newKhachHang = {
                maKhachHang: $('#newMaKhachHang').val(),
                tenKhachHang: $('#newTenKhachHang').val(),
                soDienThoai: $('#newSoDienThoai').val(),
                email: $('#newEmail').val(),
                namSinh: $('#newNamSinh').val() ? parseInt($('#newNamSinh').val()) : null,
                gioiTinh: $('input[name="newGioiTinh"]:checked').val() === 'true'
            };

            $.ajax({
                url: "/api/khach-hang",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(newKhachHang),
                success: function(response) {
                    toastr.success("Thêm khách hàng thành công!", "Thành công");

                    $('#addKhachHangModal').modal('hide');
                    clearValidationErrors('new');

                    $('#khachHangForm')[0].reset();
                    currentFilter.pageNo = 1;
                    loadKhachHang();
                },
                error: function(error) {
                    console.error("Lỗi khi thêm khách hàng:", error.responseText);
                    let errorMessage = "Lỗi không xác định khi thêm khách hàng.";
                    if (error.responseJSON && error.responseJSON.message) {
                        errorMessage = "Lỗi: " + error.responseJSON.message;
                    }
                    toastr.error(errorMessage, "Thất bại");
                }
            });
        });

        // 2. CHỨC NĂNG SỬA (Lấy data)
        $(document).on('click', '.btn-edit', function() {
            let khachHangId = $(this).data('id');
            clearValidationErrors('edit');

            $.ajax({
                url: "/api/khach-hang/" + khachHangId,
                type: "GET",
                dataType: "json",
                success: function(kh) {

                    $('#editKhachHangId').val(kh.id);
                    $('#editMaKhachHang').val(kh.maKhachHang);
                    $('#editTenKhachHang').val(kh.tenKhachHang);
                    $('#editSoDienThoai').val(kh.soDienThoai || '');
                    $('#editEmail').val(kh.email || '');
                    $('#editNamSinh').val(kh.namSinh || '');

                    if (kh.gioiTinh === true) {
                        $('#editGioiTinhNam').prop('checked', true);
                    } else if (kh.gioiTinh === false) {
                        $('#editGioiTinhNu').prop('checked', true);
                    } else {
                        $('input[name="editGioiTinh"]').prop('checked', false);
                    }

                    var editModal = new bootstrap.Modal(document.getElementById('editKhachHangModal'));
                    editModal.show();
                },
                error: function(error) {
                    console.error("Lỗi khi lấy chi tiết khách hàng:", error);
                    toastr.error("Không thể tải dữ liệu khách hàng để chỉnh sửa.", "Lỗi");
                }
            });
        });

        // 3. CHỨC NĂNG CẬP NHẬT (PUT /api/khach-hang/{id})
        $('#editKhachHangForm').on('submit', function(e) {
            e.preventDefault();

            if (!validateKhachHangForm('edit')) {
                toastr.warning("Vui lòng kiểm tra lại các trường bị lỗi.", "Validation");
                return;
            }

            let khachHangId = $('#editKhachHangId').val();

            let updatedKhachHang = {
                id: khachHangId,
                maKhachHang: $('#editMaKhachHang').val(),
                tenKhachHang: $('#editTenKhachHang').val(),
                soDienThoai: $('#editSoDienThoai').val(),
                email: $('#editEmail').val(),
                namSinh: $('#editNamSinh').val() ? parseInt($('#editNamSinh').val()) : null,
                gioiTinh: $('input[name="editGioiTinh"]:checked').val() === 'true'
            };

            $.ajax({
                url: "/api/khach-hang/" + khachHangId,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(updatedKhachHang),
                success: function(response) {
                    toastr.success("Cập nhật khách hàng thành công!", "Thành công");

                    $('#editKhachHangModal').modal('hide');
                    clearValidationErrors('edit');
                    loadKhachHang();
                },
                error: function(error) {
                    console.error("Lỗi khi cập nhật khách hàng:", error.responseText);
                    let errorMessage = "Lỗi không xác định khi cập nhật khách hàng.";
                    if (error.responseJSON && error.responseJSON.message) {
                        errorMessage = "Lỗi: " + error.responseJSON.message;
                    }
                    toastr.error(errorMessage, "Thất bại");
                }
            });
        });

        // 4. BẮT SỰ KIỆN: CLICK MỞ MODAL XÓA
        $(document).on('click', '.btn-delete', function() {
            let idToDelete = $(this).data('id');
            let maKhachHang = $(this).data('ma');

            // Đặt ID và Mã khách hàng vào modal xóa
            $('#deleteKhachHangId').val(idToDelete);
            $('#deleteKhachHangMa').text(maKhachHang);

            // Hiển thị modal xóa
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteKhachHangModal'));
            deleteModal.show();
        });

        // 5. CHỨC NĂNG XÓA (DELETE /api/khach-hang/{id})
        $('#btnConfirmDelete').on('click', function() {
            let idToDelete = $('#deleteKhachHangId').val();

            $.ajax({
                url: "/api/khach-hang/" + idToDelete,
                type: "DELETE",
                success: function() {
                    toastr.success("Xóa khách hàng thành công!", "Thành công");

                    $('#deleteKhachHangModal').modal('hide');
                    loadKhachHang();
                },
                error: function(error) {
                    console.error("Lỗi khi xóa khách hàng:", error.responseText);
                    toastr.error("Lỗi khi xóa khách hàng. Vui lòng thử lại.", "Thất bại");
                }
            });
        });


        // KHỞI TẠO: Tải dữ liệu lần đầu khi trang load
        loadKhachHang();
        loadDiaChiByKhachHangId(null);
    });
</script>
</body>
</html>