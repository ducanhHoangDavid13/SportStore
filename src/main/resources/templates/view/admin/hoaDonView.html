<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω H√≥a ƒê∆°n</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <!-- ‚úÖ Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .table thead th { background-color: #e9ecef; text-align: center; }
        .badge { font-size: 0.9rem; padding: 8px 12px; }
        .tab-button {
            border: none; background: none; font-weight: 600; color: #007bff;
            margin-right: 15px; cursor: pointer;
        }
        .tab-button.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; }
        :root {
            --sidebar-width: 260px;
            --navbar-height: 60px;
            --primary-color: #007bff;
            --secondary-bg: #2b3543;
            --text-light: #f8f9fa;
            --active-bg: #0056b3;
        }

        body {
            overflow-x: hidden;
            background-color: #f0f2f5;
        }

        .sidebar-wrapper {
            width: var(--sidebar-width);
            position: fixed;
            top: var(--navbar-height);
            left: 0; bottom: 0;
            overflow-y: auto;
            z-index: 1000;
            background-color: var(--secondary-bg);
            transition: all 0.3s;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            padding-top: calc(var(--navbar-height) + 1.5rem);
            min-height: 100vh;
            transition: margin-left 0.3s;
        }

        .nav-link {
            color: #b8c7e0;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            line-height: 1.2;
            text-decoration: none;
            cursor: pointer;
        }
        .nav-link:hover {
            color: var(--text-light) !important;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .nav-link.active {
            color: var(--text-light) !important;
            background-color: var(--primary-color);
            border-radius: 5px;
            font-weight: 600;
        }
        .menu-text { font-size: 1rem; white-space: normal; }
        .nav-link i.fa-fw { margin-top: 0.15rem; }
        .nav-link .float-end { margin-top: 0.3rem; transition: transform 0.3s; }
        .submenu-item a.nav-link {
            padding-left: 2.5rem;
            font-size: 0.9rem;
            color: #d1d9e7;
            align-items: center;
        }
        .submenu-item a.nav-link:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>

    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.2/css/dataTables.bootstrap5.min.css" />
</head>

<body>
<nav th:replace="~{library/navbar :: admin-navbar}"></nav>

<div class="page-wrapper">
    <div th:replace="~{library/navbar :: admin-sidebar}"></div>
    <main class="main-content">

        <div class="container mt-5">
            <h2 class="text-center mb-4 fw-bold">Qu·∫£n L√Ω H√≥a ƒê∆°n</h2>

            <!-- Tabs -->
            <div class="d-flex justify-content-center mb-4 flex-wrap">
                <button class="tab-button active" data-status="all">T·∫•t c·∫£</button>
                <button class="tab-button" data-status="0">Ch·ªù X√°c Nh·∫≠n</button>
                <button class="tab-button" data-status="1">ƒêang Chu·∫©n B·ªã</button>
                <button class="tab-button" data-status="2">Ho√†n Th√†nh</button>
                <button class="tab-button" data-status="3">ƒê√£ H·ªßy</button>
            </div>

            <!-- B·ªô l·ªçc ng√†y -->
            <div class="d-flex justify-content-center mb-3">
                <input type="date" class="form-control w-25 me-2" id="startDate">
                <input type="date" class="form-control w-25 me-2" id="endDate">
                <button class="btn btn-primary me-2" id="btnSearch">T√¨m ki·∫øm</button>
                <button class="btn btn-secondary" id="btnReset">L√†m m·ªõi</button>
            </div>

            <!-- B·∫£ng danh s√°ch h√≥a ƒë∆°n -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <table class="table table-hover align-middle text-center">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√£ H√≥a ƒê∆°n</th>
                            <th>H√¨nh Th·ª©c Mua H√†ng</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>T·ªïng Ti·ªÅn</th>
                            <th>Thao T√°c</th>
                        </tr>
                        </thead>
                        <tbody id="hoaDonTableBody">
                        <!-- D·ªØ li·ªáu render JS -->
                        </tbody>
                    </table>
                    <!-- ‚úÖ Ph√¢n trang -->
                    <nav>
                        <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
                    </nav>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <p class="text-muted mb-0" id="recordCount">Hi·ªÉn th·ªã 0 h√≥a ƒë∆°n</p>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
        <script th:src="@{/js/my-custom-scripts.js}"></script>

        <script>
            const API_BASE = "/api/hoadon";
            const tableBody = document.getElementById("hoaDonTableBody");
            const recordCount = document.getElementById("recordCount");
            const pagination = document.getElementById("pagination");

            let allHoaDon = [];
            let currentPage = 1;
            const itemsPerPage = 5;

            function renderStatus(status) {
                switch (status) {
                    case 0: return `<span class="badge bg-warning">Ch·ªù x√°c nh·∫≠n</span>`;
                    case 1: return `<span class="badge bg-info text-dark">ƒêang chu·∫©n b·ªã</span>`;
                    case 2: return `<span class="badge bg-success-subtle text-success fw-semibold">Ho√†n th√†nh</span>`;
                    case 3: return `<span class="badge bg-secondary">ƒê√£ h·ªßy</span>`;
                    default: return `<span class="badge bg-danger">Kh√¥ng x√°c ƒë·ªãnh</span>`;
                }
            }

            function renderPagination(totalItems) {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                pagination.innerHTML = "";
                if (totalPages <= 1) return;

                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement("li");
                    li.className = "page-item " + (i === currentPage ? "active" : "");
                    li.innerHTML = `<button class="page-link">${i}</button>`;
                    li.addEventListener("click", () => {
                        currentPage = i;
                        renderTable();
                    });
                    pagination.appendChild(li);
                }
            }

            function renderTable() {
                tableBody.innerHTML = "";
                const start = (currentPage - 1) * itemsPerPage;
                const paginated = allHoaDon.slice(start, start + itemsPerPage);

                if (paginated.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-muted">Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o</td></tr>`;
                    recordCount.innerText = "Hi·ªÉn th·ªã 0 h√≥a ƒë∆°n";
                    return;
                }

                paginated.forEach((hd, i) => {
                    tableBody.innerHTML += `
                <tr>
                    <td>${start + i + 1}</td>
                    <td>${hd.maHoaDon || "HD" + hd.id}</td>
                    <td>${hd.hinhThucBanHang === 0 ? "T·∫°i qu·∫ßy" : "Mua h√†ng online"}</td>
                    <td>${renderStatus(hd.trangThai)}</td>
                    <td>${hd.tongTien?.toLocaleString("vi-VN")} VND</td>
                    <td>
                        <button class="btn btn-success btn-sm">X√°c nh·∫≠n</button>
                        <button class="btn btn-danger btn-sm">H·ªßy</button>
                    </td>
                </tr>`;
                });

                recordCount.innerText = `Hi·ªÉn th·ªã ${allHoaDon.length} h√≥a ƒë∆°n`;
                renderPagination(allHoaDon.length);
            }

            async function loadHoaDon(status = "all") {
                let url = `${API_BASE}/list`;
                if (status !== "all") url = `${API_BASE}/trangthai?trangThai=${status}`;

                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu: " + res.status);
                    allHoaDon = await res.json();
                    currentPage = 1;
                    renderTable();
                } catch (e) {
                    console.error(e);
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</td></tr>`;
                }
            }

            // Tabs
            document.querySelectorAll(".tab-button").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    const status = btn.getAttribute("data-status");
                    loadHoaDon(status);
                });
            });

            // L·ªçc theo ng√†y
            document.getElementById("btnSearch").addEventListener("click", async () => {
                const start = document.getElementById("startDate").value;
                const end = document.getElementById("endDate").value;
                if (!start || !end) {
                    alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!");
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/date?start=${start}&end=${end}`);
                    if (!res.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");
                    allHoaDon = await res.json();
                    currentPage = 1;
                    renderTable();
                } catch (e) {
                    console.error(e);
                }
            });

            // L√†m m·ªõi
            document.getElementById("btnReset").addEventListener("click", () => {
                document.getElementById("startDate").value = "";
                document.getElementById("endDate").value = "";
                document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
                document.querySelector('.tab-button[data-status="all"]').classList.add("active");
                loadHoaDon("all");
            });

            // üöÄ Load d·ªØ li·ªáu ban ƒë·∫ßu
            loadHoaDon();

            document.addEventListener("DOMContentLoaded", function() {

                // 1. T√¨m n√∫t b·∫•m
                const toggleButton = document.getElementById('sidebarToggleBtn');

                if (toggleButton) {
                    // 2. Th√™m s·ª± ki·ªán click
                    toggleButton.addEventListener('click', function(e) {
                        e.preventDefault(); // NgƒÉn tr√¨nh duy·ªát nh·∫£y link

                        // 3. Th√™m/X√≥a class 'sidebar-toggled' tr√™n th·∫ª <body>
                        document.body.classList.toggle('sidebar-toggled');
                    });
                }

            });
        </script>
    </main>
</div>
</body>
</html>
