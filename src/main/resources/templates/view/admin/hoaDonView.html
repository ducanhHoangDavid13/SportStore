<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω H√≥a ƒê∆°n</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* (CSS C·ª¶A B·∫†N - GI·ªÆ NGUY√äN) */
        body { background-color: #f8f9fa; }
        .table thead th { background-color: #e9ecef; text-align: center; }
        .badge { font-size: 0.9rem; padding: 8px 12px; }
        .tab-button {
            border: none; background: none; font-weight: 600; color: #007bff;
            margin-right: 15px; cursor: pointer;
        }
        .tab-button.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; }
        /* (C√°c style kh√°c gi·ªØ nguy√™n) */
    </style>

    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
</head>

<body>
<nav th:replace="~{library/navbar :: admin-navbar}"></nav>

<div class="page-wrapper">
    <div th:replace="~{library/navbar :: admin-sidebar}"></div>
    <main class="main-content">

        <div class="container mt-5">
            <h2 class="text-center mb-4 fw-bold"><i class="bi bi-receipt-cutoff me-2"></i>Qu·∫£n L√Ω H√≥a ƒê∆°n</h2>

            <div class="d-flex justify-content-center mb-4 flex-wrap">
                <button class="tab-button active" data-status="all">T·∫•t c·∫£</button>
                <button class="tab-button" data-status="0">Ch·ªù X√°c Nh·∫≠n</button>
                <button class="tab-button" data-status="1">ƒêang Chu·∫©n B·ªã</button>
                <button class="tab-button" data-status="2">Ho√†n Th√†nh</button>
                <button class="tab-button" data-status="3">ƒê√£ H·ªßy</button>
            </div>

            <div class="d-flex justify-content-center mb-3">
                <input type="date" class="form-control w-25 me-2" id="startDate">
                <input type="date" class="form-control w-25 me-2" id="endDate">
                <button class="btn btn-primary me-2" id="btnSearch"><i class="bi bi-search me-1"></i>T√¨m ki·∫øm</button>
                <button class="btn btn-secondary" id="btnReset"><i class="bi bi-arrow-clockwise me-1"></i>L√†m m·ªõi</button>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <table class="table table-hover align-middle text-center">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√£ H√≥a ƒê∆°n</th>
                            <th>H√¨nh Th·ª©c Mua H√†ng</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>T·ªïng Ti·ªÅn</th>
                            <th>Thao T√°c</th>
                        </tr>
                        </thead>
                        <tbody id="hoaDonTableBody">
                        </tbody>
                    </table>
                    <nav>
                        <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
                    </nav>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <p class="text-muted mb-0" id="recordCount">Hi·ªÉn th·ªã 0 h√≥a ƒë∆°n</p>
            </div>
        </div>

    </main>
</div>

<div class="modal fade" id="invoiceDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-text me-2"></i>Chi Ti·∫øt H√≥a ƒê∆°n #<span id="detail-maHoaDon"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoice-detail-content">
                <p class="text-center text-muted">ƒêang t·∫£i...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script th:src="@{/js/my-custom-scripts.js}"></script>

<script>
    // C·∫•u h√¨nh Toastr (Th√¥ng b√°o)
    toastr.options = { "positionClass": "toast-top-right", "timeOut": "3000", "closeButton": true };

    // --- KHAI B√ÅO BI·∫æN C·ªêT L√ïI ---
    const API_BASE = "/api/admin/hoadon";
    const tableBody = document.getElementById("hoaDonTableBody");
    const recordCountEl = document.getElementById("recordCount");
    const paginationEl = document.getElementById("pagination");

    let currentPage = 0;
    let currentTrangThai = 'all';
    let currentFilters = {};
    const itemsPerPage = 10;

    // --- L·∫§Y DOM MODAL V√Ä L·ªåC ---
    const tabButtons = document.querySelectorAll(".tab-button");
    const btnSearch = document.getElementById("btnSearch");
    const btnReset = document.getElementById("btnReset");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");

    const detailModal = new bootstrap.Modal(document.getElementById('invoiceDetailModal'));
    const detailMaHoaDonEl = document.getElementById('detail-maHoaDon');
    const detailContentEl = document.getElementById('invoice-detail-content');


    // --- H√ÄM 1: RENDER TR·∫†NG TH√ÅI ---
    function renderStatus(status) {
        switch (status) {
            case 0: return `<span class="badge bg-warning">Ch·ªù X√°c Nh·∫≠n</span>`;
            case 1: return `<span class="badge bg-info text-dark">ƒêang Chu·∫©n B·ªã</span>`;
            case 2: return `<span class="badge bg-success-subtle text-success fw-semibold">Ho√†n Th√†nh</span>`;
            case 3: return `<span class="badge bg-danger">ƒê√£ H·ªßy</span>`;
            case 5: return `<span class="badge bg-primary">Ch·ªù TT (VNPAY/CK)</span>`;
            default: return `<span class="badge bg-secondary">T·∫°m (L∆∞u)</span>`;
        }
    }

    // --- H√ÄM 2: RENDER PH√ÇN TRANG ---
    function renderPagination(totalPages) {
        paginationEl.innerHTML = "";
        if (totalPages <= 1) return;

        for (let i = 0; i < totalPages; i++) {
            const li = document.createElement("li");
            li.className = "page-item " + (i === currentPage ? "active" : "");
            li.innerHTML = `<button class="page-link" data-page="${i}">${i + 1}</button>`;
            li.addEventListener("click", () => {
                loadHoaDon(i);
            });
            paginationEl.appendChild(li);
        }
    }

    // --- H√ÄM 3: G·∫ÆN S·ª∞ KI·ªÜN N√öT B·∫§M (H·ªßy/X√°c nh·∫≠n V√Ä Chi ti·∫øt) ---
    function addEventListenersToButtons() {
        // G·∫Øn s·ª± ki·ªán H·ªßy/X√°c nh·∫≠n
        tableBody.querySelectorAll('.btn-update-status').forEach(button => {
            button.addEventListener('click', (e) => {
                const hoaDonId = e.target.dataset.id;
                const newStatus = e.target.dataset.newStatus;

                let actionText = newStatus === '3' ? 'H·ª¶Y' : (newStatus === '2' ? 'HO√ÄN TH√ÄNH' : 'X√ÅC NH·∫¨N');

                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${actionText} h√≥a ƒë∆°n n√†y?`)) {
                    // Hi·ªáu ·ª©ng m·ªù khi x·ª≠ l√Ω
                    e.target.closest('tr').style.opacity = 0.5;
                    handleUpdateStatus(hoaDonId, newStatus);
                }
            });
        });

        // G·∫Øn s·ª± ki·ªán XEM CHI TI·∫æT
        tableBody.querySelectorAll('.btn-view-detail').forEach(button => {
            button.addEventListener('click', (e) => {
                const hoaDonId = e.target.dataset.id;
                fetchAndRenderDetails(hoaDonId); // G·ªçi h√†m t·∫£i chi ti·∫øt
            });
        });
    }

    // --- H√ÄM 4: RENDER B·∫¢NG V√Ä T·ªîNG H·ª¢P ---
    function renderTable(hoaDonList, totalItems, totalPages) {
        tableBody.innerHTML = "";

        if (hoaDonList.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o</td></tr>`;
            recordCountEl.innerText = "Hi·ªÉn th·ªã 0 h√≥a ƒë∆°n";
            return;
        }

        hoaDonList.forEach((hd, i) => {
            const stt = (currentPage * itemsPerPage) + i + 1;
            let buttonsHtml = '';

            // Logic n√∫t b·∫•m:
            if (hd.trangThai === 0) { // Ch·ªù x√°c nh·∫≠n
                buttonsHtml = `
                    <button class="btn btn-success btn-sm btn-update-status"
                            data-id="${hd.id}" data-new-status="1"><i class="bi bi-check-circle"></i> X√°c nh·∫≠n</button>
                    <button class="btn btn-danger btn-sm btn-update-status"
                            data-id="${hd.id}" data-new-status="3"><i class="bi bi-x-circle"></i> H·ªßy</button>
                `;
            } else if (hd.trangThai === 1) { // ƒêang Chu·∫©n B·ªã
                buttonsHtml = `
                    <button class="btn btn-primary btn-sm btn-update-status"
                            data-id="${hd.id}" data-new-status="2"><i class="bi bi-truck"></i> Ho√†n t·∫•t</button>
                `;
            } else if (hd.trangThai === 5) { // Ch·ªù TT (VNPAY/CK)
                buttonsHtml = `
                    <button class="btn btn-success btn-sm btn-update-status"
                            data-id="${hd.id}" data-new-status="1"><i class="bi bi-check-all"></i> X√°c nh·∫≠n TT</button>
                    <button class="btn btn-danger btn-sm btn-update-status"
                            data-id="${hd.id}" data-new-status="3"><i class="bi bi-x-circle"></i> H·ªßy</button>
                `;
            }

            tableBody.innerHTML += `
                <tr style="opacity: 0; transition: opacity 0.5s ease-in;">
                    <td>${stt}</td>
                    <td>${hd.maHoaDon || "HD" + hd.id}</td>
                    <td>${hd.hinhThucBanHang === 1 ? "T·∫°i qu·∫ßy" : "Mua h√†ng online"}</td>
                    <td>${renderStatus(hd.trangThai)}</td>
                    <td>${hd.tongTien?.toLocaleString("vi-VN")} VND</td>
                    <td>
                        <button class="btn btn-info btn-sm me-1 btn-view-detail" data-id="${hd.id}"><i class="bi bi-eye"></i> Xem chi ti·∫øt</button>
                        ${buttonsHtml}
                    </td>
                </tr>`;
        });

        recordCountEl.innerText = `Hi·ªÉn th·ªã ${totalItems} h√≥a ƒë∆°n`;
        renderPagination(totalPages);
        addEventListenersToButtons();

        // K√≠ch ho·∫°t hi·ªáu ·ª©ng fade-in sau khi c√°c h√†ng ƒë∆∞·ª£c th√™m v√†o DOM
        setTimeout(() => {
            tableBody.querySelectorAll('tr').forEach(row => {
                row.style.opacity = 1;
            });
        }, 50);
    }


    // --- H√ÄM 5: G·ªåI API ƒê·ªÇ C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI ---
    async function handleUpdateStatus(hoaDonId, newStatus) {
        try {
            const formData = new FormData();
            formData.append('hoaDonId', hoaDonId);
            formData.append('newTrangThai', newStatus);

            const response = await fetch(`${API_BASE}/update-status`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                // Reset opacity khi l·ªói
                document.querySelector(`[data-id="${hoaDonId}"]`).closest('tr').style.opacity = 1;
                throw new Error(result.message || 'L·ªói c·∫≠p nh·∫≠t');
            }

            toastr.success(result.message);
            loadHoaDon(currentPage); // T·∫£i l·∫°i trang hi·ªán t·∫°i

        } catch (error) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
            toastr.error(error.message);
        }
    }

    // --- H√ÄM 6: T·∫¢I V√Ä HI·ªÇN TH·ªä CHI TI·∫æT H√ìA ƒê∆†N (MODAL) ---
    async function fetchAndRenderDetails(hoaDonId) {
        detailContentEl.innerHTML = '<div class="text-center text-primary p-5"><i class="fas fa-spinner fa-spin me-2"></i>ƒêang t·∫£i chi ti·∫øt...</div>';
        detailModal.show();

        try {
            const response = await fetch(`${API_BASE}/${hoaDonId}`);

            if (response.status === 404) throw new Error("Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†y.");
            if (!response.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");

            const hd = await response.json();

            // L·∫•y chi ti·∫øt h√≥a ƒë∆°n (JSON) v√† ƒë·ªãnh d·∫°ng
            const customerName = hd.khachHang ? hd.khachHang.tenKhachHang : "Kh√°ch l·∫ª";
            const employeeName = hd.nhanVien ? hd.nhanVien.tenNhanVien : "N/A";
            const thucBanHang = hd.hinhThucBanHang === 1 ? "T·∫°i qu·∫ßy" : "Online";
            const ngayTao = new Date(hd.ngayTao).toLocaleString('vi-VN');

            // X√¢y d·ª±ng b·∫£ng chi ti·∫øt s·∫£n ph·∫©m
            let itemsTableHtml = `
                <h6 class="mt-4 mb-3 fw-bold">S·∫£n ph·∫©m ƒë√£ mua:</h6>
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>STT</th> <th>T√™n SP</th> <th>S·ªë l∆∞·ª£ng</th> <th>ƒê∆°n gi√°</th> <th>Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            let totalItemsCost = 0;

            if (hd.hoaDonChiTiets && hd.hoaDonChiTiets.length > 0) {
                hd.hoaDonChiTiets.forEach((item, index) => {
                    const spct = item.sanPhamChiTiet;

                    // Th√™m Null Check an to√†n
                    const tenSP = (spct && spct.sanPham) ? spct.sanPham.tenSanPham : 'S·∫£n ph·∫©m l·ªói';
                    const mauSac = (spct.mauSac && spct.mauSac.tenMauSac) ? spct.mauSac.tenMauSac : 'N/A';
                    const kichThuoc = (spct.kichThuoc && spct.kichThuoc.tenKichThuoc) ? spct.kichThuoc.tenKichThuoc : 'N/A';

                    const price = item.donGia;
                    const quantity = item.soLuong;
                    const total = price * quantity;
                    totalItemsCost += total;

                    itemsTableHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${tenSP} (${mauSac}/${kichThuoc})</td>
                            <td>${quantity}</td>
                            <td>${price.toLocaleString('vi-VN')}</td>
                            <td>${total.toLocaleString('vi-VN')}</td>
                        </tr>
                    `;
                });
            } else {
                itemsTableHtml += `<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ chi ti·∫øt s·∫£n ph·∫©m.</td></tr>`;
            }

            itemsTableHtml += `</tbody></table>`;


            // T·ªïng h·ª£p v√† hi·ªÉn th·ªã
            detailMaHoaDonEl.innerText = hd.maHoaDon;
            detailContentEl.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="fw-bold text-primary">Th√¥ng tin chung</h5>
                        <p><strong>M√£ giao d·ªãch:</strong> ${hd.maHoaDon}</p>
                        <p><strong>Ng√†y t·∫°o:</strong> ${ngayTao}</p>
                        <p><strong>H√¨nh th·ª©c:</strong> ${thucBanHang}</p>
                        <p><strong>Nh√¢n vi√™n:</strong> ${employeeName}</p>
                    </div>
                    <div class="col-md-6">
                        <h5 class="fw-bold text-primary">Kh√°ch h√†ng</h5>
                        <p><strong>T√™n kh√°ch:</strong> ${customerName}</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> ${renderStatus(hd.trangThai)}</p>
                        <p><strong>Ti·ªÅn gi·∫£m:</strong> ${hd.tienGiamGia ? hd.tienGiamGia.toLocaleString('vi-VN') : '0'} VND</p>
                    </div>
                </div>

                ${itemsTableHtml}

                <div class="alert alert-success mt-4 p-3 text-end">
                    <p class="mb-1">T·ªïng ti·ªÅn h√†ng: <strong>${totalItemsCost.toLocaleString('vi-VN')} VND</strong></p>
                    <p class="mb-1 text-danger">Chi·∫øt kh·∫•u: <strong>${hd.tienGiamGia ? hd.tienGiamGia.toLocaleString('vi-VN') : '0'} VND</strong></p>
                    <h5 class="mb-0">C·∫¶N THANH TO√ÅN: <strong class="text-dark">${hd.tongTien.toLocaleString('vi-VN')} VND</strong></h5>
                </div>
            `;

        } catch (error) {
            detailContentEl.innerHTML = `<p class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>L·ªói t·∫£i: ${error.message}</p>`;
        }
    }


    // --- H√ÄM 7: G·ªåI API CH√çNH (T·∫£i d·ªØ li·ªáu) ---
    async function loadHoaDon(page = 0) {
        // Th√™m hi·ªáu ·ª©ng Skeleton Loader
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>`;
        currentPage = page;

        let url = `${API_BASE}/search?page=${page}&size=${itemsPerPage}`;

        if (currentTrangThai !== 'all') {
            url += `&trangThaiList=${currentTrangThai}`;
        }

        if (currentFilters.startDate) url += `&ngayBatDau=${currentFilters.startDate}T00:00:00`;
        if (currentFilters.endDate) url += `&ngayKetThuc=${currentFilters.endDate}T23:59:59`;
        if (currentFilters.keyword) url += `&keyword=${currentFilters.keyword}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu: " + res.status);

            const dataPage = await res.json();

            renderTable(dataPage.content, dataPage.totalElements, dataPage.totalPages);

        } catch (e) {
            console.error("L·ªói t·∫£i d·ªØ li·ªáu H√≥a ƒê∆°n:", e);
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra Console.</td></tr>`;
        }
    }

    // --- H√ÄM 8: G·∫ÆN S·ª∞ KI·ªÜN V√Ä KH·ªûI CH·∫†Y ---

    function addEventListenersToButtons() {
        // G·∫Øn s·ª± ki·ªán H·ªßy/X√°c nh·∫≠n
        tableBody.querySelectorAll('.btn-update-status').forEach(button => {
            button.addEventListener('click', (e) => {
                const hoaDonId = e.target.dataset.id;
                const newStatus = e.target.dataset.newStatus;

                let actionText = newStatus === '3' ? 'H·ª¶Y' : (newStatus === '2' ? 'HO√ÄN TH√ÄNH' : 'X√ÅC NH·∫¨N');

                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${actionText} h√≥a ƒë∆°n n√†y?`)) {
                    // Hi·ªáu ·ª©ng m·ªù khi x·ª≠ l√Ω
                    e.target.closest('tr').style.opacity = 0.5;
                    handleUpdateStatus(hoaDonId, newStatus);
                }
            });
        });

        // G·∫Øn s·ª± ki·ªán XEM CHI TI·∫æT
        tableBody.querySelectorAll('.btn-view-detail').forEach(button => {
            button.addEventListener('click', (e) => {
                const hoaDonId = e.target.dataset.id;
                fetchAndRenderDetails(hoaDonId); // G·ªçi h√†m t·∫£i chi ti·∫øt
            });
        });
    }

    // G·∫Øn s·ª± ki·ªán cho c√°c Tab (L·ªçc theo tr·∫°ng th√°i)
    document.querySelectorAll(".tab-button").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            currentTrangThai = btn.getAttribute("data-status");
            currentFilters.keyword = null;

            loadHoaDon(0); // Lu√¥n t·∫£i t·ª´ trang 0
        });
    });

    // G·∫Øn s·ª± ki·ªán L·ªçc theo ng√†y
    btnSearch.addEventListener("click", () => {
        const start = startDateInput.value;
        const end = endDateInput.value;

        currentFilters.startDate = start;
        currentFilters.endDate = end;
        currentTrangThai = 'all'; // B·ªè ch·ªçn tr·∫°ng th√°i tab (m·∫∑c ƒë·ªãnh l√† 'all')

        if (!start && !end) {
            toastr.info("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c.");
            return;
        }

        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        loadHoaDon(0);
    });

    // L√†m m·ªõi (Reset)
    btnReset.addEventListener("click", () => {
        startDateInput.value = "";
        endDateInput.value = "";
        currentFilters = {};
        currentTrangThai = 'all';
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        document.querySelector('.tab-button[data-status="all"]').classList.add("active");
        loadHoaDon(0);
    });

    // üöÄ Kh·ªüi ch·∫°y d·ªØ li·ªáu ban ƒë·∫ßu
    currentTrangThai = 'all';
    loadHoaDon(0);
    addEventListenersToButtons(); // G·ªçi 1 l·∫ßn
</script>