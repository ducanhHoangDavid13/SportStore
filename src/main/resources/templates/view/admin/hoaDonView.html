<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản Lý Hóa Đơn</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />

    <!-- Link CSS gốc (nếu có) -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            overflow-x: hidden;
        }

        /* --- LAYOUT SIDEBAR --- */
        #wrapper { display: flex; width: 100%; height: 100vh; overflow: hidden; }
        #sidebar-wrapper { min-height: 100vh; width: 250px; background-color: #fff; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; flex-shrink: 0; }
        #page-content-wrapper { flex-grow: 1; background-color: #f3f4f6; overflow-y: auto; display: flex; flex-direction: column; }

        /* Top Navbar */
        .top-navbar { background: white; height: 60px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 20px; flex-shrink: 0; justify-content: space-between; }

        /* Card Styles */
        .card-box { background: #ffffff; border-radius: 12px; border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }

        /* Table Styles */
        .table-custom thead th { background: #f9fafb; color: #6b7280; font-size: 0.75rem; text-transform: uppercase; padding: 1rem; border-bottom: 2px solid #e5e7eb; vertical-align: middle; }
        .table-custom tbody td { vertical-align: middle; padding: 0.75rem; border-bottom: 1px solid #f3f4f6; font-size: 0.875rem; }
        .table-custom tbody tr:hover { background-color: #f9fafb; }

        /* Badges */
        .badge-status { padding: 0.35em 0.8em; border-radius: 99px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .bg-status-0 { background: #fff7ed; color: #c2410c; } /* Chờ xác nhận */
        .bg-status-1 { background: #e0f2fe; color: #0369a1; } /* Đã xác nhận */
        .bg-status-2 { background: #f0f9ff; color: #0284c7; } /* Đang chuẩn bị */
        .bg-status-3 { background: #e0e7ff; color: #4338ca; } /* Đang giao */
        .bg-status-4 { background: #dcfce7; color: #15803d; } /* Hoàn thành */
        .bg-status-5 { background: #fee2e2; color: #991b1b; } /* Hủy */
        .bg-status-6 { background: #f3e8ff; color: #6b21a8; } /* Chờ TT */

        /* Button Styles */
        .col-action { width: 280px; min-width: 280px; }
        .action-group { display: flex; justify-content: center; gap: 6px; }
        .btn-custom { display: inline-flex; align-items: center; justify-content: center; gap: 5px; padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; border: 1px solid transparent; transition: .2s; min-width: 85px; }
        .btn-custom:hover { transform: translateY(-2px); }

        .btn-view { background: #f8f9fa; color: #333; border-color: #e9ecef; }
        .btn-confirm { background: #d1fae5; color: #047857; border-color: #a7f3d0; }
        .btn-prepare { background: #e0f2fe; color: #0284c7; border-color: #bae6fd; }
        .btn-ship { background: #e0e7ff; color: #4338ca; border-color: #c7d2fe; }
        .btn-complete { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .btn-cancel { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }

        /* Tabs */
        .nav-pills .nav-link { color: #6b7280; font-weight: 500; margin-right: 5px; white-space: nowrap; }
        .nav-pills .nav-link.active { background-color: #4f46e5; color: white; }
        .nav-scroll { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }

        /* Modal */
        .modal-content { border-radius: 16px; border: none; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { border-bottom: 1px solid #f3f4f6; padding: 1.5rem; }
        .modal-body { padding: 1.5rem; }
    </style>
</head>
<body>

<div id="wrapper">

    <!-- 1. SIDEBAR -->
    <div id="sidebar-wrapper">
        <div th:replace="~{library/navbar :: admin-sidebar}"></div>
    </div>

    <!-- 2. MAIN CONTENT -->
    <div id="page-content-wrapper">

        <!-- Top Navbar -->
        <nav class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm me-3 border" id="menu-toggle"><i class="fas fa-bars"></i></button>
                <h5 class="mb-0 text-dark fw-bold">Quản lý Hóa đơn</h5>
            </div>
            <!-- User Info (Optional) -->
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <a class="text-decoration-none text-dark fw-bold dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle fs-4 me-1 text-primary"></i> Admin
                    </a>
                    <!-- Dropdown menu if needed -->
                </div>
            </div>
        </nav>

        <!-- Content Body -->
        <main class="container-fluid px-4 py-4">

            <!-- 1. Bộ lọc -->
            <div class="card-box p-4">
                <!-- Tabs -->
                <div class="mb-4 border-bottom pb-3 nav-scroll">
                    <ul class="nav nav-pills" id="statusTabs">
                        <li class="nav-item"><button class="nav-link active tab-btn" data-status="all">Tất cả</button></li>
                        <li class="nav-item"><button class="nav-link tab-btn" data-status="0">Chờ xác nhận</button></li>
                        <li class="nav-item"><button class="nav-link tab-btn" data-status="1">Đã xác nhận</button></li>
                        <li class="nav-item"><button class="nav-link tab-btn" data-status="2">Đang chuẩn bị</button></li>
                        <li class="nav-item"><button class="nav-link tab-btn" data-status="3">Đang giao</button></li>
                        <li class="nav-item"><button class="nav-link tab-btn" data-status="4">Hoàn thành</button></li>
                        <li class="nav-item"><button class="nav-link tab-btn" data-status="5">Đã hủy</button></li>
                        <li class="nav-item"><button class="nav-link tab-btn" data-status="6">Chờ thanh toán</button></li>
                    </ul>
                </div>

                <!-- Search -->
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0" id="keywordSearch" placeholder="Mã HĐ, Tên KH, SĐT...">
                        </div>
                    </div>
                    <div class="col-md-2"><input type="date" class="form-control" id="startDate"></div>
                    <div class="col-md-2"><input type="date" class="form-control" id="endDate"></div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light border me-2" id="btnReset"><i class="fas fa-sync-alt text-muted"></i> Reset</button>
                        <button class="btn btn-primary px-4" id="btnSearch"><i class="fas fa-search me-1"></i> Tìm kiếm</button>
                    </div>
                </div>
            </div>

            <!-- 2. Bảng dữ liệu -->
            <div class="card-box">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark">Danh sách Đơn hàng</h5>
                    <span class="badge bg-light text-dark border" id="recordCount">Loading...</span>
                </div>

                <div class="table-responsive" style="min-height: 350px;">
                    <table class="table table-custom table-hover mb-0 text-center">
                        <thead>
                        <tr>
                            <th style="width: 50px;">STT</th>
                            <th>Mã HĐ</th>
                            <th class="text-start">Khách Hàng</th>
                            <th>Loại đơn</th>
                            <th>Ngày Tạo</th>
                            <th class="text-end">Tổng Tiền</th>
                            <th>Trạng Thái</th>
                            <th class="col-action">Thao Tác</th>
                        </tr>
                        </thead>
                        <tbody id="hoaDonTableBody"></tbody>
                    </table>
                </div>

                <div class="p-3 border-top bg-light bg-opacity-25 d-flex justify-content-end">
                    <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal Chi Tiết -->
<div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold text-dark"><i class="fas fa-file-invoice me-2"></i>Chi Tiết Hóa Đơn: <span id="detail-maHoaDon" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoice-detail-content"></div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger btn-sm" id="btnPrintPdf"><i class="fas fa-file-pdf me-1"></i> Xuất PDF</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<script>
    const API_BASE = "/api/admin/hoadon";
    toastr.options = { "positionClass": "toast-top-right", "timeOut": "3000" };
    let state = { page: 0, size: 10, status: 'all', keyword: '', startDate: '', endDate: '' };

    // Sidebar Toggle
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#sidebar-wrapper").toggle(); // Hoặc toggle class nếu dùng CSS ẩn hiện
    });

    // Render Badge
    function renderStatusBadge(status) {
        const map = {
            0: { text: 'Chờ Xác Nhận', cls: 'bg-status-0', icon: 'fa-hourglass-start' },
            1: { text: 'Đã Xác Nhận', cls: 'bg-status-1', icon: 'fa-clipboard-check' },
            2: { text: 'Đang Chuẩn Bị', cls: 'bg-status-2', icon: 'fa-box' },
            3: { text: 'Đang Giao Hàng', cls: 'bg-status-3', icon: 'fa-shipping-fast' },
            4: { text: 'Hoàn Thành', cls: 'bg-status-4', icon: 'fa-check-circle' },
            5: { text: 'Đã Hủy', cls: 'bg-status-5', icon: 'fa-times-circle' },
            6: { text: 'Chờ Thanh Toán', cls: 'bg-status-6', icon: 'fa-credit-card' }
        };
        const s = map[status] || { text: 'Khác', cls: 'bg-secondary text-white', icon: 'fa-question' };
        return `<span class="badge-status ${s.cls}"><i class="fas ${s.icon}"></i> ${s.text}</span>`;
    }

    // Render Actions
    function renderActionButtons(hd) {
        let btns = `<div class="action-group">`;
        btns += `<button class="btn-custom btn-view btn-view-detail" data-id="${hd.id}"><i class="fas fa-eye"></i> Xem</button>`;

        if (hd.trangThai === 0) {
            btns += `<button class="btn-custom btn-confirm btn-update-status" data-id="${hd.id}" data-status="1"><i class="fas fa-check"></i> Xác nhận</button>
                     <button class="btn-custom btn-cancel btn-update-status" data-id="${hd.id}" data-status="5"><i class="fas fa-times"></i> Hủy</button>`;
        } else if (hd.trangThai === 1) {
            btns += `<button class="btn-custom btn-prepare btn-update-status" data-id="${hd.id}" data-status="2"><i class="fas fa-box-open"></i> Soạn hàng</button>`;
        } else if (hd.trangThai === 2) {
            btns += `<button class="btn-custom btn-ship btn-update-status" data-id="${hd.id}" data-status="3"><i class="fas fa-truck"></i> Giao hàng</button>`;
        } else if (hd.trangThai === 3) {
            btns += `<button class="btn-custom btn-complete btn-update-status" data-id="${hd.id}" data-status="4"><i class="fas fa-check-double"></i> Hoàn tất</button>`;
        } else if (hd.trangThai === 6) {
            btns += `<button class="btn-custom btn-confirm btn-update-status" data-id="${hd.id}" data-status="1"><i class="fas fa-check"></i> Đã TT</button>
                     <button class="btn-custom btn-cancel btn-update-status" data-id="${hd.id}" data-status="5"><i class="fas fa-times"></i> Hủy</button>`;
        }
        btns += `</div>`;
        return btns;
    }

    // Load Data
    async function loadHoaDon() {
        const params = new URLSearchParams({ page: state.page, size: state.size });
        if (state.status !== 'all') params.append('trangThaiList', state.status);
        if (state.keyword) params.append('keyword', state.keyword);
        if (state.startDate) params.append('ngayBatDau', state.startDate + "T00:00:00");
        if (state.endDate) params.append('ngayKetThuc', state.endDate + "T23:59:59");

        $('#hoaDonTableBody').html('<tr><td colspan="8" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>');

        try {
            const res = await fetch(`${API_BASE}/search?${params.toString()}`);
            if(!res.ok) throw new Error();
            const data = await res.json();
            renderTable(data.content);
            renderPagination(data.totalPages);
            document.getElementById("recordCount").innerText = `${data.totalElements} đơn hàng`;
        } catch {
            $('#hoaDonTableBody').html('<tr><td colspan="8" class="text-center text-danger py-5">Lỗi tải dữ liệu</td></tr>');
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById("hoaDonTableBody");
        tbody.innerHTML = "";
        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5 text-muted">Không tìm thấy đơn hàng nào</td></tr>`;
            return;
        }
        const html = data.map((hd, i) => `
            <tr>
                <td class="text-muted small">${(state.page * state.size) + i + 1}</td>
                <td class="fw-bold text-dark">#${hd.maHoaDon || 'HD'+hd.id}</td>
                <td class="text-start fw-semibold text-secondary">${hd.khachHang ? hd.khachHang.tenKhachHang : 'Khách lẻ'}</td>
                <td>${hd.hinhThucBanHang === 1 ? '<span class="badge bg-light text-dark border">Tại quầy</span>' : '<span class="badge bg-light text-dark border">Online</span>'}</td>
                <td class="small text-muted">${new Date(hd.ngayTao).toLocaleDateString('vi-VN')}</td>
                <td class="text-end fw-bold text-dark">${(hd.tongTienSauGiam || hd.tongTien).toLocaleString('vi-VN')} ₫</td>
                <td>${renderStatusBadge(hd.trangThai)}</td>
                <td>${renderActionButtons(hd)}</td>
            </tr>
        `).join('');
        tbody.innerHTML = html;
    }

    function renderPagination(totalPages) {
        const pagEl = document.getElementById("pagination");
        pagEl.innerHTML = "";
        if (totalPages <= 1) return;
        let html = `<li class="page-item ${state.page===0?'disabled':''}"><button class="page-link" onclick="changePage(${state.page-1})">&laquo;</button></li>`;
        for (let i = 0; i < totalPages; i++) {
            if(i===0 || i===totalPages-1 || (i>=state.page-1 && i<=state.page+1)){
                html += `<li class="page-item ${i===state.page?'active':''}"><button class="page-link" onclick="changePage(${i})">${i+1}</button></li>`;
            } else if (i===state.page-2 || i===state.page+2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item ${state.page===totalPages-1?'disabled':''}"><button class="page-link" onclick="changePage(${state.page+1})">&raquo;</button></li>`;
        pagEl.innerHTML = html;
    }

    function changePage(p) { state.page = p; loadHoaDon(); }

    // Update Status Logic
    async function updateStatus(id, st) {
        let msg = "Xác nhận chuyển trạng thái?";
        if (st == 5) msg = "Bạn có chắc chắn muốn HỦY đơn hàng này?";
        else if (st == 4) msg = "Xác nhận đơn hàng đã HOÀN THÀNH?";

        if(!confirm(msg)) return;
        try {
            const form = new FormData(); form.append('hoaDonId', id); form.append('newTrangThai', st);
            const res = await fetch(`${API_BASE}/update-status`, {method:'POST', body:form});
            if(res.ok) { toastr.success('Cập nhật trạng thái thành công'); loadHoaDon(); }
            else toastr.error('Lỗi cập nhật');
        } catch { toastr.error('Lỗi kết nối server'); }
    }

    // View Detail
    async function viewDetail(id) {
        const modal = new bootstrap.Modal(document.getElementById('invoiceDetailModal'));
        const contentEl = document.getElementById('invoice-detail-content');
        const btnPdf = document.getElementById('btnPrintPdf');
        modal.show();
        contentEl.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
        btnPdf.dataset.id = id;

        try {
            const [resInfo, resDetail] = await Promise.all([
                fetch(`${API_BASE}/${id}`), fetch(`${API_BASE}/${id}/chi-tiet`)
            ]);
            const hd = await resInfo.json();
            const items = resDetail.ok ? await resDetail.json() : [];
            document.getElementById('detail-maHoaDon').innerText = '#' + hd.maHoaDon;

            let rows = items.map((t,i)=>`<tr><td class="text-center">${i+1}</td><td><b>${t.sanPhamChiTiet?.sanPham?.tenSanPham}</b><br><small>Màu: ${t.sanPhamChiTiet?.mauSac?.tenMauSac} | Size: ${t.sanPhamChiTiet?.kichThuoc?.tenKichThuoc}</small></td><td class="text-center">${t.soLuong}</td><td class="text-end">${t.donGia.toLocaleString()} ₫</td><td class="text-end fw-bold">${(t.donGia*t.soLuong).toLocaleString()} ₫</td></tr>`).join('');

            contentEl.innerHTML = `
                <div class="row mb-3">
                    <div class="col-6"><p>KH: <b>${hd.khachHang?.tenKhachHang||'Khách lẻ'}</b></p><p>SĐT: ${hd.khachHang?.sdt||'-'}</p></div>
                    <div class="col-6 text-end"><p>Ngày: ${new Date(hd.ngayTao).toLocaleString('vi-VN')}</p><p>Trạng thái: ${renderStatusBadge(hd.trangThai)}</p></div>
                </div>
                <div class="table-responsive border rounded"><table class="table table-sm mb-0 align-middle"><thead class="table-light"><tr><th class="text-center">#</th><th>Sản phẩm</th><th class="text-center">SL</th><th class="text-end">Đơn giá</th><th class="text-end">Thành tiền</th></tr></thead><tbody>${rows}</tbody></table></div>
                <div class="text-end mt-3"><h5 class="fw-bold text-danger">TỔNG: ${(hd.tongTienSauGiam||hd.tongTien).toLocaleString()} ₫</h5></div>`;
        } catch { contentEl.innerHTML = '<p class="text-danger text-center">Lỗi tải chi tiết</p>'; }
    }

    // Events
    $('.tab-btn').click(function() { $('.tab-btn').removeClass('active'); $(this).addClass('active'); state.status = $(this).data('status'); state.page=0; loadHoaDon(); });
    $('#btnSearch').click(() => { state.keyword = $('#keywordSearch').val(); state.startDate = $('#startDate').val(); state.endDate = $('#endDate').val(); state.page=0; loadHoaDon(); });
    $('#btnReset').click(() => { $('#keywordSearch').val(''); $('#startDate').val(''); $('#endDate').val(''); state={page:0,size:10,status:'all'}; $('.tab-btn').removeClass('active').first().addClass('active'); loadHoaDon(); });
    $('#hoaDonTableBody').click(e => {
        const btnStatus = e.target.closest('.btn-update-status');
        const btnView = e.target.closest('.btn-view-detail');
        if(btnStatus) updateStatus(btnStatus.dataset.id, btnStatus.dataset.status);
        if(btnView) viewDetail(btnView.dataset.id);
    });
    $('#btnPrintPdf').click(function() { if(this.dataset.id) window.location.href=`${API_BASE}/export/pdf/${this.dataset.id}`; });

    // Init
    loadHoaDon();
</script>
</body>
</html>