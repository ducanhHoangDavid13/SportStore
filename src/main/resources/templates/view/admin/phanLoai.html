<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Quản lý Phân Loại</title>
  <style>

    :root {
      --sidebar-width: 260px;
      --navbar-height: 60px;
      --primary-color: #007bff;
      --secondary-bg: #2b3543;
      --text-light: #f8f9fa;
      --active-bg: #0056b3;
    }

    body {

      overflow-x: hidden;
      background-color: #f0f2f5;
    }


    .sidebar-wrapper {
      width: var(--sidebar-width);
      position: fixed; /* Đã đúng */
      top: var(--navbar-height); /* Đã đúng: Bắt đầu từ dưới navbar */
      left: 0; bottom: 0; /* Đã đúng: Kéo dài từ trên xuống dưới */
      overflow-y: auto; /* Đã đúng: Cho phép cuộn bên trong sidebar */
      z-index: 1000;
      background-color: var(--secondary-bg);
      transition: all 0.3s;
    }

    .main-content {
      margin-left: var(--sidebar-width);
      padding: 1.5rem;
      /* Điều chỉnh padding-top để tránh bị che bởi navbar cố định */
      padding-top: calc(var(--navbar-height) + 1.5rem);
      min-height: 100vh; /* Đảm bảo chiều cao tối thiểu cho nội dung */

      transition: margin-left 0.3s;
      /* Bỏ height và overflow-y: auto để cho phép toàn bộ trang cuộn */
    }


    .nav-link {
      color: #b8c7e0;
      padding: 0.75rem 1rem;
      margin-bottom: 0.25rem;
      transition: all 0.2s;
      display: flex;
      align-items: flex-start;
      line-height: 1.2;
      text-decoration: none;
      cursor: pointer;
    }
    .nav-link:hover {
      color: var(--text-light) !important;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }
    .nav-link.active {
      color: var(--text-light) !important;
      background-color: var(--primary-color);
      border-radius: 5px;
      font-weight: 600;
    }

    .menu-text {
      font-size: 1rem;
      white-space: normal;
    }
    .nav-link i.fa-fw {
      margin-top: 0.15rem;
    }
    .nav-link .float-end {
      margin-top: 0.3rem;
      transition: transform 0.3s;
    }

    .submenu-item a.nav-link {
      padding-left: 2.5rem;
      font-size: 0.9rem;
      color: #d1d9e7;
      align-items: center;
    }
    .submenu-item a.nav-link:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
  </style>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.2/css/dataTables.bootstrap5.min.css" />
</head>
<body>
<nav th:replace="~{library/navbar :: admin-navbar}"></nav>

<div class="page-wrapper">
  <div th:replace="~{library/navbar :: admin-sidebar}"></div>
  <main class="main-content">

    <div class="container">
      <div class="row mb-3 p-3 border rounded bg-light">
        <h5 class="mb-3 text-info"><i class="fas fa-filter"></i> Bộ lọc tìm kiếm</h5>
        <form id="filterForm">
          <div class="d-flex flex-wrap align-items-end gap-3">
            <div class="form-group" style="min-width: 200px;">
              <label for="keyword" class="form-label">Theo tên phân loại</label>
              <input type="text" id="keyword" class="form-control form-control-sm"
                     placeholder="Tìm theo tên phân loại" th:value="${keyword}">
            </div>
            <div class="form-group" style="min-width: 150px;">
              <label for="trangThaiFilter" class="form-label">Trạng thái</label>
              <select id="trangThaiFilter" class="form-select form-select-sm">
                <option value="">-- Chọn trạng thái --</option>
                <option value="1" th:selected="${trangThai != null and trangThai == 1}">Hoạt động</option>
                <option value="0" th:selected="${trangThai != null and trangThai == 0}">Ngừng hoạt động</option>
              </select>
            </div>
            <div class="form-group d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-search"></i> Lọc
              </button>
              <button type="button" class="btn btn-secondary btn-sm" id="btnReset">
                <i class="fas fa-redo-alt"></i> Reset
              </button>
            </div>
          </div>
        </form>
      </div>

      <div class="row">
        <div class="col-12 data-panel">
          <h3 class="mb-3">Quản lý Phân Loại</h3>
          <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal"
                    data-bs-target="#addPhanLoaiModal">
              <i class="fas fa-plus"></i> Thêm Phân Loại
            </button>
          </div>

          <div class="table-responsive" style="height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover table-sm">
              <thead class="thead-light table-dark sticky-top">
              <tr>
                <th>ID</th>
                <th>Tên Phân Loại (phanLoai)</th>
                <th>Trạng thái (trangThai)</th>
                <th>Ngày tạo (ngayTao)</th>
                <th>Thao tác</th>
              </tr>
              </thead>
              <tbody id="phanLoaiTableBody">
              <tr><td colspan="5" class="text-center">Đang tải dữ liệu...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-3">
            <nav id="paginationNav"></nav>
            <div id="pageInfo"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addPhanLoaiModal" tabindex="-1" aria-labelledby="addPhanLoaiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <form id="addPhanLoaiForm" method="post">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="addPhanLoaiModalLabel"><i class="fas fa-plus me-2"></i> THÊM MỚI PHÂN LOẠI</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="newPhanLoai" class="form-label">Tên Phân Loại (phanLoai) (*)</label>
                <input type="text" class="form-control" id="newPhanLoai" required>
              </div>
              <div class="mb-3">
                <label for="newMoTa" class="form-label">Mô tả (moTa)</label>
                <textarea class="form-control" id="newMoTa" rows="2"></textarea>
              </div>
              <div>
                <label class="form-label">Trạng thái (trangThai)</label><br>
                <div class="d-flex gap-4 pt-1">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="newTrangThai" id="newTrangThaiOn" value="1" checked>
                    <label class="form-check-label" for="newTrangThaiOn">Hoạt động (1)</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="newTrangThai" id="newTrangThaiOff" value="0">
                    <label class="form-check-label" for="newTrangThaiOff">Ngừng hoạt động (0)</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Đóng</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Lưu Phân Loại</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editPhanLoaiModal" tabindex="-1" aria-labelledby="editPhanLoaiModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <form id="editPhanLoaiForm" method="post">
            <input type="hidden" id="editPhanLoaiId" name="id">
            <div class="modal-header bg-warning text-dark">
              <h5 class="modal-title" id="editPhanLoaiModalLabel"><i class="fas fa-edit me-2"></i> CẬP NHẬT PHÂN LOẠI</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="editPhanLoai" class="form-label">Tên Phân Loại (phanLoai) (*)</label>
                <input type="text" class="form-control" id="editPhanLoai" required>
              </div>
              <div class="mb-3">
                <label for="editMoTa" class="form-label">Mô tả (moTa)</label>
                <textarea class="form-control" id="editMoTa" rows="2"></textarea>
              </div>
              <div>
                <label class="form-label">Trạng thái (trangThai)</label><br>
                <div class="d-flex gap-4 pt-1">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="editTrangThai" id="editTrangThaiOn" value="1">
                    <label class="form-check-label" for="editTrangThaiOn">Hoạt động (1)</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="editTrangThai" id="editTrangThaiOff" value="0">
                    <label class="form-check-label" for="editTrangThaiOff">Ngừng hoạt động (0)</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Hủy</button>
              <button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt me-1"></i> Cập nhật</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script th:src="@{/js/my-custom-scripts.js}"></script>

<script>
  toastr.options = { "positionClass": "toast-top-right", "timeOut": "3000", "closeButton": true };
  $(document).ready(function() {
    // --- CẤU HÌNH API VÀ TÊN BIẾN ---
    const API_URL = "/api/phan-loai";
    const TABLE_BODY_ID = '#phanLoaiTableBody';
    const ADD_FORM_ID = '#addPhanLoaiForm';
    const EDIT_MODAL_ID = '#editPhanLoaiModal';
    const EDIT_FORM_ID = '#editPhanLoaiForm';
    const MODEL_NAME = 'Phân Loại';

    let currentFilter = {
      page: 1,
      keyword: $('#keyword').val() || '',
      trangThai: $('#trangThaiFilter').val() || ''
    };
    let currentPageData = null;

    function loadData() {
      let params = {
        page: currentFilter.page - 1, size: 5, keyword: currentFilter.keyword.trim(),
        trangThai: currentFilter.trangThai === '' ? null : parseInt(currentFilter.trangThai)
      };
      $(TABLE_BODY_ID).html('<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>');
      $('#pageInfo').text(''); $('#paginationNav').empty();
      $.ajax({
        url: API_URL, type: "GET", data: params, dataType: "json",
        success: function(response) {
          currentPageData = response;
          renderTable(response.content);
          renderPagination(response.number + 1, response.totalPages);
          updatePageInfo(response);
        },
        error: function() {
          $(TABLE_BODY_ID).html('<tr><td colspan="5" class="text-danger text-center">Lỗi tải dữ liệu.</td></tr>');
          toastr.error("Lỗi tải dữ liệu " + MODEL_NAME.toLowerCase() + ".");
        }
      });
    }

    function renderTable(list) {
      let html = '';
      if (!list || list.length === 0) {
        html = `<tr><td colspan="5" class="text-center">Không có ${MODEL_NAME.toLowerCase()} nào khớp với bộ lọc.</td></tr>`;
      } else {
        list.forEach(function(item) {
          let trangThaiBadge = item.trangThai === 1 ? '<span class="badge bg-success">Hoạt động</span>' : '<span class="badge bg-danger">Ngừng hoạt động</span>';
          let ngayTaoFormatted = item.ngayTao ? new Date(item.ngayTao).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
          let tenDisplay = item.phanLoai || '';

          html += `<tr data-id="${item.id}">
                                <td>${item.id}</td>
                                <td>${tenDisplay}</td>
                                <td class="text-center">${trangThaiBadge}</td>
                                <td class="text-center">${ngayTaoFormatted}</td>
                                <td class="text-center">
                                    <button class="btn btn-warning btn-sm me-1 btn-edit" data-id="${item.id}" title="Sửa"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-danger btn-sm btn-delete" data-id="${item.id}" title="Xóa"><i class="fas fa-trash"></i></button>
                                </td>
                             </tr>`;
        });
      }
      $(TABLE_BODY_ID).html(html);
    }

    // --- HÀM PHÂN TRANG VÀ THÔNG TIN TRANG (GIỮ NGUYÊN) ---
    function renderPagination(currentPage, totalPages) { /* Logic giữ nguyên */ }
    function updatePageInfo(pageData) { /* Logic giữ nguyên */ }

    // --- SỰ KIỆN LỌC & PHÂN TRANG (GIỮ NGUYÊN) ---
    $('#paginationNav').on('click', 'a.page-link', function(e) {
      e.preventDefault();
      const newPage = $(this).data('page');
      if (!newPage || $(this).parent().hasClass('disabled') || $(this).parent().hasClass('active')) return;
      currentFilter.page = newPage;
      loadData();
    });
    $('#filterForm').on('submit', function(e) {
      e.preventDefault();
      currentFilter.keyword = $('#keyword').val().trim();
      currentFilter.trangThai = $('#trangThaiFilter').val();
      currentFilter.page = 1;
      loadData();
    });
    $('#btnReset').on('click', function() {
      $('#keyword').val(''); $('#trangThaiFilter').val('');
      currentFilter = { page: 1, keyword: '', trangThai: '' };
      loadData();
    });

    // --- SỰ KIỆN CRUD ---
    $(ADD_FORM_ID).on('submit', function(e) {
      e.preventDefault();
      let newPhanLoai = {
        phanLoai: $('#newPhanLoai').val().trim(), moTa: $('#newMoTa').val().trim(),
        trangThai: parseInt($('input[name="newTrangThai"]:checked').val())
      };
      if (!newPhanLoai.phanLoai) { toastr.warning("Tên phân loại là bắt buộc."); return; }
      $.ajax({
        url: API_URL, type: "POST", contentType: "application/json", data: JSON.stringify(newPhanLoai),
        beforeSend: function() { $(ADD_FORM_ID + ' button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Đang lưu...'); },
        complete: function() { $(ADD_FORM_ID + ' button[type="submit"]').prop('disabled', false).html('<i class="fas fa-save me-1"></i> Lưu ' + MODEL_NAME); },
        success: function() {
          toastr.success("Thêm " + MODEL_NAME.toLowerCase() + " thành công!");
          $('#addPhanLoaiModal').one('hidden.bs.modal', function () { $(ADD_FORM_ID)[0].reset(); currentFilter.page = 1; loadData(); }).modal('hide');
        },
        error: function(jqXHR) { toastr.error(jqXHR.responseJSON?.message || "Lỗi thêm " + MODEL_NAME.toLowerCase() + "."); }
      });
    });

    $(document).on('click', '.btn-edit', function() {
      let itemId = $(this).data('id');
      $.ajax({
        url: API_URL + "/" + itemId, type: "GET", dataType: "json",
        success: function(item) {
          $('#editPhanLoaiId').val(item.id); $('#editPhanLoai').val(item.phanLoai || ''); $('#editMoTa').val(item.moTa || '');
          if (item.trangThai === 1) $('#editTrangThaiOn').prop('checked', true); else $('#editTrangThaiOff').prop('checked', true);
          var editModal = new bootstrap.Modal(document.getElementById(EDIT_MODAL_ID.substring(1))); editModal.show();
        },
        error: function() { toastr.error("Không tải được dữ liệu để sửa."); }
      });
    });

    $(EDIT_FORM_ID).on('submit', function(e) {
      e.preventDefault();
      let itemId = $('#editPhanLoaiId').val();
      let updatedPhanLoai = {
        phanLoai: $('#editPhanLoai').val().trim(), moTa: $('#editMoTa').val().trim(),
        trangThai: parseInt($('input[name="editTrangThai"]:checked').val())
      };
      if (!updatedPhanLoai.phanLoai) { toastr.warning("Tên phân loại là bắt buộc."); return; }

      $.ajax({
        url: API_URL + "/" + itemId, type: "PUT", contentType: "application/json", data: JSON.stringify(updatedPhanLoai),
        beforeSend: function() { $(EDIT_FORM_ID + ' button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Đang cập nhật...'); },
        complete: function() { $(EDIT_FORM_ID + ' button[type="submit"]').prop('disabled', false).html('<i class="fas fa-sync-alt me-1"></i> Cập nhật'); },
        success: function() {
          toastr.success("Cập nhật " + MODEL_NAME.toLowerCase() + " thành công!");
          $('#editPhanLoaiModal').one('hidden.bs.modal', function () { loadData(); }).modal('hide');
        },
        error: function(jqXHR) { toastr.error(jqXHR.responseJSON?.message || "Lỗi cập nhật " + MODEL_NAME.toLowerCase() + "."); }
      });
    });

    $(document).on('click', '.btn-delete', function() {
      let idToDelete = $(this).data('id');
      if (confirm(`Bạn chắc chắn muốn xóa ${MODEL_NAME} ID: ${idToDelete}?`)) {
        $.ajax({
          url: API_URL + "/" + idToDelete, type: "DELETE",
          success: function() {
            toastr.success("Xóa thành công!");
            if (currentPageData && currentPageData.numberOfElements === 1 && currentFilter.page > 1) { currentFilter.page--; }
            loadData();
          },
          error: function(jqXHR) { toastr.error(jqXHR.status === 409 ? "Không thể xóa phân loại này vì đang được sử dụng." : "Lỗi xóa " + MODEL_NAME.toLowerCase() + "."); }
        });
      }
    });

    // --- KHỞI TẠO ---
    loadData();
  });
</script>
</body>
</html>