<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Biến thể Sản phẩm</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Bootstrap & Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <link rel="stylesheet" th:href="@{/css/styles.css}" />

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #374151; }
    .card-box { background: #fff; border-radius: 12px; border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
    .table-custom thead th { background: #f9fafb; color: #6b7280; font-size: 0.75rem; text-transform: uppercase; padding: 1rem 0.75rem; border-bottom: 2px solid #e5e7eb; }
    .table-custom tbody td { vertical-align: middle; padding: 0.75rem; border-bottom: 1px solid #f3f4f6; font-size: 0.875rem; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; transition: .2s; }
    .btn-action:hover { transform: translateY(-2px); }
    .form-select:focus, .form-control:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
  </style>
</head>
<body>

<nav th:replace="library/navbar :: admin-navbar"></nav>

<div class="page-wrapper">
  <div th:replace="library/navbar :: admin-sidebar"></div>
  <main class="main-content pt-4 px-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold text-dark mb-0">Quản lý Chi tiết Sản phẩm</h3>
    </div>

    <!-- 1. FILTER CARD -->
    <div class="card-box p-4">
      <h6 class="fw-bold text-muted mb-3"><i class="fas fa-filter me-2"></i>BỘ LỌC TÌM KIẾM</h6>
      <form id="filterForm">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small fw-bold">SẢN PHẨM</label>
            <select class="form-select" id="filterSanPham">
              <option value="">-- Tất cả --</option>
              <!-- Option rendered by JS or Thymeleaf initial load -->
              <option th:each="sp : ${listSanPham}" th:value="${sp.id}" th:text="${sp.tenSanPham}"></option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-bold">MÀU SẮC</label>
            <select class="form-select" id="filterMauSac">
              <option value="">-- Tất cả --</option>
              <option th:each="ms : ${listMauSac}" th:value="${ms.id}" th:text="${ms.tenMauSac}"></option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-bold">KÍCH THƯỚC</label>
            <select class="form-select" id="filterKichThuoc">
              <option value="">-- Tất cả --</option>
              <option th:each="kt : ${listKichThuoc}" th:value="${kt.id}" th:text="${kt.tenKichThuoc}"></option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-bold">GIÁ TỪ</label>
            <input type="number" class="form-control" id="filterMinPrice" placeholder="0">
          </div>
          <div class="col-md-2">
            <label class="form-label small fw-bold">ĐẾN</label>
            <input type="number" class="form-control" id="filterMaxPrice" placeholder="Max">
          </div>
          <div class="col-12 text-end">
            <button type="button" class="btn btn-light border me-2" id="btnReset"><i class="fas fa-sync-alt me-1"></i> Reset</button>
            <button type="submit" class="btn btn-primary px-4"><i class="fas fa-search me-1"></i> Lọc dữ liệu</button>
          </div>
        </div>
      </form>
    </div>

    <!-- 2. TABLE CARD -->
    <div class="card-box">
      <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold text-dark">Danh sách Biến thể</h5>
        <button class="btn btn-success btn-sm shadow-sm" onclick="showAddModal()">
          <i class="fas fa-plus me-1"></i> Thêm biến thể
        </button>
      </div>

      <div class="table-responsive" style="min-height: 300px;">
        <table class="table table-custom table-hover mb-0">
          <thead>
          <tr>
            <th>Sản phẩm</th>
            <th class="text-center">Màu sắc</th>
            <th class="text-center">Size</th>
            <th>Thể loại</th>
            <th class="text-end">Giá bán</th>
            <th class="text-center">SL Tồn</th>
            <th class="text-center" style="width: 100px;">Thao tác</th>
          </tr>
          </thead>
          <tbody id="spctTableBody">
          <!-- Data loaded by AJAX -->
          </tbody>
        </table>
      </div>

      <div class="p-3 border-top bg-light bg-opacity-25 d-flex justify-content-between align-items-center">
        <span class="text-muted small" id="pageInfo"></span>
        <nav id="paginationNav"></nav>
      </div>
    </div>

    <!-- MODAL THÊM / SỬA -->
    <div class="modal fade" id="spctModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white border-0">
            <h5 class="modal-title fw-bold" id="modalTitle">THÊM MỚI BIẾN THỂ</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="spctForm">
              <input type="hidden" id="spctId">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label fw-bold small">SẢN PHẨM <span class="text-danger">*</span></label>
                  <select class="form-select" id="modalSanPham" required>
                    <option value="">-- Chọn sản phẩm --</option>
                    <option th:each="sp : ${listSanPham}" th:value="${sp.id}" th:text="${sp.tenSanPham}"></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">MÀU SẮC <span class="text-danger">*</span></label>
                  <select class="form-select" id="modalMauSac" required>
                    <option th:each="ms : ${listMauSac}" th:value="${ms.id}" th:text="${ms.tenMauSac}"></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">KÍCH THƯỚC <span class="text-danger">*</span></label>
                  <select class="form-select" id="modalKichThuoc" required>
                    <option th:each="kt : ${listKichThuoc}" th:value="${kt.id}" th:text="${kt.tenKichThuoc}"></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">THỂ LOẠI</label>
                  <select class="form-select" id="modalTheLoai">
                    <option th:each="tl : ${listTheLoai}" th:value="${tl.id}" th:text="${tl.tenTheLoai}"></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">CHẤT LIỆU</label>
                  <select class="form-select" id="modalChatLieu">
                    <option th:each="cl : ${listChatLieu}" th:value="${cl.id}" th:text="${cl.loaiChatLieu}"></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">XUẤT XỨ</label>
                  <select class="form-select" id="modalXuatXu">
                    <option th:each="xx : ${listXuatXu}" th:value="${xx.id}" th:text="${xx.tenXuatXu}"></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">PHÂN LOẠI</label>
                  <select class="form-select" id="modalPhanLoai">
                    <option th:each="pl : ${listPhanLoai}" th:value="${pl.id}" th:text="${pl.phanLoai}"></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">GIÁ BÁN (VNĐ) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="modalGiaTien" required min="0">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold small">SỐ LƯỢNG <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="modalSoLuong" required min="0">
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Đóng</button>
            <button type="button" class="btn btn-primary px-4" onclick="saveSPCT()">Lưu lại</button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  toastr.options = { "closeButton": true, "progressBar": true, "positionClass": "toast-bottom-right", "timeOut": "3000" };

  // Cấu hình API
  const API_URL = '/api/san-pham-chi-tiet';
  let spctModal;
  let currentFilter = { page: 0, size: 10 }; // 0-based page index

  $(document).ready(function() {
    spctModal = new bootstrap.Modal(document.getElementById('spctModal'));
    loadData(); // Tải dữ liệu lần đầu

    // Toggle Sidebar
    $('#sidebarToggleBtn').click(function(e) {
      e.preventDefault(); document.body.classList.toggle('sidebar-toggled');
    });
  });

  // --- 1. LOAD DATA (AJAX) ---
  function loadData() {
    // Lấy giá trị filter
    currentFilter.idSanPham = $('#filterSanPham').val() || null;
    currentFilter.idMauSac = $('#filterMauSac').val() || null;
    currentFilter.idKichThuoc = $('#filterKichThuoc').val() || null;
    currentFilter.minPrice = $('#filterMinPrice').val() || null;
    currentFilter.maxPrice = $('#filterMaxPrice').val() || null;

    $('#spctTableBody').html('<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>');

    $.ajax({
      url: API_URL, type: 'GET', data: currentFilter,
      success: function(res) {
        renderTable(res.content);
        renderPagination(res);
        updatePageInfo(res);
      },
      error: function() {
        $('#spctTableBody').html('<tr><td colspan="7" class="text-center text-danger py-4">Lỗi tải dữ liệu</td></tr>');
      }
    });
  }

  function renderTable(list) {
    if (!list || list.length === 0) {
      $('#spctTableBody').html('<tr><td colspan="7" class="text-center py-4 text-muted">Không có dữ liệu</td></tr>');
      return;
    }
    let html = '';
    list.forEach(item => {
      const gia = item.giaTien ? item.giaTien.toLocaleString('vi-VN') + ' ₫' : '0 ₫';
      html += `
            <tr>
                <td class="fw-semibold text-dark">${item.sanPham?.tenSanPham || '-'}</td>
                <td class="text-center"><span class="badge bg-light text-dark border">${item.mauSac?.tenMauSac || '-'}</span></td>
                <td class="text-center"><span class="badge bg-light text-dark border">${item.kichThuoc?.tenKichThuoc || '-'}</span></td>
                <td>${item.theLoai?.tenTheLoai || '-'}</td>
                <td class="text-end fw-bold text-success">${gia}</td>
                <td class="text-center">${item.soLuong}</td>
                <td class="text-center">
                    <button class="btn btn-action btn-light text-warning border me-1" onclick="openEdit(${item.id})"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-action btn-light text-danger border" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
    });
    $('#spctTableBody').html(html);
  }

  // --- 2. PHÂN TRANG ---
  function renderPagination(pageData) {
    if (pageData.totalPages <= 1) { $('#paginationNav').empty(); return; }

    let html = '<ul class="pagination pagination-sm mb-0">';
    // Prev
    html += `<li class="page-item ${pageData.first ? 'disabled' : ''}">
                    <button class="page-link" onclick="changePage(${pageData.number - 1})">&laquo;</button>
                 </li>`;

    // Numbers
    for(let i=0; i<pageData.totalPages; i++) {
      if (i===0 || i===pageData.totalPages-1 || (i>=pageData.number-1 && i<=pageData.number+1)) {
        html += `<li class="page-item ${i===pageData.number ? 'active' : ''}">
                            <button class="page-link" onclick="changePage(${i})">${i + 1}</button>
                         </li>`;
      } else if (i===pageData.number-2 || i===pageData.number+2) {
        html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      }
    }

    // Next
    html += `<li class="page-item ${pageData.last ? 'disabled' : ''}">
                    <button class="page-link" onclick="changePage(${pageData.number + 1})">&raquo;</button>
                 </li></ul>`;

    $('#paginationNav').html(html);
  }

  function changePage(p) {
    if (p < 0) return;
    currentFilter.page = p;
    loadData();
  }

  function updatePageInfo(data) {
    if (data.totalElements > 0) {
      const start = data.number * data.size + 1;
      const end = start + data.numberOfElements - 1;
      $('#pageInfo').html(`Hiển thị <strong>${start}-${end}</strong> trên <strong>${data.totalElements}</strong> bản ghi`);
    } else {
      $('#pageInfo').html('');
    }
  }

  // --- 3. ADD / EDIT / DELETE ---
  function showAddModal() {
    $('#spctForm')[0].reset();
    $('#spctId').val('');
    $('#modalTitle').text('THÊM MỚI BIẾN THỂ');
    spctModal.show();
  }

  async function openEdit(id) {
    try {
      const res = await fetch(`${API_URL}/${id}`);
      const data = await res.json();

      $('#spctId').val(data.id);
      $('#modalSanPham').val(data.sanPham?.id || '');
      $('#modalMauSac').val(data.mauSac?.id || '');
      $('#modalKichThuoc').val(data.kichThuoc?.id || '');
      $('#modalTheLoai').val(data.theLoai?.id || '');
      $('#modalChatLieu').val(data.chatLieu?.id || '');
      $('#modalXuatXu').val(data.xuatXu?.id || '');
      $('#modalPhanLoai').val(data.phanLoai?.id || '');
      $('#modalGiaTien').val(data.giaTien);
      $('#modalSoLuong').val(data.soLuong);

      $('#modalTitle').text('CẬP NHẬT BIẾN THỂ');
      spctModal.show();
    } catch(e) { toastr.error('Lỗi tải dữ liệu'); }
  }

  async function saveSPCT() {
    const id = $('#spctId').val();
    const payload = {
      id: id || null,
      sanPham: { id: $('#modalSanPham').val() },
      mauSac: { id: $('#modalMauSac').val() },
      kichThuoc: { id: $('#modalKichThuoc').val() },
      theLoai: { id: $('#modalTheLoai').val() },
      chatLieu: { id: $('#modalChatLieu').val() },
      xuatXu: { id: $('#modalXuatXu').val() },
      phanLoai: { id: $('#modalPhanLoai').val() },
      giaTien: parseFloat($('#modalGiaTien').val()),
      soLuong: parseInt($('#modalSoLuong').val())
    };

    // Validation đơn giản
    if(!payload.sanPham.id || !payload.mauSac.id || !payload.kichThuoc.id || isNaN(payload.giaTien)) {
      return toastr.warning('Vui lòng điền đủ thông tin bắt buộc (*)');
    }

    try {
      const method = id ? 'PUT' : 'POST';
      const url = id ? `${API_URL}/${id}` : API_URL;

      const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if(!res.ok) throw new Error(await res.text());

      toastr.success(id ? 'Cập nhật thành công' : 'Thêm mới thành công');
      spctModal.hide();
      loadData();
    } catch(e) {
      toastr.error('Lưu thất bại: ' + e.message);
    }
  }

  async function deleteItem(id) {
    if(!confirm('Xóa biến thể này?')) return;
    try {
      const res = await fetch(`${API_URL}/${id}`, {method:'DELETE'});
      if(res.ok) { toastr.success('Đã xóa'); loadData(); }
      else toastr.error('Lỗi xóa (Có thể đang được sử dụng)');
    } catch(e) { toastr.error('Lỗi server'); }
  }

  // Event listeners
  $('#filterForm').submit(function(e) { e.preventDefault(); currentFilter.page = 0; loadData(); });
  $('#btnReset').click(function() { $('#filterForm')[0].reset(); currentFilter.page = 0; loadData(); });

</script>
</body>
</html>