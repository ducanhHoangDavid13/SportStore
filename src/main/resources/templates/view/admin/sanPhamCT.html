<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Chi tiết Sản phẩm</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.2/css/dataTables.bootstrap5.min.css" />
</head>
<body>

<nav th:replace="~{library/navbar :: admin-navbar}"></nav>

<div class="page-wrapper">
  <div th:replace="~{library/navbar :: admin-sidebar}"></div>
  <main class="main-content">
    <div class="container mt-4">

      <h2>Quản lý Chi tiết Sản phẩm (Biến thể)</h2>

      <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
              data-bs-target="#spctModal" onclick="moModalThemMoi()">
        <i class="bi bi-plus-circle"></i> Thêm mới biến thể
      </button>

      <div class="card card-body mb-3">
        <form th:action="@{/admin/san-pham-chi-tiet}" method="GET" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Lọc theo Sản phẩm</label>
            <select class="form-select" name="idSanPham">
              <option value="">-- Tất cả sản phẩm --</option>
              <option th:each="sp : ${listSanPham}" th:value="${sp.id}" th:text="${sp.tenSanPham}"
                      th:selected="${sp.id == idSanPham}"></option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Lọc theo Màu sắc</label>
            <select class="form-select" name="idMauSac">
              <option value="">-- Tất cả màu sắc --</option>
              <option th:each="ms : ${listMauSac}" th:value="${ms.id}" th:text="${ms.tenMauSac}"
                      th:selected="${ms.id == idMauSac}"></option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Lọc theo Kích thước</label>
            <select class="form-select" name="idKichThuoc">
              <option value="">-- Tất cả kích thước --</option>
              <option th:each="kt : ${listKichThuoc}" th:value="${kt.id}" th:text="${kt.tenKichThuoc}"
                      th:selected="${kt.id == idKichThuoc}"></option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Giá từ</label>
            <input type="number" class="form-control" name="minPrice" th:value="${minPrice}" placeholder="VND">
          </div>
          <div class="col-md-2">
            <label class="form-label">Giá đến</label>
            <input type="number" class="form-control" name="maxPrice" th:value="${maxPrice}" placeholder="VND">
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-info me-2">
              <i class="bi bi-search"></i> Lọc
            </button>
            <a th:href="@{/admin/san-pham-chi-tiet}" class="btn btn-outline-secondary">
              Xóa lọc
            </a>
          </div>
        </form>
      </div>

      <table class="table table-bordered table-hover">
        <thead class="table-light">
        <tr>
          <th>Sản phẩm</th>
          <th>Màu sắc</th>
          <th>Kích thước</th>
          <th>Thể loại</th>
          <th>Giá tiền</th>
          <th>Số lượng</th>
          <th>Thao tác</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="spct : ${spctPage.content}">
          <td th:text="${spct.sanPham != null ? spct.sanPham.tenSanPham : 'N/A'}"></td>
          <td th:text="${spct.mauSac != null ? spct.mauSac.tenMauSac : 'N/A'}"></td>
          <td th:text="${spct.kichThuoc != null ? spct.kichThuoc.tenKichThuoc : 'N/A'}"></td>
          <td th:text="${spct.theLoai != null ? spct.theLoai.tenTheLoai : 'N/A'}"></td>
          <td th:text="${#numbers.formatDecimal(spct.giaTien, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
          <td th:text="${spct.soLuong}"></td>
          <td>
            <button type="button" class="btn btn-sm btn-success"
                    data-bs-toggle="modal" data-bs-target="#spctModal"
                    th:attr="data-id=${spct.id}" onclick="moModalCapNhat(this.getAttribute('data-id'))">
              <i class="bi bi-pencil-square"></i> Sửa
            </button>
            <button type="button" class="btn btn-sm btn-danger"
                    th:attr="data-id=${spct.id}" onclick="xoaBienThe(this.getAttribute('data-id'))">
              <i class="bi bi-trash"></i> Xóa
            </button>
          </td>
        </tr>
        <tr th:if="${spctPage.empty}">
          <td colspan="7" class="text-center">Không tìm thấy chi tiết sản phẩm nào.</td>
        </tr>
        </tbody>
      </table>
      <nav aria-label="Page navigation" th:if="${spctPage.totalPages > 1}">
        <ul class="pagination">

          <li class="page-item" th:classappend="${spctPage.first} ? 'disabled'">
            <a class="page-link" th:href="@{/admin/san-pham-chi-tiet(
          page=${spctPage.number - 1},
          idSanPham=${idSanPham},
          idMauSac=${idMauSac},
          idKichThuoc=${idKichThuoc},
          idChatLieu=${idChatLieu},
          idTheLoai=${idTheLoai},
          idXuatXu=${idXuatXu},
          idPhanLoai=${idPhanLoai},
          minPrice=${minPrice},
          maxPrice=${maxPrice},
          trangThai=${trangThai},
          keyword=${keyword}
        )}">&laquo;</a>
          </li>

          <li class="page-item" th:each="i : ${#numbers.sequence(0, spctPage.totalPages - 1)}"
              th:classappend="${i == spctPage.number} ? 'active'">
            <a class="page-link" th:href="@{/admin/san-pham-chi-tiet(
          page=${i},
          idSanPham=${idSanPham},
          idMauSac=${idMauSac},
          idKichThuoc=${idKichThuoc},
          idChatLieu=${idChatLieu},
          idTheLoai=${idTheLoai},
          idXuatXu=${idXuatXu},
          idPhanLoai=${idPhanLoai},
          minPrice=${minPrice},
          maxPrice=${maxPrice},
          trangThai=${trangThai},
          keyword=${keyword}
        )}" th:text="${i + 1}">1</a>
          </li>

          <li class="page-item" th:classappend="${spctPage.last} ? 'disabled'">
            <a class="page-link" th:href="@{/admin/san-pham-chi-tiet(
          page=${spctPage.number + 1},
          idSanPham=${idSanPham},
          idMauSac=${idMauSac},
          idKichThuoc=${idKichThuoc},
          idChatLieu=${idChatLieu},
          idTheLoai=${idTheLoai},
          idXuatXu=${idXuatXu},
          idPhanLoai=${idPhanLoai},
          minPrice=${minPrice},
          maxPrice=${maxPrice},
          trangThai=${trangThai},
          keyword=${keyword}
        )}">&raquo;</a>
          </li>
        </ul>
      </nav>
    </div>

    <div class="modal fade" id="spctModal" tabindex="-1" aria-labelledby="spctModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="spctForm">
            <div class="modal-header">
              <h5 class="modal-title" id="spctModalTitle">Thêm mới Biến thể</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body row g-3">
              <input type="hidden" name="id" id="spctId">

              <div class="col-md-12">
                <label class="form-label">Sản phẩm (*)</label>
                <select class="form-select" name="sanPham" required>
                  <option value="">-- Chọn sản phẩm --</option>
                  <option th:each="sp : ${listSanPham}" th:value="${sp.id}" th:text="${sp.tenSanPham}"></option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Màu sắc (*)</label>
                <select class="form-select" name="mauSac" required>
                  <option value="">-- Chọn màu sắc --</option>
                  <option th:each="ms : ${listMauSac}" th:value="${ms.id}" th:text="${ms.tenMauSac}"></option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Kích thước (*)</label>
                <select class="form-select" name="kichThuoc" required>
                  <option value="">-- Chọn kích thước --</option>
                  <option th:each="kt : ${listKichThuoc}" th:value="${kt.id}" th:text="${kt.tenKichThuoc}"></option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Thể loại (*)</label>
                <select class="form-select" name="theLoai" required>
                  <option value="">-- Chọn thể loại --</option>
                  <option th:each="tl : ${listTheLoai}" th:value="${tl.id}" th:text="${tl.tenTheLoai}"></option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Chất liệu (*)</label>
                <select class="form-select" name="chatLieu" required>
                  <option value="">-- Chọn chất liệu --</option>
                  <option th:each="cl : ${listChatLieu}" th:value="${cl.id}" th:text="${cl.loaiChatLieu}"></option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Xuất xứ (*)</label>
                <select class="form-select" name="xuatXu" required>
                  <option value="">-- Chọn xuất xứ --</option>
                  <option th:each="xx : ${listXuatXu}" th:value="${xx.id}" th:text="${xx.tenXuatXu}"></option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Phân loại (*)</label>
                <select class="form-select" name="phanLoai" required>
                  <option value="">-- Chọn phân loại --</option>
                  <option th:each="pl : ${listPhanLoai}" th:value="${pl.id}" th:text="${pl.phanLoai}"></option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Giá tiền (*)</label>
                <input type="number" class="form-control" name="giaTien" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Số lượng (*)</label>
                <input type="number" class="form-control" name="soLuong" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button type="submit" class="btn btn-primary">Lưu</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<script>
  toastr.options = { "positionClass": "toast-top-right", "timeOut": "3000", "closeButton": true };

  const spctModal = document.getElementById('spctModal');
  const spctForm = document.getElementById('spctForm');
  const spctModalTitle = document.getElementById('spctModalTitle');

  // Hàm Mở Modal Thêm mới (Giữ nguyên)
  function moModalThemMoi() {
    spctForm.reset();
    document.getElementById('spctId').value = '';
    spctModalTitle.innerText = 'Thêm mới Biến thể';
  }

  // Hàm Mở Modal Cập nhật (Đã cập nhật để fill 2 trường mới)
  async function moModalCapNhat(id) {
    spctForm.reset();
    spctModalTitle.innerText = 'Cập nhật Biến thể';

    try {
      const response = await fetch(`/api/san-pham-chi-tiet/${id}`);
      if (!response.ok) throw new Error('Không tìm thấy dữ liệu');

      const spct = await response.json();

      document.getElementById('spctId').value = spct.id;
      spctForm.querySelector('[name="giaTien"]').value = spct.giaTien;
      spctForm.querySelector('[name="soLuong"]').value = spct.soLuong;

      // Fill tất cả dropdown
      if (spct.sanPham) spctForm.querySelector('[name="sanPham"]').value = spct.sanPham.id;
      if (spct.mauSac) spctForm.querySelector('[name="mauSac"]').value = spct.mauSac.id;
      if (spct.kichThuoc) spctForm.querySelector('[name="kichThuoc"]').value = spct.kichThuoc.id;
      if (spct.theLoai) spctForm.querySelector('[name="theLoai"]').value = spct.theLoai.id;
      if (spct.chatLieu) spctForm.querySelector('[name="chatLieu"]').value = spct.chatLieu.id;
      // Cập nhật 2 trường còn thiếu
      if (spct.xuatXu) spctForm.querySelector('[name="xuatXu"]').value = spct.xuatXu.id;
      if (spct.phanLoai) spctForm.querySelector('[name="phanLoai"]').value = spct.phanLoai.id;

    } catch (error) {
      console.error('Lỗi khi lấy SPCT:', error);
      toastr.error('Không thể tải dữ liệu để sửa.');
      var myModal = bootstrap.Modal.getInstance(spctModal);
      myModal.hide();
    }
  }

  // --- BỔ SUNG: XỬ LÝ SUBMIT FORM BẰNG AJAX (FETCH) ---
  spctForm.addEventListener('submit', async function(e) {
    e.preventDefault(); // Ngăn trang tải lại

    const id = document.getElementById('spctId').value;
    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/san-pham-chi-tiet/${id}` : '/api/san-pham-chi-tiet';

    // 1. Lấy dữ liệu từ form
    // (Kiểm tra validation cơ bản)
    const sanPhamId = spctForm.querySelector('[name="sanPham"]').value;
    const mauSacId = spctForm.querySelector('[name="mauSac"]').value;
    const kichThuocId = spctForm.querySelector('[name="kichThuoc"]').value;
    const giaTien = spctForm.querySelector('[name="giaTien"]').value;
    const soLuong = spctForm.querySelector('[name="soLuong"]').value;

    if (!sanPhamId || !mauSacId || !kichThuocId || !giaTien || !soLuong) {
      toastr.warning('Vui lòng điền đầy đủ các trường bắt buộc (*).');
      return;
    }

    // 2. Xây dựng đối tượng JSON
    const data = {
      id: id || null,
      giaTien: giaTien,
      soLuong: soLuong,
      sanPham: { id: sanPhamId },
      mauSac: { id: mauSacId },
      kichThuoc: { id: kichThuocId },
      theLoai: { id: spctForm.querySelector('[name="theLoai"]').value },
      chatLieu: { id: spctForm.querySelector('[name="chatLieu"]').value },
      xuatXu: { id: spctForm.querySelector('[name="xuatXu"]').value },
      phanLoai: { id: spctForm.querySelector('[name="phanLoai"]').value }
    };

    // 3. Gửi dữ liệu
    try {
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        throw new Error('Lỗi từ server: ' + await response.text());
      }

      // 4. Thành công
      toastr.success(id ? 'Cập nhật thành công!' : 'Thêm mới thành công!');
      var myModal = bootstrap.Modal.getInstance(spctModal);
      myModal.hide();
      window.location.reload(); // Tải lại trang để thấy thay đổi

    } catch (error) {
      console.error('Lỗi khi lưu SPCT:', error);
      toastr.error('Lưu thất bại. Vui lòng kiểm tra lại (có thể biến thể đã tồn tại).');
    }
  });

  // --- BỔ SUNG: HÀM XỬ LÝ NÚT XÓA ---
  async function xoaBienThe(id) {
    if (!confirm('Bạn có chắc muốn xóa biến thể này?')) {
      return;
    }

    try {
      const response = await fetch(`/api/san-pham-chi-tiet/${id}`, {
        method: 'DELETE'
      });

      if (response.status === 409) { // Conflict
        toastr.error('Không thể xóa biến thể này vì đang được sử dụng (ví dụ: trong hóa đơn).');
        return;
      }
      if (!response.ok) {
        throw new Error('Lỗi server khi xóa');
      }

      toastr.success('Xóa thành công!');
      window.location.reload(); // Tải lại trang

    } catch (error) {
      console.error('Lỗi khi xóa SPCT:', error);
      toastr.error('Đã xảy ra lỗi khi xóa.');
    }
  }
  document.addEventListener("DOMContentLoaded", function() {

    // 1. Tìm nút bấm
    const toggleButton = document.getElementById('sidebarToggleBtn');

    if (toggleButton) {
      // 2. Thêm sự kiện click
      toggleButton.addEventListener('click', function(e) {
        e.preventDefault(); // Ngăn trình duyệt nhảy link

        // 3. Thêm/Xóa class 'sidebar-toggled' trên thẻ <body>
        document.body.classList.toggle('sidebar-toggled');
      });
    }

  });

  // (Bỏ đoạn code DOMContentLoaded cũ vì nó dùng cho Thymeleaf Form)
</script>
</body>
</html>