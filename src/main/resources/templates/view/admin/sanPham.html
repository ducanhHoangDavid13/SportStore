<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản lý Sản phẩm</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}"/>
    <link rel="stylesheet" th:href="@{/css/navbar.css}"/>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }

        /* Card Styles */
        .card-box {
            background: #ffffff;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }

        /* Table Styles */
        .table-custom thead th {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
            padding: 1rem;
            vertical-align: middle;
        }

        .table-custom tbody td {
            vertical-align: middle;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .table-custom tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Product Image */
        .product-thumb {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }

        /* Badges & Buttons */
        .badge-status {
            padding: 0.35em 0.8em;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 99px;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-action {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .btn-action:hover {
            transform: translateY(-2px);
        }

        /* Modals */
        .modal-content {
            border-radius: 16px;
            border: none;
        }

        .modal-header {
            border-bottom: 1px solid #f3f4f6;
            padding: 1.5rem;
        }

        .modal-header.bg-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
        }

        .modal-header.bg-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        .modal-body {
            padding: 1.5rem;
        }
    </style>
</head>

<body>
<nav th:replace="library/navbar :: admin-navbar"></nav>
<div class="page-wrapper">
    <div th:replace="library/navbar :: admin-sidebar"></div>
    <main class="main-content pt-4 px-4">

        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark mb-0">Quản lý Sản phẩm</h3>
            </div>

            <div class="card-box p-4">
                <div class="d-flex align-items-center mb-3 border-bottom pb-2">
                    <i class="fas fa-filter text-primary me-2"></i> <span class="fw-bold text-secondary">Bộ lọc</span>
                </div>
                <form id="filterForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">TỪ KHÓA</label>
                            <input type="text" id="keyword" class="form-control" placeholder="Mã hoặc Tên sản phẩm...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">TRẠNG THÁI</label>
                            <select id="trangThaiFilter" class="form-select">
                                <option value="">Tất cả</option>
                                <option value="1">Đang bán</option>
                                <option value="0">Ngừng bán</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary px-4"><i class="fas fa-search me-1"></i>
                                    Tìm kiếm
                                </button>
                                <button type="button" class="btn btn-light border px-3" id="btnReset"><i
                                        class="fas fa-sync-alt me-1"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card-box">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">Danh sách Sản phẩm</h5>
                    <div>
                        <button class="btn btn-success btn-sm shadow-sm me-2" data-bs-toggle="modal"
                                data-bs-target="#addSanPhamModal"><i class="fas fa-plus me-1"></i> Thêm mới
                        </button>
                        <button class="btn btn-outline-success btn-sm shadow-sm" id="btnExportExcel"><i
                                class="fas fa-file-excel me-1"></i> Excel
                        </button>
                    </div>
                </div>
                <div class="table-responsive" style="min-height: 350px;">
                    <table class="table table-custom table-hover mb-0">
                        <thead>
                        <tr>
                            <th>Mã SP</th>
                            <th class="text-center">Ảnh</th>
                            <th>Tên Sản Phẩm</th>
                            <th class="text-end">Giá bán</th>
                            <th class="text-center">Số lượng</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center">Ngày tạo</th>
                            <th class="text-center" style="width: 150px;">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody id="sanPhamTableBody"></tbody>
                    </table>
                </div>
                <div class="p-3 border-top d-flex justify-content-between align-items-center">
                    <div id="pageInfo" class="text-muted small"></div>
                    <nav id="paginationNav"></nav>
                </div>
            </div>
        </div>

        <div class="modal fade" id="addSanPhamModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white border-0">
                        <h5 class="modal-title fw-bold"><i class="fas fa-cube me-2"></i> THÊM SẢN PHẨM</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addSanPhamForm" enctype="multipart/form-data">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">MÃ SẢN PHẨM</label>
                                    <input type="text" class="form-control" id="newMaSanPham">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">TÊN SẢN PHẨM <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newTenSanPham" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">GIÁ BÁN (VNĐ) <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="newGiaTien" min="0" required>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold small">MÔ TẢ</label>
                                    <textarea class="form-control" id="newMoTa" rows="2"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">TRẠNG THÁI</label>
                                    <select class="form-select" id="newTrangThaiSelect">
                                        <option value="1">Đang bán</option>
                                        <option value="0">Ngừng bán</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-primary">ẢNH ĐẠI DIỆN</label>
                                    <input type="file" class="form-control" id="initialImageUpload" accept="image/*">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" form="addSanPhamForm" class="btn btn-primary px-4">Lưu lại</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editSanPhamModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-white border-0">
                        <h5 class="modal-title fw-bold"><i class="fas fa-edit me-2"></i> CẬP NHẬT SẢN PHẨM</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editSanPhamForm" enctype="multipart/form-data">
                            <input type="hidden" id="editSanPhamId">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">MÃ SẢN PHẨM</label>
                                    <input type="text" class="form-control bg-light" id="editMaSanPham" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">TÊN SẢN PHẨM <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editTenSanPham" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">GIÁ BÁN</label>
                                    <input type="number" class="form-control" id="editGiaTien" min="0" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted">SỐ LƯỢNG TỔNG (Chỉ đọc)</label>
                                    <input type="text" class="form-control bg-secondary-subtle text-secondary fw-bold"
                                           id="editSoLuong" readonly
                                           title="Số lượng được tự động tính từ các biến thể chi tiết"
                                           style="cursor: not-allowed;">
                                    <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                                        <i class="fas fa-info-circle me-1"></i>Số lượng được quản lý ở chi tiết sản
                                        phẩm.
                                    </small>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold small">MÔ TẢ</label>
                                    <textarea class="form-control" id="editMoTa" rows="2"></textarea>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">TRẠNG THÁI</label>
                                    <select class="form-select" id="editTrangThaiSelect">
                                        <option value="1">Đang bán</option>
                                        <option value="0">Ngừng bán</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-primary">CẬP NHẬT ẢNH</label>
                                    <div class="d-flex align-items-center gap-3">
                                        <img id="editImagePreview" src="https://via.placeholder.com/60"
                                             class="rounded border p-1"
                                             style="width: 60px; height: 60px; object-fit: cover;">
                                        <input type="file" class="form-control" id="editImageUpload" accept="image/*">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" form="editSanPhamForm" class="btn btn-warning text-white px-4">Cập nhật
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="manageImagesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-secondary text-white">
                        <h5 class="modal-title">Quản lý Album Ảnh</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6 id="currentProductName" class="mb-3 fw-bold text-primary"></h6>
                        <div id="image-preview-area-new" class="d-flex flex-wrap gap-2 mb-3"></div>
                        <div class="input-group">
                            <input type="file" class="form-control" id="newImageUploadNew" multiple accept="image/*">
                            <button class="btn btn-success" id="btnUploadImagesNew">Tải lên</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/js/main.js}"></script>

<script>
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-bottom-right",
        "timeOut": "3000"
    };

    function formatCurrency(amount) {
        // Đảm bảo amount là số trước khi format
        const numericAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
        if (isNaN(numericAmount)) return '0 VNĐ';

        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(numericAmount);
    }

    function renderStatusBadge(status) {
        return status === 1 ?
            '<span class="badge-status badge-active"><i class="fas fa-check-circle me-1"></i>Đang bán</span>' :
            '<span class="badge-status badge-inactive"><i class="fas fa-ban me-1"></i>Ngừng bán</span>';
    }

    $(document).ready(function () {
        let currentFilter = {
            page: 1,
            keyword: '',
            trangThai: ''
        };
        let currentEditingSanPhamId = null;

        // --- 1. LOAD DATA ---
        function loadSanPham() {
            let params = {
                page: currentFilter.page - 1,
                size: 5,
                keyword: currentFilter.keyword,
                trangThai: currentFilter.trangThai === '' ? null : parseInt(currentFilter.trangThai),
                // Bổ sung mặc định sắp xếp theo Ngày tạo giảm dần (Yêu cầu DISP-002)
                sort: 'ngayTao,desc'
            };

            $('#sanPhamTableBody').html('<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>');
            $('#paginationNav').empty();

            $.ajax({
                url: "/api/san-pham",
                type: "GET",
                data: params,
                dataType: "json",
                success: function (res) {
                    renderTable(res.content);
                    renderPagination(res.number + 1, res.totalPages);
                    updatePageInfo(res);
                },
                error: function () {
                    $('#sanPhamTableBody').html('<tr><td colspan="8" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>');
                    toastr.error("Không thể tải danh sách sản phẩm.");
                }
            });
        }

        function renderTable(list) {
            if (!list || list.length === 0) {
                $('#sanPhamTableBody').html('<tr><td colspan="8" class="text-center py-4 text-muted">Không có sản phẩm nào</td></tr>');
                return;
            }
            let html = '';
            list.forEach(sp => {
                let imgUrl = sp.tenHinhAnhChinh ? `/api/hinh-anh/download/${sp.tenHinhAnhChinh}` : 'https://via.placeholder.com/48?text=NoImg';
                let dateStr = sp.ngayTao ? new Date(sp.ngayTao).toLocaleDateString('vi-VN') : '-';

                // LOGIC NÚT DỪNG TRẠNG THÁI
                let toggleBtn = '';
                if (sp.trangThai === 1) {
                    // Đang bán -> Nút đỏ để Dừng
                    toggleBtn = `<button class="btn btn-action btn-light text-danger border btn-toggle-status" data-id="${sp.id}" data-status="0" title="Ngừng kinh doanh"><i class="fas fa-ban"></i></button>`;
                } else {
                    // Ngừng bán -> Nút xanh để Kích hoạt lại
                    toggleBtn = `<button class="btn btn-action btn-light text-success border btn-toggle-status" data-id="${sp.id}" data-status="1" title="Kích hoạt lại"><i class="fas fa-sync-alt"></i></button>`;
                }

                html += `
                <tr>
                    <td class="fw-bold text-primary">#${sp.maSanPham || 'N/A'}</td>
                    <td class="text-center"><img src="${imgUrl}" class="product-thumb" onerror="this.src='https://via.placeholder.com/48?text=Error'"></td>
                    <td class="fw-semibold">${sp.tenSanPham}</td>
                    <td class="text-end fw-bold text-dark">${formatCurrency(sp.giaTien)}</td>
                    <td class="text-center">${sp.soLuong || 0}</td>
                    <td class="text-center">${renderStatusBadge(sp.trangThai)}</td>
                    <td class="text-center small text-muted">${dateStr}</td>
                    <td class="text-center">
                        <button class="btn btn-action btn-light text-warning border me-1 btn-edit" data-id="${sp.id}" title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-action btn-light text-secondary border me-1 btn-manage-images" data-id="${sp.id}" data-name="${sp.tenSanPham}" title="Album ảnh"><i class="fas fa-images"></i></button>
                        ${toggleBtn}
                    </td>
                </tr>`;
            });
            $('#sanPhamTableBody').html(html);
        }

        function renderPagination(currentPage, totalPages) {
            if (totalPages <= 1) {
                $('#paginationNav').empty();
                return;
            }
            let nav = '<ul class="pagination pagination-sm mb-0">';
            nav += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">&laquo;</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                    nav += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                else if ((i === currentPage - 2 && i > 1) || (i === currentPage + 2 && i < totalPages))
                    nav += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            nav += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}">&raquo;</a></li></ul>`;
            $('#paginationNav').html(nav);
        }

        function updatePageInfo(data) {
            if (data.totalElements > 0) $('#pageInfo').html(`Hiển thị <strong>${data.numberOfElements}</strong> trên <strong>${data.totalElements}</strong> sản phẩm`);
            else $('#pageInfo').html('Không có dữ liệu');
        }

        // --- EVENTS ---
        $('#filterForm').submit(e => {
            e.preventDefault();
            currentFilter.keyword = $('#keyword').val().trim();
            currentFilter.trangThai = $('#trangThaiFilter').val();
            currentFilter.page = 1;
            loadSanPham();
        });
        $('#btnReset').click(() => {
            $('#keyword').val('');
            $('#trangThaiFilter').val('');
            currentFilter = {
                page: 1,
                keyword: '',
                trangThai: ''
            };
            loadSanPham();
        });
        $(document).on('click', '.page-link', function (e) {
            e.preventDefault();
            const page = parseInt($(this).data('page'));
            if (!$(this).parent().hasClass('disabled') && !isNaN(page)) {
                currentFilter.page = page;
                loadSanPham();
            }
        });


        // --- ADD SẢN PHẨM (Sử dụng SweetAlert2 cho xác nhận) ---
        $('#addSanPhamForm').submit(function (e) {
            e.preventDefault();

            // 1. Validate Tên và Giá tiền
            if (!$('#newTenSanPham').val().trim()) {
                toastr.warning("Tên sản phẩm không được để trống");
                return;
            }
            const giaTienVal = parseFloat($('#newGiaTien').val());
            if (isNaN(giaTienVal) || giaTienVal <= 0) {
                toastr.warning("Giá tiền phải lớn hơn 0");
                return;
            }

            // 2. Xác nhận trước khi gửi (SweetAlert2)
            Swal.fire({
                title: 'Xác nhận Thêm Sản phẩm?',
                text: "Bạn có chắc muốn thêm sản phẩm mới này vào hệ thống?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý, Thêm ngay!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    executeAddSanPham();
                }
            });
        });

        function executeAddSanPham() {
            const formData = new FormData();
            const spData = {
                maSanPham: $('#newMaSanPham').val().trim() || null,
                tenSanPham: $('#newTenSanPham').val().trim(),
                giaTien: parseFloat($('#newGiaTien').val()),
                moTa: $('#newMoTa').val().trim(),
                trangThai: parseInt($('#newTrangThaiSelect').val())
            };

            formData.append('sanPhamData', new Blob([JSON.stringify(spData)], {type: 'application/json'}));

            const fileInput = $('#initialImageUpload')[0];
            if (fileInput.files && fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }

            $.ajax({
                url: "/api/san-pham/create-with-image",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: function () {
                    $('#addSanPhamModal').find('button').prop('disabled', true);
                    Swal.fire({
                        title: 'Đang xử lý...',
                        text: 'Vui lòng chờ trong giây lát.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading()
                        }
                    });
                },
                success: () => {
                    Swal.fire('Thành công!', 'Sản phẩm mới đã được thêm.', 'success');
                    $('#addSanPhamModal').modal('hide');
                    $('#addSanPhamForm')[0].reset();
                    currentFilter.page = 1;
                    loadSanPham();
                },
                error: function (xhr) {
                    let msg = xhr.responseJSON?.message || xhr.responseText || "Lỗi thêm mới. Kiểm tra lại Backend.";
                    let title = "Lỗi Thêm Mới";
                    if (xhr.status === 409 || msg.toLowerCase().includes("trùng")) {
                        title = "Trùng lặp dữ liệu";
                        msg = "Mã hoặc Tên sản phẩm đã tồn tại!";
                    }
                    Swal.fire(title, msg, 'error');
                },
                complete: function () {
                    $('#addSanPhamModal').find('button').prop('disabled', false);
                    Swal.close();
                }
            });
        }

        // --- EDIT (LOAD DATA & SHOW IMAGE) ---
        $(document).on('click', '.btn-edit', function () {
            const id = $(this).data('id');
            $.get(`/api/san-pham/${id}`, function (sp) {
                $('#editSanPhamId').val(sp.id);
                $('#editMaSanPham').val(sp.maSanPham);
                $('#editTenSanPham').val(sp.tenSanPham);
                $('#editGiaTien').val(sp.giaTien);
                $('#editSoLuong').val(sp.soLuong || 0);
                $('#editMoTa').val(sp.moTa);
                $('#editTrangThaiSelect').val(sp.trangThai);

                $('#editImageUpload').val('');

                let imgUrl = 'https://via.placeholder.com/60?text=NoImg';
                if (sp.tenHinhAnhChinh) imgUrl = `/api/hinh-anh/download/${sp.tenHinhAnhChinh}`;
                $('#editImagePreview').attr('src', imgUrl);

                new bootstrap.Modal(document.getElementById('editSanPhamModal')).show();
            }).fail(() => toastr.error("Không tìm thấy thông tin sản phẩm."));
        });

        // --- UPDATE SẢN PHẨM (Sử dụng SweetAlert2 cho xác nhận) ---
        $('#editSanPhamForm').submit(function (e) {
            e.preventDefault();
            const id = $('#editSanPhamId').val();

            // Validation cho Giá tiền
            const giaTienVal = parseFloat($('#editGiaTien').val());
            if (isNaN(giaTienVal) || giaTienVal <= 0) {
                toastr.warning("Giá tiền phải lớn hơn 0");
                return;
            }

            // Xác nhận trước khi gửi (SweetAlert2)
            Swal.fire({
                title: 'Xác nhận Cập nhật?',
                text: "Bạn có chắc muốn lưu các thay đổi cho sản phẩm này?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Đồng ý, Cập nhật!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    executeUpdateSanPham(id);
                }
            });
        });

        function executeUpdateSanPham(id) {
            const formData = new FormData();

            const data = {
                maSanPham: $('#editMaSanPham').val(),
                tenSanPham: $('#editTenSanPham').val(),
                giaTien: parseFloat($('#editGiaTien').val()),
                moTa: $('#editMoTa').val(),
                trangThai: parseInt($('#editTrangThaiSelect').val())
            };

            formData.append('sanPhamData', new Blob([JSON.stringify(data)], {type: 'application/json'}));

            const file = $('#editImageUpload')[0].files[0];
            if (file) formData.append('file', file);

            $.ajax({
                url: `/api/san-pham/update-with-image/${id}`,
                type: 'PUT',
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: function () {
                    $('#editSanPhamModal').find('button').prop('disabled', true);
                    Swal.fire({
                        title: 'Đang xử lý...',
                        text: 'Vui lòng chờ trong giây lát.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading()
                        }
                    });
                },
                success: () => {
                    Swal.fire('Thành công!', 'Sản phẩm đã được cập nhật.', 'success');
                    $('#editSanPhamModal').modal('hide');
                    loadSanPham();
                },
                error: (xhr) => {
                    let msg = xhr.responseJSON?.message || xhr.responseText || "Lỗi cập nhật. Kiểm tra lại Backend.";
                    Swal.fire('Lỗi Cập Nhật', msg, 'error');
                },
                complete: function () {
                    $('#editSanPhamModal').find('button').prop('disabled', false);
                    Swal.close();
                }
            });
        }

        // --- ĐỔI TRẠNG THÁI (Sử dụng SweetAlert2 cho xác nhận) ---
        $(document).on('click', '.btn-toggle-status', function () {
            const id = $(this).data('id');
            const newStatus = $(this).data('status'); // 0 hoặc 1
            const actionText = newStatus === 1 ? "Kích hoạt lại" : "Ngừng kinh doanh";
            const icon = newStatus === 1 ? 'info' : 'warning';
            const confirmBtnColor = newStatus === 1 ? '#28a745' : '#dc3545';
            const actionMessage = newStatus === 1
                ? 'Bạn có chắc muốn KÍCH HOẠT lại sản phẩm này? Sản phẩm sẽ hiển thị trên trang bán hàng.'
                : 'Bạn có chắc muốn NGỪNG KINH DOANH sản phẩm này? Sản phẩm sẽ không còn hiển thị.';

            // Xác nhận trước khi đổi trạng thái (SweetAlert2)
            Swal.fire({
                title: `${actionText} Sản phẩm?`,
                text: actionMessage,
                icon: icon,
                showCancelButton: true,
                confirmButtonColor: confirmBtnColor,
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    executeStatusUpdate(id, newStatus, actionText);
                }
            });
        });

        function executeStatusUpdate(id, newStatus, actionText) {
            Swal.fire({
                title: 'Đang xử lý...',
                text: 'Vui lòng chờ trong giây lát.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            });
            $.ajax({
                url: `/api/san-pham/${id}/trang-thai?trangThai=${newStatus}`,
                type: 'PUT',
                success: () => {
                    Swal.fire('Thành công!', `Đã ${actionText} sản phẩm thành công!`, 'success');
                    loadSanPham();
                },
                error: (xhr) => {
                    Swal.fire('Lỗi Cập Nhật', "Lỗi khi cập nhật trạng thái. Vui lòng kiểm tra lại API Backend.", 'error');
                }
            });
        }

        // --- MANAGE IMAGES (ALBUM) ---
        function loadProductImagesForNewModal(id, name) {
            currentEditingSanPhamId = id;
            $('#currentProductName').text(name);
            $('#image-preview-area-new').html('<div class="spinner-border text-primary spinner-border-sm"></div>');

            $.get(`/api/hinh-anh/san-pham/${id}`, function (list) {
                let html = '';
                if (list.length) {
                    list.forEach(img => {
                        // Đảm bảo sử dụng tên file đã được lưu bằng UUID
                        html += `
                        <div class="position-relative border rounded" style="width: 80px; height: 80px;">
                            <img src="/api/hinh-anh/download/${img.tenHinhAnh}" class="w-100 h-100 object-fit-cover rounded" onerror="this.src='https://via.placeholder.com/80?text=Error'">
                            <button class="btn btn-danger btn-sm p-0 position-absolute top-0 end-0 delete-image-btn-new" data-id="${img.id}" style="width:20px;height:20px;">&times;</button>
                        </div>`;
                    });
                } else html = '<span class="text-muted small">Chưa có ảnh</span>';
                $('#image-preview-area-new').html(html);
            }).fail(() => toastr.error("Lỗi tải album ảnh."));
        }

        $(document).on('click', '.btn-manage-images', function () {
            loadProductImagesForNewModal($(this).data('id'), $(this).data('name'));
            new bootstrap.Modal(document.getElementById('manageImagesModal')).show();
        });

        $('#btnUploadImagesNew').click(function () {
            const files = $('#newImageUploadNew')[0].files;
            if (!files.length) return toastr.warning("Chọn ảnh để tải lên");

            // Xử lý upload ảnh (có thể thêm SweetAlert2 cho quá trình upload nếu cần)
            const fd = new FormData();
            for (let f of files) {
                fd.append('file', f);
            }
            fd.append('idSanPham', currentEditingSanPhamId);

            $.ajax({
                url: '/api/hinh-anh/upload',
                type: 'POST',
                data: fd,
                contentType: false,
                processData: false,
                beforeSend: function () {
                    $('#btnUploadImagesNew').prop('disabled', true).text('Tải lên...');
                },
                success: () => {
                    toastr.success("Tải ảnh thành công");
                    $('#newImageUploadNew').val('');
                    loadProductImagesForNewModal(currentEditingSanPhamId, $('#currentProductName').text());
                    loadSanPham();
                },
                error: (xhr) => {
                    let msg = xhr.responseJSON?.message || xhr.responseText || "Lỗi tải ảnh. Kiểm tra kích thước file.";
                    toastr.error(`Lỗi tải ảnh: ${msg}`);
                },
                complete: function() {
                    $('#btnUploadImagesNew').prop('disabled', false).text('Tải lên');
                }
            });
        });

        // --- XÓA ẢNH (Sử dụng SweetAlert2 cho xác nhận) ---
        $(document).on('click', '.delete-image-btn-new', function () {
            const imageId = $(this).data('id');

            Swal.fire({
                title: 'Xóa Ảnh?',
                text: "Bạn có chắc muốn XÓA ảnh này khỏi album? Thao tác này không thể hoàn tác!",
                icon: 'error',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Đồng ý, Xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    executeDeleteImage(imageId);
                }
            });
        });

        function executeDeleteImage(imageId) {
            Swal.fire({
                title: 'Đang xóa...',
                text: 'Vui lòng chờ trong giây lát.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            });
            $.ajax({
                url: `/api/hinh-anh/${imageId}`,
                type: 'DELETE',
                success: () => {
                    Swal.fire('Đã Xóa!', "Ảnh đã được xóa thành công.", 'success');
                    loadProductImagesForNewModal(currentEditingSanPhamId, $('#currentProductName').text());
                    loadSanPham();
                },
                error: () => {
                    Swal.fire('Lỗi', "Lỗi xóa ảnh. Vui lòng thử lại.", 'error');
                }
            });
        }

        loadSanPham();
    });
    $('#btnExportExcel').click(function () {
        window.location.href = "/api/san-pham/export/excel";
    });
</script>
</body>

</html>