<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Quản lý Sản phẩm</title>

 <style>

     :root {
         --sidebar-width: 260px;
         --navbar-height: 60px;
         --primary-color: #007bff;
         --secondary-bg: #2b3543;
         --text-light: #f8f9fa;
         --active-bg: #0056b3;
     }

     body {

         overflow-x: hidden;
         background-color: #f0f2f5;
     }


     .sidebar-wrapper {
         width: var(--sidebar-width);
         position: fixed; /* Đã đúng */
         top: var(--navbar-height); /* Đã đúng: Bắt đầu từ dưới navbar */
         left: 0; bottom: 0; /* Đã đúng: Kéo dài từ trên xuống dưới */
         overflow-y: auto; /* Đã đúng: Cho phép cuộn bên trong sidebar */
         z-index: 1000;
         background-color: var(--secondary-bg);
         transition: all 0.3s;
     }

     .main-content {
         margin-left: var(--sidebar-width);
         padding: 1.5rem;
         /* Điều chỉnh padding-top để tránh bị che bởi navbar cố định */
         padding-top: calc(var(--navbar-height) + 1.5rem);
         min-height: 100vh; /* Đảm bảo chiều cao tối thiểu cho nội dung */

         transition: margin-left 0.3s;
         /* Bỏ height và overflow-y: auto để cho phép toàn bộ trang cuộn */
     }


     .nav-link {
         color: #b8c7e0;
         padding: 0.75rem 1rem;
         margin-bottom: 0.25rem;
         transition: all 0.2s;
         display: flex;
         align-items: flex-start;
         line-height: 1.2;
         text-decoration: none;
         cursor: pointer;
     }
     .nav-link:hover {
         color: var(--text-light) !important;
         background-color: rgba(255, 255, 255, 0.1);
         border-radius: 5px;
     }
     .nav-link.active {
         color: var(--text-light) !important;
         background-color: var(--primary-color);
         border-radius: 5px;
         font-weight: 600;
     }

     .menu-text {
         font-size: 1rem;
         white-space: normal;
     }
     .nav-link i.fa-fw {
         margin-top: 0.15rem;
     }
     .nav-link .float-end {
         margin-top: 0.3rem;
         transition: transform 0.3s;
     }

     .submenu-item a.nav-link {
         padding-left: 2.5rem;
         font-size: 0.9rem;
         color: #d1d9e7;
         align-items: center;
     }
     .submenu-item a.nav-link:hover {
         background-color: rgba(255, 255, 255, 0.05);
     }
 </style>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.2/css/dataTables.bootstrap5.min.css" />
</head>
<body>
<nav th:replace="~{library/navbar :: admin-navbar}"></nav>

<div class="page-wrapper">
    <div th:replace="~{library/navbar :: admin-sidebar}"></div>
    <main class="main-content">

        <div class="container">
            <div class="row mb-3 p-3 border rounded bg-light">
                <h5 class="mb-3 text-info"><i class="fas fa-filter"></i> Bộ lọc tìm kiếm</h5>
                <form id="filterForm">
                    <div class="d-flex flex-wrap align-items-end gap-3">
                        <div class="form-group" style="min-width: 200px;">
                            <label for="keyword" class="form-label">Theo mã, tên</label>
                            <input type="text" id="keyword" class="form-control form-control-sm"
                                   placeholder="Tìm theo mã, tên sản phẩm" th:value="${keyword}">
                        </div>
                        <div class="form-group" style="min-width: 150px;">
                            <label for="trangThaiFilter" class="form-label">Trạng thái</label>
                            <select id="trangThaiFilter" class="form-select form-select-sm">
                                <option value="">-- Chọn trạng thái --</option>
                                <option value="1" th:selected="${trangThai != null and trangThai == 1}">Đang bán</option>
                                <option value="0" th:selected="${trangThai != null and trangThai == 0}">Ngừng bán</option>
                            </select>
                        </div>
                        <div class="form-group d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-search"></i> Lọc
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnReset">
                                <i class="fas fa-redo-alt"></i> Reset
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="row">
                <div class="col-12 data-panel">
                    <h3 class="mb-3">Quản lý Sản phẩm</h3>
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal"
                                data-bs-target="#addSanPhamModal">
                            <i class="fas fa-plus"></i> Thêm Sản phẩm
                        </button>
                        <button class="btn btn-secondary btn-sm"><i class="fas fa-file-export"></i> Xuất file</button>
                    </div>

                    <div class="table-responsive" style="height: 400px; overflow-y: auto;">
                        <table class="table table-bordered table-hover table-sm">
                            <thead class="thead-light table-dark sticky-top">
                            <tr>
                                <th>Mã SP (maSanPham)</th>
                                <th>Tên SP (tenSanPham)</th>
                                <th>Giá tiền (giaTien)</th>
                                <th>Số lượng (soLuong)</th>
                                <th>Trạng thái (trangThai)</th>
                                <th>Ngày tạo (ngayTao)</th>
                                <th>Thao tác</th>
                            </tr>
                            </thead>
                            <tbody id="sanPhamTableBody">
                            <tr><td colspan="7" class="text-center">Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <nav id="paginationNav"></nav>
                        <div id="pageInfo"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="addSanPhamModal" tabindex="-1" aria-labelledby="addSanPhamModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <form id="addSanPhamForm" method="post">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="addSanPhamModalLabel"><i class="fas fa-plus me-2"></i> THÊM MỚI SẢN PHẨM</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newMaSanPham" class="form-label">Mã Sản phẩm (maSanPham)</label>
                                    <input type="text" class="form-control" id="newMaSanPham" placeholder="Tự động nếu để trống">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="newTenSanPham" class="form-label">Tên Sản phẩm (tenSanPham) (*)</label>
                                    <input type="text" class="form-control" id="newTenSanPham" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newGiaTien" class="form-label">Giá tiền (giaTien) (*)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="newGiaTien" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="newSoLuong" class="form-label">Số lượng (soLuong) (*)</label>
                                    <input type="number" min="0" class="form-control" id="newSoLuong" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="newMoTa" class="form-label">Mô tả (moTa)</label>
                                    <textarea class="form-control" id="newMoTa" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Trạng thái (trangThai)</label><br>
                                    <div class="d-flex gap-4 pt-1">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="newTrangThai" id="newTrangThaiOn" value="1" checked>
                                            <label class="form-check-label" for="newTrangThaiOn">Đang bán (1)</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="newTrangThai" id="newTrangThaiOff" value="0">
                                            <label class="form-check-label" for="newTrangThaiOff">Ngừng bán (0)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Đóng</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Lưu Sản phẩm</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editSanPhamModal" tabindex="-1" aria-labelledby="editSanPhamModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <form id="editSanPhamForm" method="post">
                        <input type="hidden" id="editSanPhamId" name="id">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="editSanPhamModalLabel"><i class="fas fa-edit me-2"></i> CẬP NHẬT SẢN PHẨM</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editMaSanPham" class="form-label">Mã Sản phẩm (maSanPham)</label>
                                    <input type="text" class="form-control" id="editMaSanPham">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editTenSanPham" class="form-label">Tên Sản phẩm (tenSanPham) (*)</label>
                                    <input type="text" class="form-control" id="editTenSanPham" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editGiaTien" class="form-label">Giá tiền (giaTien) (*)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="editGiaTien" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editSoLuong" class="form-label">Số lượng (soLuong) (*)</label>
                                    <input type="number" min="0" class="form-control" id="editSoLuong" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="editMoTa" class="form-label">Mô tả (moTa)</label>
                                    <textarea class="form-control" id="editMoTa" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Trạng thái (trangThai)</label><br>
                                    <div class="d-flex gap-4 pt-1">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="editTrangThai" id="editTrangThaiOn" value="1">
                                            <label class="form-check-label" for="editTrangThaiOn">Đang bán (1)</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="editTrangThai" id="editTrangThaiOff" value="0">
                                            <label class="form-check-label" for="editTrangThaiOff">Ngừng bán (0)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Hủy</button>
                            <button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt me-1"></i> Cập nhật</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script th:src="@{/js/my-custom-scripts.js}"></script>

<script>
    // Cấu hình Toastr
    toastr.options = { "positionClass": "toast-top-right", "timeOut": "3000", "closeButton": true };

    $(document).ready(function() {
        // Biến lưu trạng thái lọc và phân trang
        let currentFilter = {
            page: 1, // Trang hiện tại (1-based for display)
            keyword: $('#keyword').val() || '', // Lấy từ Thymeleaf nếu có
            trangThai: $('#trangThaiFilter').val() || '' // Lấy từ Thymeleaf nếu có
        };
        let currentPageData = null; // Biến lưu dữ liệu trang hiện tại

        // Hàm gọi API để tải dữ liệu Sản phẩm
        function loadSanPham() {
            let params = {
                page: currentFilter.page - 1, // API dùng 0-based index
                size: 5, // Số item mỗi trang (CẬP NHẬT THEO @PageableDefault nếu muốn)
                keyword: currentFilter.keyword.trim(), // Gửi keyword đã trim()
                trangThai: currentFilter.trangThai === '' ? null : parseInt(currentFilter.trangThai)
            };

            $('#sanPhamTableBody').html('<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>');
            $('#pageInfo').text('');
            $('#paginationNav').empty();

            $.ajax({
                url: "/api/san-pham", // Endpoint API GET
                type: "GET",
                data: params,
                dataType: "json",
                success: function(response) {
                    currentPageData = response;
                    renderTable(response.content);
                    renderPagination(response.number + 1, response.totalPages);
                    updatePageInfo(response);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Lỗi tải SP:", textStatus, errorThrown, jqXHR.responseText);
                    $('#sanPhamTableBody').html('<tr><td colspan="7" class="text-danger text-center">Lỗi tải dữ liệu.</td></tr>');
                    $('#paginationNav').empty();
                    toastr.error("Lỗi tải dữ liệu sản phẩm.");
                }
            });
        }

        // Hàm vẽ bảng dữ liệu
        function renderTable(sanPhamList) {
            let html = '';
            if (!sanPhamList || sanPhamList.length === 0) {
                html = '<tr><td colspan="7" class="text-center">Không có sản phẩm nào khớp với bộ lọc.</td></tr>';
            } else {
                sanPhamList.forEach(function(sp) {
                    let trangThaiBadge = sp.trangThai === 1 ? '<span class="badge bg-success">Đang bán</span>' : '<span class="badge bg-danger">Ngừng bán</span>';
                    let giaTienFormatted = 'N/A';
                    if (sp.giaTien != null) {
                        try {
                            const giaTienFloat = parseFloat(sp.giaTien);
                            if (!isNaN(giaTienFloat)) {
                                giaTienFormatted = giaTienFloat.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                            } else {
                                giaTienFormatted = sp.giaTien + ' ₫';
                            }
                        } catch (e) {
                            giaTienFormatted = sp.giaTien + ' ₫';
                        }
                    }
                    let ngayTaoFormatted = 'N/A';
                    if (sp.ngayTao) {
                        try {
                            const dateObj = new Date(sp.ngayTao);
                            if (!isNaN(dateObj)) {
                                ngayTaoFormatted = dateObj.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            } else {
                                ngayTaoFormatted = sp.ngayTao.toString();
                            }
                        } catch (e) {
                            ngayTaoFormatted = sp.ngayTao.toString();
                        }
                    }
                    let maSpDisplay = sp.maSanPham || '';
                    let tenSpDisplay = sp.tenSanPham || '';
                    let soLuongDisplay = sp.soLuong != null ? sp.soLuong : '';

                    html += `<tr data-id="${sp.id}">
                                <td>${maSpDisplay}</td>
                                <td>${tenSpDisplay}</td>
                                <td class="text-end">${giaTienFormatted}</td>
                                <td class="text-center">${soLuongDisplay}</td>
                                <td class="text-center">${trangThaiBadge}</td>
                                <td class="text-center">${ngayTaoFormatted}</td>
                                <td class="text-center">
                                    <button class="btn btn-warning btn-sm me-1 btn-edit" data-id="${sp.id}" title="Sửa"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-danger btn-sm btn-delete" data-id="${sp.id}" title="Xóa"><i class="fas fa-trash"></i></button>
                                </td>
                             </tr>`;
                });
            }
            $('#sanPhamTableBody').html(html);
        }

        // Hàm vẽ phân trang
        function renderPagination(currentPage, totalPages) {
            if (totalPages <= 1) { $('#paginationNav').empty(); return; }
            let paginationHtml = '<ul class="pagination pagination-sm mb-0">';
            let prevDisabled = currentPage === 1 ? 'disabled' : '';
            paginationHtml += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${currentPage - 1}">&laquo;</a></li>`;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
                if (startPage > 2) {
                    paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                let active = currentPage === i ? 'active' : '';
                paginationHtml += `<li class="page-item ${active}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
            }

            let nextDisabled = currentPage === totalPages ? 'disabled' : '';
            paginationHtml += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${currentPage + 1}">&raquo;</a></li>`;
            paginationHtml += '</ul>';
            $('#paginationNav').html(paginationHtml);
        }

        // Hàm cập nhật thông tin trang
        function updatePageInfo(pageData) {
            if (!pageData || pageData.totalElements === 0) {
                $('#pageInfo').text('Không có dữ liệu');
                return;
            }
            const startItem = pageData.number * pageData.size + 1;
            const endItem = startItem + pageData.numberOfElements - 1;
            $('#pageInfo').text(`Hiển thị ${startItem}-${endItem} của ${pageData.totalElements} mục`);
        }

        // Sự kiện click phân trang
        $('#paginationNav').on('click', 'a.page-link', function(e) {
            e.preventDefault();
            const newPage = $(this).data('page');
            if (!newPage || $(this).parent().hasClass('disabled') || $(this).parent().hasClass('active')) return;
            currentFilter.page = newPage;
            loadSanPham();
        });

        // Sự kiện submit form lọc
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            currentFilter.keyword = $('#keyword').val().trim();
            currentFilter.trangThai = $('#trangThaiFilter').val();
            currentFilter.page = 1;
            loadSanPham();
        });

        // Sự kiện click nút Reset
        $('#btnReset').on('click', function() {
            $('#keyword').val('');
            $('#trangThaiFilter').val('');
            currentFilter = { page: 1, keyword: '', trangThai: '' };
            loadSanPham();
        });

        // Sự kiện submit form Thêm mới (ĐÃ SỬA)
        $('#addSanPhamForm').on('submit', function(e) {
            e.preventDefault();
            const $newGiaTien = $('#newGiaTien').val();
            const $newSoLuong = $('#newSoLuong').val();

            let newSanPham = {
                maSanPham: $('#newMaSanPham').val().trim() || null,
                tenSanPham: $('#newTenSanPham').val().trim(),
                giaTien: $newGiaTien ? Number($newGiaTien) : null,
                soLuong: $newSoLuong ? Number($newSoLuong) : null,
                moTa: $('#newMoTa').val().trim(),
                trangThai: parseInt($('input[name="newTrangThai"]:checked').val())
            };

            // Validation
            if (!newSanPham.tenSanPham) { toastr.warning("Tên sản phẩm là bắt buộc."); return; }
            if (newSanPham.giaTien == null || isNaN(newSanPham.giaTien) || newSanPham.giaTien < 0) { toastr.warning("Giá tiền không hợp lệ."); return; }
            if (newSanPham.soLuong == null || isNaN(newSanPham.soLuong) || newSanPham.soLuong < 0 || newSanPham.soLuong % 1 !== 0) { toastr.warning("Số lượng không hợp lệ (phải là số nguyên không âm)."); return; }

            $.ajax({
                url: "/api/san-pham", type: "POST", contentType: "application/json", data: JSON.stringify(newSanPham),
                beforeSend: function() {
                    $('#addSanPhamForm button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Đang lưu...');
                },
                complete: function() {
                    $('#addSanPhamForm button[type="submit"]').prop('disabled', false).html('<i class="fas fa-save me-1"></i> Lưu Sản phẩm');
                },
                success: function(response) {
                    toastr.success("Thêm thành công!");

                    // 1. Lắng nghe sự kiện KHI modal đã đóng xong
                    $('#addSanPhamModal').one('hidden.bs.modal', function () {
                        // 2. Sau khi modal đã đóng, mới reset form và tải lại bảng
                        $('#addSanPhamForm')[0].reset();
                        currentFilter.page = 1; // Thêm mới thì quay về trang 1
                        loadSanPham();
                    });

                    // 3. Bây giờ mới ra lệnh cho modal bắt đầu đóng
                    $('#addSanPhamModal').modal('hide');
                },
                error: function(jqXHR) {
                    let errorMessage = jqXHR.responseJSON?.message || jqXHR.responseText || "Lỗi thêm sản phẩm. Vui lòng kiểm tra lại dữ liệu.";
                    toastr.error(errorMessage);
                }
            });
        });

        // Sự kiện click nút Sửa (mở modal)
        $(document).on('click', '.btn-edit', function() {
            let sanPhamId = $(this).data('id');
            $.ajax({
                url: "/api/san-pham/" + sanPhamId, type: "GET", dataType: "json",
                success: function(sp) {
                    // Đổ dữ liệu vào form
                    $('#editSanPhamId').val(sp.id);
                    $('#editMaSanPham').val(sp.maSanPham || '');
                    $('#editTenSanPham').val(sp.tenSanPham || '');
                    $('#editGiaTien').val(sp.giaTien);
                    $('#editSoLuong').val(sp.soLuong);
                    $('#editMoTa').val(sp.moTa || '');
                    if (sp.trangThai === 1) $('#editTrangThaiOn').prop('checked', true);
                    else $('#editTrangThaiOff').prop('checked', true);

                    // Khởi tạo và mở modal
                    var editModal = new bootstrap.Modal(document.getElementById('editSanPhamModal'));
                    editModal.show();
                },
                error: function(jqXHR) {
                    toastr.error("Không tải được dữ liệu để sửa.");
                }
            });
        });

        // Sự kiện submit form Cập nhật (ĐÃ SỬA)
        $('#editSanPhamForm').on('submit', function(e) {
            e.preventDefault();
            let sanPhamId = $('#editSanPhamId').val();
            const $editGiaTien = $('#editGiaTien').val();
            const $editSoLuong = $('#editSoLuong').val();

            let updatedSanPham = {
                maSanPham: $('#editMaSanPham').val().trim(),
                tenSanPham: $('#editTenSanPham').val().trim(),
                giaTien: $editGiaTien ? Number($editGiaTien) : null,
                soLuong: $editSoLuong ? Number($editSoLuong) : null,
                moTa: $('#editMoTa').val().trim(),
                trangThai: parseInt($('input[name="editTrangThai"]:checked').val())
            };

            // Validation
            if (!updatedSanPham.tenSanPham) { toastr.warning("Tên sản phẩm là bắt buộc."); return; }
            if (updatedSanPham.giaTien == null || isNaN(updatedSanPham.giaTien) || updatedSanPham.giaTien < 0) { toastr.warning("Giá tiền không hợp lệ."); return; }
            if (updatedSanPham.soLuong == null || isNaN(updatedSanPham.soLuong) || updatedSanPham.soLuong < 0 || updatedSanPham.soLuong % 1 !== 0) { toastr.warning("Số lượng không hợp lệ (phải là số nguyên không âm)."); return; }

            $.ajax({
                url: "/api/san-pham/" + sanPhamId, type: "PUT", contentType: "application/json", data: JSON.stringify(updatedSanPham),
                beforeSend: function() {
                    $('#editSanPhamForm button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Đang cập nhật...');
                },
                complete: function() {
                    $('#editSanPhamForm button[type="submit"]').prop('disabled', false).html('<i class="fas fa-sync-alt me-1"></i> Cập nhật');
                },
                success: function(response) {
                    toastr.success("Cập nhật thành công!");

                    // 1. Lắng nghe sự kiện KHI modal đã đóng xong
                    $('#editSanPhamModal').one('hidden.bs.modal', function () {
                        // 2. Sau khi modal đã đóng, mới tải lại bảng
                        loadSanPham();
                    });

                    // 3. Bây giờ mới ra lệnh cho modal bắt đầu đóng
                    $('#editSanPhamModal').modal('hide');
                },
                error: function(jqXHR) {
                    let errorMessage = jqXHR.responseJSON?.message || jqXHR.responseText || "Lỗi cập nhật sản phẩm.";
                    toastr.error(errorMessage);
                }
            });
        });

        // Sự kiện click nút Xóa
        $(document).on('click', '.btn-delete', function() {
            let idToDelete = $(this).data('id');
            if (confirm(`Bạn chắc chắn muốn xóa Sản phẩm ID: ${idToDelete}? Thao tác này không thể hoàn tác.`)) {
                $.ajax({
                    url: "/api/san-pham/" + idToDelete, type: "DELETE",
                    success: function() {
                        toastr.success("Xóa thành công!");
                        // Nếu trang hiện tại chỉ còn 1 mục và đó là mục vừa xóa, quay lại trang trước
                        if (currentPageData && currentPageData.numberOfElements === 1 && currentFilter.page > 1) {
                            currentFilter.page--;
                        }
                        loadSanPham();
                    },
                    error: function(jqXHR) {
                        if (jqXHR.status === 409) {
                            toastr.error("Không thể xóa sản phẩm này vì đang được sử dụng ở nơi khác.");
                        } else {
                            toastr.error("Lỗi xóa sản phẩm.");
                        }
                    }
                });
            }
        });

        // --- KHỞI TẠO ---
        loadSanPham();
    });
</script>
</body>
</html>