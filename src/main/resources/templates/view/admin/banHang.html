<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Bán Hàng Tại Quầy</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

    <style>
        :root { --primary-color: #0d6efd; --bg-body: #f3f4f6; --card-radius: 8px; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); height: 100vh; overflow: hidden; }
        .navbar-custom { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 55px; }
        .nav-link { font-weight: 500; font-size: 0.95rem; color: #555 !important; }
        .nav-link:hover, .nav-link.active { color: var(--primary-color) !important; }
        .main-wrapper { height: calc(100vh - 55px); padding: 10px; }
        .left-panel { height: 100%; display: flex; flex-direction: column; gap: 10px; }
        .customer-card { background: white; border-radius: var(--card-radius); padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .cart-container { flex-grow: 1; background: white; border-radius: var(--card-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .cart-list { flex-grow: 1; overflow-y: auto; padding: 0; }
        .cart-item { padding: 8px 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 0.9rem; }
        .cart-item:hover { background-color: #f9fafb; }
        .cart-img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px; }
        .payment-card { background: white; border-radius: var(--card-radius); padding: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .right-panel { height: 100%; display: flex; flex-direction: column; gap: 10px; }
        .search-bar { background: white; padding: 8px; border-radius: var(--card-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .product-list-wrapper { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .product-card { background: white; border-radius: 6px; overflow: hidden; border: 1px solid #eee; transition: all 0.15s; cursor: pointer; height: 100%; position: relative; }
        .product-card:hover { transform: translateY(-2px); border-color: var(--primary-color); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .product-img { height: 120px; object-fit: cover; width: 100%; }
        .product-body { padding: 8px; text-align: center; }
        .product-title { font-size: 0.9rem; font-weight: 600; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .product-info { font-size: 0.8rem; color: #6c757d; margin-bottom: 4px; }
        .product-price { color: #d63384; font-weight: 700; font-size: 1rem; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary fs-5" href="#"><i class="bi bi-box-seam-fill"></i> F-STORE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-shop"></i> Bán hàng</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/admin/hoa-don}"><i class="bi bi-receipt"></i> Hóa đơn</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/admin/san-pham}"><i class="bi bi-box"></i> Sản phẩm</a></li>
            </ul>
            <div class="d-flex align-items-center gap-2">
                <div class="bg-light px-3 py-1 rounded-pill border fw-bold text-secondary" style="font-size: 0.85rem;" sec:authorize="isAuthenticated()">
                    <i class="bi bi-person-circle me-1"></i> <span th:text="${nhanVienHienTai.tenNhanVien}">Admin</span>
                    <input type="hidden" id="current-employee-id" th:value="${nhanVienHienTai.id}">
                </div>
                <form th:action="@{/logout}" method="post" class="m-0">
                    <button class="btn btn-sm btn-outline-danger border-0"><i class="bi bi-power"></i></button>
                </form>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid main-wrapper">
    <div class="row h-100 g-2">
        <div class="col-lg-6 col-md-6 h-100">
            <div class="left-panel">
                <div class="customer-card">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-primary bg-opacity-10 text-primary" id="ma-don-hang">#NEW</span>
                        <small class="text-muted fw-bold" id="clock">00:00</small>
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-person"></i></span>
                        <div class="form-control fw-bold border-start-0" id="customer-name" style="background: #fff;">Khách lẻ</div>
                        <button class="btn btn-outline-primary" id="btn-search-customer"><i class="bi bi-search"></i></button>
                        <button class="btn btn-outline-secondary" id="btn-reset-customer"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>

                <div class="cart-container">
                    <div class="p-2 bg-light fw-bold border-bottom d-flex justify-content-between small">
                        <span><i class="bi bi-cart3 me-1"></i> Giỏ hàng</span>
                        <span id="item-count" class="badge bg-secondary">0</span>
                    </div>
                    <div class="cart-list" id="cart-list">
                    </div>
                </div>

                <div class="payment-card">
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text bg-warning bg-opacity-10 text-warning"><i class="bi bi-ticket-perforated-fill"></i></span>
                        <select class="form-select" id="coupon-select">
                            <option value="" data-value="0">Mã giảm giá...</option>
                        </select>
                    </div>

                    <div class="d-flex justify-content-between small mb-1">
                        <span>Tổng tiền hàng:</span> <span class="fw-bold" id="subtotal">0 ₫</span>
                    </div>
                    <div class="d-flex justify-content-between small mb-1 text-success">
                        <span>Giảm giá:</span> <span class="fw-bold" id="discount">-0 ₫</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center pt-2 border-top mb-2">
                        <span class="fw-bold text-dark">KHÁCH TRẢ:</span>
                        <span class="fs-4 fw-bold text-primary" id="total" data-value="0">0 ₫</span>
                    </div>

                    <div class="btn-group w-100 mb-2" role="group">
                        <input type="radio" class="btn-check" name="pay-method" id="method-cash" value="CASH" checked>
                        <label class="btn btn-outline-secondary btn-sm py-2" for="method-cash"><i class="bi bi-cash"></i> Tiền mặt</label>

                        <input type="radio" class="btn-check" name="pay-method" id="method-qr" value="QR">
                        <label class="btn btn-outline-secondary btn-sm py-2" for="method-qr"><i class="bi bi-qr-code"></i> Chuyển khoản</label>
                    </div>

                    <div id="cash-section" class="row g-2 mb-2">
                        <div class="col-6">
                            <input type="text" class="form-control form-control-sm fw-bold" id="customer-paid" placeholder="Khách đưa">
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control form-control-sm fw-bold bg-light" id="change-amount" readonly placeholder="Tiền thừa">
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <button class="btn btn-outline-dark w-100 fw-bold btn-sm py-2" id="btn-save-draft"><i class="bi bi-floppy2"></i> Lưu tạm</button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-info w-100 fw-bold btn-sm py-2" id="btn-list-drafts"><i class="bi bi-list-ul"></i> Đơn chờ</button>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary w-100 py-2 fw-bold fs-6" id="btn-checkout">THANH TOÁN</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-6 h-100">
            <div class="right-panel">
                <div class="search-bar d-flex gap-2">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" id="product-search" placeholder="Tìm kiếm sản phẩm...">
                    </div>
                    <button class="btn btn-light border btn-sm" id="btn-reload"><i class="bi bi-arrow-clockwise"></i></button>
                </div>

                <div class="product-list-wrapper">
                    <div class="row row-cols-2 row-cols-lg-3 g-2" id="product-grid">
                        <div class="col-12 text-center mt-5"><div class="spinner-border text-primary spinner-border-sm"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-qr" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold text-primary w-100 text-center">QUÉT MÃ THANH TOÁN</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center pt-2">
                <div class="bg-light p-2 rounded border mb-2 d-inline-block">
                    <img src="" id="qr-image-popup" class="img-fluid" style="max-height: 250px;" alt="QR Code">
                </div>
                <div class="fw-bold fs-5 text-danger mb-1" id="qr-amount-popup">0 ₫</div>
                <div class="small text-muted">Nội dung: <span id="qr-content-popup" class="fw-bold text-dark">...</span></div>
                <div class="mt-3 d-grid">
                    <button class="btn btn-success fw-bold" id="btn-confirm-transfer"><i class="bi bi-check-circle-fill me-1"></i> KHÁCH ĐÃ CHUYỂN</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-customer" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title fw-bold">Tìm Khách Hàng</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="input-search-cust" placeholder="Tên hoặc SĐT...">
                    <button class="btn btn-primary" id="btn-do-search-cust">Tìm</button>
                </div>
                <div class="list-group" id="list-cust-results"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-drafts" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title fw-bold">Đơn Hàng Chờ</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-hover mb-0 text-center small">
                    <thead class="table-light"><tr><th>Mã HĐ</th><th>Khách</th><th>Tổng tiền</th><th>Thao tác</th></tr></thead>
                    <tbody id="tbody-drafts"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<script>
    const API_BASE = ""; // Để rỗng nếu cùng domain
    const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
    toastr.options = { "positionClass": "toast-top-center", "timeOut": "2000" };

    // !!! CẤU HÌNH NGÂN HÀNG !!!
    const BANK_ID = "TCB";
    const ACCOUNT_NO = "19039509651013";
    const ACCOUNT_NAME = "HOANG DUC ANH";

    // STATE
    let cart = [];
    let allProducts = [];
    let currentCustomer = null;
    let currentOrderCode = "";

    $(document).ready(function() {
        initNewOrder();
        loadProducts();
        loadCoupons();

        setInterval(() => $('#clock').text(new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})), 1000);

        // EVENTS
        $('#product-search').on('keyup', filterProducts);
        $('#btn-reload').click(loadProducts);
        $('#product-grid').on('click', '.product-card', function() { addToCart($(this).data()); });
        $('#cart-list').on('click', '.btn-remove', function() { removeFromCart($(this).data('id')); });
        $('#cart-list').on('change', '.qty-input', function() { updateQty($(this).data('id'), $(this).val()); });
        $('#btn-search-customer').click(() => $('#modal-customer').modal('show'));
        $('#btn-reset-customer').click(resetCustomer);
        $('#btn-do-search-cust').click(searchCustomer);
        $('#list-cust-results').on('click', '.item-cust', function() { setCustomer($(this).data('id'), $(this).data('name')); });
        $('input[name="pay-method"]').change(togglePaymentMethod);
        $('#customer-paid').on('input', calculateChange);
        $('#coupon-select').change(renderCart); // Khi chọn mã thì tính lại tiền ngay
        $('#btn-checkout').click(handleCheckoutClick);
        $('#btn-confirm-transfer').click(handleTransferConfirm);
        $('#btn-save-draft').click(saveDraft);
        $('#btn-list-drafts').click(loadDraftsList);
        $('#tbody-drafts').on('click', '.btn-select-draft', function() { loadDraftDetail($(this).data('id')); });
    });

    // --- 1. LOGIC COUPON & TÍNH TIỀN (QUAN TRỌNG) ---

    async function loadCoupons() {
        try {
            const res = await fetch(`${API_BASE}/api/phieu-giam-gia/active`);
            if (!res.ok) throw new Error(`Lỗi HTTP: ${res.status}`);

            const list = await res.json();
            console.log("Dữ liệu phiếu giảm giá từ API:", list); // Debug xem DB trả về gì

            let html = '<option value="" data-type="0" data-value="0" data-max="0" data-condition="0">-- Chọn mã giảm giá --</option>';

            list.forEach(c => {
                // Mapping dữ liệu chuẩn theo Model mới
                // hinhThucGiam: 1 = Tiền, 2 = Phần trăm
                // giaTriGiam: Giá trị (VD: 20 nếu là 20%)
                // soTienGiam: Đóng vai trò là GIẢM TỐI ĐA (Max Discount) nếu là %

                const type = c.hinhThucGiam || 1;
                const value = c.giaTriGiam || 0;
                const maxDiscount = c.soTienGiam || 999999999; // Nếu null thì coi như không giới hạn
                const condition = c.dieuKienGiamGia || 0;

                let label = `${c.maPhieuGiamGia}`;
                if(c.tenPhieuGiamGia) label += ` - ${c.tenPhieuGiamGia}`;

                // Tạo text hiển thị thông minh
                if (type === 2) {
                    // Loại %
                    label += ` [Giảm ${value}%`;
                    if(maxDiscount < 999999999) {
                        label += ` - Tối đa ${maxDiscount.toLocaleString('vi-VN')}đ`;
                    }
                    label += `]`;
                } else {
                    // Loại Tiền
                    label += ` [Giảm ${value.toLocaleString('vi-VN')}đ]`;
                }

                if (condition > 0) {
                    label += ` (Đơn > ${condition.toLocaleString('vi-VN')}đ)`;
                }

                // Lưu data vào thẻ option để dùng khi tính tiền
                html += `<option value="${c.id}"
                            data-type="${type}"
                            data-value="${value}"
                            data-max="${maxDiscount}"
                            data-condition="${condition}">
                            ${label}
                         </option>`;
            });
            $('#coupon-select').html(html);
        } catch(e) {
            console.error("Lỗi tải Coupon:", e);
        }
    }

    function renderCart() {
        if(!cart.length) {
            $('#cart-list').html('<div class="text-center mt-5 text-muted opacity-50"><i class="bi bi-basket3 fs-1"></i><p class="small mt-2">Giỏ trống</p></div>');
            $('#item-count').text('0');
            updateSummary(0, 0); return;
        }
        $('#item-count').text(cart.length);

        let subtotal = 0;
        let html = '';
        cart.forEach(i => {
            subtotal += i.price * i.qty;
            html += `
            <div class="cart-item">
                <img src="${i.img}" class="cart-img border">
                <div class="flex-grow-1 overflow-hidden">
                    <div class="fw-bold text-truncate" style="font-size: 0.9rem;">${i.name}</div>
                    <div class="small text-muted" style="font-size: 0.8rem;">${i.size} | ${i.color}</div>
                    <div class="small text-primary fw-bold">${formatter.format(i.price)}</div>
                </div>
                <input type="number" class="form-control form-control-sm text-center mx-2 qty-input" style="width:40px; padding: 2px;" value="${i.qty}" data-id="${i.id}">
                <button class="btn btn-sm text-danger btn-remove" data-id="${i.id}"><i class="bi bi-trash"></i></button>
            </div>`;
        });
        $('#cart-list').html(html);

        // --- TÍNH TOÁN GIẢM GIÁ ---
        let discountAmount = 0;
        const opt = $('#coupon-select option:selected');

        // Lấy dữ liệu từ option đã render ở loadCoupons
        const type = parseInt(opt.data('type')) || 1;
        const value = parseFloat(opt.data('value')) || 0;
        const max = parseFloat(opt.data('max')) || 0;
        const cond = parseFloat(opt.data('condition')) || 0;

        console.log(`Tính giảm giá: Type=${type}, Value=${value}, Max=${max}, Subtotal=${subtotal}`);

        // Kiểm tra điều kiện đơn hàng tối thiểu
        if (subtotal >= cond && value > 0) {
            if (type === 2) {
                // === GIẢM THEO % ===
                let percentDiscount = (subtotal * value) / 100;
                // Áp dụng mức giảm tối đa (Cap)
                if (max > 0 && percentDiscount > max) {
                    percentDiscount = max;
                }
                discountAmount = percentDiscount;
            } else {
                // === GIẢM THEO TIỀN ===
                discountAmount = value;
            }
        }

        updateSummary(subtotal, discountAmount);
    }

    function updateSummary(sub, disc) {
        $('#subtotal').text(formatter.format(sub));
        $('#discount').text(disc > 0 ? `-${formatter.format(disc)}` : '0 ₫');
        const total = Math.max(0, sub - disc);
        $('#total').text(formatter.format(total)).data('val', total);
        if ($('input[name="pay-method"]:checked').val() !== 'QR') calculateChange();
    }

    // --- 2. CÁC HÀM KHÁC (GIỮ NGUYÊN) ---

    function togglePaymentMethod() {
        const method = $('input[name="pay-method"]:checked').val();
        if (method === 'QR') $('#cash-section').hide();
        else $('#cash-section').show();
    }

    function calculateChange() {
        const total = $('#total').data('val');
        const paid = parseFloat($('#customer-paid').val().replace(/[^0-9]/g, '')) || 0;
        const change = paid - total;
        $('#change-amount').val(change >= 0 ? formatter.format(change) : 'Thiếu');
        $('#change-amount').toggleClass('text-danger', change < 0).toggleClass('text-dark', change >= 0);
    }

    function showQrPopup() {
        const total = $('#total').data('val');
        if (total <= 0) return toastr.warning("Đơn hàng 0 đồng!");
        const content = `${currentOrderCode} TT`;
        const url = `https://img.vietqr.io/image/${BANK_ID}-${ACCOUNT_NO}-compact.jpg?amount=${total}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(ACCOUNT_NAME)}`;
        $('#qr-image-popup').attr('src', url);
        $('#qr-amount-popup').text(formatter.format(total));
        $('#qr-content-popup').text(content);
        $('#modal-qr').modal('show');
    }

    async function loadProducts() {
        try {
            const res = await fetch(`${API_BASE}/api/data/san-pham-chi-tiet-active`);
            allProducts = await res.json();
            renderProductGrid(allProducts);
        } catch (e) { toastr.error("Lỗi tải SP"); }
    }

    function renderProductGrid(list) {
        if(!list.length) return $('#product-grid').html('<div class="col-12 text-center text-muted mt-5">Không tìm thấy SP</div>');
        let html = '';
        list.forEach(sp => {
            const name = sp.sanPham?.tenSanPham || 'SP';
            const price = sp.giaTien || 0;
            const size = sp.kichThuoc?.tenKichThuoc || '-';
            const color = sp.mauSac?.tenMauSac || '-';
            let img = 'https://via.placeholder.com/200x200?text=No+Img';
            if(sp.sanPham?.hinhAnh?.[0]?.tenHinhAnh) img = `/api/hinh-anh/download/${sp.sanPham.hinhAnh[0].tenHinhAnh}`;

            html += `
            <div class="col">
                <div class="product-card h-100" data-id="${sp.id}" data-name="${name}" data-price="${price}" data-img="${img}" data-size="${size}" data-color="${color}">
                    <img src="${img}" class="product-img">
                    <div class="product-body">
                        <div class="product-title" title="${name}">${name}</div>
                        <div class="product-info">${size} / ${color}</div>
                        <div class="product-price">${formatter.format(price)}</div>
                    </div>
                </div>
            </div>`;
        });
        $('#product-grid').html(html);
    }

    function filterProducts() {
        const term = $('#product-search').val().toLowerCase();
        renderProductGrid(allProducts.filter(p => (p.sanPham?.tenSanPham||'').toLowerCase().includes(term)));
    }

    function addToCart(p) {
        const item = cart.find(i => i.id == p.id);
        if(item) item.qty++; else cart.push({...p, qty: 1});
        renderCart();
    }
    function removeFromCart(id) { cart = cart.filter(i => i.id != id); renderCart(); }
    function updateQty(id, val) {
        const item = cart.find(i => i.id == id);
        if(item) { item.qty = Math.max(1, parseInt(val)||1); renderCart(); }
    }

    function initNewOrder() {
        cart = []; currentCustomer = null;
        currentOrderCode = "HD" + Math.floor(Date.now()/1000).toString().slice(-6);
        $('#ma-don-hang').text("#" + currentOrderCode);
        resetCustomer(); $('#coupon-select').val(''); $('#customer-paid').val('');
        renderCart();
        $('#method-cash').prop('checked', true); togglePaymentMethod();
    }

    function handleCheckoutClick() {
        if(!cart.length) return toastr.warning("Giỏ hàng trống");
        const method = $('input[name="pay-method"]:checked').val();
        if (method === 'QR') showQrPopup();
        else processPayment('CASH');
    }

    function handleTransferConfirm() {
        $('#modal-qr').modal('hide');
        processPayment('TRANSFER');
    }

    async function processPayment(method) {
        const total = $('#total').data('val');
        const paid = method === 'CASH' ? (parseFloat($('#customer-paid').val().replace(/[^0-9]/g,''))||0) : total;

        if(method === 'CASH' && paid < total) return toastr.error("Khách trả thiếu tiền!");

        const payload = {
            nhanVienId: $('#current-employee-id').val(),
            khachHangId: currentCustomer?.id,
            itemsList: cart.map(i => ({sanPhamChiTietId: i.id, soLuong: i.qty, donGia: i.price})),
            totalAmount: total,
            discountAmount: parseFloat($('#discount').text().replace(/[^0-9]/g,'').replace('-','').replace('₫','').replace('.','')) || 0,
            paymentMethod: method,
            orderCode: currentOrderCode,
            phieuGiamGiaId: $('#coupon-select').val() || null,
            customerPaidAmount: paid
        };

        try {
            const res = await fetch(API_BASE + '/api/ban-hang/thanh-toan', {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(res.ok) {
                toastr.success(`Thanh toán thành công! (${data.maHoaDon})`);
                initNewOrder();
            } else toastr.error(data.message);
        } catch(e) { toastr.error("Lỗi Server"); }
    }

    async function saveDraft() {
        if(!cart.length) return toastr.warning("Trống");
        try {
            const payload = {
                nhanVienId: $('#current-employee-id').val(),
                khachHangId: currentCustomer?.id,
                itemsList: cart.map(i => ({sanPhamChiTietId: i.id, soLuong: i.qty, donGia: i.price})),
                paymentMethod: 'DRAFT', orderCode: currentOrderCode,
                phieuGiamGiaId: $('#coupon-select').val() || null, customerPaidAmount: 0
            };
            const res = await fetch(`${API_BASE}/api/ban-hang/luu-tam`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            const data = await res.json();
            if(res.ok) { toastr.success("Đã lưu tạm: " + data.maHoaDon); initNewOrder(); }
            else toastr.error(data.message);
        } catch(e) {}
    }

    async function searchCustomer() {
        const kw = $('#input-search-cust').val(); if(!kw) return;
        try {
            const res = await fetch(`${API_BASE}/api/khach-hang/search?keyword=${kw}`);
            const list = await res.json();
            let html = '';
            list.forEach(c => html += `<a href="#" class="list-group-item list-group-item-action item-cust" data-id="${c.id}" data-name="${c.tenKhachHang}"><b>${c.tenKhachHang}</b> - ${c.soDienThoai}</a>`);
            $('#list-cust-results').html(html || '<div class="p-3 text-center">Không tìm thấy</div>');
        } catch(e) {}
    }
    function setCustomer(id, name) { currentCustomer = {id, name}; $('#customer-name').text(name).addClass('text-primary'); $('#modal-customer').modal('hide'); }
    function resetCustomer() { currentCustomer = null; $('#customer-name').text('Khách lẻ').removeClass('text-primary'); }

    async function loadDraftsList() {
        try {
            const res = await fetch(`${API_BASE}/api/ban-hang/hoa-don-tam`);
            const list = await res.json();
            let html = '';
            list.forEach(hd => {
                html += `<tr><td>${hd.maHoaDon}</td><td>${hd.khachHang?.tenKhachHang||'Lẻ'}</td><td>${formatter.format(hd.tongTienSauGiam)}</td>
                <td><button class="btn btn-sm btn-primary btn-select-draft" data-id="${hd.id}">Chọn</button></td></tr>`;
            });
            $('#tbody-drafts').html(html || '<tr><td colspan="4" class="text-center">Trống</td></tr>');
            $('#modal-drafts').modal('show');
        } catch(e) {}
    }

    async function loadDraftDetail(id) {
        try {
            const res = await fetch(`${API_BASE}/api/ban-hang/hoa-don-tam/${id}`);
            const hd = await res.json();
            currentOrderCode = hd.maHoaDon; $('#ma-don-hang').text("#"+hd.maHoaDon);
            if(hd.khachHang) setCustomer(hd.khachHang.id, hd.khachHang.tenKhachHang); else resetCustomer();
            if(hd.phieuGiamGia) $('#coupon-select').val(hd.phieuGiamGia.id); else $('#coupon-select').val('');
            cart = (hd.hoaDonChiTiets||[]).map(d => {
                const sp = d.sanPhamChiTiet;
                let img = 'https://via.placeholder.com/200';
                if(sp.sanPham?.hinhAnh?.[0]?.tenHinhAnh) img = `/api/hinh-anh/download/${sp.sanPham.hinhAnh[0].tenHinhAnh}`;
                return {
                    id: sp.id, name: sp.sanPham.tenSanPham, price: d.donGia, qty: d.soLuong, img: img,
                    size: sp.kichThuoc?.tenKichThuoc||'-', color: sp.mauSac?.tenMauSac||'-'
                };
            });
            renderCart(); $('#modal-drafts').modal('hide'); toastr.success("Đã tải đơn: "+hd.maHoaDon);
        } catch(e) {}
    }
</script>

</body>
</html>