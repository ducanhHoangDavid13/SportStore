<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao Diện Bán Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .product-grid-container { max-height: 85vh; overflow-y: auto; }
        .sticky-top-search { top: 1rem; z-index: 10; }
        .product-card-img { aspect-ratio: 1 / 1; object-fit: cover; }
        .cart-item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .product-card { cursor: pointer; transition: all 0.2s ease-in-out; }
        .product-card:hover { transform: scale(1.03); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .quantity-input { max-width: 70px; }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>

<div class="container-fluid p-3">
    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="bi bi-receipt-cutoff me-2"></i>Đơn Hàng:
                                <strong id="ma-don-hang">#...</strong>
                            </h5>
                            <small class="text-muted" id="customer-name">Khách hàng: <strong>Khách lẻ</strong></small>
                        </div>
                        <button class="btn btn-outline-primary" id="choose-customer-btn">
                            <i class="bi bi-person-plus-fill me-1"></i> Chọn Khách hàng
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-white py-3"><h6 class="mb-0">Giỏ hàng</h6></div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="cart-items-list">
                        <li id="empty-cart-message" class="list-group-item text-center text-muted p-5">
                            <i class="bi bi-cart-x fs-1"></i><p class="mt-2">Chưa có sản phẩm nào.</p>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label for="coupon-select" class="form-label">Phiếu giảm giá:</label>
                        <select class="form-select" id="coupon-select">
                            <option value="" data-value="0">-- Không dùng --</option>
                        </select>
                    </div>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            Tổng tiền hàng: <span id="subtotal-amount">0 ₫</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            Chiết khấu: <span id="discount-amount" class="text-danger">0 ₫</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 border-0">
                            <h5 class="mb-0">CẦN THANH TOÁN:</h5>
                            <h5 class="mb-0 text-primary" id="total-amount">0 ₫</h5>
                        </li>
                    </ul> <hr>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label for="customer-paid" class="form-label">Khách đưa</label>
                            <input type="text" class="form-control form-control-lg" id="customer-paid" value="0">
                        </div>
                        <div class="col-6">
                            <label for="customer-change" class="form-label">Tiền thừa trả khách</label>
                            <input type="text" class="form-control form-control-lg" id="customer-change" value="0" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Phương thức:</label>
                        <div class="d-flex">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cash" checked>
                                <label class="form-check-label" for="cash">Tiền mặt</label>
                            </div>
                            <div class="form-check me-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="transfer">
                                <label class="form-check-label" for="transfer">Chuyển khoản (Chờ)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="qr">
                                <label class="form-check-label" for="qr">VietQR (Tự động)</label>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-lg w-100 fw-bold fs-5" id="checkout-button">
                        <i class="bi bi-check-circle-fill me-2"></i>THANH TOÁN (F9)
                    </button>
                    <button class="btn btn-info btn-lg w-100 mt-2" id="print-pdf-btn">
                        <i class="bi bi-printer-fill me-2"></i> Xuất Hóa Đơn (PDF)
                    </button>
                    <div class="row g-2 mt-2">
                        <div class="col">
                            <button class="btn btn-outline-secondary w-100" id="save-draft-button">
                                <i class="bi bi-floppy me-1"></i> Lưu Tạm
                            </button>
                        </div>
                        <div class="col">
                            <button class="btn btn-outline-danger w-100" id="new-order-button">
                                <i class="bi bi-x-circle me-1"></i> Đơn Mới
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm border-0 mb-3 sticky-top-search">
                <div class="card-body">
                    <input type="text" class="form-control" id="search-product-input" placeholder="Quét mã vạch, nhập tên hoặc mã SP...">
                </div>
            </div>
            <div class="product-grid-container p-1">
                <div class="row row-cols-2 row-cols-md-3 g-3" id="product-grid-list">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quét mã VietQR để thanh toán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="qr-image" src="" alt="VietQR Code" class="img-fluid mb-3">
                <h5 id="qr-amount" class="text-danger"></h5>
                <p class="text-muted">Hệ thống sẽ tự động xác nhận khi tiền về</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const { jsPDF } = window.jspdf;
        const API_BASE = "http://localhost:8080"; // Đổi lại PORTHOST của bạn

        // --- Biến toàn cục ---
        let cartItems = []; // Giỏ hàng
        let allProducts = []; // Danh sách SP
        let currentTotal = 0; // Tổng tiền cuối
        let currentSubtotal = 0; // Tổng tiền hàng
        let currentDiscount = 0; // Tiền giảm
        let currentCustomerId = null; // ID Khách hàng
        let currentOrderCode = ""; // Mã HĐ

        // --- Định dạng tiền tệ ---
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency', currency: 'VND'
        });

        // --- Lấy các phần tử DOM ---
        const productGridList = document.getElementById("product-grid-list");
        const couponSelect = document.getElementById("coupon-select");
        const cartList = document.getElementById("cart-items-list");
        const emptyCartMsg = document.getElementById("empty-cart-message");
        const subtotalEl = document.getElementById("subtotal-amount");
        const discountEl = document.getElementById("discount-amount");
        const totalEl = document.getElementById("total-amount");
        const customerPaidInput = document.getElementById("customer-paid");
        const customerChangeOutput = document.getElementById("customer-change");
        const newOrderButton = document.getElementById("new-order-button");
        const checkoutButton = document.getElementById("checkout-button");
        const saveDraftButton = document.getElementById("save-draft-button");
        const printPdfButton = document.getElementById("print-pdf-btn");
        const maDonHangEl = document.getElementById("ma-don-hang");
        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
        const qrImageEl = document.getElementById("qr-image");
        const qrAmountEl = document.getElementById("qr-amount");
        const searchInput = document.getElementById("search-product-input");

        // --- HÀM TẢI DỮ LIỆU ĐỘNG ---
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/api/data/san-pham-active`);
                if (!response.ok) throw new Error('Không thể tải sản phẩm');
                allProducts = await response.json(); // Lưu vào biến toàn cục
                renderProducts(allProducts); // Hiển thị
            } catch (error) {
                console.error("Lỗi tải sản phẩm:", error);
                productGridList.innerHTML = '<p class="text-danger">Lỗi tải sản phẩm.</p>';
            }
        }

        async function loadCoupons() {
            try {
                const response = await fetch(`${API_BASE}/api/data/phieu-giam-gia-active`);
                if (!response.ok) throw new Error('Không thể tải PGG');
                const coupons = await response.json();
                coupons.forEach(coupon => {
                    // Dùng tenPhieuGiamGia và soTienGiam từ Model
                    const optionHtml = `
                        <option value="${coupon.id}" data-value="${coupon.soTienGiam}">
                            ${coupon.tenPhieuGiamGia} (Giảm ${formatter.format(coupon.soTienGiam)})
                        </option>
                    `;
                    couponSelect.insertAdjacentHTML('beforeend', optionHtml);
                });
            } catch (error) {
                console.error("Lỗi tải PGG:", error);
            }
        }

        // --- HÀM VẼ (RENDER) ---
        function renderProducts(productsToRender) {
            productGridList.innerHTML = ''; // Xóa cũ
            if (productsToRender.length === 0) {
                productGridList.innerHTML = '<p>Không tìm thấy sản phẩm.</p>';
                return;
            }

            productsToRender.forEach(spct => {
                const tenSP = spct.sanPham.tenSanPham;
                const giaTien = spct.giaTien;
                const idSPCT = spct.id;
                const imgUrl = "https://via.placeholder.com/300x300"; // Tạm

                const productCardHtml = `
                    <div class="col">
                        <div class="card shadow-sm border-0 product-card h-100"
                             data-id="${idSPCT}"
                             data-name="${tenSP}"
                             data-price="${giaTien}"
                             data-img="${imgUrl}">
                            <img src="${imgUrl}" class="card-img-top product-card-img" alt="${tenSP}">
                            <div class="card-body p-2 text-center">
                                <h6 class="card-title mb-1 fs-sm">${tenSP} (ID: ${idSPCT})</h6>
                                <p class="card-text text-primary fw-bold mb-0">${formatter.format(giaTien)}</p>
                            </div>
                        </div>
                    </div>
                `;
                productGridList.insertAdjacentHTML('beforeend', productCardHtml);
            });
            attachProductClickListeners(); // Gắn lại sự kiện
        }

        function renderCart() {
            cartList.innerHTML = '';
            if (cartItems.length === 0) {
                cartList.appendChild(emptyCartMsg.cloneNode(true));
            } else {
                cartItems.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex align-items-center";
                    li.innerHTML = `
                        <img src="${item.img}" class="cart-item-img me-3" alt="${item.name}">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${item.name}</h6>
                            <small class="text-muted">${formatter.format(item.price)}</Sall>
                        </div>
                        <input type="number" class="form-control text-center quantity-input mx-3"
                               value="${item.quantity}" min="1" data-id="${item.id}">
                        <div class="text-end" style="min-width: 100px;">
                            <h6 class="mb-0">${formatter.format(item.price * item.quantity)}</h6>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-3 remove-item-btn" data-id="${item.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    cartList.appendChild(li);
                });
            }
            updateTotals();
            addCartEventListeners();
        }

        // --- HÀM LOGIC GIỎ HÀNG ---
        function addItemToCart(product) {
            const existingItem = cartItems.find(item => item.id === product.id);
            if (existingItem) { existingItem.quantity++; }
            else { cartItems.push({ ...product, quantity: 1 }); }
            renderCart();
        }
        function updateQuantity(productId, newQuantity) {
            const item = cartItems.find(item => item.id === productId);
            if (item) {
                item.quantity = parseInt(newQuantity) || 1;
                if (item.quantity < 1) item.quantity = 1;
            }
            renderCart();
        }
        function removeItem(productId) {
            cartItems = cartItems.filter(item => item.id !== productId);
            renderCart();
        }
        function updateTotals() {
            currentSubtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Lấy tiền giảm từ PGG
            const selectedCoupon = couponSelect.options[couponSelect.selectedIndex];
            currentDiscount = parseFloat(selectedCoupon.dataset.value || 0);

            // (Logic PGG: Bạn nói sẽ tự xử lý, ví dụ đơn giản)
            // if (currentSubtotal < 500000) currentDiscount = 0; // Ví dụ điều kiện

            currentTotal = currentSubtotal - currentDiscount;

            subtotalEl.innerText = formatter.format(currentSubtotal);
            discountEl.innerText = formatter.format(currentDiscount);
            totalEl.innerText = formatter.format(currentTotal);

            updateChange();
        }
        function updateChange() {
            const paidAmount = parseFloat(customerPaidInput.value.replace(/,/g, '')) || 0;
            const change = paidAmount - currentTotal;
            if (currentTotal > 0 && change >= 0) {
                customerChangeOutput.value = formatter.format(change);
            } else if (currentTotal > 0 && change < 0) {
                customerChangeOutput.value = "Chưa đủ";
            } else {
                customerChangeOutput.value = "0 ₫";
            }
        }
        function createNewOrder() {
            cartItems = [];
            currentCustomerId = null;
            currentOrderCode = "HD" + Math.floor(100000 + Math.random() * 900000); // Tạo mã mới
            maDonHangEl.innerText = "#" + currentOrderCode;
            customerPaidInput.value = "0";
            couponSelect.value = ""; // Reset PGG
            renderCart();
        }
        function getOrderData() {
            return {
                customerId: currentCustomerId,
                items: cartItems.map(item => ({
                    productId: parseInt(item.id),
                    quantity: item.quantity,
                    price: parseFloat(item.price)
                })),
                totalAmount: currentTotal,
                paidAmount: parseFloat(customerPaidInput.value.replace(/,/g, '')) || 0,
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').id
            };
        }

        // --- HÀM GỌI API ---
        async function callApi(endpoint, orderData) {
            console.log(`Gửi đến ${endpoint}:`, JSON.stringify(orderData, null, 2));
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Lỗi không xác định');
            }
            return response.json();
        }

        // --- HÀM XỬ LÝ SỰ KIỆN CHÍNH ---
        async function handleCheckout() {
            if (cartItems.length === 0) {
                alert("Giỏ hàng rỗng."); return;
            }

            const orderData = getOrderData();
            const paymentMethod = orderData.paymentMethod;

            try {
                if (paymentMethod === 'cash') {
                    // 1. TIỀN MẶT
                    if (orderData.paidAmount < currentTotal) {
                        alert('Lỗi: Khách đưa chưa đủ tiền!');
                        customerPaidInput.focus();
                        return;
                    }
                    const hoaDon = await callApi('/api/ban-hang/thanh-toan', orderData);
                    alert(`Thanh toán Tiền mặt thành công! (HĐ: ${hoaDon.maHoaDon})`);
                    createNewOrder();

                } else if (paymentMethod === 'qr' || paymentMethod === 'transfer') {
                    // 2. QR / CHUYỂN KHOẢN (Đều phải tạo đơn Chờ)

                    // Gán mã HĐ tự tạo trước
                    orderData.orderCode = currentOrderCode;

                    const hoaDon = await callApi('/api/ban-hang/luu-tam', orderData);

                    // Cập nhật mã HĐ chuẩn từ server
                    maDonHangEl.innerText = hoaDon.maHoaDon;

                    if (paymentMethod === 'qr') {
                        // Gọi API tạo QR
                        generateQrCode(hoaDon.maHoaDon, orderData.totalAmount);
                        // (Đơn hàng sẽ hoàn tất khi Webhook gọi)
                    } else {
                        // Báo cho NV chờ
                        alert(`Đã tạo đơn Chờ Chuyển khoản (HĐ: ${hoaDon.maHoaDon}). Vui lòng chờ tiền về.`);
                        createNewOrder();
                    }
                }
            } catch (error) {
                console.error('Lỗi Thanh toán/Lưu tạm:', error);
                alert('Có lỗi xảy ra: ' + error.message);
            }
        }

        async function handleSaveDraft() {
            if (cartItems.length === 0) {
                alert("Giỏ hàng rỗng."); return;
            }
            const orderData = getOrderData();
            // Ép PTTT là "null" hoặc "cash" để nó hiểu là HĐ Tạm (0)
            orderData.paymentMethod = "cash";

            try {
                const hoaDon = await callApi('/api/ban-hang/luu-tam', orderData);
                alert(`Đã lưu Hóa đơn tạm thành công! (HĐ: ${hoaDon.maHoaDon})`);
                createNewOrder();
            } catch (error) {
                alert('Lỗi Lưu Tạm: ' + error.message);
            }
        }

        async function generateQrCode(orderCode, amount) {
            try {
                const response = await fetch(`${API_BASE}/api/ban-hang/generate-qr`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, orderCode: orderCode })
                });
                if (!response.ok) throw new Error('Lỗi tạo link QR');

                const data = await response.json();
                if (data.qrLink) {
                    qrImageEl.src = data.qrLink;
                    qrAmountEl.innerText = "Số tiền: " + formatter.format(amount);
                    qrModal.show();
                }
            } catch (err) {
                alert("Lỗi tạo mã QR: " + err.message);
            }
        }

        function handlePrintPdf() {
            // (Code PDF của bạn - không đổi)
            if (cartItems.length === 0) {
                alert("Chưa có sản phẩm."); return;
            }
            const doc = new jsPDF();
            doc.setFont("helvetica", "normal");
            doc.text("HOA DON BAN LE", 105, 20, { align: 'center' });
            doc.text(`Ma Don: ${maDonHangEl.innerText}`, 20, 30);
            doc.text(`Khach hang: Khach le`, 20, 40);

            let y = 62;
            doc.text("San pham", 20, y);
            doc.text("SL", 130, y);
            doc.text("Don gia", 150, y);
            doc.text("Thanh tien", 170, y);
            y += 3;
            doc.line(20, y, 190, y);
            y += 7;

            cartItems.forEach(item => {
                doc.text(item.name, 20, y);
                doc.text(item.quantity.toString(), 130, y);
                doc.text(formatter.format(item.price), 150, y);
                doc.text(formatter.format(item.price * item.quantity), 170, y);
                y += 7;
            });

            doc.line(20, y, 190, y); y += 7;
            doc.setFont("helvetica", "bold");
            doc.text("Tong tien hang:", 100, y);
            doc.text(formatter.format(currentSubtotal), 170, y); y += 7;
            doc.text("Giam gia:", 100, y);
            doc.text(formatter.format(currentDiscount), 170, y); y += 7;
            doc.text("CAN THANH TOAN:", 100, y);
            doc.text(formatter.format(currentTotal), 170, y);

            doc.save(`HoaDon-${currentOrderCode}.pdf`);
        }

        function handleSearchProducts() {
            const keyword = searchInput.value.toLowerCase().trim();
            if (!keyword) {
                renderProducts(allProducts); // Nếu trống, hiện tất cả
                return;
            }

            const filteredProducts = allProducts.filter(spct =>
                spct.sanPham.tenSanPham.toLowerCase().includes(keyword) ||
                spct.id.toString().includes(keyword)
            );
            renderProducts(filteredProducts);
        }

        // --- GẮN SỰ KIỆN BAN ĐẦU ---
        function attachProductClickListeners() {
            document.querySelectorAll(".product-card").forEach(card => {
                card.addEventListener("click", () => {
                    const product = card.dataset;
                    addItemToCart({
                        id: product.id,
                        name: product.name,
                        price: parseFloat(product.price),
                        img: product.img
                    });
                });
            });
        }

        customerPaidInput.addEventListener("input", updateChange);
        newOrderButton.addEventListener("click", createNewOrder);
        checkoutButton.addEventListener("click", handleCheckout);
        saveDraftButton.addEventListener("click", handleSaveDraft);
        printPdfButton.addEventListener("click", handlePrintPdf);
        couponSelect.addEventListener("change", updateTotals); // Cập nhật tiền khi đổi PGG
        searchInput.addEventListener("keyup", handleSearchProducts);

        // --- KHỞI CHẠY ---
        createNewOrder();
        loadProducts();
        loadCoupons();
    });
</script>

</body>
</html>