<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS PRO - Bán Hàng Tại Quầy</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
          rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
          rel="stylesheet"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #0d6efd;
            --bg-app: #f2f6fc;
            --surface: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Navbar */
        .navbar-pos {
            background: var(--surface);
            height: 60px;
            border-bottom: 1px solid #eef2f6;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-link-custom {
            text-decoration: none;
            color: #555;
            font-weight: 500;
            margin-left: 15px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .nav-link-custom:hover {
            color: var(--primary);
        }

        /* Layout */
        .pos-container {
            flex: 1;
            padding: 15px;
            display: grid;
            grid-template-columns: 7fr 5fr;
            gap: 15px;
            overflow: hidden;
        }

        .pos-card {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }

        /* Cart Area */
        .cart-body {
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }

        .cart-table {
            width: 100%;
            border-collapse: collapse;
        }

        .cart-table th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
            font-size: 0.8rem;
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .cart-table td {
            padding: 10px;
            vertical-align: middle;
            border-bottom: 1px solid #f9f9f9;
        }

        .qty-control {
            display: inline-flex;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .qty-btn {
            width: 28px;
            height: 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .qty-input {
            width: 40px;
            height: 30px;
            border: none;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            text-align: center;
            font-weight: 600;
            outline: none;
            font-size: 0.9rem;
        }

        /* Remove arrows from number input */
        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Product & Filter */
        .search-container {
            display: flex;
            gap: 10px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            outline: none;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .btn-filter {
            width: 45px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-filter:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .product-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: #f8f9fa;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .prod-card {
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 15px;
            height: 110px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .prod-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            background-color: #f8faff;
        }

        .prod-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
            line-height: 1.3;
            text-align: center;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .prod-code {
            font-size: 0.75rem;
            color: #6c757d;
            text-align: center;
            background: #f1f3f5;
            padding: 2px 8px;
            border-radius: 4px;
            align-self: center;
            font-weight: 500;
        }

        .prod-price-preview {
            font-size: 0.8rem;
            color: var(--primary);
            text-align: center;
            font-weight: 700;
            margin-top: 4px;
        }

        /* Variant Options in Modal */
        .variant-option {
            border: 1px solid #ddd;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            background: #fff;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
        }

        .variant-option:hover:not(.disabled) {
            border-color: var(--primary);
            background: #f0f8ff;
            color: var(--primary);
        }

        .variant-option.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            font-weight: 600;
        }

        .variant-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #e9ecef;
            color: #adb5bd;
            text-decoration: line-through;
        }

        /* Payment Footer */
        .payment-footer {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .total-price {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
        }

        /* Select2 Customization */
        .select2-container--bootstrap-5 .select2-selection {
            border-color: #dee2e6;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>

<nav class="navbar-pos">
    <div class="d-flex align-items-center">
        <a href="#" class="fw-bold text-decoration-none text-primary fs-5 me-4"><i class="bi bi-shop me-2"></i>POS
            F-STORE</a>
        <div class="d-none d-md-flex">
            <a th:href="@{/admin/hoa-don}" class="nav-link-custom" target="_blank"><i class="bi bi-receipt"></i> QL Hóa
                Đơn</a>
            <a th:href="@{/admin/san-pham-chi-tiet}" class="nav-link-custom" target="_blank"><i
                    class="bi bi-box-seam"></i> QL SPCT</a>
        </div>
    </div>
    <div class="d-flex gap-3 align-items-center">
        <input type="hidden" id="current-employee-id" th:value="${nhanVienHienTai != null ? nhanVienHienTai.id : 1}">
        <span class="fw-bold small text-dark"><i class="bi bi-person-circle me-1"></i> <span
                th:text="${nhanVienHienTai != null ? nhanVienHienTai.tenNhanVien : 'Nhân viên'}">NV</span></span>
        <a th:href="@{/admin/dashboard}" class="btn btn-sm btn-outline-danger border-0"><i
                class="bi bi-box-arrow-right"></i></a>
    </div>
</nav>

<div class="pos-container">
    <div class="pos-card">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary bg-opacity-10 text-primary fs-6">#<span id="ma-don-hang">NEW</span></span>
                <button class="btn btn-sm btn-outline-secondary position-relative" id="btn-list-drafts"
                        title="Phím tắt: F7">
                    <i class="bi bi-clock-history"></i> Đơn chờ
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                          id="draft-count" style="display:none">0</span>
                </button>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-primary" onclick="$('#modal-customer').modal('show')">
                    <i class="bi bi-person-plus"></i> <span id="customer-name">Khách lẻ</span>
                </button>
                <div class="bg-light px-2 rounded fw-bold text-secondary d-flex align-items-center small"
                     id="clock-display" style="min-width: 100px; justify-content: center;">
                    --:--
                </div>
            </div>
        </div>

        <div class="cart-body">
            <table class="cart-table">
                <thead>
                <tr>
                    <th style="width:45%">Sản phẩm</th>
                    <th style="width:25%">SL</th>
                    <th style="width:20%;text-align:right">Tiền</th>
                    <th style="width:10%"></th>
                </tr>
                </thead>
                <tbody id="cart-list"></tbody>
            </table>
        </div>

        <div class="payment-footer">
            <div class="row g-2">
                <div class="col-md-7 pe-3 border-end">
                    <div class="mb-2">
                        <label class="small fw-bold text-muted">Phiếu giảm giá</label>
                        <select class="form-select form-select-sm select2-basic" id="coupon-select"
                                style="width: 100%;">
                            <option value="">-- Chọn mã giảm giá --</option>
                        </select>
                        <small class="text-success fst-italic" id="coupon-message" style="display: none"></small>
                    </div>

                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-outline-primary btn-sm flex-fill active btn-pay-method"
                                data-method="CASH">Tiền mặt
                        </button>
                        <button class="btn btn-outline-primary btn-sm flex-fill btn-pay-method" data-method="QR"><i
                                class="bi bi-qr-code"></i> CK/QR
                        </button>
                        <input type="hidden" id="pay-method-val" value="CASH">
                    </div>
                    <div id="cash-section">
                        <input type="text" class="form-control form-control-sm fw-bold text-end" id="customer-paid"
                               placeholder="Nhập tiền khách đưa...">
                        <div class="d-flex justify-content-between mt-1 px-1 small">
                            <span>Tiền thừa:</span> <span class="fw-bold text-success"
                                                          id="change-amount-text">0 ₫</span>
                        </div>
                    </div>
                    <div id="qr-hint" class="alert alert-info py-1 small mb-0 d-none text-center">
                        <i class="bi bi-info-circle"></i> Nhấn **THANH TOÁN (QR)** để hiển thị mã quét
                    </div>
                </div>

                <div class="col-md-5 d-flex flex-column justify-content-between">
                    <div>
                        <div class="d-flex justify-content-between small mb-1"><span>Tạm tính:</span> <span
                                class="fw-bold" id="subtotal">0 ₫</span></div>
                        <div class="d-flex justify-content-between small mb-1"><span>Giảm giá:</span> <span
                                class="fw-bold text-danger" id="discount">0 ₫</span></div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-2">
                            <span class="fw-bold text-dark">KHÁCH PHẢI TRẢ</span>
                            <span class="total-price" id="total" data-value="0">0 ₫</span>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-secondary flex-fill fw-bold" id="btn-save-draft" title="Lưu tạm"><i
                                class="bi bi-pause-circle"></i> Treo
                        </button>
                        <button class="btn btn-primary flex-fill fw-bold" id="btn-checkout" style="flex: 2;">THANH
                            TOÁN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="pos-card">
        <div class="p-2 border-bottom">
            <div class="search-container">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" id="product-search" placeholder="Tìm tên, mã, size, màu..." autofocus>
                </div>
                <button class="btn-filter" id="btn-open-filter" title="Bộ lọc nâng cao"><i class="bi bi-funnel"></i>
                </button>
            </div>
        </div>
        <div class="product-grid-container">
            <div class="product-grid" id="product-grid"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-filter" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold">Bộ Lọc Sản Phẩm</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-6"><label class="small fw-bold mb-1">Danh mục</label><select id="filter-category"
                                                                                                 class="form-select select2-modal"
                                                                                                 style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">Thương hiệu</label><select id="filter-brand"
                                                                                                    class="form-select select2-modal"
                                                                                                    style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">Chất liệu</label><select id="filter-material"
                                                                                                  class="form-select select2-modal"
                                                                                                  style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">Màu sắc</label><select id="filter-color"
                                                                                                class="form-select select2-modal"
                                                                                                style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">Kích thước</label><select id="filter-size"
                                                                                                   class="form-select select2-modal"
                                                                                                   style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">Sắp xếp giá</label>
                        <select id="sort-price" class="form-select select2-modal" style="width: 100%;">
                            <option value="none">Mặc định</option>
                            <option value="asc">Thấp đến Cao</option>
                            <option value="desc">Cao đến Thấp</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-light btn-sm" onclick="resetFilter()">Mặc định</button>
                <button class="btn btn-primary btn-sm" onclick="applyFilter(); $('#modal-filter').modal('hide');">Áp
                    dụng
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-drafts" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light py-3">
                <h6 class="modal-title fw-bold text-primary"><i class="bi bi-clock-history"></i> DANH SÁCH ĐƠN CHỜ</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover mb-0 text-center small align-middle">
                        <thead class="table-light sticky-top">
                        <tr>
                            <th>Mã HĐ</th>
                            <th>Khách hàng</th>
                            <th>Tổng tiền</th>
                            <th>Thời gian tạo</th>
                            <th>Ghi chú</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody id="tbody-drafts"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-qr-payment" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center border-0 shadow-lg">
            <div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold w-100 text-primary">QUÉT MÃ THANH
                TOÁN</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="qr-code-container" class="d-inline-block p-2 border border-secondary rounded shadow-sm"></div>
                <div class="mt-2 small">
                    <div class="fw-bold">Số tiền: <span class="text-danger" id="qr-total"></span></div>
                    <div class="text-muted">Nội dung: <span id="qr-content" class="fw-bold"></span></div>
                    <div class="text-muted small">NH: Techcombank - STK: 1903 9509 6510 13</div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success w-100 fw-bold py-2" onclick="confirmQRPayment()"><i
                            class="bi bi-check-circle-fill"></i> ĐÃ NHẬN TIỀN
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-select-variant" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0 pt-3"><h6 class="modal-title fw-bold text-primary text-center w-100"
                                                             id="modal-prod-name">Product Name</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <div class="text-center mb-3"><h4 class="fw-bold text-danger mb-0" id="modal-prod-price">---</h4><small
                        class="text-muted">Kho: <span id="modal-prod-stock" class="fw-bold">-</span></small></div>
                <div class="mb-2"><label class="small fw-bold text-muted mb-1">KÍCH THƯỚC</label>
                    <div id="modal-size-list" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                </div>
                <div class="mb-3"><label class="small fw-bold text-muted mb-1">MÀU SẮC</label>
                    <div id="modal-color-list" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                </div>
                <div class="input-group input-group-sm mb-3">
                    <button class="btn btn-outline-secondary" onclick="adjustModalQty(-1)">-</button>
                    <input type="number" id="modal-qty-input" class="form-control text-center fw-bold" value="1"
                           min="1">
                    <button class="btn btn-outline-secondary" onclick="adjustModalQty(1)">+</button>
                </div>
                <button type="button" class="btn btn-primary w-100 fw-bold" id="btn-confirm-add-cart">Thêm vào đơn
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-customer" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header pb-0 border-0"><h6 class="modal-title fw-bold">Khách hàng</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-2"><input type="text" class="form-control" id="input-search-cust"
                                                     placeholder="Tên hoặc SĐT...">
                    <button class="btn btn-primary" id="btn-do-search-cust"><i class="bi bi-search"></i></button>
                </div>
                <div class="list-group list-group-flush" id="list-cust-results"
                     style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // ==========================================
    // 1. CẤU HÌNH HỆ THỐNG & API
    // ==========================================
    const API_PRODUCTS = "/api/data/san-pham-chi-tiet-active";
    const API_COUPONS = "/api/data/phieu-giam-gia-active";
    const API_DRAFTS = "/api/ban-hang/hoa-don-tam";
    const API_PAYMENT = "/api/ban-hang/thanh-toan";
    const API_SAVE_DRAFT = "/api/ban-hang/luu-tam";

    // Cấu hình Tài khoản ngân hàng (VietQR)
    const BANK_ID = "970407"; // Techcombank (Tra cứu mã Bin tại vietqr.io)
    const BANK_ACCOUNT_NUMBER = "19039509651013";
    const ACCOUNT_NAME_FOR_QR = "HOANG DUC ANH";
    const BANK_SHORT_NAME = "Techcombank";

    // Cấu hình giao diện
    const formatter = new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'});
    toastr.options = {"positionClass": "toast-top-center", "timeOut": "2000"};

    // Biến toàn cục
    let cart = [];
    let allProducts = [];
    let groupedProducts = {};
    let currentCustomer = null;
    let currentOrderCode = "";
    let currentVariants = [], selectedSize = null, selectedColor = null;

    // ==========================================
    // 2. KHỞI TẠO KHI TRANG LOAD
    // ==========================================
    $(document).ready(function () {
        // Init Plugins
        $('.select2-basic').select2({theme: 'bootstrap-5'});
        $('.select2-modal').select2({theme: 'bootstrap-5', dropdownParent: $('#modal-filter')});

        // Khởi chạy dữ liệu ban đầu
        startClock();
        initNewOrder();
        loadProducts();
        loadCoupons();
        updateDraftCount();

        // --- CÁC SỰ KIỆN (EVENT LISTENERS) ---

        // 1. Tìm kiếm & Lọc sản phẩm
        $('#product-search').on('input', applyFilter);
        $('#filter-category, #filter-brand, #filter-material, #filter-size, #filter-color, #sort-price').on('change', applyFilter);
        $('#btn-open-filter').click(() => $('#modal-filter').modal('show'));

        // 2. Chọn sản phẩm vào giỏ
        $('#product-grid').on('click', '.prod-card', function () {
            openProductModal($(this).data('parent-id'));
        });

        // 3. Xử lý Modal chọn thuộc tính (Size/Color)
        $('#modal-size-list').on('click', '.variant-option', function () {
            if ($(this).hasClass('disabled')) return;
            $('#modal-size-list .variant-option').removeClass('active');
            $(this).addClass('active');
            selectedSize = $(this).data('val');
            updateVariantUI();
        });
        $('#modal-color-list').on('click', '.variant-option', function () {
            if ($(this).hasClass('disabled')) return;
            $('#modal-color-list .variant-option').removeClass('active');
            $(this).addClass('active');
            selectedColor = $(this).data('val');
            updateVariantUI();
        });

        $('#btn-confirm-add-cart').click(confirmAddToCart);

        // 4. Thao tác trong giỏ hàng (Xóa, Tăng/Giảm SL)
        $('#cart-list').on('click', '.btn-remove', function () {
            removeFromCart($(this).data('id'));
        });

        $('#cart-list').on('click', '.qty-btn', function () {
            let input = $(this).siblings('.qty-input');
            let currentVal = parseInt(input.val()) || 1;
            let newVal = currentVal + $(this).data('delta');
            if (newVal < 1) newVal = 1; // Chặn số âm
            updateQty($(this).data('id'), newVal);
        });

        $('#cart-list').on('change', '.qty-input', function () {
            let newQty = parseInt($(this).val());
            if (isNaN(newQty) || newQty < 1) {
                newQty = 1;
                $(this).val(1);
                toastr.warning("Số lượng tối thiểu là 1");
            }
            updateQty($(this).data('id'), newQty);
        });

        // 5. Input số lượng trong Modal (Chặn âm)
        $('#modal-qty-input').on('change keyup', function () {
            let val = parseInt($(this).val());
            if (isNaN(val) || val < 1) $(this).val(1);
        });

        // 6. Thanh toán & Hóa đơn
        $('#btn-checkout').click(handleCheckoutClick);
        $('#btn-save-draft').click(saveDraft);
        $('#btn-confirm-qr-paid').click(confirmQRPayment); // Nút "Đã nhận tiền" trong modal QR

        // 7. Tính tiền thừa & Voucher
        $('#customer-paid').on('input', calculateChange);
        $('#coupon-select').on('change', function () {
            // Khi chọn voucher, tính lại tổng tiền ngay lập tức
            let currentTotal = parseFloat($('#subtotal').data('val')) || 0;
            updateSummary(currentTotal);
        });

        // 8. Khách hàng
        $('#btn-do-search-cust').click(searchCustomer);
        $('#list-cust-results').on('click', '.item-cust', function () {
            setCustomer($(this).data('id'), $(this).data('name'));
        });

        // 9. Phương thức thanh toán
        $('.btn-pay-method').click(function () {
            $('.btn-pay-method').removeClass('active');
            $(this).addClass('active');
            setPaymentMethod($(this).data('method'));
        });

        // 10. Xử lý Hóa đơn treo
        $('#btn-list-drafts').click(loadDraftsList);
        $('#tbody-drafts').on('click', '.btn-select-draft', function () {
            loadDraftDetail($(this).data('id'));
        });
        $('#tbody-drafts').on('click', '.btn-delete-draft', function () {
            let code = $(this).attr('data-code');
            deleteDraftOrder(code);
        });
    });

    // ==========================================
    // 3. LOGIC SẢN PHẨM & GIỎ HÀNG
    // ==========================================

    async function loadProducts() {
        try {
            const res = await fetch(API_PRODUCTS);
            if (!res.ok) throw new Error("API Error");
            allProducts = await res.json();
            groupProductsByParent();
            loadFilterOptions();
            renderProductGrid(Object.values(groupedProducts));
        } catch (e) {
            console.error(e);
            toastr.error("Không thể tải danh sách sản phẩm");
        }
    }

    function groupProductsByParent() {
        groupedProducts = {};
        allProducts.forEach(spct => {
            if (!spct.sanPham) return;
            const p = spct.sanPham;
            if (!groupedProducts[p.id]) {
                groupedProducts[p.id] = {
                    parentId: p.id,
                    parentName: p.tenSanPham,
                    parentCode: p.maSanPham,
                    category: p.loaiSanPham?.tenLoai || "Khác",
                    brand: p.thuongHieu?.tenThuongHieu || "Khác",
                    material: p.chatLieu?.tenChatLieu || "Khác",
                    price: spct.giaTien || 0,
                    variants: []
                };
            }
            groupedProducts[p.id].variants.push(spct);
        });
    }

    function renderProductGrid(list) {
        let html = '';
        list.forEach(p => {
            html += `
            <div class="prod-card" data-parent-id="${p.parentId}">
                <div class="prod-name">${p.parentName}</div>
                <div class="prod-code">${p.parentCode}</div>
                <div class="prod-price-preview">${formatter.format(p.price)}</div>
            </div>`;
        });
        $('#product-grid').html(html || '<div class="text-center w-100 text-muted mt-5">Không tìm thấy sản phẩm phù hợp</div>');
    }

    function openProductModal(pId) {
        const g = groupedProducts[pId];
        if (!g) return;
        currentVariants = g.variants;
        $('#modal-prod-name').text(g.parentName);
        $('#modal-prod-price').text("Vui lòng chọn thuộc tính");
        $('#modal-prod-stock').text("-");

        // Render options
        const sizes = [...new Set(currentVariants.map(v => v.kichThuoc?.tenKichThuoc || "Free"))].sort();
        const colors = [...new Set(currentVariants.map(v => v.mauSac?.tenMauSac || "Free"))].sort();

        $('#modal-size-list').html(sizes.map(s => `<div class="variant-option" data-val="${s}">${s}</div>`).join(''));
        $('#modal-color-list').html(colors.map(c => `<div class="variant-option" data-val="${c}">${c}</div>`).join(''));

        selectedSize = null; selectedColor = null;
        updateVariantUI();
        $('#modal-qty-input').val(1);
        $('#btn-confirm-add-cart').prop('disabled', true);
        $('#modal-select-variant').modal('show');
    }

    function updateVariantUI() {
        // Logic kiểm tra xem sự kết hợp size/color có tồn tại không
        const checkAvailability = (s, c) => currentVariants.some(v =>
            (!s || (v.kichThuoc?.tenKichThuoc || "Free") === s) &&
            (!c || (v.mauSac?.tenMauSac || "Free") === c) &&
            (v.soLuong > 0)
        );

        $('#modal-size-list .variant-option').each(function () {
            $(this).toggleClass('disabled', !checkAvailability($(this).data('val'), selectedColor));
        });
        $('#modal-color-list .variant-option').each(function () {
            $(this).toggleClass('disabled', !checkAvailability(selectedSize, $(this).data('val')));
        });

        if (selectedSize && selectedColor) {
            const v = currentVariants.find(v => (v.kichThuoc?.tenKichThuoc || "Free") === selectedSize && (v.mauSac?.tenMauSac || "Free") === selectedColor);
            if (v) {
                $('#modal-prod-price').text(formatter.format(v.giaTien));
                $('#modal-prod-stock').text(v.soLuong);
                $('#btn-confirm-add-cart').prop('disabled', v.soLuong <= 0).data('variant-id', v.id);
            } else {
                $('#modal-prod-stock').text("Hết hàng");
                $('#btn-confirm-add-cart').prop('disabled', true);
            }
        }
    }

    function confirmAddToCart() {
        const vId = $('#btn-confirm-add-cart').data('variant-id');
        const qtyReq = parseInt($('#modal-qty-input').val()) || 1;

        const v = currentVariants.find(v => v.id == vId);
        if (!v || v.soLuong < qtyReq) return toastr.warning("Sản phẩm không đủ hàng");

        const exist = cart.find(i => i.id == vId);
        if (exist) {
            if (exist.qty + qtyReq > v.soLuong) return toastr.warning("Tổng số lượng vượt quá tồn kho");
            exist.qty += qtyReq;
        } else {
            cart.push({
                id: v.id,
                name: v.sanPham.tenSanPham,
                price: v.giaTien,
                size: v.kichThuoc?.tenKichThuoc || "Free",
                color: v.mauSac?.tenMauSac || "Free",
                qty: qtyReq,
                stock: v.soLuong
            });
        }
        renderCart();
        $('#modal-select-variant').modal('hide');
        toastr.success("Đã thêm vào giỏ");
    }

    function renderCart() {
        let subtotal = 0, html = '';
        if (cart.length === 0) {
            html = '<tr><td colspan="4" class="text-center py-5 text-muted small">Giỏ hàng trống</td></tr>';
        } else {
            cart.forEach(i => {
                const totalItem = i.price * i.qty;
                subtotal += totalItem;
                html += `
                <tr>
                    <td>
                        <div class="fw-bold small text-truncate" style="max-width:140px">${i.name}</div>
                        <span class="text-muted small">${i.size} - ${i.color}</span>
                    </td>
                    <td>
                        <div class="qty-control">
                            <button class="qty-btn" data-id="${i.id}" data-delta="-1">-</button>
                            <input type="number" class="qty-input" value="${i.qty}" data-id="${i.id}" min="1">
                            <button class="qty-btn" data-id="${i.id}" data-delta="1">+</button>
                        </div>
                    </td>
                    <td class="text-end fw-bold small">${formatter.format(totalItem)}</td>
                    <td class="text-end"><i class="bi bi-trash text-danger btn-remove pointer" data-id="${i.id}"></i></td>
                </tr>`;
            });
        }
        $('#cart-list').html(html);
        updateSummary(subtotal);
    }

    function removeFromCart(id) {
        cart = cart.filter(i => i.id != id);
        renderCart();
    }

    function updateQty(id, qty) {
        if (isNaN(qty) || qty < 1) qty = 1;
        const item = cart.find(i => i.id == id);
        if (item) {
            if (qty > item.stock) {
                toastr.warning(`Kho chỉ còn ${item.stock} sản phẩm`);
                qty = item.stock;
            }
            item.qty = qty;
            renderCart();
        }
    }

    // ==========================================
    // 4. LOGIC THANH TOÁN & VOUCHER (QUAN TRỌNG)
    // ==========================================

    function updateSummary(subtotal) {
        // Hiển thị tạm tính
        $('#subtotal').data('val', subtotal).text(formatter.format(subtotal));

        let discountAmount = 0;
        let finalTotal = subtotal;

        // Lấy thông tin voucher
        const $option = $('#coupon-select').find(':selected');
        const couponId = $('#coupon-select').val();
        const $msg = $('#coupon-message');

        $msg.hide().removeClass('text-danger text-success');

        if (couponId && subtotal > 0) {
            // Lấy data từ thẻ option (đã gán ở hàm loadCoupons)
            const type = parseInt($option.data('type')); // 1: Tiền mặt, 2: %
            const value = parseFloat($option.data('val')) || 0;
            const minBill = parseFloat($option.data('min')) || 0;
            const maxDisc = parseFloat($option.data('max'));

            if (subtotal < minBill) {
                $msg.text(`Cần tối thiểu ${formatter.format(minBill)} để dùng mã`).addClass('text-danger').show();
                discountAmount = 0;
            } else {
                if (type === 2) {
                    // === GIẢM THEO % ===
                    let calculated = subtotal * (value / 100);
                    if (!isNaN(maxDisc) && maxDisc > 0 && calculated > maxDisc) {
                        calculated = maxDisc;
                    }
                    discountAmount = calculated;
                    let maxInfo = (maxDisc > 0) ? `(Max: ${formatter.format(maxDisc)})` : '';
                    $msg.text(`Giảm ${value}% ${maxInfo}`).addClass('text-success').show();
                } else {
                    // === GIẢM TIỀN MẶT ===
                    discountAmount = value;
                    $msg.text(`Giảm trực tiếp ${formatter.format(value)}`).addClass('text-success').show();
                }
            }
        }

        // Chặn lỗi giảm quá tổng tiền
        if (discountAmount > subtotal) discountAmount = subtotal;

        // Làm tròn tiền
        discountAmount = Math.round(discountAmount);
        finalTotal = subtotal - discountAmount;

        // Hiển thị kết quả
        $('#discount').text(formatter.format(discountAmount)).data('val', discountAmount);
        $('#total').text(formatter.format(finalTotal)).data('val', finalTotal);

        // Tính lại tiền thừa nếu đang nhập tiền mặt
        calculateChange();
    }

    function handleCheckoutClick() {
        if (!cart.length) return toastr.warning("Giỏ hàng trống");

        const total = parseFloat($('#total').data('val'));
        const method = $('#pay-method-val').val();

        if (method === 'CASH') {
            const paid = parseCurrency($('#customer-paid').val());
            if (paid < total) return Swal.fire('Thiếu tiền', 'Khách chưa đưa đủ tiền', 'warning');

            Swal.fire({
                title: 'Xác nhận thanh toán?',
                text: `Tổng: ${formatter.format(total)}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Thanh toán ngay'
            }).then((r) => {
                if (r.isConfirmed) submitOrder('CASH', paid);
            });
        } else {
            // Chuyển khoản QR
            if (total <= 0) return toastr.error("Tổng tiền không hợp lệ");
            generateQRCode(total, currentOrderCode);
        }
    }

    function generateQRCode(total, code) {
        $('#qr-total').text(formatter.format(total));
        const content = `TT ${code}`;
        $('#qr-content').text(content);

        // Tạo link ảnh VietQR (Không cần thư viện JS ngoài)
        const qrUrl = `https://img.vietqr.io/image/${BANK_SHORT_NAME}-${BANK_ACCOUNT_NUMBER}-compact.png?amount=${total}&addInfo=${content}&accountName=${ACCOUNT_NAME_FOR_QR}`;

        $('#qr-code-container').html(`<img src="${qrUrl}" class="img-fluid border" alt="QR Code" style="max-height: 250px;">`);
        $('#modal-qr-payment').modal('show');
    }

    function confirmQRPayment() {
        const total = parseFloat($('#total').data('val'));
        $('#modal-qr-payment').modal('hide');
        submitOrder('QR', total);
    }

    async function submitOrder(method, paidAmount) {
        const btn = $('#btn-checkout');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Đang xử lý...');

        try {
            const payload = {
                maHoaDon: currentOrderCode,
                nhanVienId: $('#current-employee-id').val() || 1, // Lấy ID nhân viên từ input hidden
                khachHangId: currentCustomer?.id || null,
                tongTien: parseFloat($('#total').data('val')),
                tienGiamGia: parseFloat($('#discount').data('val')) || 0,
                phieuGiamGiaId: $('#coupon-select').val() || null,
                phuongThucThanhToan: method,
                tienKhachDua: paidAmount,
                danhSachSanPham: cart.map(i => ({
                    sanPhamChiTietId: i.id,
                    soLuong: i.qty,
                    donGia: i.price
                }))
            };

            const res = await fetch(API_PAYMENT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Thanh toán thành công!',
                    text: 'Mã HĐ: ' + (data.maHoaDon || currentOrderCode),
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    initNewOrder();
                    loadProducts(); // Cập nhật lại kho
                    updateDraftCount(); // Cập nhật lại số đơn treo nếu có
                });
            } else {
                Swal.fire('Lỗi', data.message || 'Thanh toán thất bại', 'error');
            }
        } catch (e) {
            Swal.fire('Lỗi', 'Lỗi kết nối Server', 'error');
        } finally {
            btn.prop('disabled', false).text(method === 'CASH' ? 'THANH TOÁN' : 'THANH TOÁN (QR)');
        }
    }

    // ==========================================
    // 5. CÁC HÀM PHỤ TRỢ (HELPER) & DRAFTS
    // ==========================================

    async function loadCoupons() {
        try {
            const res = await fetch(API_COUPONS);
            const list = await res.json();
            let html = '<option value="">-- Chọn mã giảm giá --</option>';
            list.forEach(c => {
                // Backend: 1=Tiền, 2=%
                let label = c.hinhThucGiam == 2 ? Math.round(c.giaTriGiam) + '%' : formatter.format(c.giaTriGiam);
                html += `<option value="${c.id}"
                            data-type="${c.hinhThucGiam}"
                            data-val="${c.giaTriGiam}"
                            data-min="${c.dieuKienGiamGia || 0}"
                            data-max="${c.soTienGiamToiDa || 0}">
                            ${c.tenPhieuGiamGia} - ${label}
                         </option>`;
            });
            $('#coupon-select').html(html);
        } catch (e) {
            console.error("Lỗi tải voucher", e);
        }
    }

    function initNewOrder() {
        cart = [];
        currentCustomer = null;
        // Tạo mã đơn ảo: HD + 6 số cuối timestamp
        currentOrderCode = "HD" + Math.floor(Date.now() / 1000).toString().slice(-6);

        $('#ma-don-hang').text(currentOrderCode);
        $('#customer-name').text('Khách lẻ');
        $('#coupon-select').val('').trigger('change');
        $('#customer-paid').val('');
        setPaymentMethod('CASH');
        renderCart();
    }

    function setPaymentMethod(m) {
        $('#pay-method-val').val(m);
        if (m === 'CASH') {
            $('#cash-section').removeClass('d-none');
            $('#qr-hint').addClass('d-none');
            $('#btn-checkout').text('THANH TOÁN');
        } else {
            $('#cash-section').addClass('d-none');
            $('#qr-hint').removeClass('d-none');
            $('#btn-checkout').html('<i class="bi bi-qr-code"></i> THANH TOÁN (QR)');
        }
        calculateChange();
    }

    // --- Drafts (Hóa đơn treo) ---
    async function saveDraft() {
        if (!cart.length) return toastr.warning("Giỏ hàng trống!");

        Swal.fire({title: 'Treo đơn này?', showCancelButton: true, confirmButtonText: 'Đồng ý'}).then(async (r) => {
            if (r.isConfirmed) {
                try {
                    const payload = {
                        maHoaDon: currentOrderCode,
                        nhanVienId: $('#current-employee-id').val() || 1,
                        khachHangId: currentCustomer?.id || null,
                        danhSachSanPham: cart.map(i => ({sanPhamChiTietId: i.id, soLuong: i.qty})),
                        tongTien: parseFloat($('#total').data('val')),
                        phuongThucThanhToan: "DRAFT"
                    };
                    const res = await fetch(API_SAVE_DRAFT, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        toastr.success("Đã treo đơn thành công");
                        initNewOrder();
                        updateDraftCount();
                    } else toastr.error("Lỗi treo đơn");
                } catch { toastr.error("Lỗi kết nối"); }
            }
        });
    }

    async function loadDraftsList() {
        try {
            const res = await fetch(API_DRAFTS);
            const list = await res.json();
            let html = list.length ? '' : '<tr><td colspan="6" class="text-center">Không có đơn treo</td></tr>';

            list.forEach(h => {
                const date = h.ngayTao ? new Date(h.ngayTao).toLocaleString('vi-VN') : '';
                html += `<tr>
                    <td><span class="badge bg-secondary">${h.maHoaDon}</span></td>
                    <td>${h.khachHang ? h.khachHang.tenKhachHang : 'Khách lẻ'}</td>
                    <td>${formatter.format(h.tongTien)}</td>
                    <td>${date}</td>
                    <td>${h.ghiChu || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-select-draft" data-id="${h.maHoaDon}">Chọn</button>
                        <button class="btn btn-sm btn-danger btn-delete-draft" data-code="${h.maHoaDon}"><i class="bi bi-x"></i></button>
                    </td>
                </tr>`;
            });
            $('#tbody-drafts').html(html);
            $('#modal-drafts').modal('show');
        } catch { toastr.error("Lỗi tải danh sách"); }
    }

    async function loadDraftDetail(id) {
        try {
            const res = await fetch(API_DRAFTS + '/' + id);
            const order = await res.json();

            currentOrderCode = order.maHoaDon;
            $('#ma-don-hang').text(currentOrderCode);

            if (order.khachHang) setCustomer(order.khachHang.id, order.khachHang.tenKhachHang);
            else { currentCustomer = null; $('#customer-name').text('Khách lẻ'); }

            cart = [];
            const details = order.hoaDonChiTiet || order.hoaDonChiTiets || [];
            details.forEach(d => {
                cart.push({
                    id: d.sanPhamChiTiet.id,
                    name: d.sanPhamChiTiet.sanPham.tenSanPham,
                    price: d.donGia,
                    size: d.sanPhamChiTiet.kichThuoc?.tenKichThuoc || "Free",
                    color: d.sanPhamChiTiet.mauSac?.tenMauSac || "Free",
                    qty: d.soLuong,
                    stock: 999
                });
            });
            renderCart();
            $('#modal-drafts').modal('hide');
        } catch { toastr.error("Lỗi tải đơn hàng"); }
    }

    async function deleteDraftOrder(code) {
        if(!confirm('Xóa hóa đơn treo này?')) return;
        try {
            const res = await fetch(API_DRAFTS + '/' + code, { method: 'DELETE' });
            if(res.ok) { toastr.success("Đã xóa"); loadDraftsList(); updateDraftCount(); }
        } catch { toastr.error("Lỗi xóa"); }
    }

    async function updateDraftCount() {
        try {
            const res = await fetch(API_DRAFTS);
            const list = await res.json();
            const count = list.length;
            $('#draft-count').text(count).toggle(count > 0);
        } catch {}
    }

    // --- Search & Filter ---
    function loadFilterOptions() {
        const createOptions = (arr, selector) => {
            let html = '<option value="">Tất cả</option>';
            arr.forEach(v => html += `<option value="${v}">${v}</option>`);
            $(selector).html(html);
        };

        const sizes = [...new Set(allProducts.map(v => v.kichThuoc?.tenKichThuoc || "Free"))].sort();
        const colors = [...new Set(allProducts.map(v => v.mauSac?.tenMauSac || "Free"))].sort();
        const cats = [...new Set(Object.values(groupedProducts).map(p => p.category))].sort();
        const brands = [...new Set(Object.values(groupedProducts).map(p => p.brand))].sort();

        createOptions(sizes, '#filter-size');
        createOptions(colors, '#filter-color');
        createOptions(cats, '#filter-category');
        createOptions(brands, '#filter-brand');
    }

    function applyFilter() {
        const k = removeTone($('#product-search').val().trim());
        const fCat = $('#filter-category').val();
        const fBrand = $('#filter-brand').val();
        const fSize = $('#filter-size').val();
        const fColor = $('#filter-color').val();
        const sort = $('#sort-price').val();

        let result = Object.values(groupedProducts).filter(p => {
            let matchText = true;
            if (k) {
                const name = removeTone(p.parentName);
                if (!name.includes(k) && !p.parentCode.toLowerCase().includes(k)) matchText = false;
            }
            if (fCat && p.category !== fCat) return false;
            if (fBrand && p.brand !== fBrand) return false;

            let matchVariant = true;
            if (fSize || fColor) {
                matchVariant = p.variants.some(v => {
                    const s = v.kichThuoc?.tenKichThuoc || "Free";
                    const c = v.mauSac?.tenMauSac || "Free";
                    return (!fSize || s === fSize) && (!fColor || c === fColor);
                });
            }
            return matchText && matchVariant;
        });

        if (sort === 'asc') result.sort((a,b) => a.price - b.price);
        if (sort === 'desc') result.sort((a,b) => b.price - a.price);

        renderProductGrid(result);
    }

    // --- Utils ---
    function startClock() {
        setInterval(() => {
            const now = new Date();
            const t = now.toLocaleTimeString('vi-VN', {hour12: false});
            const d = now.toLocaleDateString('vi-VN');
            $('#clock-display').html(`<div class="text-end line-height-1"><span class="fs-6 fw-bold">${t}</span><br><span style="font-size:0.7rem">${d}</span></div>`);
        }, 1000);
    }

    async function searchCustomer() {
        const k = $('#input-search-cust').val();
        if(!k) return;
        try {
            const res = await fetch(`/api/khach-hang/search?keyword=${k}`);
            const list = await res.json();
            let html = list.map(c => `<a href="#" class="list-group-item list-group-item-action item-cust" data-id="${c.id}" data-name="${c.tenKhachHang}">${c.tenKhachHang} - ${c.soDienThoai}</a>`).join('');
            $('#list-cust-results').html(html || 'Không tìm thấy');
        } catch {}
    }

    function setCustomer(id, name) {
        currentCustomer = {id, name};
        $('#customer-name').text(name);
        $('#modal-customer').modal('hide');
        toastr.success("Đã chọn khách hàng");
    }

    function calculateChange() {
        if ($('#pay-method-val').val() !== 'CASH') return;
        const paid = parseCurrency($('#customer-paid').val());
        const total = parseFloat($('#total').data('val')) || 0;
        const diff = paid - total;

        const $el = $('#change-amount-text');
        if (diff < 0) {
            $el.text(`Thiếu ${formatter.format(Math.abs(diff))}`).removeClass('text-success').addClass('text-danger');
        } else {
            $el.text(formatter.format(diff)).removeClass('text-danger').addClass('text-success');
        }
    }

    function parseCurrency(str) {
        return parseFloat(str?.toString().replace(/[^0-9]/g, '')) || 0;
    }

    function removeTone(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D').toLowerCase();
    }

    // Hàm này giúp cập nhật số lượng khi bấm +/- trong modal
    window.adjustModalQty = function(d) {
        let el = $('#modal-qty-input');
        let v = parseInt(el.val()) || 1;
        v += d;
        if(v < 1) v = 1;
        el.val(v);
    };
</script>
</body>
</html>