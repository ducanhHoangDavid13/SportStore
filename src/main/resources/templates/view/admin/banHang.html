<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>POS - F-STORE</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

    <style>
        :root {
            --primary: #0061f2; /* Xanh dương đậm hiện đại */
            --primary-light: #e1e9ff;
            --secondary: #6900c7;
            --bg-app: #f2f6fc;
            --surface: #ffffff;
            --text-main: #2c3e50;
            --text-light: #95a5a6;
            --border-radius: 12px;
            --shadow-card: 0 4px 12px rgba(0,0,0,0.03);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text-main);
        }

        /* --- NAVBAR --- */
        .navbar-pos {
            background: var(--surface);
            height: 60px;
            border-bottom: 1px solid #eef2f6;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            z-index: 100;
        }
        .brand-logo { font-weight: 800; font-size: 1.25rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .nav-btn {
            background: transparent; border: none; font-weight: 600; color: #5b6b79;
            padding: 8px 16px; border-radius: 8px; transition: all 0.2s; text-decoration: none;
        }
        .nav-btn:hover, .nav-btn.active { background: var(--primary-light); color: var(--primary); }

        /* --- MAIN LAYOUT --- */
        .pos-container {
            flex: 1;
            padding: 15px;
            display: grid;
            grid-template-columns: 7fr 5fr; /* Bên trái 7 phần, phải 5 phần */
            gap: 15px;
            overflow: hidden;
        }

        /* --- CARD STYLES --- */
        .pos-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }

        /* --- LEFT COLUMN: CART & PAYMENT --- */
        .order-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
        .order-id-badge { background: var(--primary-light); color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .clock-display { font-family: 'Inter', monospace; font-weight: 600; color: #555; background: #f8f9fa; padding: 5px 10px; border-radius: 6px; }

        /* Cart List */
        .cart-body { flex: 1; overflow-y: auto; background: #fff; }
        .cart-table { width: 100%; border-collapse: collapse; }
        .cart-table th { position: sticky; top: 0; background: #f8f9fa; z-index: 10; font-size: 0.8rem; text-transform: uppercase; color: #888; padding: 12px; font-weight: 600; border-bottom: 1px solid #eee; }
        .cart-table td { padding: 12px; vertical-align: middle; border-bottom: 1px solid #f9f9f9; }
        .cart-item-img { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
        .qty-control { display: inline-flex; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .qty-btn { width: 28px; height: 28px; background: #fff; border: none; cursor: pointer; color: var(--primary); font-weight: bold; transition: 0.2s; }
        .qty-btn:hover { background: var(--primary-light); }
        .qty-input { width: 32px; border: none; text-align: center; font-weight: 600; font-size: 0.9rem; outline: none; }

        /* Payment Footer */
        .payment-footer { padding: 15px; background: #fdfdfd; border-top: 1px solid #eee; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; color: #555; }
        .total-price { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        .pay-method-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .method-option {
            flex: 1; border: 1px solid #e0e0e0; padding: 10px; border-radius: 8px; text-align: center;
            cursor: pointer; transition: 0.2s; font-weight: 500; color: #666; font-size: 0.9rem;
        }
        .method-option.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); font-weight: 700; }
        .method-option i { display: block; font-size: 1.2rem; margin-bottom: 4px; }

        .btn-action-lg {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            background: linear-gradient(135deg, var(--primary), #004ecc); color: white;
            box-shadow: 0 4px 10px rgba(0, 97, 242, 0.3); transition: 0.3s;
        }
        .btn-action-lg:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 97, 242, 0.4); }

        /* --- RIGHT COLUMN: PRODUCT GRID --- */
        .product-filter { padding: 12px; background: #fff; border-bottom: 1px solid #eee; display: flex; gap: 10px; }
        .search-box { flex: 1; position: relative; }
        .search-box input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: 1px solid #ddd; background: #f8f9fa; outline: none; }
        .search-box input:focus { background: #fff; border-color: var(--primary); }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }

        .product-grid-container { flex: 1; overflow-y: auto; padding: 12px; background: #f8f9fa; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .prod-card {
            background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid transparent;
            cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            display: flex; flex-direction: column;
        }
        .prod-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .prod-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
        .prod-details { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .prod-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .prod-meta { font-size: 0.75rem; color: #888; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-bottom: 6px; }
        .prod-price { font-weight: 700; color: var(--primary); font-size: 1rem; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        @media (max-width: 992px) {
            .pos-container { grid-template-columns: 1fr; overflow-y: auto; }
            .pos-card { height: auto; max-height: 600px; }
        }
    </style>
</head>
<body>

<nav class="navbar-pos">
    <a href="#" class="brand-logo"><i class="bi bi-box-seam-fill"></i> F-STORE POS</a>
    <div class="d-flex align-items-center gap-2">
        <a href="#" class="nav-btn active"><i class="bi bi-shop me-1"></i>Bán hàng</a>
        <a th:href="@{/admin/hoa-don}" class="nav-btn"><i class="bi bi-receipt me-1"></i>Hóa đơn</a>
        <div class="vr mx-2"></div>
        <div class="dropdown">
            <button class="btn btn-light rounded-pill border px-3 py-1 d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:28px; height:28px; font-size:0.8rem;">NV</div>
                <span class="fw-bold small text-dark" sec:authorize="isAuthenticated()" th:text="${nhanVienHienTai.tenNhanVien}">Nhân viên</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2">
                <li>
                    <form th:action="@{/logout}" method="post" class="m-0">
                        <button class="dropdown-item text-danger"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</button>
                    </form>
                </li>
            </ul>
            <input type="hidden" id="current-employee-id" th:value="${nhanVienHienTai.id}">
        </div>
    </div>
</nav>

<div class="pos-container">

    <div class="pos-card">
        <div class="order-header">
            <div class="d-flex align-items-center gap-3">
                <span class="order-id-badge" id="ma-don-hang">#NEW</span>
                <div class="d-flex align-items-center bg-light px-3 py-1 rounded border" style="cursor: pointer;" onclick="$('#modal-customer').modal('show')">
                    <i class="bi bi-person-circle text-secondary me-2"></i>
                    <span class="fw-bold text-dark" id="customer-name">Khách lẻ</span>
                    <i class="bi bi-chevron-down ms-2 small text-muted"></i>
                </div>
                <i class="bi bi-x-circle text-danger ms-1" style="cursor: pointer;" onclick="resetCustomer()" title="Xóa khách"></i>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="btn-list-drafts"><i class="bi bi-list-ul"></i> Đơn chờ</button>
                <div class="clock-display" id="clock-display">00:00:00</div>
            </div>
        </div>

        <div class="cart-body">
            <table class="cart-table">
                <thead>
                <tr>
                    <th style="width: 45%;">Sản phẩm</th>
                    <th style="width: 15%;">Đơn giá</th>
                    <th style="width: 20%; text-align: center;">Số lượng</th>
                    <th style="width: 15%; text-align: right;">Thành tiền</th>
                    <th style="width: 5%;"></th>
                </tr>
                </thead>
                <tbody id="cart-list">
                </tbody>
            </table>
        </div>

        <div class="payment-footer">
            <div class="row g-3">
                <div class="col-md-6 border-end pe-3">
                    <label class="form-label small fw-bold text-muted mb-1">MÃ GIẢM GIÁ</label>
                    <select class="form-select form-select-sm mb-3 bg-light border-0" id="coupon-select">
                        <option value="">Chọn voucher...</option>
                    </select>

                    <label class="form-label small fw-bold text-muted mb-1">PHƯƠNG THỨC THANH TOÁN</label>
                    <div class="pay-method-selector">
                        <div class="method-option active" data-val="CASH" onclick="setPaymentMethod('CASH')">
                            <i class="bi bi-cash-coin"></i> Tiền mặt
                        </div>
                        <div class="method-option" data-val="QR" onclick="setPaymentMethod('QR')">
                            <i class="bi bi-qr-code-scan"></i> Chuyển khoản
                        </div>
                        <input type="hidden" id="pay-method-val" value="CASH">
                    </div>

                    <div id="cash-section">
                        <div class="input-group">
                            <span class="input-group-text bg-white text-muted border-end-0">Khách đưa</span>
                            <input type="text" class="form-control fw-bold text-end border-start-0" id="customer-paid" placeholder="0">
                            <span class="input-group-text bg-white">₫</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2 px-2">
                            <small class="text-muted">Tiền thừa:</small>
                            <span class="fw-bold text-success" id="change-amount-text">0 ₫</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 d-flex flex-column justify-content-between">
                    <div>
                        <div class="summary-item"><span>Tổng tiền hàng</span> <span class="fw-bold text-dark" id="subtotal">0 ₫</span></div>
                        <div class="summary-item"><span>Giảm giá</span> <span class="fw-bold text-danger" id="discount">0 ₫</span></div>
                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                            <span class="text-uppercase fw-bold text-secondary">Khách phải trả</span>
                            <span class="total-price" id="total" data-value="0">0 ₫</span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="row g-2 mb-2">
                            <div class="col-6"><button class="btn btn-light border w-100 fw-bold text-secondary py-2" id="btn-save-draft">Lưu tạm</button></div>
                            <div class="col-6"><button class="btn btn-light border w-100 fw-bold text-secondary py-2" onclick="initNewOrder()">Hủy</button></div>
                        </div>
                        <button class="btn-action-lg" id="btn-checkout">
                            <i class="bi bi-check-lg me-1"></i> THANH TOÁN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="pos-card">
        <div class="product-filter">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="product-search" placeholder="Tìm kiếm sản phẩm (Tên, Mã)...">
            </div>
            <button class="btn btn-light border rounded-circle" id="btn-reload" style="width: 42px; height: 42px;"><i class="bi bi-arrow-clockwise"></i></button>
        </div>

        <div class="product-grid-container">
            <div class="product-grid" id="product-grid">
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="modal-qr" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0">
            <div class="modal-body text-center p-4">
                <h5 class="fw-bold text-primary mb-3">QUÉT MÃ QR</h5>
                <div class="p-2 border rounded d-inline-block mb-3 bg-white">
                    <img src="" id="qr-image-popup" class="img-fluid" style="width: 200px;" alt="QR Code">
                </div>
                <h4 class="fw-bold text-danger mb-1" id="qr-amount-popup">0 ₫</h4>
                <p class="text-muted small mb-3" id="qr-content-popup">...</p>
                <button class="btn btn-success w-100 fw-bold py-2" id="btn-confirm-transfer">XÁC NHẬN ĐÃ CHUYỂN</button>
                <button class="btn btn-light text-muted w-100 mt-2 btn-sm" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-customer" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h6 class="modal-title fw-bold">Tìm Khách Hàng</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="input-search-cust" placeholder="Nhập tên hoặc số điện thoại...">
                    <button class="btn btn-primary" id="btn-do-search-cust"><i class="bi bi-search"></i></button>
                </div>
                <div class="list-group list-group-flush" id="list-cust-results"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-drafts" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold">Danh sách đơn chờ</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-hover mb-0 text-center small align-middle">
                    <thead class="table-light"><tr><th>Mã HĐ</th><th>Khách hàng</th><th>Tổng tiền</th><th>Thao tác</th></tr></thead>
                    <tbody id="tbody-drafts"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<script>
    const API_BASE = "";
    const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
    toastr.options = { "positionClass": "toast-top-center", "timeOut": "2000" };

    // SETTINGS NGÂN HÀNG
    const BANK_ID = "TCB";
    const ACCOUNT_NO = "19039509651013";
    const ACCOUNT_NAME = "HOANG DUC ANH";

    // STATE
    let cart = [];
    let allProducts = [];
    let currentCustomer = null;
    let currentOrderCode = "";

    $(document).ready(function() {
        initNewOrder();
        loadProducts();
        loadCoupons();

        // Đồng hồ có giây
        setInterval(() => {
            const now = new Date();
            $('#clock-display').text(now.toLocaleTimeString('vi-VN', { hour12: false }));
        }, 1000);

        // Events
        $('#product-search').on('keyup', filterProducts);
        $('#btn-reload').click(loadProducts);
        $('#product-grid').on('click', '.prod-card', function() { addToCart($(this).data()); });
        $('#cart-list').on('click', '.btn-remove', function() { removeFromCart($(this).data('id')); });
        $('#cart-list').on('click', '.qty-btn', function() {
            const id = $(this).data('id'), delta = $(this).data('delta');
            const item = cart.find(i => i.id == id);
            if(item) updateQty(id, item.qty + delta);
        });

        $('#btn-do-search-cust').click(searchCustomer);
        $('#list-cust-results').on('click', '.item-cust', function() { setCustomer($(this).data('id'), $(this).data('name')); });
        $('#customer-paid').on('input', calculateChange);
        $('#coupon-select').change(renderCart);
        $('#btn-checkout').click(handleCheckoutClick);
        $('#btn-confirm-transfer').click(handleTransferConfirm);
        $('#btn-save-draft').click(saveDraft);
        $('#btn-list-drafts').click(loadDraftsList);
        $('#tbody-drafts').on('click', '.btn-select-draft', function() { loadDraftDetail($(this).data('id')); });
    });

    // --- LOGIC GIAO DIỆN MỚI ---

    function setPaymentMethod(method) {
        $('.method-option').removeClass('active');
        $(`.method-option[data-val="${method}"]`).addClass('active');
        $('#pay-method-val').val(method);
        if(method === 'QR') $('#cash-section').slideUp('fast'); else $('#cash-section').slideDown('fast');
        renderCart();
    }

    function renderCart() {
        if(!cart.length) {
            $('#cart-list').html('<tr><td colspan="5" class="text-center py-5 text-muted small opacity-75"><i class="bi bi-cart3 fs-1 d-block mb-2"></i>Chưa có sản phẩm nào</td></tr>');
            updateSummary(0, 0); return;
        }

        let subtotal = 0;
        let html = '';
        cart.forEach(i => {
            const totalItem = i.price * i.qty;
            subtotal += totalItem;
            html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <img src="${i.img}" class="cart-item-img">
                        <div style="line-height:1.2;">
                            <div class="fw-bold text-dark text-truncate" style="max-width: 220px;" title="${i.name}">${i.name}</div>
                            <span class="badge bg-light text-secondary border fw-normal mt-1">${i.size} | ${i.color}</span>
                        </div>
                    </div>
                </td>
                <td class="small">${formatter.format(i.price)}</td>
                <td>
                    <div class="qty-control mx-auto">
                        <button class="qty-btn" data-id="${i.id}" data-delta="-1">-</button>
                        <input type="text" class="qty-input" value="${i.qty}" readonly>
                        <button class="qty-btn" data-id="${i.id}" data-delta="1">+</button>
                    </div>
                </td>
                <td class="text-end fw-bold text-dark small">${formatter.format(totalItem)}</td>
                <td class="text-end"><i class="bi bi-trash3 text-danger btn-remove" style="cursor:pointer; font-size:1.1rem;" data-id="${i.id}"></i></td>
            </tr>`;
        });
        $('#cart-list').html(html);

        // Tính Voucher
        let discountAmount = 0;
        const opt = $('#coupon-select option:selected');
        const couponId = opt.val();
        if (couponId) {
            const type = parseInt(opt.data('type'))||1;
            const value = parseFloat(opt.data('value'))||0;
            const max = parseFloat(opt.data('max'))||0;
            const cond = parseFloat(opt.data('condition'))||0;
            if (subtotal < cond) {
                toastr.warning(`Đơn tối thiểu ${formatter.format(cond)}`); $('#coupon-select').val('');
            } else {
                if (type === 2) {
                    discountAmount = (subtotal * value) / 100;
                    if(max > 0 && discountAmount > max) discountAmount = max;
                } else { discountAmount = value; }
            }
        }
        updateSummary(subtotal, discountAmount);
    }

    function updateSummary(sub, disc) {
        $('#subtotal').text(formatter.format(sub));
        $('#discount').text(disc > 0 ? `-${formatter.format(disc)}` : '0 ₫');
        const total = Math.max(0, sub - disc);
        $('#total').text(formatter.format(total)).data('val', total);
        if ($('#pay-method-val').val() === 'CASH') calculateChange();
    }

    function renderProductGrid(list) {
        if(!list.length) return $('#product-grid').html('<div class="col-12 text-center text-muted py-5">Không tìm thấy sản phẩm</div>');
        let html = '';
        list.forEach(sp => {
            const name = sp.sanPham?.tenSanPham || 'Sản phẩm';
            const price = sp.giaTien || 0;
            const size = sp.kichThuoc?.tenKichThuoc || '-';
            const color = sp.mauSac?.tenMauSac || '-';
            let img = 'https://via.placeholder.com/200x200?text=SP';
            if(sp.sanPham?.hinhAnh?.[0]?.tenHinhAnh) img = `/api/hinh-anh/download/${sp.sanPham.hinhAnh[0].tenHinhAnh}`;

            html += `
            <div class="prod-card" data-id="${sp.id}" data-name="${name}" data-price="${price}" data-img="${img}" data-size="${size}" data-color="${color}">
                <img src="${img}" class="prod-img">
                <div class="prod-details">
                    <div class="prod-name" title="${name}">${name}</div>
                    <div class="prod-meta">${size} / ${color}</div>
                    <div class="prod-price">${formatter.format(price)}</div>
                </div>
            </div>`;
        });
        $('#product-grid').html(html);
    }

    // --- CÁC HÀM LOGIC CỐT LÕI (GIỮ NGUYÊN) ---
    function calculateChange() {
        const total = $('#total').data('val');
        const valStr = $('#customer-paid').val().replace(/[^0-9]/g, '');
        const paid = parseFloat(valStr) || 0;
        const change = paid - total;
        $('#change-amount-text').text(change >= 0 ? formatter.format(change) : 'Thiếu tiền');
        $('#change-amount-text').toggleClass('text-danger', change < 0).toggleClass('text-success', change >= 0);
    }

    function addToCart(p) {
        const item = cart.find(i => i.id == p.id);
        if(item) { item.qty++; toastr.success("+1"); }
        else { cart.push({...p, qty: 1}); toastr.success("Đã thêm"); }
        renderCart();
    }

    function removeFromCart(id) { cart = cart.filter(i => i.id != id); renderCart(); }
    function updateQty(id, val) { const item = cart.find(i => i.id == id); if(item) { item.qty = Math.max(1, val); renderCart(); } }

    async function loadProducts() { try { const res = await fetch(`${API_BASE}/api/data/san-pham-chi-tiet-active`); allProducts = await res.json(); renderProductGrid(allProducts); } catch(e){} }

    async function loadCoupons() {
        try {
            const res = await fetch(`${API_BASE}/api/phieu-giam-gia/active`);
            const list = await res.json();
            let html = '<option value="" data-type="0" data-value="0" data-max="0" data-condition="0">Chọn mã giảm giá...</option>';
            list.forEach(c => {
                const type = c.hinhThucGiam || 1; const value = c.giaTriGiam || 0; const max = c.soTienGiam || 999999999; const cond = c.dieuKienGiamGia || 0;
                let label = `${c.maPhieuGiamGia}`;
                if(type===2) label += ` [${value}%]`; else label += ` [${value.toLocaleString()}đ]`;
                html += `<option value="${c.id}" data-type="${type}" data-value="${value}" data-max="${max}" data-condition="${cond}">${label}</option>`;
            });
            $('#coupon-select').html(html);
        } catch(e){}
    }

    function initNewOrder() {
        cart = []; currentCustomer = null;
        currentOrderCode = "HD" + Math.floor(Date.now()/1000).toString().slice(-6);
        $('#ma-don-hang').text("#" + currentOrderCode);
        resetCustomer(); $('#coupon-select').val(''); $('#customer-paid').val('');
        setPaymentMethod('CASH'); renderCart();
    }

    function handleCheckoutClick() {
        if(!cart.length) return toastr.warning("Giỏ hàng trống");
        const method = $('#pay-method-val').val();
        if (method === 'QR') showQrPopup(); else processPayment('CASH');
    }

    function handleTransferConfirm() { $('#modal-qr').modal('hide'); processPayment('TRANSFER'); }

    async function processPayment(method) {
        const total = $('#total').data('val');
        const paid = method === 'CASH' ? (parseFloat($('#customer-paid').val().replace(/[^0-9]/g,''))||0) : total;
        if(method === 'CASH' && paid < total) return toastr.error("Khách trả thiếu tiền!");

        const payload = {
            nhanVienId: $('#current-employee-id').val(),
            khachHangId: currentCustomer?.id,
            danhSachSanPham: cart.map(i => ({sanPhamChiTietId: i.id, soLuong: i.qty, donGia: i.price})),
            tongTien: total,
            tienGiamGia: parseFloat($('#discount').text().replace(/[^0-9]/g,'').replace('-','')) || 0,
            phuongThucThanhToan: method,
            maHoaDon: currentOrderCode,
            phieuGiamGiaId: $('#coupon-select').val() || null,
            customerPaidAmount: paid
        };

        try {
            const res = await fetch(API_BASE + '/api/ban-hang/thanh-toan', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            if(res.ok) { toastr.success("Thanh toán thành công!"); initNewOrder(); }
            else toastr.error(data.message);
        } catch(e) { toastr.error("Lỗi Server"); }
    }

    function showQrPopup() {
        const total = $('#total').data('val');
        if (total <= 0) return toastr.warning("0đ");
        const content = `${currentOrderCode} TT`;
        const url = `https://img.vietqr.io/image/${BANK_ID}-${ACCOUNT_NO}-compact.jpg?amount=${total}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(ACCOUNT_NAME)}`;
        $('#qr-image-popup').attr('src', url);
        $('#qr-amount-popup').text(formatter.format(total));
        $('#qr-content-popup').text(content);
        $('#modal-qr').modal('show');
    }

    async function saveDraft() {
        if(!cart.length) return toastr.warning("Giỏ hàng trống, không thể lưu!");

        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");

        // --- BỔ SUNG: Lấy tổng tiền và giảm giá từ giao diện ---
        // Lấy số tiền khách phải trả (đã lưu trong data-val của thẻ #total)
        const tongTienKhachTra = $('#total').data('val') || 0;

        // Lấy tiền giảm giá (cắt bỏ ký tự chữ, chỉ lấy số)
        const tienGiamStr = $('#discount').text().replace(/[^0-9]/g, '');
        const tienGiamGia = parseFloat(tienGiamStr) || 0;
        // ------------------------------------------------------

        try {
            const payload = {
                nhanVienId: $('#current-employee-id').val(),
                khachHangId: currentCustomer?.id,
                danhSachSanPham: cart.map(i => ({sanPhamChiTietId: i.id, soLuong: i.qty, donGia: i.price})),
                phuongThucThanhToan: 'DRAFT',
                maHoaDon: currentOrderCode,
                phieuGiamGiaId: $('#coupon-select').val() || null,

                // --- QUAN TRỌNG: Phải gửi kèm 2 trường này ---
                tongTien: tongTienKhachTra,   // Map vào request.getTongTien()
                tienGiamGia: tienGiamGia      // Map vào request.getTienGiamGia()
            };

            const res = await fetch(`${API_BASE}/api/ban-hang/luu-tam`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if(res.ok) {
                toastr.success("Đã lưu đơn tạm thành công!");
                initNewOrder();
            } else {
                toastr.error(data.message || "Lỗi lưu đơn hàng");
            }
        } catch(e) {
            console.error(e);
            toastr.error("Lỗi kết nối Server");
        }
    }

    function filterProducts() {
        const term = $('#product-search').val().toLowerCase();
        renderProductGrid(allProducts.filter(p => (p.sanPham?.tenSanPham||'').toLowerCase().includes(term)));
    }

    async function searchCustomer() {
        const kw = $('#input-search-cust').val(); if(!kw) return;
        try {
            const res = await fetch(`${API_BASE}/api/khach-hang/search?keyword=${kw}`);
            const list = await res.json();
            let html = '';
            list.forEach(c => html += `<a href="#" class="list-group-item list-group-item-action item-cust" data-id="${c.id}" data-name="${c.tenKhachHang}"><b>${c.tenKhachHang}</b> - ${c.soDienThoai}</a>`);
            $('#list-cust-results').html(html || '<div class="p-3 text-center">Không tìm thấy</div>');
        } catch(e) {}
    }
    function setCustomer(id, name) { currentCustomer = {id, name}; $('#customer-name').text(name).addClass('text-primary'); $('#modal-customer').modal('hide'); }
    function resetCustomer() { currentCustomer = null; $('#customer-name').text('Khách lẻ').removeClass('text-primary'); }

    async function loadDraftsList() {
        try {
            const res = await fetch(`${API_BASE}/api/ban-hang/hoa-don-tam`);
            const list = await res.json();
            let html = '';
            list.forEach(hd => html += `<tr><td>${hd.maHoaDon}</td><td>${hd.khachHang?.tenKhachHang||'Lẻ'}</td><td>${formatter.format(hd.tongTienSauGiam)}</td><td><button class="btn btn-sm btn-primary btn-select-draft" data-id="${hd.id}">Chọn</button></td></tr>`);
            $('#tbody-drafts').html(html || '<tr><td colspan="4" class="text-center">Trống</td></tr>');
            $('#modal-drafts').modal('show');
        } catch(e) {}
    }

    async function loadDraftDetail(id) {
        try {
            const res = await fetch(`${API_BASE}/api/ban-hang/hoa-don-tam/${id}`);
            const hd = await res.json();
            currentOrderCode = hd.maHoaDon; $('#ma-don-hang').text("#"+hd.maHoaDon);
            if(hd.khachHang) setCustomer(hd.khachHang.id, hd.khachHang.tenKhachHang); else resetCustomer();
            if(hd.phieuGiamGia) $('#coupon-select').val(hd.phieuGiamGia.id); else $('#coupon-select').val('');
            cart = (hd.hoaDonChiTiets||[]).map(d => {
                const sp = d.sanPhamChiTiet;
                let img = 'https://via.placeholder.com/200';
                if(sp.sanPham?.hinhAnh?.[0]?.tenHinhAnh) img = `/api/hinh-anh/download/${sp.sanPham.hinhAnh[0].tenHinhAnh}`;
                return { id: sp.id, name: sp.sanPham.tenSanPham, price: d.donGia, qty: d.soLuong, img: img, size: sp.kichThuoc?.tenKichThuoc||'-', color: sp.mauSac?.tenMauSac||'-' };
            });
            renderCart(); $('#modal-drafts').modal('hide'); toastr.success("Đã tải đơn");
        } catch(e) {}
    }
</script>

</body>
</html>