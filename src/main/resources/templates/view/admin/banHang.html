<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS PRO - B√°n H√†ng T·∫°i Qu·∫ßy</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
          rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
          rel="stylesheet"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #0d6efd;
            --bg-app: #f2f6fc;
            --surface: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Navbar */
        .navbar-pos {
            background: var(--surface);
            height: 60px;
            border-bottom: 1px solid #eef2f6;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-link-custom {
            text-decoration: none;
            color: #555;
            font-weight: 500;
            margin-left: 15px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .nav-link-custom:hover {
            color: var(--primary);
        }

        /* Layout */
        .pos-container {
            flex: 1;
            padding: 15px;
            display: grid;
            grid-template-columns: 7fr 5fr;
            gap: 15px;
            overflow: hidden;
        }

        .pos-card {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }

        /* Cart Area */
        .cart-body {
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }

        .cart-table {
            width: 100%;
            border-collapse: collapse;
        }

        .cart-table th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
            font-size: 0.8rem;
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .cart-table td {
            padding: 10px;
            vertical-align: middle;
            border-bottom: 1px solid #f9f9f9;
        }

        .qty-control {
            display: inline-flex;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .qty-btn {
            width: 28px;
            height: 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .qty-input {
            width: 40px;
            height: 30px;
            border: none;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            text-align: center;
            font-weight: 600;
            outline: none;
            font-size: 0.9rem;
        }

        /* Product & Filter */
        .search-container {
            display: flex;
            gap: 10px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            outline: none;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .btn-filter {
            width: 45px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-filter:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .product-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: #f8f9fa;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .prod-card {
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 15px;
            height: 110px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .prod-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            background-color: #f8faff;
        }

        .prod-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
            line-height: 1.3;
            text-align: center;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .prod-code {
            font-size: 0.75rem;
            color: #6c757d;
            text-align: center;
            background: #f1f3f5;
            padding: 2px 8px;
            border-radius: 4px;
            align-self: center;
            font-weight: 500;
        }

        .prod-price-preview {
            font-size: 0.8rem;
            color: var(--primary);
            text-align: center;
            font-weight: 700;
            margin-top: 4px;
        }

        /* Variant Options in Modal */
        .variant-option {
            border: 1px solid #ddd;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            background: #fff;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
        }

        .variant-option:hover:not(.disabled) {
            border-color: var(--primary);
            background: #f0f8ff;
            color: var(--primary);
        }

        .variant-option.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            font-weight: 600;
        }

        .variant-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #e9ecef;
            color: #adb5bd;
            text-decoration: line-through;
        }

        /* Payment Footer */
        .payment-footer {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .total-price {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
        }

        .qr-popup-img {
            width: 100%;
            max-width: 250px;
            border-radius: 12px;
            border: 1px solid #eee;
            margin-bottom: 10px;
        }

        /* Select2 Customization */
        .select2-container--bootstrap-5 .select2-selection {
            border-color: #dee2e6;
            font-size: 0.875rem;
        }

        .select2-container--bootstrap-5 .select2-selection--single {
            padding-top: 0.25rem;
        }
    </style>
</head>
<body>

<nav class="navbar-pos">
    <div class="d-flex align-items-center">
        <a href="#" class="fw-bold text-decoration-none text-primary fs-5 me-4"><i class="bi bi-shop me-2"></i>POS
            F-STORE</a>
        <div class="d-none d-md-flex">
            <a th:href="@{/admin/hoa-don}" class="nav-link-custom" target="_blank"><i class="bi bi-receipt"></i> QL H√≥a
                ƒê∆°n</a>
            <a th:href="@{/admin/san-pham-chi-tiet}" class="nav-link-custom" target="_blank"><i
                    class="bi bi-box-seam"></i> QL SPCT</a>
        </div>
    </div>
    <div class="d-flex gap-3 align-items-center">
        <input type="hidden" id="current-employee-id" th:value="${nhanVienHienTai != null ? nhanVienHienTai.id : 1}">
        <span class="fw-bold small text-dark"><i class="bi bi-person-circle me-1"></i> <span
                th:text="${nhanVienHienTai != null ? nhanVienHienTai.tenNhanVien : 'Nh√¢n vi√™n'}">NV</span></span>
        <a th:href="@{/admin/dashboard}" class="btn btn-sm btn-outline-danger border-0"><i
                class="bi bi-box-arrow-right"></i></a>
    </div>
</nav>

<div class="pos-container">
    <div class="pos-card">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary bg-opacity-10 text-primary fs-6">#<span id="ma-don-hang">NEW</span></span>
                <button class="btn btn-sm btn-outline-secondary position-relative" id="btn-list-drafts"
                        title="Ph√≠m t·∫Øt: F7">
                    <i class="bi bi-clock-history"></i> ƒê∆°n ch·ªù
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                          id="draft-count" style="display:none">0</span>
                </button>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="$('#modal-customer').modal('show')">
                    <i class="bi bi-person-plus"></i> <span id="customer-name">Kh√°ch l·∫ª</span>
                </button>
                <div class="bg-light px-2 rounded fw-bold text-secondary d-flex align-items-center small"
                     id="clock-display">00:00
                </div>
            </div>
        </div>

        <div class="cart-body">
            <table class="cart-table">
                <thead>
                <tr>
                    <th style="width:45%">S·∫£n ph·∫©m</th>
                    <th style="width:25%">SL</th>
                    <th style="width:20%;text-align:right">Ti·ªÅn</th>
                    <th style="width:10%"></th>
                </tr>
                </thead>
                <tbody id="cart-list"></tbody>
            </table>
        </div>

        <div class="payment-footer">
            <div class="row g-2">
                <div class="col-md-7 pe-3 border-end">
                    <div class="mb-2">
                        <label class="small fw-bold text-muted">Phi·∫øu gi·∫£m gi√°</label>
                        <select class="form-select form-select-sm select2-basic" id="coupon-select"
                                style="width: 100%;">
                            <option value="">-- Ch·ªçn m√£ gi·∫£m gi√° --</option>
                        </select>
                        <small class="text-success fst-italic" id="coupon-message" style="display: none"></small>
                    </div>

                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-outline-primary btn-sm flex-fill active btn-pay-method"
                                data-method="CASH">Ti·ªÅn m·∫∑t
                        </button>
                        <button class="btn btn-outline-primary btn-sm flex-fill btn-pay-method" data-method="QR"><i
                                class="bi bi-qr-code"></i> CK/QR
                        </button>
                        <input type="hidden" id="pay-method-val" value="CASH">
                    </div>
                    <div id="cash-section">
                        <input type="text" class="form-control form-control-sm fw-bold text-end" id="customer-paid"
                               placeholder="Nh·∫≠p ti·ªÅn kh√°ch ƒë∆∞a...">
                        <div class="d-flex justify-content-between mt-1 px-1 small">
                            <span>Ti·ªÅn th·ª´a:</span> <span class="fw-bold text-success"
                                                          id="change-amount-text">0 ‚Ç´</span>
                        </div>
                    </div>
                    <div id="qr-hint" class="alert alert-info py-1 small mb-0 d-none text-center">
                        <i class="bi bi-info-circle"></i> Nh·∫•n **THANH TO√ÅN (QR)** ƒë·ªÉ hi·ªÉn th·ªã m√£ qu√©t
                    </div>
                </div>

                <div class="col-md-5 d-flex flex-column justify-content-between">
                    <div>
                        <div class="d-flex justify-content-between small mb-1"><span>T·∫°m t√≠nh:</span> <span
                                class="fw-bold" id="subtotal">0 ‚Ç´</span></div>
                        <div class="d-flex justify-content-between small mb-1"><span>Gi·∫£m gi√°:</span> <span
                                class="fw-bold text-danger" id="discount">0 ‚Ç´</span></div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-2">
                            <span class="fw-bold text-dark">KH√ÅCH PH·∫¢I TR·∫¢</span>
                            <span class="total-price" id="total" data-value="0">0 ‚Ç´</span>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-secondary flex-fill fw-bold" id="btn-save-draft" title="L∆∞u t·∫°m"><i
                                class="bi bi-pause-circle"></i> Treo
                        </button>
                        <button class="btn btn-primary flex-fill fw-bold" id="btn-checkout" style="flex: 2;">THANH
                            TO√ÅN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="pos-card">
        <div class="p-2 border-bottom">
            <div class="search-container">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" id="product-search" placeholder="T√¨m t√™n, m√£, size, m√†u..." autofocus>
                </div>
                <button class="btn-filter" id="btn-open-filter" title="B·ªô l·ªçc n√¢ng cao"><i class="bi bi-funnel"></i>
                </button>
            </div>
        </div>
        <div class="product-grid-container">
            <div class="product-grid" id="product-grid"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-filter" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold">B·ªô L·ªçc S·∫£n Ph·∫©m</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-6"><label class="small fw-bold mb-1">Danh m·ª•c</label><select id="filter-category"
                                                                                                 class="form-select select2-modal"
                                                                                                 style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">Th∆∞∆°ng hi·ªáu</label><select id="filter-brand"
                                                                                                    class="form-select select2-modal"
                                                                                                    style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">Ch·∫•t li·ªáu</label><select id="filter-material"
                                                                                                  class="form-select select2-modal"
                                                                                                  style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">M√†u s·∫Øc</label><select id="filter-color"
                                                                                                class="form-select select2-modal"
                                                                                                style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">K√≠ch th∆∞·ªõc</label><select id="filter-size"
                                                                                                   class="form-select select2-modal"
                                                                                                   style="width: 100%;"></select>
                    </div>
                    <div class="col-6"><label class="small fw-bold mb-1">S·∫Øp x·∫øp gi√°</label>
                        <select id="sort-price" class="form-select select2-modal" style="width: 100%;">
                            <option value="none">M·∫∑c ƒë·ªãnh</option>
                            <option value="asc">Th·∫•p ƒë·∫øn Cao</option>
                            <option value="desc">Cao ƒë·∫øn Th·∫•p</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-light btn-sm" onclick="resetFilter()">M·∫∑c ƒë·ªãnh</button>
                <button class="btn btn-primary btn-sm" onclick="applyFilter(); $('#modal-filter').modal('hide');">√Åp
                    d·ª•ng
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-drafts" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light py-3">
                <h6 class="modal-title fw-bold text-primary"><i class="bi bi-clock-history"></i> DANH S√ÅCH ƒê∆†N CH·ªú</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover mb-0 text-center small align-middle">
                        <thead class="table-light sticky-top">
                        <tr>
                            <th>M√£ Hƒê</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Th·ªùi gian t·∫°o</th>
                            <th>Ghi ch√∫</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                        </thead>
                        <tbody id="tbody-drafts">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-qr-payment" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center border-0 shadow-lg">
            <div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold w-100 text-primary">QU√âT M√É THANH
                TO√ÅN</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="qr-code-container" class="d-inline-block p-2 border border-secondary rounded shadow-sm"></div>
                <div class="mt-2 small">
                    <div class="fw-bold">S·ªë ti·ªÅn: <span class="text-danger" id="qr-total"></span></div>
                    <div class="text-muted">N·ªôi dung: <span id="qr-content" class="fw-bold"></span></div>
                    <div class="text-muted small">NH: Techcombank - STK: 1903 9509 6510 13</div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success w-100 fw-bold py-2" onclick="confirmQRPayment()"><i
                            class="bi bi-check-circle-fill"></i> ƒê√É NH·∫¨N TI·ªÄN
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-select-variant" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0 pt-3"><h6 class="modal-title fw-bold text-primary text-center w-100"
                                                             id="modal-prod-name">Product Name</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <div class="text-center mb-3"><h4 class="fw-bold text-danger mb-0" id="modal-prod-price">---</h4><small
                        class="text-muted">Kho: <span id="modal-prod-stock" class="fw-bold">-</span></small></div>
                <div class="mb-2"><label class="small fw-bold text-muted mb-1">K√çCH TH∆Ø·ªöC</label>
                    <div id="modal-size-list" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                </div>
                <div class="mb-3"><label class="small fw-bold text-muted mb-1">M√ÄU S·∫ÆC</label>
                    <div id="modal-color-list" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                </div>
                <div class="input-group input-group-sm mb-3">
                    <button class="btn btn-outline-secondary" onclick="adjustModalQty(-1)">-</button>
                    <input type="number" id="modal-qty-input" class="form-control text-center fw-bold" value="1"
                           min="1">
                    <button class="btn btn-outline-secondary" onclick="adjustModalQty(1)">+</button>
                </div>
                <button type="button" class="btn btn-primary w-100 fw-bold" id="btn-confirm-add-cart">Th√™m v√†o ƒë∆°n
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-customer" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header pb-0 border-0"><h6 class="modal-title fw-bold">Kh√°ch h√†ng</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-2"><input type="text" class="form-control" id="input-search-cust"
                                                     placeholder="T√™n ho·∫∑c SƒêT...">
                    <button class="btn btn-primary" id="btn-do-search-cust"><i class="bi bi-search"></i></button>
                </div>
                <div class="list-group list-group-flush" id="list-cust-results"
                     style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // --- C·∫§U H√åNH API ---
    const API_PRODUCTS = "/api/data/san-pham-chi-tiet-active";
    const API_COUPONS = "/api/data/phieu-giam-gia-active";
    const API_DRAFTS = "/api/ban-hang/hoa-don-tam";
    const API_PAYMENT = "/api/ban-hang/thanh-toan";
    const API_SAVE_DRAFT = "/api/ban-hang/luu-tam";

    // üåü --- C·∫§U H√åNH QR CODE (TECHCOMBANK - VIETQR) --- üåü
    // D·ªØ li·ªáu l·∫•y t·ª´ h√¨nh ·∫£nh: HOANG DUC ANH, 1903 9509 6510 13 (Techcombank)
    const BANK_ID = "970407"; // M√£ BIN/ID Ng√¢n h√†ng Techcombank
    const BANK_ACCOUNT_NUMBER = "19039509651013"; // S·ªë t√†i kho·∫£n th·ª• h∆∞·ªüng
    const ACCOUNT_NAME_FOR_QR = "HOANG DUC ANH"; // T√™n ch·ªß t√†i kho·∫£n
    const BANK_SHORT_NAME = "Techcombank";
    const QR_CONTAINER_ID = "qr-code-container"; // ID c·ªßa th·∫ª DIV ch·ª©a m√£ QR

    let qrcodeInstance = null; // Bi·∫øn gi·ªØ instance c·ªßa QRCode.js

    const formatter = new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'});
    toastr.options = {"positionClass": "toast-top-center", "timeOut": "2000"};

    let cart = [];
    let allProducts = [];
    let groupedProducts = {};
    let currentCustomer = null;
    let currentOrderCode = "";
    let currentVariants = [], selectedSize = null, selectedColor = null;

    $(document).ready(function () {
        // Init Plugins
        $('.select2-basic').select2({theme: 'bootstrap-5'});
        $('.select2-modal').select2({theme: 'bootstrap-5', dropdownParent: $('#modal-filter')});

        // Load Initial Data
        initNewOrder();
        loadProducts();
        loadCoupons();
        updateDraftCount();

        // Event Listeners
        $('#product-search').on('input', applyFilter);
        $('#filter-category, #filter-brand, #filter-material, #filter-size, #filter-color, #sort-price').on('change', applyFilter);
        $('#btn-open-filter').click(() => $('#modal-filter').modal('show'));

        $('#product-grid').on('click', '.prod-card', function () {
            openProductModal($(this).data('parent-id'));
        });

        $('#modal-size-list').on('click', '.variant-option', function () {
            if ($(this).hasClass('disabled')) return;
            $('#modal-size-list .variant-option').removeClass('active');
            $(this).addClass('active');
            selectedSize = $(this).data('val');
            updateVariantUI();
        });
        $('#modal-color-list').on('click', '.variant-option', function () {
            if ($(this).hasClass('disabled')) return;
            $('#modal-color-list .variant-option').removeClass('active');
            $(this).addClass('active');
            selectedColor = $(this).data('val');
            updateVariantUI();
        });

        $('#btn-confirm-add-cart').click(confirmAddToCart);

        $('#cart-list').on('click', '.btn-remove', function () {
            removeFromCart($(this).data('id'));
        });
        $('#cart-list').on('click', '.qty-btn', function () {
            updateQty($(this).data('id'), parseInt($(this).siblings('.qty-input').val()) + $(this).data('delta'));
        });
        $('#cart-list').on('change', '.qty-input', function () {
            updateQty($(this).data('id'), parseInt($(this).val()));
        });

        $('#btn-checkout').click(handleCheckoutClick);
        $('#btn-save-draft').click(saveDraft);
        $('#customer-paid').on('input', calculateChange);
        $('#coupon-select').on('change', function () {
            renderCart();
        });

        $('#btn-do-search-cust').click(searchCustomer);
        $('#list-cust-results').on('click', '.item-cust', function () {
            setCustomer($(this).data('id'), $(this).data('name'));
        });

        $('.btn-pay-method').click(function () {
            $('.btn-pay-method').removeClass('active');
            $(this).addClass('active');
            setPaymentMethod($(this).data('method'));
        });

        // --- S·ª∞ KI·ªÜN H√ìA ƒê∆†N CH·ªú ---
        $('#btn-list-drafts').click(function () {
            loadDraftsList();
        });

        // N√∫t Ch·ªçn ƒë∆°n ch·ªù
        $('#tbody-drafts').on('click', '.btn-select-draft', function () {
            loadDraftDetail($(this).data('id'));
        });

        // N√∫t X√≥a ƒë∆°n ch·ªù
        $('#tbody-drafts').on('click', '.btn-delete-draft', function () {
            let code = $(this).attr('data-code');
            if (!code || code === "undefined") {
                toastr.error("L·ªói: Kh√¥ng t√¨m th·∫•y m√£ h√≥a ƒë∆°n!");
                return;
            }
            deleteDraftOrder(code);
        });
    });

    // --- LOGIC H√ìA ƒê∆†N CH·ªú (GI·ªÆ NGUY√äN) ---
    async function loadDraftsList() {
        try {
            const res = await fetch(API_DRAFTS);
            if (!res.ok) throw new Error("L·ªói t·∫£i danh s√°ch");

            const list = await res.json();
            let html = '';

            if (list.length === 0) {
                html = '<tr><td colspan="6" class="text-muted py-4">Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o ƒëang treo</td></tr>';
            } else {
                list.forEach(h => {
                    const dateStr = h.ngayTao ? new Date(h.ngayTao).toLocaleString('vi-VN') : '';
                    const cusName = h.khachHang ? h.khachHang.tenKhachHang : 'Kh√°ch l·∫ª';

                    html += `
                    <tr>
                        <td><span class="badge bg-secondary">${h.maHoaDon}</span></td>
                        <td class="fw-bold text-start ps-4">${cusName}</td>
                        <td class="text-primary fw-bold">${formatter.format(h.tongTien)}</td>
                        <td>${dateStr}</td>
                        <td class="text-truncate" style="max-width: 100px;" title="${h.ghiChu || ''}">${h.ghiChu || '-'}</td>
                        <td>
                            <div class="d-flex gap-1 justify-content-center">
                                <button class="btn btn-primary btn-sm btn-select-draft" data-id="${h.maHoaDon}" title="Ch·ªçn ƒë∆°n n√†y">
                                    <i class="bi bi-box-arrow-in-down-left"></i>
                                </button>
                                <button class="btn btn-danger btn-sm btn-delete-draft" data-code="${h.maHoaDon}" title="X√≥a b·ªè">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
            }
            $('#tbody-drafts').html(html);
            $('#modal-drafts').modal('show');
        } catch (e) {
            console.error(e);
            toastr.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n ch·ªù!");
        }
    }

    async function deleteDraftOrder(maHoaDon) {
        if (!maHoaDon) {
            toastr.error("M√£ h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá");
            return;
        }

        Swal.fire({
            title: `X√≥a h√≥a ƒë∆°n ${maHoaDon}?`,
            text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'X√≥a ngay',
            cancelButtonText: 'H·ªßy'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(API_DRAFTS + '/' + maHoaDon, { method: 'DELETE' });

                    if (res.ok) {
                        toastr.success("ƒê√£ x√≥a h√≥a ƒë∆°n: " + maHoaDon);
                        loadDraftsList();
                        updateDraftCount();
                    } else {
                        const errMsg = await res.text();
                        toastr.error(errMsg || "X√≥a th·∫•t b·∫°i");
                    }
                } catch (e) {
                    toastr.error("L·ªói k·∫øt n·ªëi server");
                }
            }
        });
    }

    // 3. T·∫£i chi ti·∫øt & Ph·ª•c h·ªìi gi·ªè h√†ng
    async function loadDraftDetail(id) {
        Swal.fire({
            title: 'Ph·ª•c h·ªìi ƒë∆°n h√†ng?',
            text: "Gi·ªè h√†ng hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#0d6efd',
            confirmButtonText: 'ƒê·ªìng √Ω',
            cancelButtonText: 'H·ªßy'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // LOG B∆∞·ªõc 1: G·ªçi API
                    console.log(`[DRAFT] ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng: ${id}`);
                    const res = await fetch(API_DRAFTS + '/' + id);// Load chi ti·∫øt v·∫´n d√πng ID (GET)

                    if (!res.ok) {
                        console.error(`[DRAFT ERROR] L·ªói API khi t·∫£i chi ti·∫øt: Status ${res.status}`);
                        throw new Error("L·ªói API khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng");
                    }

                    const order = await res.json();

                    // LOG B∆∞·ªõc 2: D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c
                    console.log("[DRAFT SUCCESS] D·ªØ li·ªáu chi ti·∫øt:", order);

                    currentOrderCode = order.maHoaDon;
                    $('#ma-don-hang').text(currentOrderCode);

                    if (order.khachHang) {
                        setCustomer(order.khachHang.id, order.khachHang.tenKhachHang);
                    } else {
                        $('#customer-name').text('Kh√°ch l·∫ª');
                        currentCustomer = null;
                    }

                    cart = [];
                    // Ki·ªÉm tra c·∫£ hai t√™n tr∆∞·ªùng c√≥ th·ªÉ c√≥ (hoaDonChiTiet ho·∫∑c hoaDonChiTiets)
                    const details = order.hoaDonChiTiet || order.hoaDonChiTiets || [];

                    if (details.length === 0) {
                        console.warn("[DRAFT WARNING] Kh√¥ng c√≥ chi ti·∫øt s·∫£n ph·∫©m n√†o trong ƒë∆°n n√†y.");
                    }

                    details.forEach(d => {
                        const spct = d.sanPhamChiTiet;

                        if (spct && spct.id) {
                            const originalProd = allProducts.find(p => p.id == spct.id);
                            const realStock = originalProd ? originalProd.soLuong : 0;

                            // LOG B∆∞·ªõc 3: Th√™m s·∫£n ph·∫©m v√†o gi·ªè
                            console.log(`[DRAFT ITEM] Th√™m SPCT ID ${spct.id}, SL ${d.soLuong} v√†o gi·ªè.`);

                            cart.push({
                                id: spct.id,
                                name: spct.sanPham.tenSanPham,
                                price: d.donGia,
                                size: spct.kichThuoc?.tenKichThuoc || "Free",
                                color: spct.mauSac?.tenMauSac || "Free",
                                qty: d.soLuong,
                                stock: realStock
                            });
                        } else {
                            console.error("[DRAFT ERROR] Chi ti·∫øt h√≥a ƒë∆°n thi·∫øu th√¥ng tin SPCT:", d);
                        }
                    });

                    // LOG B∆∞·ªõc 4: Render gi·ªè h√†ng
                    renderCart();

                    $('#modal-drafts').modal('hide');
                    toastr.success("ƒê√£ ph·ª•c h·ªìi ƒë∆°n h√†ng: " + currentOrderCode);
                } catch (e) {
                    console.error("[DRAFT FATAL ERROR]", e);
                    toastr.error("L·ªói t·∫£i chi ti·∫øt ƒë∆°n h√†ng: " + e.message);
                }
            }
        });
    }

    async function updateDraftCount() {
        try {
            const res = await fetch(API_DRAFTS);
            if (res.ok) {
                const list = await res.json();
                const count = list.length;
                if (count > 0) {
                    $('#draft-count').text(count).show();
                } else {
                    $('#draft-count').hide();
                }
            }
        } catch (e) {
        }
    }

    // --- C√ÅC H√ÄM LOGIC S·∫¢N PH·∫®M & GI·ªé H√ÄNG (GI·ªÆ NGUY√äN) ---

    async function loadProducts() {
        try {
            const res = await fetch(API_PRODUCTS);
            allProducts = await res.json();
            groupProductsByParent();
            loadFilterOptions();
            renderProductGrid(Object.values(groupedProducts));
        } catch (e) {
            toastr.error("L·ªói t·∫£i danh s√°ch s·∫£n ph·∫©m");
        }
    }

    function groupProductsByParent() {
        groupedProducts = {};
        allProducts.forEach(spct => {
            if (!spct.sanPham) return;
            const p = spct.sanPham;
            if (!groupedProducts[p.id]) {
                groupedProducts[p.id] = {
                    parentId: p.id, parentName: p.tenSanPham, parentCode: p.maSanPham,
                    category: p.loaiSanPham?.tenLoai || "Kh√°c", brand: p.thuongHieu?.tenThuongHieu || "Kh√°c",
                    material: p.chatLieu?.tenChatLieu || "Kh√°c", price: spct.giaTien || 0, variants: []
                };
            }
            groupedProducts[p.id].variants.push(spct);
        });
    }

    function loadFilterOptions() {
        const sizes = [...new Set(allProducts.map(v => v.kichThuoc?.tenKichThuoc || "Free"))].sort();
        const colors = [...new Set(allProducts.map(v => v.mauSac?.tenMauSac || "Free"))].sort();
        const cats = [...new Set(Object.values(groupedProducts).map(p => p.category))].sort();
        const brands = [...new Set(Object.values(groupedProducts).map(p => p.brand))].sort();
        const materials = [...new Set(Object.values(groupedProducts).map(p => p.material))].sort();

        const fill = (list, selector) => {
            let html = '<option value="">T·∫•t c·∫£</option>';
            list.forEach(v => html += `<option value="${v}">${v}</option>`);
            $(selector).html(html).trigger('change');
        };
        fill(sizes, '#filter-size');
        fill(colors, '#filter-color');
        fill(cats, '#filter-category');
        fill(brands, '#filter-brand');
        fill(materials, '#filter-material');
    }

    function applyFilter() {
        const k = removeVietnameseTones($('#product-search').val().trim());
        const fCat = $('#filter-category').val();
        const fBrand = $('#filter-brand').val();
        const fMat = $('#filter-material').val();
        const fSize = $('#filter-size').val();
        const fColor = $('#filter-color').val();
        const sortMode = $('#sort-price').val();

        let filtered = Object.values(groupedProducts).filter(p => {
            let matchText = true;
            if (k) {
                const name = removeVietnameseTones(p.parentName);
                const code = (p.parentCode || "").toLowerCase();
                if (!name.includes(k) && !code.includes(k)) matchText = false;
            }
            if (fCat && p.category !== fCat) return false;
            if (fBrand && p.brand !== fBrand) return false;
            if (fMat && p.material !== fMat) return false;
            let matchVariant = true;
            if (fSize || fColor) {
                matchVariant = p.variants.some(v => {
                    const s = v.kichThuoc?.tenKichThuoc || "Free";
                    const c = v.mauSac?.tenMauSac || "Free";
                    if (fSize && s !== fSize) return false;
                    if (fColor && c !== fColor) return false;
                    return true;
                });
            }
            return matchText && matchVariant;
        });

        if (sortMode === 'asc') filtered.sort((a, b) => a.price - b.price);
        if (sortMode === 'desc') filtered.sort((a, b) => b.price - a.price);
        renderProductGrid(filtered);
    }

    function renderProductGrid(list) {
        let html = '';
        list.forEach(p => {
            html += `<div class="prod-card" data-parent-id="${p.parentId}">
                        <div class="prod-name">${p.parentName}</div>
                        <div class="prod-code">${p.parentCode}</div>
                        <div class="prod-price-preview">${formatter.format(p.price)}</div>
                     </div>`;
        });
        $('#product-grid').html(html || '<div class="text-center w-100 text-muted mt-5">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p</div>');
    }

    function openProductModal(pId) {
        const g = groupedProducts[pId];
        if (!g) return;
        currentVariants = g.variants;
        $('#modal-prod-name').text(g.parentName);
        $('#modal-prod-price').text("Vui l√≤ng ch·ªçn thu·ªôc t√≠nh");
        $('#modal-prod-stock').text("-");
        const sizes = [...new Set(currentVariants.map(v => v.kichThuoc?.tenKichThuoc || "Free"))].sort();
        const colors = [...new Set(currentVariants.map(v => v.mauSac?.tenMauSac || "Free"))].sort();
        $('#modal-size-list').html(sizes.map(s => `<div class="variant-option" data-val="${s}">${s}</div>`).join(''));
        $('#modal-color-list').html(colors.map(c => `<div class="variant-option" data-val="${c}">${c}</div>`).join(''));
        selectedSize = null;
        selectedColor = null;
        updateVariantUI();
        $('#modal-qty-input').val(1);
        $('#btn-confirm-add-cart').prop('disabled', true);
        $('#modal-select-variant').modal('show');
    }

    function updateVariantUI() {
        const ck = (s, c) => currentVariants.some(v => (!s || (v.kichThuoc?.tenKichThuoc || "Free") === s) && (!c || (v.mauSac?.tenMauSac || "Free") === c) && (v.soLuong > 0));
        $('#modal-size-list .variant-option').each(function () {
            $(this).toggleClass('disabled', !ck($(this).data('val'), selectedColor));
        });
        $('#modal-color-list .variant-option').each(function () {
            $(this).toggleClass('disabled', !ck(selectedSize, $(this).data('val')));
        });
        if (selectedSize && selectedColor) {
            const v = currentVariants.find(v => (v.kichThuoc?.tenKichThuoc || "Free") === selectedSize && (v.mauSac?.tenMauSac || "Free") === selectedColor);
            if (v) {
                $('#modal-prod-price').text(formatter.format(v.giaTien));
                $('#modal-prod-stock').text(v.soLuong);
                $('#btn-confirm-add-cart').prop('disabled', v.soLuong <= 0).data('variant-id', v.id);
            } else {
                $('#modal-prod-stock').text("H·∫øt h√†ng");
                $('#btn-confirm-add-cart').prop('disabled', true);
            }
        }
    }

    function confirmAddToCart() {
        const vId = $('#btn-confirm-add-cart').data('variant-id');
        const qtyReq = parseInt($('#modal-qty-input').val()) || 1;
        const v = currentVariants.find(v => v.id == vId);
        if (!v || v.soLuong < qtyReq) return toastr.warning("S·∫£n ph·∫©m kh√¥ng ƒë·ªß h√†ng");
        const exist = cart.find(i => i.id == vId);
        if (exist) {
            if (exist.qty + qtyReq > v.soLuong) return toastr.warning("T·ªïng s·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho");
            exist.qty += qtyReq;
        } else {
            cart.push({
                id: v.id,
                name: v.sanPham.tenSanPham,
                price: v.giaTien,
                size: v.kichThuoc?.tenKichThuoc || "Free",
                color: v.mauSac?.tenMauSac || "Free",
                qty: qtyReq,
                stock: v.soLuong
            });
        }
        renderCart();
        $('#modal-select-variant').modal('hide');
        toastr.success("ƒê√£ th√™m v√†o gi·ªè");
    }

    function renderCart() {
        let subtotal = 0, html = '';
        if (cart.length === 0) {
            html = '<tr><td colspan="4" class="text-center py-5 text-muted small">Gi·ªè h√†ng tr·ªëng</td></tr>';
        } else {
            cart.forEach(i => {
                const totalItem = i.price * i.qty;
                subtotal += totalItem;
                html += `<tr><td><div class="fw-bold small text-truncate" style="max-width:140px">${i.name}</div><span class="text-muted small">${i.size} - ${i.color}</span></td>
                    <td><div class="qty-control"><button class="qty-btn" data-id="${i.id}" data-delta="-1">-</button><input type="number" class="qty-input" value="${i.qty}" data-id="${i.id}"><button class="qty-btn" data-id="${i.id}" data-delta="1">+</button></div></td>
                    <td class="text-end fw-bold small">${formatter.format(totalItem)}</td><td class="text-end"><i class="bi bi-trash text-danger btn-remove pointer" data-id="${i.id}"></i></td></tr>`;
            });
        }
        $('#cart-list').html(html);
        updateSummary(subtotal);
    }

    // --- LOGIC QR CODE & PAYMENT (ƒê√É C·∫¨P NH·∫¨T) ---

    function createVietQrPayload(total, orderCode) {
        // C·∫•u tr√∫c chu·ªói data cho QR Code (ƒë·ªÉ ·ª©ng d·ª•ng ng√¢n h√†ng qu√©t v√† ƒëi·ªÅn t·ª± ƒë·ªông)
        const totalAmount = Math.round(total);
        const qrContentText = removeVietnameseTones(`TT HD ${orderCode}`).toUpperCase().replace(/ /g, '.');

        // Payload theo chu·∫©n NAPAS/VietQR (Quy t·∫Øc 38, t√πy thu·ªôc v√†o ƒë·ªô ph·ª©c t·∫°p c·ªßa th∆∞ vi·ªán/API)
        // V√¨ QRCode.js ƒë∆°n gi·∫£n, ta d√πng chu·ªói th√¥ng tin chi ti·∫øt ƒë·ªÉ ·ª©ng d·ª•ng Mobile Banking hi·ªÉu
        // Ho·∫∑c d√πng format QRIBFT:
        const qrData = [
            "000201", // Payload Format Indicator
            "010211", // Point of Initiation Method
            "38"+(68).toString().padStart(2, '0'), // Merchant Account Information (Techcombank 68)
            "0010A000000727", // ID of NAPAS
            "01" + (BANK_ID.length + BANK_ACCOUNT_NUMBER.length + 3).toString().padStart(2, '0') + BANK_ID + "01" + BANK_ACCOUNT_NUMBER, // Bank info & Account
            "5303704", // Currency Code (VND 704)
            "54" + (totalAmount.toString().length).toString().padStart(2, '0') + totalAmount, // Amount
            "5802VN", // Country Code (VN)
            "62" + (22 + qrContentText.length).toString().padStart(2, '0'), // Additional Data Field Template
            "08" + (qrContentText.length).toString().padStart(2, '0') + qrContentText, // Bill Number (Content)
            "6304" // CRC (S·∫Ω ƒë∆∞·ª£c t√≠nh to√°n n·∫øu d√πng th∆∞ vi·ªán full, ·ªü ƒë√¢y ta b·ªè qua)
        ].join('');

        // V√¨ QRCode.js kh√¥ng t√≠nh to√°n CRC, ta ƒë∆°n gi·∫£n h√≥a th√†nh chu·ªói d·ªÖ ƒë·ªçc h∆°n cho Mobile Banking:
        return `STK: ${BANK_ACCOUNT_NUMBER} | NH: ${BANK_SHORT_NAME} | TEN: ${ACCOUNT_NAME_FOR_QR} | SO TIEN: ${totalAmount} | NOI DUNG: ${qrContentText}`;
    }

    function generateQRCode(totalAmount, orderCode) {
        const container = document.getElementById(QR_CONTAINER_ID);

        // 1. X√≥a m√£ QR c≈© (n·∫øu c√≥)
        if (qrcodeInstance) {
            container.innerHTML = '';
            qrcodeInstance = null;
        }

        if (totalAmount <= 0) {
            toastr.warning("T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0 ƒë·ªÉ t·∫°o m√£ QR.");
            return;
        }

        const qrData = createVietQrPayload(totalAmount, orderCode);
        const qrContentText = removeVietnameseTones(`TT HD ${orderCode}`).toUpperCase().replace(/ /g, '.');

        // 2. Hi·ªÉn th·ªã th√¥ng tin trong Modal
        $('#qr-total').text(formatter.format(totalAmount));
        $('#qr-content').text(qrContentText);

        // 3. T·∫°o m√£ QR m·ªõi
        try {
            qrcodeInstance = new QRCode(container, {
                text: qrData, // D·ªØ li·ªáu ƒë√£ ƒë·ªãnh d·∫°ng
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            $('#modal-qr-payment').modal('show');

        } catch (e) {
            console.error("L·ªói t·∫°o QR Code:", e);
            toastr.error("Kh√¥ng th·ªÉ t·∫°o m√£ QR thanh to√°n.");
        }
    }

    // File: ban-hang-tai-quay.html (trong th·∫ª <script>)

    function updateSummary(subtotal) {
        $('#subtotal').data('val', subtotal).text(formatter.format(subtotal));
        let discount = 0;
        const opt = $('#coupon-select').find(':selected');
        const cId = $('#coupon-select').val();
        $('#coupon-message').hide();

        if (cId) {
            const type = parseInt(opt.data('type')); // Quy ∆∞·ªõc: 1 = Ti·ªÅn m·∫∑t, 2 = Ph·∫ßn trƒÉm

            // D√πng parseCurrency ƒë·ªÉ ƒë·∫£m b·∫£o l·∫•y ƒë∆∞·ª£c s·ªë nguy√™n (v√≠ d·ª•: 35000)
            const val = parseCurrency(opt.data('val'));
            const min = parseCurrency(opt.data('min'));
            const maxData = opt.data('max');
            const max = (maxData === undefined || maxData === null || parseCurrency(maxData) === 0) ? 999999999 : parseCurrency(maxData);

            if (subtotal < min) {
                // ... (L·ªói ƒë∆°n t·ªëi thi·ªÉu)
            } else {
                // ‚úÖ S·ª¨A LOGIC: Ki·ªÉm tra n·∫øu l√† GI·∫¢M PH·∫¶N TRƒÇM (type === 2)
                if (type === 2) {
                    // Gi·∫£m ph·∫ßn trƒÉm
                    discount = subtotal * (val / 100);
                    if (discount > max) discount = max;
                } else if (type === 1) {
                    // Gi·∫£m ti·ªÅn m·∫∑t
                    discount = val;
                } else {
                    discount = 0; // Lo·∫°i kh√¥ng x√°c ƒë·ªãnh
                }

                $('#coupon-message').text(`√Åp d·ª•ng m√£ th√†nh c√¥ng: -${formatter.format(discount)}`).removeClass('text-danger').addClass('text-success').show();
            }
        }

        // ... (Ph·∫ßn t√≠nh to√°n t·ªïng ti·ªÅn c√≤n l·∫°i gi·ªØ nguy√™n)
        if (discount > subtotal) discount = subtotal;
        const finalTotal = subtotal - discount;
        $('#discount').text(formatter.format(discount)).data('val', discount);
        $('#total').text(formatter.format(finalTotal)).data('val', finalTotal);
        calculateChange();
    }

    function removeFromCart(id) {
        cart = cart.filter(i => i.id != id);
        renderCart();
    }

    function updateQty(id, qty) {
        if (isNaN(qty) || qty < 1) qty = 1;
        const item = cart.find(i => i.id == id);
        if (item) {
            if (qty > item.stock) {
                toastr.warning(`Kho ch·ªâ c√≤n ${item.stock} s·∫£n ph·∫©m`);
                qty = item.stock;
            }
            item.qty = qty;
            renderCart();
        }
    }

    function handleCheckoutClick() {
        if (!cart.length) {
            toastr.warning("Gi·ªè h√†ng ƒëang tr·ªëng!");
            return;
        }
        const total = parseFloat($('#total').data('val')) || 0;
        const method = $('#pay-method-val').val();

        if (method === 'CASH') {
            let paidAmount = parseCurrency($('#customer-paid').val());
            if (paidAmount < total) {
                Swal.fire('Thi·∫øu ti·ªÅn', 'Kh√°ch ch∆∞a ƒë∆∞a ƒë·ªß ti·ªÅn', 'warning');
                return;
            }
            Swal.fire({
                title: 'X√°c nh·∫≠n thanh to√°n',
                html: `<div>T·ªïng ti·ªÅn: <b>${formatter.format(total)}</b></div><div>Ph∆∞∆°ng th·ª©c: <b>${method}</b></div>`,
                icon: 'question', showCancelButton: true, confirmButtonText: 'X√°c nh·∫≠n & In h√≥a ƒë∆°n'
            }).then((result) => {
                if (result.isConfirmed) submitOrder(method, paidAmount);
            });
        } else if (method === 'QR') {
            if (total <= 0) {
                toastr.error("T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0 ƒë·ªÉ thanh to√°n QR.");
                return;
            }
            // T·∫°o m√£ QR v√† m·ªü modal khi nh·∫•n THANH TO√ÅN
            generateQRCode(total, currentOrderCode);
        }
    }

    function confirmQRPayment() {
        const total = parseFloat($('#total').data('val')) || 0;
        // Gi·∫£ ƒë·ªãnh kh√°ch ƒë√£ chuy·ªÉn ƒë·ªß ti·ªÅn (paidAmount = total)
        Swal.fire({
            title: 'X√°c nh·∫≠n ƒê√£ nh·∫≠n ti·ªÅn?',
            text: `ƒê√£ ki·ªÉm tra t√†i kho·∫£n v√† nh·∫≠n ƒë·ªß ${formatter.format(total)}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ƒê√£ nh·∫≠n ƒë·ªß'
        }).then((result) => {
            if (result.isConfirmed) {
                $('#modal-qr-payment').modal('hide');
                submitOrder('QR', total);
            }
        });
    }

    async function submitOrder(method, paidAmount) {
        const btn = $('#btn-checkout');
        const originalText = btn.text();
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span> ƒêang x·ª≠ l√Ω...');

        try {
            const payload = {
                maHoaDon: currentOrderCode,
                nhanVienId: $('#current-employee-id').val() || 1,
                khachHangId: currentCustomer?.id || null,
                danhSachSanPham: cart.map(i => ({sanPhamChiTietId: i.id, soLuong: i.qty, donGia: i.price})),
                tongTien: parseFloat($('#total').data('val')),
                tienGiamGia: parseFloat($('#discount').data('val')) || 0,
                phieuGiamGiaId: $('#coupon-select').val() || null,
                phuongThucThanhToan: method,
                tienKhachDua: paidAmount
            };
            const res = await fetch(API_PAYMENT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Thanh to√°n th√†nh c√¥ng!',
                    text: 'M√£ Hƒê: ' + (data.maHoaDon || currentOrderCode),
                    timer: 2000,
                    showConfirmButton: false
                })
                    .then(() => {
                        initNewOrder();
                        loadProducts();
                        updateDraftCount();
                    });
            } else {
                Swal.fire('L·ªói', data.message || 'Thanh to√°n th·∫•t b·∫°i', 'error');
            }
        } catch (e) {
            Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error');
        } finally {
            btn.prop('disabled', false).text(originalText);
        }
    }

    async function saveDraft() {
        if (!cart.length) return toastr.warning("Gi·ªè h√†ng tr·ªëng!");
        Swal.fire({title: 'Treo ƒë∆°n n√†y?', showCancelButton: true, confirmButtonText: 'ƒê·ªìng √Ω'}).then(async (r) => {
            if (r.isConfirmed) {
                try {
                    const payload = {
                        maHoaDon: currentOrderCode,
                        nhanVienId: $('#current-employee-id').val() || 1,
                        khachHangId: currentCustomer?.id || null,
                        danhSachSanPham: cart.map(i => ({sanPhamChiTietId: i.id, soLuong: i.qty, donGia: i.price})),
                        tongTien: parseFloat($('#total').data('val')),
                        phuongThucThanhToan: "DRAFT"
                    };
                    const res = await fetch(API_SAVE_DRAFT, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        toastr.success("ƒê√£ treo ƒë∆°n");
                        initNewOrder();
                        updateDraftCount();
                    } else toastr.error("L·ªói treo ƒë∆°n");
                } catch (e) {
                    toastr.error("L·ªói k·∫øt n·ªëi");
                }
            }
        });
    }

    function initNewOrder() {
        cart = [];
        currentCustomer = null;
        currentOrderCode = "HD" + Math.floor(Date.now() / 1000).toString().slice(-6);
        $('#ma-don-hang').text(currentOrderCode);
        $('#customer-name').text('Kh√°ch l·∫ª');
        $('#coupon-select').val('').trigger('change');
        $('#customer-paid').val('');
        setPaymentMethod('CASH');
        $('.btn-pay-method[data-method="CASH"]').addClass('active').siblings().removeClass('active');
        renderCart();
    }

    function setPaymentMethod(m) {
        $('#pay-method-val').val(m);
        if (m === 'CASH') {
            $('#cash-section').removeClass('d-none');
            $('#qr-hint').addClass('d-none');
            $('#modal-qr-payment').modal('hide');
            $('#btn-checkout').text('THANH TO√ÅN');
        } else {
            $('#cash-section').addClass('d-none');
            $('#qr-hint').removeClass('d-none');
            $('#btn-checkout').html('<i class="bi bi-qr-code"></i> THANH TO√ÅN (QR)');
        }
        calculateChange();
    }

    // --- C√ÅC H√ÄM H·ªñ TR·ª¢ (GI·ªÆ NGUY√äN) ---
    async function loadCoupons() {
        try {
            const r = await fetch(API_COUPONS);
            const l = await r.json();
            let h = '<option value="">-- Ch·ªçn m√£ --</option>';
            l.forEach(c => h += `<option value="${c.id}" data-type="${c.hinhThucGiam}" data-val="${c.giaTriGiam}" data-min="${c.dieuKienGiamGia || 0}" data-max="${c.soTienGiam || 999}">${c.tenPhieuGiamGia}</option>`);
            $('#coupon-select').html(h);
        } catch {
        }
    }

    async function searchCustomer() {
        const k = $('#input-search-cust').val();
        if (!k) return;
        try {
            const r = await fetch(`/api/khach-hang/search?keyword=${k}`);
            const l = await r.json();
            let h = '';
            l.forEach(c => h += `<a href="#" class="list-group-item list-group-item-action item-cust" data-id="${c.id}" data-name="${c.tenKhachHang}">${c.tenKhachHang} - ${c.soDienThoai}</a>`);
            $('#list-cust-results').html(h || 'Kh√¥ng t√¨m th·∫•y');
        } catch {
        }
    }

    function setCustomer(id, n) {
        currentCustomer = {id, name: n};
        $('#customer-name').text(n);
        $('#modal-customer').modal('hide');
        toastr.success("ƒê√£ ch·ªçn kh√°ch");
    }

    function calculateChange() {
        if ($('#pay-method-val').val() !== 'CASH') return;
        const p = parseCurrency($('#customer-paid').val());
        const t = parseFloat($('#total').data('val')) || 0;
        const c = p - t;
        $('#change-amount-text').text(c < 0 ? `Thi·∫øu ${formatter.format(Math.abs(c))}` : formatter.format(c)).removeClass(c < 0 ? 'text-success' : 'text-danger').addClass(c < 0 ? 'text-danger' : 'text-success');
    }

    function parseCurrency(str) {
        return parseFloat(str?.toString().replace(/[^0-9]/g, '')) || 0;
    }

    function removeVietnameseTones(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D').toLowerCase();
    }

    function adjustModalQty(d) {
        let v = parseInt($('#modal-qty-input').val()) || 1;
        v += d;
        if (v < 1) v = 1;
        $('#modal-qty-input').val(v);
    }
</script>
</body>
</html>