<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - F-STORE</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />

    <style>
        :root {
            --primary: #0061f2; /* Xanh dương đậm hiện đại */
            --primary-light: #e1e9ff;
            --secondary: #6900c7;
            --bg-app: #f2f6fc;
            --surface: #ffffff;
            --text-main: #2c3e50;
            --text-light: #95a5a6;
            --border-radius: 12px;
            --shadow-card: 0 4px 12px rgba(0,0,0,0.03);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text-main);
        }

        /* --- NAVBAR --- */
        .navbar-pos {
            background: var(--surface);
            height: 60px;
            border-bottom: 1px solid #eef2f6;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            z-index: 100;
        }
        .brand-logo { font-weight: 800; font-size: 1.25rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .nav-btn {
            background: transparent; border: none; font-weight: 600; color: #5b6b79;
            padding: 8px 16px; border-radius: 8px; transition: all 0.2s; text-decoration: none;
        }
        .nav-btn:hover, .nav-btn.active { background: var(--primary-light); color: var(--primary); }

        /* --- MAIN LAYOUT --- */
        .pos-container {
            flex: 1;
            padding: 15px;
            display: grid;
            grid-template-columns: 7fr 5fr; /* Bên trái 7 phần, phải 5 phần */
            gap: 15px;
            overflow: hidden;
        }

        /* --- CARD STYLES --- */
        .pos-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }

        /* --- LEFT COLUMN: CART & PAYMENT --- */
        .order-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
        .order-id-badge { background: var(--primary-light); color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .clock-display { font-family: 'Inter', monospace; font-weight: 600; color: #555; background: #f8f9fa; padding: 5px 10px; border-radius: 6px; }

        /* Cart List */
        .cart-body { flex: 1; overflow-y: auto; background: #fff; }
        .cart-table { width: 100%; border-collapse: collapse; }
        .cart-table th { position: sticky; top: 0; background: #f8f9fa; z-index: 10; font-size: 0.8rem; text-transform: uppercase; color: #888; padding: 12px; font-weight: 600; border-bottom: 1px solid #eee; }
        .cart-table td { padding: 12px; vertical-align: middle; border-bottom: 1px solid #f9f9f9; }
        .cart-item-img { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
        .qty-control { display: inline-flex; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .qty-btn { width: 28px; height: 28px; background: #fff; border: none; cursor: pointer; color: var(--primary); font-weight: bold; transition: 0.2s; }
        .qty-btn:hover { background: var(--primary-light); }
        .qty-input { width: 32px; border: none; text-align: center; font-weight: 600; font-size: 0.9rem; outline: none; }

        /* Payment Footer */
        .payment-footer { padding: 15px; background: #fdfdfd; border-top: 1px solid #eee; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; color: #555; }
        .total-price { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        .pay-method-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .method-option {
            flex: 1; border: 1px solid #e0e0e0; padding: 10px; border-radius: 8px; text-align: center;
            cursor: pointer; transition: 0.2s; font-weight: 500; color: #666; font-size: 0.9rem;
        }
        .method-option.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); font-weight: 700; }
        .method-option i { display: block; font-size: 1.2rem; margin-bottom: 4px; }

        .btn-action-lg {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            background: linear-gradient(135deg, var(--primary), #004ecc); color: white;
            box-shadow: 0 4px 10px rgba(0, 97, 242, 0.3); transition: 0.3s;
        }
        .btn-action-lg:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 97, 242, 0.4); }

        /* --- RIGHT COLUMN: PRODUCT GRID --- */
        .product-filter { padding: 12px; background: #fff; border-bottom: 1px solid #eee; display: flex; gap: 10px; }
        .search-box { flex: 1; position: relative; }
        .search-box input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: 1px solid #ddd; background: #f8f9fa; outline: none; }
        .search-box input:focus { background: #fff; border-color: var(--primary); }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }

        .product-grid-container { flex: 1; overflow-y: auto; padding: 12px; background: #f8f9fa; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .prod-card {
            background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid transparent;
            cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            display: flex; flex-direction: column;
        }
        .prod-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .prod-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
        .prod-details { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .prod-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .prod-meta { font-size: 0.75rem; color: #888; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-bottom: 6px; }
        .prod-price { font-weight: 700; color: var(--primary); font-size: 1rem; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        @media (max-width: 992px) {
            .pos-container { grid-template-columns: 1fr; overflow-y: auto; }
            .pos-card { height: auto; max-height: 600px; }
        }
    </style>
</head>
<body>

<nav class="navbar-pos">
    <a href="#" class="brand-logo"><i class="bi bi-box-seam-fill"></i> F-STORE POS</a>
    <div class="d-flex align-items-center gap-2">
        <a href="#" class="nav-btn active"><i class="bi bi-shop me-1"></i>Bán hàng</a>
        <a th:href="@{/admin/hoa-don}" class="nav-btn"><i class="bi bi-receipt me-1"></i>Hóa đơn</a>
        <div class="vr mx-2"></div>
        <div class="dropdown">
            <button class="btn btn-light rounded-pill border px-3 py-1 d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:28px; height:28px; font-size:0.8rem;">NV</div>
                <span class="fw-bold small text-dark" sec:authorize="isAuthenticated()" th:text="${nhanVienHienTai.tenNhanVien}">Nhân viên</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2">
                <li>
                    <form th:action="@{/logout}" method="post" class="m-0">
                        <button class="dropdown-item text-danger"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</button>
                    </form>
                </li>
            </ul>
            <input type="hidden" id="current-employee-id" th:value="${nhanVienHienTai.id}">
        </div>
    </div>
</nav>

<div class="pos-container">

    <div class="pos-card">
        <div class="order-header">
            <div class="d-flex align-items-center gap-3">
                <span class="order-id-badge" id="ma-don-hang">#NEW</span>
                <div class="d-flex align-items-center bg-light px-3 py-1 rounded border" style="cursor: pointer;" onclick="$('#modal-customer').modal('show')">
                    <i class="bi bi-person-circle text-secondary me-2"></i>
                    <span class="fw-bold text-dark" id="customer-name">Khách lẻ</span>
                    <i class="bi bi-chevron-down ms-2 small text-muted"></i>
                </div>
                <i class="bi bi-x-circle text-danger ms-1" style="cursor: pointer;" onclick="resetCustomer()" title="Xóa khách"></i>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="btn-list-drafts"><i class="bi bi-list-ul"></i> Đơn chờ</button>
                <div class="clock-display" id="clock-display">00:00:00</div>
            </div>
        </div>

        <div class="cart-body">
            <table class="cart-table">
                <thead>
                <tr>
                    <th style="width: 45%;">Sản phẩm</th>
                    <th style="width: 15%;">Đơn giá</th>
                    <th style="width: 20%; text-align: center;">Số lượng</th>
                    <th style="width: 15%; text-align: right;">Thành tiền</th>
                    <th style="width: 5%;"></th>
                </tr>
                </thead>
                <tbody id="cart-list">
                </tbody>
            </table>
        </div>

        <div class="payment-footer">
            <div class="row g-3">
                <div class="col-md-6 border-end pe-3">
                    <label class="form-label small fw-bold text-muted mb-1">MÃ GIẢM GIÁ</label>
                    <select class="form-select form-select-sm mb-3 bg-light border-0" id="coupon-select">
                        <option value="">Chọn voucher...</option>
                    </select>

                    <label class="form-label small fw-bold text-muted mb-1">PHƯƠNG THỨC THANH TOÁN</label>
                    <div class="pay-method-selector">
                        <div class="method-option active" data-val="CASH" onclick="setPaymentMethod('CASH')">
                            <i class="bi bi-cash-coin"></i> Tiền mặt
                        </div>
                        <div class="method-option" data-val="QR" onclick="setPaymentMethod('QR')">
                            <i class="bi bi-qr-code-scan"></i> Chuyển khoản
                        </div>
                        <input type="hidden" id="pay-method-val" value="CASH">
                    </div>

                    <div id="cash-section">
                        <div class="input-group">
                            <span class="input-group-text bg-white text-muted border-end-0">Khách đưa</span>
                            <input type="text" class="form-control fw-bold text-end border-start-0" id="customer-paid" placeholder="0">
                            <span class="input-group-text bg-white">₫</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2 px-2">
                            <small class="text-muted">Tiền thừa:</small>
                            <span class="fw-bold text-success" id="change-amount-text">0 ₫</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 d-flex flex-column justify-content-between">
                    <div>
                        <div class="summary-item"><span>Tổng tiền hàng</span> <span class="fw-bold text-dark" id="subtotal">0 ₫</span></div>
                        <div class="summary-item"><span>Giảm giá</span> <span class="fw-bold text-danger" id="discount">0 ₫</span></div>
                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                            <span class="text-uppercase fw-bold text-secondary">Khách phải trả</span>
                            <span class="total-price" id="total" data-value="0">0 ₫</span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="row g-2 mb-2">
                            <div class="col-6"><button class="btn btn-light border w-100 fw-bold text-secondary py-2" id="btn-save-draft">Lưu tạm</button></div>
                            <div class="col-6"><button class="btn btn-light border w-100 fw-bold text-secondary py-2" onclick="initNewOrder()">Hủy</button></div>
                        </div>
                        <button class="btn-action-lg" id="btn-checkout">
                            <i class="bi bi-check-lg me-1"></i> THANH TOÁN
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="pos-card">
        <div class="product-filter">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="product-search" placeholder="Tìm kiếm sản phẩm (Tên, Mã)...">
            </div>
            <button class="btn btn-light border rounded-circle" id="btn-reload" style="width: 42px; height: 42px;"><i class="bi bi-arrow-clockwise"></i></button>
        </div>

        <div class="product-grid-container">
            <div class="product-grid" id="product-grid">
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="modal-qr" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0">
            <div class="modal-body text-center p-4">
                <h5 class="fw-bold text-primary mb-3">QUÉT MÃ QR</h5>
                <div class="p-2 border rounded d-inline-block mb-3 bg-white">
                    <img src="" id="qr-image-popup" class="img-fluid" style="width: 200px;" alt="QR Code">
                </div>
                <h4 class="fw-bold text-danger mb-1" id="qr-amount-popup">0 ₫</h4>
                <p class="text-muted small mb-3" id="qr-content-popup">...</p>
                <button class="btn btn-success w-100 fw-bold py-2" id="btn-confirm-transfer">XÁC NHẬN ĐÃ CHUYỂN</button>
                <button class="btn btn-light text-muted w-100 mt-2 btn-sm" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-customer" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h6 class="modal-title fw-bold">Tìm Khách Hàng</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="input-search-cust" placeholder="Nhập tên hoặc số điện thoại...">
                    <button class="btn btn-primary" id="btn-do-search-cust"><i class="bi bi-search"></i></button>
                </div>
                <div class="list-group list-group-flush" id="list-cust-results"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-drafts" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold">Danh sách đơn chờ</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-hover mb-0 text-center small align-middle">
                    <thead class="table-light"><tr><th>Mã HĐ</th><th>Khách hàng</th><th>Tổng tiền</th><th>Thao tác</th></tr></thead>
                    <tbody id="tbody-drafts"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script>
    const SHIPPING_FEE = 30000;
    const API_TINH = "https://esgoo.net/api-tinhthanh/1/0.htm";
    const API_HUYEN = "https://esgoo.net/api-tinhthanh/2/";
    const API_XA = "https://esgoo.net/api-tinhthanh/3/";

    let currentCart = [];
    const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

    document.addEventListener("DOMContentLoaded", function () {
        loadAddressData();
        loadCartFromStorage();
        loadActiveVouchers();
    });

    // --- 1. TẢI VOUCHER (LOGIC GIỐNG POS) ---
    function loadActiveVouchers() {
        fetch('/api/phieu-giam-gia/active')
            .then(res => res.json())
            .then(data => {
                let html = '<option value="" data-type="0" data-value="0" data-max="0" data-condition="0">-- Chọn mã giảm giá --</option>';
                data.forEach(c => {
                    // Mapping dữ liệu chuẩn
                    const type = c.hinhThucGiam || 1; // 1: Tiền, 2: %
                    const value = c.giaTriGiam || 0;
                    const max = c.soTienGiam || 999999999;
                    const cond = c.dieuKienGiamGia || 0;

                    let label = `${c.maPhieuGiamGia}`;
                    if(c.tenPhieuGiamGia) label += ` - ${c.tenPhieuGiamGia}`;

                    if (type === 2) { // %
                        label += ` [Giảm ${value}%`;
                        if(max < 999999999) label += ` - Tối đa ${formatter.format(max)}`;
                        label += `]`;
                    } else { // Tiền
                        label += ` [Giảm ${formatter.format(value)}]`;
                    }

                    if (cond > 0) label += ` (Đơn > ${formatter.format(cond)})`;

                    // Lưu data vào thẻ option để tính toán luôn ở client (nhanh hơn gọi API)
                    html += `<option value="${c.maPhieuGiamGia}"
                                data-id="${c.id}"
                                data-type="${type}"
                                data-value="${value}"
                                data-max="${max}"
                                data-condition="${cond}">
                                ${label}
                             </option>`;
                });
                document.getElementById('voucherSelect').innerHTML = html;
            })
            .catch(err => console.error("Lỗi voucher:", err));
    }

    // --- 2. TÍNH TIỀN & HIỂN THỊ (LOGIC GIỐNG POS) ---
    function renderCheckoutSummary() {
        // Tính tổng tiền hàng
        let subTotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        // Lấy thông tin Voucher đang chọn
        const select = document.getElementById('voucherSelect');
        const opt = select.options[select.selectedIndex];

        let discountAmount = 0;

        // Nếu có chọn mã
        if (opt.value) {
            const type = parseFloat(opt.getAttribute('data-type'));
            const value = parseFloat(opt.getAttribute('data-value'));
            const max = parseFloat(opt.getAttribute('data-max'));
            const cond = parseFloat(opt.getAttribute('data-condition'));

            // Kiểm tra điều kiện đơn tối thiểu
            if (subTotal < cond) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Chưa đủ điều kiện',
                    text: `Đơn hàng phải từ ${formatter.format(cond)} mới được dùng mã này!`,
                    confirmButtonColor: '#f59e0b'
                });
                select.value = ""; // Reset về mặc định
                discountAmount = 0;
            } else {
                // Tính toán
                if (type === 2) { // %
                    let percentDiscount = (subTotal * value) / 100;
                    if (max > 0 && percentDiscount > max) percentDiscount = max;
                    discountAmount = percentDiscount;
                } else { // Tiền
                    discountAmount = value;
                }

                // Không giảm quá tổng tiền
                if(discountAmount > subTotal) discountAmount = subTotal;
            }
        }

        // Cập nhật giao diện
        document.getElementById('subTotal').innerText = formatter.format(subTotal);
        document.getElementById('shippingFee').innerText = formatter.format(SHIPPING_FEE);
        document.getElementById('discountAmount').innerText = discountAmount > 0 ? "-" + formatter.format(discountAmount) : "0₫";

        let finalTotal = subTotal + SHIPPING_FEE - discountAmount;
        if(finalTotal < 0) finalTotal = 0;
        document.getElementById('finalTotal').innerText = formatter.format(finalTotal);
    }

    // --- 3. LOAD GIỎ HÀNG ---
    function loadCartFromStorage() {
        const json = localStorage.getItem('cartItems');
        currentCart = json ? JSON.parse(json) : [];
        const container = document.getElementById('cartItemsList');

        if (currentCart.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted"><i class="fa-solid fa-basket-shopping fs-1 mb-2"></i><p>Giỏ hàng trống</p><a href="/san-pham" class="btn btn-sm btn-outline-primary rounded-pill">Mua sắm ngay</a></div>`;
            // Reset tiền
            document.getElementById('subTotal').innerText = "0₫";
            document.getElementById('finalTotal').innerText = "0₫";
            return;
        }

        let html = '';
        currentCart.forEach((item, index) => {
            html += `
                <div class="order-item align-items-center">
                    <img src="${item.image || 'https://via.placeholder.com/64'}" class="item-img">
                    <div class="item-info flex-grow-1">
                        <span class="item-name text-truncate" style="max-width: 180px;" title="${item.name}">${item.name}</span>
                        <div class="item-meta">Size: <b>${item.size}</b> | Màu: <b>${item.color}</b></div>
                        <div class="d-flex justify-content-between mt-1 align-items-center">
                            <small class="text-muted bg-light px-2 rounded">x${item.quantity}</small>
                            <span class="item-price fw-bold text-primary">${formatter.format(item.price * item.quantity)}</span>
                        </div>
                    </div>
                    <div class="ms-2">
                        <button type="button" class="btn-remove-item" onclick="removeCartItem(${index})" title="Xóa">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
        renderCheckoutSummary(); // Tính tiền ngay khi load
    }

    function removeCartItem(index) {
        Swal.fire({
            title: 'Xóa sản phẩm?', icon: 'warning', showCancelButton: true,
            confirmButtonColor: '#ef4444', confirmButtonText: 'Xóa', cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                currentCart.splice(index, 1);
                localStorage.setItem('cartItems', JSON.stringify(currentCart));
                loadCartFromStorage();
            }
        });
    }

    // --- 4. ĐẶT HÀNG ---
    document.getElementById('btnPlaceOrder').addEventListener('click', function() {
        // Validate Form
        const fullName = document.getElementById('fullName').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('addressDetail').value;
        const citySel = document.getElementById('city');
        const distSel = document.getElementById('district');
        const wardSel = document.getElementById('ward');

        if(!fullName || !phone || !address || !citySel.value || !distSel.value || !wardSel.value) {
            Swal.fire({ icon: 'error', title: 'Thiếu thông tin', text: 'Vui lòng điền đầy đủ thông tin giao hàng!' });
            return;
        }

        // Lấy thông tin địa chỉ dạng chữ
        const cityName = citySel.options[citySel.selectedIndex].getAttribute('data-name');
        const distName = distSel.options[distSel.selectedIndex].getAttribute('data-name');
        const wardName = wardSel.options[wardSel.selectedIndex].getAttribute('data-name');

        // Lấy mã giảm giá
        const voucherCode = document.getElementById('voucherSelect').value;

        const payload = {
            fullName: fullName, phone: phone, email: document.getElementById('email').value,
            city: cityName, district: distName, ward: wardName, addressDetail: address,
            note: document.getElementById('note').value,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
            voucherCode: voucherCode,
            shippingFee: SHIPPING_FEE,
            items: currentCart.map(i => ({ sanPhamChiTietId: i.id, soLuong: i.quantity, donGia: i.price }))
        };

        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ĐANG XỬ LÝ...';
        btn.disabled = true;

        fetch('/api/checkout/place-order', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    if(data.redirectUrl) {
                        if(!data.redirectUrl.includes('vnpay')) localStorage.removeItem('cartItems');
                        window.location.href = data.redirectUrl;
                    } else {
                        Swal.fire({ icon: 'success', title: 'Thành công!', text: 'Đặt hàng thành công!' });
                    }
                } else {
                    Swal.fire({ icon: 'error', title: 'Rất tiếc...', text: data.message });
                    btn.innerHTML = originalText; btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                Swal.fire({ icon: 'error', title: 'Lỗi hệ thống', text: 'Không thể kết nối đến server.' });
                btn.innerHTML = originalText; btn.disabled = false;
            });
    });

    // --- 5. XỬ LÝ ĐỊA CHÍNH API ---
    function loadAddressData() {
        fetch(API_TINH).then(res => res.json()).then(data => {
            if (data.error === 0) {
                let html = '<option value="">Chọn Tỉnh/Thành</option>';
                data.data.forEach(t => html += `<option value="${t.id}" data-name="${t.full_name}">${t.full_name}</option>`);
                document.getElementById('city').innerHTML = html;
            }
        });
        document.getElementById('city').addEventListener('change', function () {
            const id = this.value;
            const dist = document.getElementById('district'); const ward = document.getElementById('ward');
            dist.innerHTML = '<option value="">Đang tải...</option>'; ward.innerHTML = '<option value="">Chọn Phường/Xã</option>'; ward.disabled = true;
            if(id) {
                fetch(API_HUYEN + id + ".htm").then(res => res.json()).then(data => {
                    let html = '<option value="">Chọn Quận/Huyện</option>';
                    data.data.forEach(h => html += `<option value="${h.id}" data-name="${h.full_name}">${h.full_name}</option>`);
                    dist.innerHTML = html; dist.disabled = false;
                });
            } else { dist.innerHTML = '<option value="">Chọn Quận/Huyện</option>'; dist.disabled = true; }
        });
        document.getElementById('district').addEventListener('change', function () {
            const id = this.value;
            const ward = document.getElementById('ward');
            ward.innerHTML = '<option value="">Đang tải...</option>';
            if(id) {
                fetch(API_XA + id + ".htm").then(res => res.json()).then(data => {
                    let html = '<option value="">Chọn Phường/Xã</option>';
                    data.data.forEach(x => html += `<option value="${x.id}" data-name="${x.full_name}">${x.full_name}</option>`);
                    ward.innerHTML = html; ward.disabled = false;
                });
            } else { ward.innerHTML = '<option value="">Chọn Phường/Xã</option>'; ward.disabled = true; }
        });
    }
</script>

</body>
</html>