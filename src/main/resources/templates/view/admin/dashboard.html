<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Quản Trị Hệ Thống</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css"/>

    <link rel="stylesheet" th:href="@{/css/styles.css}"/>
    <link rel="stylesheet" th:href="@{/css/navbar.css}"/>
    <style>
        :root {
            --font-family: 'Plus Jakarta Sans', sans-serif;
            --primary-color: #4318FF;
            --secondary-color: #A3AED0;
            --light-bg: #F4F7FE;
            --card-bg: #ffffff;
            --dark-text: #1B2559;
            --border-radius: 20px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-bg);
            color: var(--dark-text);
        }

        .content {
            padding: 20px 30px;
        }

        /* Card Styles */
        .custom-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: none;
            box-shadow: 0px 18px 40px rgba(112, 144, 176, 0.12);
            padding: 24px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Stat Card */
        .stat-card {
            flex-direction: row;
            align-items: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(67, 24, 255, 0.1);
            color: var(--primary-color);
            margin-left: auto;
        }

        /* Filter Buttons */
        .filter-btn-group .btn {
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 6px 16px;
            color: var(--secondary-color);
            background: transparent;
            border-radius: 10px;
        }

        .filter-btn-group .btn.active {
            background: var(--primary-color);
            color: #fff;
        }

        .filter-btn-group .btn:hover:not(.active) {
            background: #e2e8f0;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }

        /* Table */
        .table-custom th {
            font-weight: 600;
            color: var(--secondary-color);
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .table-custom td {
            vertical-align: middle;
            padding: 15px 10px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Product Item */
        .product-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #edf2f7;
        }

        .product-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .product-img {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            object-fit: cover;
        }
    </style>
</head>
<body>

<nav th:replace="~{library/navbar :: admin-navbar}"></nav>

<div class="d-flex">
    <div th:replace="~{library/navbar :: admin-sidebar}">
    </div>

    <main class="content flex-grow-1">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <small class="text-secondary fw-bold">Pages / Dashboard</small>
                <h4 class="fw-bold m-0 text-dark">Tổng quan</h4>
            </div>
            <div class="d-flex align-items-center gap-2 bg-white p-2 rounded-pill shadow-sm">
                <i class="bi bi-calendar-event text-primary ms-2"></i>
                <span class="fw-bold small text-secondary me-2" id="currentDateDisplay">Hôm nay</span>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-12 col-md-6 col-xl-3">
                <div class="custom-card stat-card">
                    <div>
                        <div class="text-secondary small fw-bold">Doanh thu hôm nay</div>
                        <div class="fs-4 fw-bolder mt-1 text-dark"
                             th:text="${#numbers.formatDecimal(todayRevenue != null ? todayRevenue : 0, 0, 'COMMA', 0, 'POINT') + ' ₫'}">
                            0 ₫
                        </div>
                    </div>
                    <div class="stat-icon-wrapper"><i class="bi bi-cash-coin"></i></div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-xl-3">
                <div class="custom-card stat-card">
                    <div>
                        <div class="text-secondary small fw-bold">Đơn hàng mới</div>
                        <div class="fs-4 fw-bolder mt-1 text-dark"
                             th:text="${totalOrdersToday != null ? totalOrdersToday : 0}">0
                        </div>
                    </div>
                    <div class="stat-icon-wrapper bg-primary-subtle text-primary"><i class="bi bi-receipt"></i></div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-xl-3">
                <div class="custom-card stat-card">
                    <div>
                        <div class="text-secondary small fw-bold">Khách hàng mới</div>
                        <div class="fs-4 fw-bolder mt-1 text-dark" th:text="${newCustomers != null ? newCustomers : 0}">
                            0
                        </div>
                    </div>
                    <div class="stat-icon-wrapper bg-success-subtle text-success"><i class="bi bi-person-add"></i></div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-xl-3">
                <div class="custom-card stat-card">
                    <div>
                        <div class="text-secondary small fw-bold">Sắp hết hàng</div>
                        <div class="fs-4 fw-bolder mt-1 text-dark"
                             th:text="${totalSanPhamSapHet != null ? totalSanPhamSapHet : 0}">0
                        </div>
                    </div>
                    <div class="stat-icon-wrapper bg-danger-subtle text-danger"><i
                            class="bi bi-exclamation-triangle"></i></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-12 col-lg-8">
                <div class="custom-card">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                        <h5 class="fw-bold m-0"><i class="bi bi-graph-up-arrow text-primary me-2"></i>Biểu đồ Doanh thu
                        </h5>

                        <div class="d-flex bg-light rounded-3 p-1 filter-btn-group">
                            <button class="btn active" onclick="updateChart('weekly', this)">Tuần</button>
                            <button class="btn" onclick="updateChart('monthly', this)">Tháng</button>
                            <button class="btn" onclick="updateChart('quarterly', this)">Quý</button>
                            <button class="btn" onclick="updateChart('yearly', this)">Năm</button>
                        </div>

                        <div class="d-flex gap-1">
                            <input type="date" id="startDate" class="form-control form-control-sm"
                                   style="max-width: 130px;">
                            <input type="date" id="endDate" class="form-control form-control-sm"
                                   style="max-width: 130px;">
                            <button class="btn btn-sm btn-primary" onclick="updateChart('custom', this)"><i
                                    class="bi bi-funnel"></i></button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="custom-card">
                    <h5 class="fw-bold mb-4">Trạng thái Đơn hàng</h5>
                    <div class="chart-container" style="height: 240px;">
                        <canvas id="orderStatusChart"></canvas>
                    </div>
                    <div class="mt-4 pt-3 border-top small">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-primary me-2"></i>Hoàn thành</span>
                            <span class="fw-bold"
                                  th:text="${orderStatusValues != null && orderStatusValues.size() > 0 ? orderStatusValues[0] : 0}">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-warning me-2"></i>Đang giao</span>
                            <span class="fw-bold"
                                  th:text="${orderStatusValues != null && orderStatusValues.size() > 1 ? orderStatusValues[1] : 0}">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-circle-fill text-danger me-2"></i>Đã hủy</span>
                            <span class="fw-bold"
                                  th:text="${orderStatusValues != null && orderStatusValues.size() > 2 ? orderStatusValues[2] : 0}">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-12 col-xl-8">
                <div class="custom-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0">Đơn hàng gần đây</h5>
                        <a href="/admin/hoa-don" class="btn btn-light btn-sm text-primary fw-bold rounded-pill">Xem tất
                            cả</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom table-hover">
                            <thead class="bg-light rounded-3">
                            <tr>
                                <th>Mã HĐ</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="order : ${recentOrders}">
                                <td class="fw-bold text-primary" th:text="'#' + ${order.maHoaDon}">#000</td>
                                <td th:text="${order.customerName}">Khách lẻ</td>
                                <td th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">01/01/2025</td>
                                <td class="fw-bold"
                                    th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + ' ₫'}">
                                    0 ₫
                                </td>
                                <td>
                                    <span class="badge bg-success-subtle text-success border border-success-subtle"
                                          th:if="${order.status == 1}">Hoàn thành</span>
                                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle"
                                          th:if="${order.status == 3}">Đang giao</span>
                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle"
                                          th:if="${order.status == 0}">Đã hủy</span>
                                    <span class="badge bg-secondary-subtle text-secondary"
                                          th:if="${order.status != 1 && order.status != 3 && order.status != 0}">Chờ xử lý</span>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(recentOrders)}">
                                <td colspan="5" class="text-center py-4 text-muted">Chưa có dữ liệu đơn hàng</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-4">
                <div class="custom-card">
                    <h5 class="fw-bold mb-4">Top sản phẩm bán chạy</h5>
                    <div class="d-flex flex-column">
                        <div th:each="prod : ${topProducts}" class="product-item">
                            <img th:src="${prod.productImage != null ? prod.productImage : 'https://placehold.co/100'}"
                                 class="product-img" alt="Product">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold fs-6 text-truncate" style="max-width: 150px;"
                                    th:text="${prod.productName}">Sản phẩm A</h6>
                                <small class="text-muted" th:text="'Đã bán: ' + ${prod.totalSold}">Sold: 0</small>
                            </div>
                            <div class="fw-bold text-primary"
                                 th:text="${#numbers.formatDecimal(prod.price, 0, 'COMMA', 0, 'POINT') + ' ₫'}">0 ₫
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(topProducts)}" class="text-center text-muted py-3">
                            <i class="bi bi-box2 display-6"></i>
                            <p class="mt-2 small">Chưa có dữ liệu thống kê</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
    // Hiển thị ngày hiện tại ở Header
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('vi-VN', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    // --- KHỞI TẠO BIẾU ĐỒ ---
    let revenueChart; // Biến toàn cục để lưu instance của biểu đồ
    let statusChart;  // Biến toàn cục cho biểu đồ tròn (nếu cần update sau này)

    document.addEventListener("DOMContentLoaded", function () {
        // 1. Dữ liệu ban đầu từ Controller (Load trang lần đầu)
        const initLabels = /*[[${dayLabels}]]*/ [];
        const initRevenues = /*[[${revenueList}]]*/ [];
        const pieValues = /*[[${orderStatusValues}]]*/ [0, 0, 0];

        // Fallback dữ liệu nếu list rỗng
        const safeLabels = (initLabels && initLabels.length > 0) ? initLabels : ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
        const safeRevenues = (initRevenues && initRevenues.length > 0) ? initRevenues : [0, 0, 0, 0, 0, 0, 0];

        // 2. VẼ BIỂU ĐỒ CỘT (BAR CHART) - [ĐÃ SỬA]
        const ctxRev = document.getElementById('revenueChart').getContext('2d');

        revenueChart = new Chart(ctxRev, {
            type: 'bar', // <--- QUAN TRỌNG: Đổi từ 'line' sang 'bar'
            data: {
                labels: safeLabels,
                datasets: [{
                    label: 'Doanh thu',
                    data: safeRevenues,
                    backgroundColor: '#4318FF', // Màu cột
                    borderRadius: 6,           // Bo góc cột
                    barThickness: 30,          // Độ rộng cột (px)
                    hoverBackgroundColor: '#2B00FF' // Màu khi di chuột vào
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        backgroundColor: '#1B2559',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: false, // Ẩn ô màu trong tooltip
                        callbacks: {
                            label: function (context) {
                                return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN', {
                                    style: 'currency',
                                    currency: 'VND'
                                }).format(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            borderDash: [5, 5],
                            drawBorder: false,
                            color: '#E0E5F2'
                        },
                        ticks: {
                            color: '#A3AED0',
                            font: {size: 11},
                            callback: function (value) {
                                return value.toLocaleString('vi-VN');
                            }
                        }
                    },
                    x: {
                        grid: {display: false}, // Ẩn lưới dọc
                        ticks: {
                            color: '#A3AED0',
                            font: {size: 12}
                        }
                    }
                }
            }
        });

        // 3. Vẽ biểu đồ Pie (Trạng thái)
        const ctxPie = document.getElementById('orderStatusChart');
        if (ctxPie) {
            statusChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Hoàn thành', 'Đang giao', 'Đã hủy'],
                    datasets: [{
                        data: pieValues,
                        backgroundColor: ['#4318FF', '#FFB547', '#E31A1A'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {legend: {display: false}}
                }
            });
        }
    });

    // --- HÀM GỌI API AJAX ĐỂ CẬP NHẬT BIỂU ĐỒ ---
    function updateChart(filterType, btnElement) {
        // 1. UI: Đổi trạng thái nút Active
        if (filterType !== 'custom') {
            document.querySelectorAll('.filter-btn-group .btn').forEach(btn => btn.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');
        }

        // 2. Chuẩn bị URL
        let url = `/admin/dashboard/revenue?filter=${filterType}`;

        if (filterType === 'custom') {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert("Vui lòng chọn đầy đủ ngày bắt đầu và kết thúc!");
                return;
            }
            url += `&startDate=${startDate}&endDate=${endDate}`;
        }

        // 3. Gọi AJAX
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("Lỗi kết nối server");
                return response.json();
            })
            .then(data => {
                // Cập nhật biểu đồ Cột
                revenueChart.data.labels = data.labels;
                revenueChart.data.datasets[0].data = data.revenues;
                revenueChart.update();

                // Cập nhật biểu đồ Tròn (nếu API trả về pieData)
                if (data.pieData && statusChart) {
                    statusChart.data.datasets[0].data = data.pieData;
                    statusChart.update();
                }
            })
            .catch(error => {
                console.error("Lỗi tải biểu đồ:", error);
                // alert("Không thể tải dữ liệu biểu đồ. Vui lòng thử lại!"); // Có thể comment dòng này để đỡ phiền
            });
    }
</script>

</body>
</html>