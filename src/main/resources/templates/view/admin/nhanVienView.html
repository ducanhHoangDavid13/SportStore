<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Quản lý Nhân viên</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Bootstrap 5 & Libs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }

        /* Card Styles */
        .card-box {
            background: #ffffff;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }

        /* Table Styles */
        .table-custom thead th {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e5e7eb;
            padding: 1rem 0.75rem;
            white-space: nowrap;
        }
        .table-custom tbody td {
            vertical-align: middle;
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        .table-custom tbody tr:hover { background-color: #f9fafb; }

        /* Badges */
        .badge-status {
            padding: 0.35em 0.8em;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
        }
        .badge-active { background-color: #d1fae5; color: #065f46; }
        .badge-inactive { background-color: #fee2e2; color: #991b1b; }
        .badge-gender-m { background-color: #e0f2fe; color: #0369a1; }
        .badge-gender-f { background-color: #fce7f3; color: #be185d; }

        /* Action Buttons */
        .btn-action {
            width: 32px; height: 32px; padding: 0;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 6px; transition: all 0.2s;
        }
        .btn-action:hover { transform: translateY(-2px); }

        /* Modal Styling */
        .modal-content { border-radius: 16px; border: none; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { border-bottom: 1px solid #f3f4f6; padding: 1.5rem; }
        .modal-header.bg-primary { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%) !important; }
        .modal-body { padding: 1.5rem; }

        .form-control:focus, .form-select:focus {
            border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body>
<nav th:replace="~{library/navbar :: admin-navbar}"></nav>

<div class="page-wrapper">
    <div th:replace="~{library/navbar :: admin-sidebar}"></div>
    <main class="main-content pt-4 px-4">

        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark mb-0">Quản lý Nhân viên</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="#" class="text-decoration-none">Admin</a></li>
                        <li class="breadcrumb-item active">Nhân viên</li>
                    </ol>
                </nav>
            </div>

            <!-- 1. Filter Card -->
            <div class="card-box p-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label text-muted small fw-bold">TỪ KHÓA</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Tìm theo mã hoặc tên nhân viên...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-primary px-4" onclick="searchNhanVien()"><i class="fas fa-filter me-1"></i> Tìm kiếm</button>
                            <button class="btn btn-light border px-3" onclick="loadNhanVien()"><i class="fas fa-sync-alt me-1"></i> Làm mới</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Table Card -->
            <div class="card-box">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark">Danh sách Nhân viên</h5>
                    <button class="btn btn-success btn-sm shadow-sm" onclick="showAddModal()">
                        <i class="fas fa-user-plus me-2"></i> Thêm mới
                    </button>
                </div>

                <div class="table-responsive" style="min-height: 400px;">
                    <table class="table table-custom table-hover mb-0">
                        <thead>
                        <tr>
                            <th>Mã NV</th>
                            <th>Họ và Tên</th>
                            <th>Liên hệ</th>
                            <th>CCCD</th>
                            <th class="text-center">Giới tính</th>
                            <th>Địa chỉ</th>
                            <th>Vai trò</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center" style="width: 100px;">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody id="tableBody">
                        <!-- Data Render Here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="p-3 border-top bg-light bg-opacity-25 d-flex justify-content-between align-items-center">
                    <div id="pageInfo" class="text-muted small"></div>
                    <div id="paginationContainer"></div>
                </div>
            </div>
        </div>

        <!-- Modal Thêm/Sửa -->
        <div class="modal fade" id="nvModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white border-0">
                        <h5 class="modal-title fw-bold" id="modalTitle"><i class="fas fa-user-tie me-2"></i> THÊM NHÂN VIÊN</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="nvForm" onsubmit="return false;">
                            <input type="hidden" id="nvId"/>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">MÃ NHÂN VIÊN <span class="text-danger">*</span></label>
                                    <input id="maNhanVien" class="form-control" placeholder="VD: NV001" required/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">HỌ VÀ TÊN <span class="text-danger">*</span></label>
                                    <input id="tenNhanVien" class="form-control" placeholder="Nhập họ tên đầy đủ" required/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">EMAIL</label>
                                    <input id="email" type="email" class="form-control" placeholder="email@example.com"/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">SỐ ĐIỆN THOẠI</label>
                                    <input id="soDienThoai" class="form-control" placeholder="0xxxxxxxxx"/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">CĂN CƯỚC (CCCD)</label>
                                    <input id="cccd" class="form-control" placeholder="Số căn cước"/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">GIỚI TÍNH</label>
                                    <select id="gioiTinh" class="form-select">
                                        <option value="">-- Chọn --</option>
                                        <option value="true">Nam</option>
                                        <option value="false">Nữ</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">ĐỊA CHỈ</label>
                                    <input id="diaChi" class="form-control" placeholder="Địa chỉ chi tiết"/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">VAI TRÒ</label>
                                    <input id="vaiTro" class="form-control" placeholder="VD: Quản lý, Nhân viên..."/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">TRẠNG THÁI</label>
                                    <select id="trangThai" class="form-select">
                                        <option value="1">Đang làm việc</option>
                                        <option value="0">Đã nghỉ việc</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary px-4" onclick="saveNhanVien()">Lưu lại</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toasts Container -->
        <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    </main>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script th:src="@{/js/my-custom-scripts.js}"></script>

<script>
    // Cấu hình Toastr
    toastr.options = { "closeButton": true, "progressBar": true, "positionClass": "toast-bottom-right", "timeOut": "3000" };

    const apiBase = "/api/nhanvien";
    let nvModal; // Khởi tạo sau khi DOM ready

    let currentPage = 1;
    const pageSize = 10;
    let allNhanVien = [];

    // --- HELPER FUNCTIONS ---
    function trangThaiToBadge(v) {
        return v === 1
            ? '<span class="badge-status badge-active"><i class="fas fa-check-circle me-1"></i>Đang làm</span>'
            : '<span class="badge-status badge-inactive"><i class="fas fa-user-times me-1"></i>Nghỉ việc</span>';
    }

    function gioiTinhToBadge(v) {
        if(v === true) return '<span class="badge-status badge-gender-m"><i class="fas fa-mars"></i> Nam</span>';
        if(v === false) return '<span class="badge-status badge-gender-f"><i class="fas fa-venus"></i> Nữ</span>';
        return '<span class="text-muted small">N/A</span>';
    }

    function parseTrangThai(v){ return Number(v)===1?1:0; }
    function parseGioiTinh(v){ if(v==='true')return true; if(v==='false')return false; return null; }

    // --- MAIN LOGIC ---
    async function loadNhanVien(){
        $('#tableBody').html('<tr><td colspan="9" class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><div class="mt-2 text-muted">Đang tải dữ liệu...</div></td></tr>');

        try{
            const res = await fetch(apiBase+'/list');
            if(!res.ok) throw new Error(res.status);
            allNhanVien = await res.json();
            renderTable();
            renderPagination();
            updatePageInfo();
        } catch(e) {
            console.error(e);
            $('#tableBody').html('<tr><td colspan="9" class="text-center text-danger py-5">Lỗi kết nối server.</td></tr>');
            toastr.error('Không thể tải danh sách');
        }
    }

    function renderTable(){
        const body = document.getElementById('tableBody');
        if(!allNhanVien.length){
            body.innerHTML=`<tr><td colspan="9" class="text-center py-5 text-muted">Không tìm thấy nhân viên nào</td></tr>`;
            return;
        }

        const start = (currentPage-1)*pageSize;
        const end = start+pageSize;
        const pageData = allNhanVien.slice(start,end);

        body.innerHTML = pageData.map(nv => `
            <tr>
                <td class="fw-bold text-primary">#${nv.maNhanVien??'N/A'}</td>
                <td class="fw-semibold text-dark">${nv.tenNhanVien??'N/A'}</td>
                <td>
                    <div class="small">${nv.email || '-'}</div>
                    <div class="small text-muted">${nv.soDienThoai || '-'}</div>
                </td>
                <td>${nv.cccd??'-'}</td>
                <td class="text-center">${gioiTinhToBadge(nv.gioiTinh)}</td>
                <td class="small text-muted text-truncate" style="max-width: 150px;" title="${nv.diaChi||''}">${nv.diaChi||'-'}</td>
                <td><span class="badge bg-light text-dark border">${nv.vaiTro||'NV'}</span></td>
                <td class="text-center">${trangThaiToBadge(nv.trangThai)}</td>
                <td class="text-center">
                    <button class="btn btn-action btn-light text-warning border me-1" onclick="openEdit(${nv.id})" title="Sửa"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-action btn-light text-danger border" onclick="deleteNhanVien(${nv.id})" title="Xóa"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>`).join('');
    }

    function renderPagination(){
        const totalPages = Math.max(1, Math.ceil(allNhanVien.length/pageSize));
        const div = document.getElementById('paginationContainer');

        let html = `<ul class="pagination pagination-sm mb-0">`;
        html += `<li class="page-item ${currentPage===1?'disabled':''}"><button class="page-link" onclick="changePage(${currentPage-1})"><i class="fas fa-chevron-left"></i></button></li>`;

        for(let i=1; i<=totalPages; i++){
            html += `<li class="page-item ${i===currentPage?'active':''}"><button class="page-link" onclick="changePage(${i})">${i}</button></li>`;
        }

        html += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><button class="page-link" onclick="changePage(${currentPage+1})"><i class="fas fa-chevron-right"></i></button></li></ul>`;
        div.innerHTML = html;
    }

    function changePage(p){
        const totalPages = Math.ceil(allNhanVien.length/pageSize);
        if(p<1 || p>totalPages) return;
        currentPage = p;
        renderTable(); renderPagination(); updatePageInfo();
    }

    function updatePageInfo() {
        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, allNhanVien.length);
        if (allNhanVien.length > 0) {
            $('#pageInfo').text(`Hiển thị ${start}-${end} của ${allNhanVien.length} nhân viên`);
        } else {
            $('#pageInfo').text('');
        }
    }

    async function searchNhanVien(){
        const kw = document.getElementById('searchInput').value.trim().toLowerCase();
        try{
            const res = await fetch(apiBase+'/list');
            const list = await res.json();
            allNhanVien = list.filter(nv =>
                (nv.tenNhanVien??'').toLowerCase().includes(kw) ||
                (nv.maNhanVien??'').toLowerCase().includes(kw)
            );
            currentPage = 1;
            renderTable(); renderPagination(); updatePageInfo();
        } catch(e){ toastr.error('Lỗi tìm kiếm'); }
    }

    function showAddModal(){
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i> THÊM NHÂN VIÊN';
        document.getElementById('nvForm').reset();
        document.getElementById('nvId').value='';
        document.getElementById('trangThai').value='1';
        nvModal.show();
    }

    async function openEdit(id){
        try{
            const res = await fetch(`${apiBase}/${id}`);
            if(!res.ok){ toastr.error('Không tìm thấy nhân viên'); return; }
            const nv = await res.json();

            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i> CẬP NHẬT NHÂN VIÊN';
            document.getElementById('nvId').value=nv.id??'';
            document.getElementById('maNhanVien').value=nv.maNhanVien??'';
            document.getElementById('tenNhanVien').value=nv.tenNhanVien??'';
            document.getElementById('email').value=nv.email??'';
            document.getElementById('soDienThoai').value=nv.soDienThoai??'';
            document.getElementById('cccd').value=nv.cccd??'';
            document.getElementById('gioiTinh').value=nv.gioiTinh===null?'':String(nv.gioiTinh);
            document.getElementById('diaChi').value=nv.diaChi??'';
            document.getElementById('vaiTro').value=nv.vaiTro??'';
            document.getElementById('trangThai').value=nv.trangThai===1?'1':'0';

            nvModal.show();
        } catch(e){ toastr.error('Lỗi khi tải dữ liệu'); }
    }

    async function saveNhanVien(){
        const id = document.getElementById('nvId').value;
        const ma = document.getElementById('maNhanVien').value.trim();
        const ten = document.getElementById('tenNhanVien').value.trim();

        if(!ma || !ten){ toastr.warning('Vui lòng nhập Mã và Tên nhân viên'); return; }

        const payload = {
            maNhanVien: ma, tenNhanVien: ten,
            email: document.getElementById('email').value.trim()||null,
            soDienThoai: document.getElementById('soDienThoai').value.trim()||null,
            cccd: document.getElementById('cccd').value.trim()||null,
            gioiTinh: parseGioiTinh(document.getElementById('gioiTinh').value),
            diaChi: document.getElementById('diaChi').value.trim()||null,
            vaiTro: document.getElementById('vaiTro').value.trim()||null,
            trangThai: parseTrangThai(document.getElementById('trangThai').value)
        };

        try{
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiBase}/update/${id}` : `${apiBase}/add`;
            const res = await fetch(url, {
                method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
            });

            if(!res.ok) { toastr.error('Lưu thất bại'); return; }

            nvModal.hide();
            toastr.success(id ? 'Cập nhật thành công' : 'Thêm mới thành công');
            loadNhanVien();
        } catch(e){ toastr.error('Lỗi kết nối server'); }
    }

    async function deleteNhanVien(id){
        if(!confirm('Bạn có chắc chắn muốn xóa nhân viên này?')) return;
        try{
            const res = await fetch(`${apiBase}/delete/${id}`, {method:'DELETE'});
            if(!res.ok) { toastr.error('Xóa thất bại'); return; }
            toastr.success('Đã xóa nhân viên');
            loadNhanVien();
        } catch(e){ toastr.error('Lỗi khi xóa'); }
    }

    // Init
    $(document).ready(function() {
        nvModal = new bootstrap.Modal(document.getElementById('nvModal'));
        loadNhanVien();

        // Sidebar toggle
        const toggleButton = document.getElementById('sidebarToggleBtn');
        if (toggleButton) {
            toggleButton.addEventListener('click', function(e) {
                e.preventDefault();
                document.body.classList.toggle('sidebar-toggled');
            });
        }
    });
</script>
</body>
</html>