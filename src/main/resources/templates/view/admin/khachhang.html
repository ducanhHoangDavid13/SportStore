<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Quản lý Khách hàng</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Bootstrap 5 & Libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" th:href="@{/css/styles.css}" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }

        /* Card Styles */
        .card-box {
            background: #ffffff;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }

        /* Filter */
        .filter-header {
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #4b5563;
        }

        /* Table Styles */
        .table-custom thead th {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e5e7eb;
            padding: 1rem 0.75rem;
        }
        .table-custom tbody td {
            vertical-align: middle;
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        .table-custom tbody tr:hover { background-color: #f9fafb; cursor: pointer; }

        /* Highlight active row */
        .table-custom tbody tr.table-active {
            background-color: #e0e7ff !important; /* Màu xanh nhạt khi chọn */
        }

        /* Action Buttons */
        .btn-action {
            width: 32px; height: 32px; padding: 0;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 6px; transition: all 0.2s;
        }
        .btn-action:hover { transform: translateY(-2px); }

        /* Tabs Styling */
        .nav-tabs .nav-link {
            color: #6b7280;
            font-weight: 500;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.75rem 1.5rem;
        }
        .nav-tabs .nav-link.active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
            background: transparent;
            font-weight: 600;
        }
        .nav-tabs { border-bottom: 1px solid #e5e7eb; }

        /* Modal Styling */
        .modal-content { border-radius: 16px; border: none; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header.bg-primary { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%) !important; }
        .modal-header.bg-warning { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%) !important; color: white !important; }
        .modal-header.bg-danger { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%) !important; }

        .form-control:focus, .form-select:focus {
            border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body>
<nav th:replace="library/navbar :: admin-navbar"></nav>

<div class="page-wrapper">
    <div th:replace="library/navbar :: admin-sidebar"></div>
    <main class="main-content pt-4 px-4">

        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark mb-0">Quản lý Khách hàng</h3>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="#" class="text-decoration-none">Admin</a></li>
                        <li class="breadcrumb-item active">Khách hàng</li>
                    </ol>
                </nav>
            </div>

            <!-- 1. Filter Card -->
            <div class="card-box p-4">
                <div class="filter-header d-flex align-items-center">
                    <i class="fas fa-filter text-primary me-2"></i> Bộ lọc tìm kiếm
                </div>
                <form id="filterForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label text-muted small fw-bold">TỪ KHÓA</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" id="keyword" class="form-control border-start-0" placeholder="Mã hoặc Tên...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted small fw-bold">SỐ ĐIỆN THOẠI</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-phone text-muted"></i></span>
                                <input type="text" id="sdt" class="form-control border-start-0" placeholder="Số điện thoại...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted small fw-bold">GIỚI TÍNH</label>
                            <select id="gioiTinh" class="form-select">
                                <option value="">Tất cả</option>
                                <option value="true">Nam</option>
                                <option value="false">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary px-3 w-100"><i class="fas fa-filter me-1"></i> Lọc</button>
                                <button type="button" class="btn btn-light border px-3 w-100" id="btnReset"><i class="fas fa-sync-alt me-1"></i> Reset</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 2. Customer Table Card -->
            <div class="card-box">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark">Danh sách Khách hàng</h5>
                    <div>
                        <button class="btn btn-success btn-sm shadow-sm me-2" data-bs-toggle="modal" data-bs-target="#addKhachHangModal">
                            <i class="fas fa-user-plus me-2"></i> Thêm mới
                        </button>
                        <button class="btn btn-outline-secondary btn-sm shadow-sm">
                            <i class="fas fa-file-export me-1"></i> Xuất Excel
                        </button>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-custom table-hover mb-0">
                        <thead class="sticky-top" style="z-index: 1;">
                        <tr>
                            <th>Mã KH</th>
                            <th>Họ và Tên</th>
                            <th>Điện thoại</th>
                            <th>Email</th>
                            <th class="text-center">Tuổi</th>
                            <th class="text-center">Giới tính</th>
                            <th class="text-center" style="width: 120px;">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody id="khachHangTableBody">
                        <!-- JS will render data here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="p-3 border-top bg-light bg-opacity-25 d-flex justify-content-end">
                    <nav id="paginationNav"></nav>
                </div>
            </div>

            <!-- 3. Address Tabs Card -->
            <div class="card-box p-0">
                <ul class="nav nav-tabs px-3 pt-2" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#tabdiachi">
                            <i class="fas fa-map-marker-alt me-2"></i>Sổ Địa Chỉ
                        </a>
                    </li>
                </ul>
                <div class="tab-content p-4">
                    <div class="tab-pane fade show active" id="tabdiachi">
                        <div class="table-responsive">
                            <table class="table table-custom table-sm" id="diaChiTable">
                                <thead>
                                <tr>
                                    <th>Người nhận</th>
                                    <th>SĐT</th>
                                    <th>Địa chỉ cụ thể</th>
                                    <th>Xã/Phường</th>
                                    <th>Quận/Huyện - Tỉnh/TP</th>
                                    <th>Loại</th>
                                    <th>Ghi chú</th>
                                </tr>
                                </thead>
                                <tbody id="diaChiTableBody">
                                <tr><td colspan="7" class="text-center py-4 text-muted">Vui lòng chọn một khách hàng để xem địa chỉ.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- MODAL THÊM MỚI -->
        <div class="modal fade" id="addKhachHangModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <form id="khachHangForm" method="post">
                        <div class="modal-header bg-primary text-white border-0">
                            <h5 class="modal-title fw-bold"><i class="fas fa-user-plus me-2"></i> THÊM KHÁCH HÀNG MỚI</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">MÃ KHÁCH HÀNG <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newMaKhachHang" placeholder="Ví dụ: KH001">
                                    <div class="invalid-feedback" id="error-newMaKhachHang"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">HỌ VÀ TÊN <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newTenKhachHang" placeholder="Nhập họ tên đầy đủ">
                                    <div class="invalid-feedback" id="error-newTenKhachHang"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">SỐ ĐIỆN THOẠI</label>
                                    <input type="text" class="form-control" id="newSoDienThoai" placeholder="0xxxxxxxxx">
                                    <div class="invalid-feedback" id="error-newSoDienThoai"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">EMAIL</label>
                                    <input type="email" class="form-control" id="newEmail" placeholder="email@example.com">
                                    <div class="invalid-feedback" id="error-newEmail"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">NĂM SINH</label>
                                    <input type="number" class="form-control" id="newNamSinh" placeholder="YYYY">
                                    <div class="invalid-feedback" id="error-newNamSinh"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">GIỚI TÍNH</label>
                                    <div class="d-flex gap-3 p-2 border rounded bg-light">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="newGioiTinh" id="newGioiTinhNam" value="true">
                                            <label class="form-check-label" for="newGioiTinhNam"><i class="fas fa-mars text-primary"></i> Nam</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="newGioiTinh" id="newGioiTinhNu" value="false">
                                            <label class="form-check-label" for="newGioiTinhNu"><i class="fas fa-venus text-danger"></i> Nữ</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Đóng</button>
                            <button type="submit" class="btn btn-primary px-4">Lưu lại</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- MODAL CẬP NHẬT -->
        <div class="modal fade" id="editKhachHangModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <form id="editKhachHangForm" method="post">
                        <input type="hidden" id="editKhachHangId" name="id">
                        <div class="modal-header bg-warning text-white border-0">
                            <h5 class="modal-title fw-bold"><i class="fas fa-user-edit me-2"></i> CẬP NHẬT KHÁCH HÀNG</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">MÃ KHÁCH HÀNG <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editMaKhachHang" readonly>
                                    <div class="invalid-feedback" id="error-editMaKhachHang"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">HỌ VÀ TÊN <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editTenKhachHang">
                                    <div class="invalid-feedback" id="error-editTenKhachHang"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">SỐ ĐIỆN THOẠI</label>
                                    <input type="text" class="form-control" id="editSoDienThoai">
                                    <div class="invalid-feedback" id="error-editSoDienThoai"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">EMAIL</label>
                                    <input type="email" class="form-control" id="editEmail">
                                    <div class="invalid-feedback" id="error-editEmail"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">NĂM SINH</label>
                                    <input type="number" class="form-control" id="editNamSinh">
                                    <div class="invalid-feedback" id="error-editNamSinh"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">GIỚI TÍNH</label>
                                    <div class="d-flex gap-3 p-2 border rounded bg-light">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="editGioiTinh" id="editGioiTinhNam" value="true">
                                            <label class="form-check-label" for="editGioiTinhNam"><i class="fas fa-mars text-primary"></i> Nam</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="editGioiTinh" id="editGioiTinhNu" value="false">
                                            <label class="form-check-label" for="editGioiTinhNu"><i class="fas fa-venus text-danger"></i> Nữ</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy bỏ</button>
                            <button type="submit" class="btn btn-warning text-white px-4">Cập nhật</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- MODAL XÓA -->
        <div class="modal fade" id="deleteKhachHangModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white border-0">
                        <h5 class="modal-title fw-bold"><i class="fas fa-trash-alt me-2"></i>XÓA KHÁCH HÀNG</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <input type="hidden" id="deleteKhachHangId">
                        <i class="fas fa-exclamation-circle text-danger fa-3x mb-3"></i>
                        <p class="mb-1">Bạn có chắc muốn xóa khách hàng:</p>
                        <h5 id="deleteKhachHangMa" class="fw-bold text-dark"></h5>
                        <p class="small text-muted">Hành động này không thể hoàn tác.</p>
                    </div>
                    <div class="modal-footer border-0 justify-content-center pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-danger px-4" id="btnConfirmDelete">Xác nhận xóa</button>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script th:src="@{/js/my-custom-scripts.js}"></script>

<script>
    toastr.options = { "closeButton": true, "progressBar": true, "positionClass": "toast-bottom-right", "timeOut": "3000" };

    $(document).ready(function() {
        let currentFilter = { pageNo: 1, keyword: '', sdt: '', gioiTinh: '' };

        // Validation & Reset Error (Giữ nguyên)
        function clearValidationErrors(prefix) {
            $(`#${prefix}KhachHangForm .form-control`).removeClass('is-invalid');
            $(`#${prefix}KhachHangModal .invalid-feedback`).empty();
        }

        function validateKhachHangForm(prefix) {
            clearValidationErrors(prefix);
            let isValid = true;
            const maKhachHang = $('#' + prefix + 'MaKhachHang').val().trim();
            const tenKhachHang = $('#' + prefix + 'TenKhachHang').val().trim();
            const soDienThoai = $('#' + prefix + 'SoDienThoai').val().trim();
            const email = $('#' + prefix + 'Email').val().trim();
            const namSinhStr = $('#' + prefix + 'NamSinh').val().trim();

            const setError = (fieldId, message) => {
                $(`#${prefix}${fieldId}`).addClass('is-invalid');
                $(`#error-${prefix}${fieldId}`).text(message);
                isValid = false;
            };

            if (!maKhachHang) setError('MaKhachHang', "Mã không được để trống.");
            if (!tenKhachHang) setError('TenKhachHang', "Tên không được để trống.");
            if (soDienThoai && !/^0\d{9}$/.test(soDienThoai)) setError('SoDienThoai', "SĐT phải có 10 số và bắt đầu bằng 0.");
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) setError('Email', "Email không hợp lệ.");
            if (namSinhStr) {
                const namSinh = parseInt(namSinhStr);
                if (isNaN(namSinh) || namSinh < 1900 || namSinh > 2025) setError('NamSinh', "Năm sinh từ 1900-2025.");
            }
            return isValid;
        }

        // LOAD & RENDER
        function loadKhachHang() {
            let params = {
                pageNo: currentFilter.pageNo,
                keyword: currentFilter.keyword,
                sdt: currentFilter.sdt,
                gioiTinh: currentFilter.gioiTinh === 'true' ? true : (currentFilter.gioiTinh === 'false' ? false : null)
            };

            $('#khachHangTableBody').html('<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Đang tải dữ liệu...</div></td></tr>');
            renderDiaChiTable([]); // Clear địa chỉ

            $.ajax({
                url: "/api/khach-hang", type: "GET", data: params, dataType: "json",
                success: function(response) {
                    renderTable(response.content);
                    renderPagination(response.number + 1, response.totalPages);
                },
                error: function() {
                    $('#khachHangTableBody').html('<tr><td colspan="7" class="text-danger text-center py-3">Lỗi tải dữ liệu.</td></tr>');
                    toastr.error("Lỗi tải danh sách khách hàng.");
                }
            });
        }

        function renderTable(khachHangList) {
            let html = '';
            if (khachHangList.length === 0) {
                html = '<tr><td colspan="7" class="text-center py-4 text-muted">Không tìm thấy khách hàng nào.</td></tr>';
            } else {
                khachHangList.forEach(function(kh) {
                    let gioiTinhDisplay = '';
                    if (kh.gioiTinh === true) gioiTinhDisplay = '<span class="text-primary"><i class="fas fa-mars"></i> Nam</span>';
                    else if (kh.gioiTinh === false) gioiTinhDisplay = '<span class="text-danger"><i class="fas fa-venus"></i> Nữ</span>';
                    else gioiTinhDisplay = '<span class="text-muted">N/A</span>';

                    let tuoi = kh.tuoi !== null ? kh.tuoi : '-';

                    html += `<tr data-id="${kh.id}" data-ma="${kh.maKhachHang}" class="clickable-row">
                                <td class="text-muted fw-bold">#${kh.maKhachHang}</td>
                                <td class="fw-semibold text-dark">${kh.tenKhachHang}</td>
                                <td>${kh.soDienThoai || '-'}</td>
                                <td class="small text-muted">${kh.email || '-'}</td>
                                <td class="text-center">${tuoi}</td>
                                <td class="text-center">${gioiTinhDisplay}</td>
                                <td class="text-center">
                                    <button class="btn btn-action btn-light text-warning border me-1 btn-edit" data-id="${kh.id}" title="Sửa"><i class="fas fa-pen"></i></button>
                                    <button class="btn btn-action btn-light text-danger border btn-delete" data-id="${kh.id}" data-ma="${kh.maKhachHang}" title="Xóa"><i class="fas fa-trash-alt"></i></button>
                                </td>
                             </tr>`;
                });
            }
            $('#khachHangTableBody').html(html);
        }

        function renderPagination(currentPage, totalPages) {
            if (totalPages <= 1) { $('#paginationNav').empty(); return; }
            let nav = '<ul class="pagination pagination-sm mb-0">';
            nav += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}"><i class="fas fa-chevron-left"></i></a></li>`;

            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                nav += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }

            nav += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}"><i class="fas fa-chevron-right"></i></a></li></ul>`;

            $('#paginationNav').html(nav);
            $('#paginationNav a.page-link').on('click', function(e) {
                e.preventDefault();
                if (!$(this).parent().hasClass('disabled')) {
                    currentFilter.pageNo = $(this).data('page');
                    loadKhachHang();
                }
            });
        }

        // ĐỊA CHỈ
        function renderDiaChiTable(diaChiList) {
            let html = '';
            if (!diaChiList || diaChiList.length === 0) {
                html = '<tr><td colspan="7" class="text-center py-4 text-muted">Không có địa chỉ nào. Chọn khách hàng để xem.</td></tr>';
            } else {
                diaChiList.forEach(function(dc) {
                    html += `<tr>
                                <td class="fw-semibold">${dc.hoTen || '-'}</td>
                                <td>${dc.soDienThoai || '-'}</td>
                                <td>${dc.diaChiCuThe || '-'}</td>
                                <td>${dc.xa || '-'}</td>
                                <td>${dc.thanhPho || '-'}</td>
                                <td><span class="badge bg-light text-dark border">${dc.loaiDiaChi || 'Khác'}</span></td>
                                <td class="small text-muted">${dc.ghiChu || '-'}</td>
                             </tr>`;
                });
            }
            $('#diaChiTableBody').html(html);
        }

        function loadDiaChiByKhachHangId(khachHangId) {
            if (!khachHangId) { renderDiaChiTable([]); return; }
            $('#diaChiTableBody').html('<tr><td colspan="7" class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Đang tải địa chỉ...</td></tr>');

            $.ajax({
                url: "/api/dia-chi/khach-hang/" + khachHangId, type: "GET", dataType: "json",
                success: function(response) { renderDiaChiTable(response); },
                error: function() { $('#diaChiTableBody').html('<tr><td colspan="7" class="text-center text-danger">Lỗi tải địa chỉ.</td></tr>'); }
            });
        }

        // EVENT LISTENERS
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            currentFilter.keyword = $('#keyword').val();
            currentFilter.sdt = $('#sdt').val();
            currentFilter.gioiTinh = $('#gioiTinh').val();
            currentFilter.pageNo = 1;
            loadKhachHang();
        });

        $('#btnReset').on('click', function() {
            $('#keyword').val(''); $('#sdt').val(''); $('#gioiTinh').val('');
            currentFilter = { pageNo: 1, keyword: '', sdt: '', gioiTinh: '' };
            loadKhachHang();
        });

        $(document).on('click', '#khachHangTableBody tr.clickable-row', function(e) {
            // Tránh click khi bấm nút Sửa/Xóa
            if ($(e.target).closest('button').length) return;

            let khachHangId = $(this).data('id');
            $('#khachHangTableBody tr').removeClass('table-active');
            $(this).addClass('table-active');
            loadDiaChiByKhachHangId(khachHangId);
        });

        // ADD
        $('#khachHangForm').on('submit', function(e) {
            e.preventDefault();
            if (!validateKhachHangForm('new')) return;

            let data = {
                maKhachHang: $('#newMaKhachHang').val(),
                tenKhachHang: $('#newTenKhachHang').val(),
                soDienThoai: $('#newSoDienThoai').val(),
                email: $('#newEmail').val(),
                namSinh: $('#newNamSinh').val() || null,
                gioiTinh: $('input[name="newGioiTinh"]:checked').val() === 'true'
            };

            $.ajax({
                url: "/api/khach-hang", type: "POST", contentType: "application/json", data: JSON.stringify(data),
                success: function() {
                    toastr.success("Thêm mới thành công!");
                    $('#addKhachHangModal').modal('hide');
                    $('#khachHangForm')[0].reset();
                    currentFilter.pageNo = 1; loadKhachHang();
                },
                error: function(err) { toastr.error(err.responseJSON?.message || "Lỗi thêm mới."); }
            });
        });

        // EDIT - OPEN MODAL
        $(document).on('click', '.btn-edit', function() {
            let id = $(this).data('id');
            clearValidationErrors('edit');
            $.ajax({
                url: "/api/khach-hang/" + id, type: "GET",
                success: function(kh) {
                    $('#editKhachHangId').val(kh.id);
                    $('#editMaKhachHang').val(kh.maKhachHang);
                    $('#editTenKhachHang').val(kh.tenKhachHang);
                    $('#editSoDienThoai').val(kh.soDienThoai);
                    $('#editEmail').val(kh.email);
                    $('#editNamSinh').val(kh.namSinh);

                    if (kh.gioiTinh === true) $('#editGioiTinhNam').prop('checked', true);
                    else if (kh.gioiTinh === false) $('#editGioiTinhNu').prop('checked', true);
                    else $('input[name="editGioiTinh"]').prop('checked', false);

                    var modal = new bootstrap.Modal(document.getElementById('editKhachHangModal'));
                    modal.show();
                },
                error: function() { toastr.error("Không lấy được dữ liệu."); }
            });
        });

        // UPDATE
        $('#editKhachHangForm').on('submit', function(e) {
            e.preventDefault();
            if (!validateKhachHangForm('edit')) return;
            let id = $('#editKhachHangId').val();
            let data = {
                id: id,
                maKhachHang: $('#editMaKhachHang').val(),
                tenKhachHang: $('#editTenKhachHang').val(),
                soDienThoai: $('#editSoDienThoai').val(),
                email: $('#editEmail').val(),
                namSinh: $('#editNamSinh').val() || null,
                gioiTinh: $('input[name="editGioiTinh"]:checked').val() === 'true'
            };

            $.ajax({
                url: "/api/khach-hang/" + id, type: "PUT", contentType: "application/json", data: JSON.stringify(data),
                success: function() {
                    toastr.success("Cập nhật thành công!");
                    $('#editKhachHangModal').modal('hide');
                    loadKhachHang();
                },
                error: function(err) { toastr.error(err.responseJSON?.message || "Lỗi cập nhật."); }
            });
        });

        // DELETE
        $(document).on('click', '.btn-delete', function() {
            $('#deleteKhachHangId').val($(this).data('id'));
            $('#deleteKhachHangMa').text($(this).data('ma'));
            var modal = new bootstrap.Modal(document.getElementById('deleteKhachHangModal'));
            modal.show();
        });

        $('#btnConfirmDelete').on('click', function() {
            let id = $('#deleteKhachHangId').val();
            $.ajax({
                url: "/api/khach-hang/" + id, type: "DELETE",
                success: function() {
                    toastr.success("Đã xóa thành công!");
                    $('#deleteKhachHangModal').modal('hide');
                    loadKhachHang();
                },
                error: function() { toastr.error("Lỗi xóa khách hàng."); }
            });
        });

        // INIT
        loadKhachHang();
    });
</script>
</body>
</html>